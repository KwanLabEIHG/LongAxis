
%% longaxis
% longaxis was written by Keith R. Carney using MATLAB versions 2016b, 2017b and 2018b. 
% University of Utah, Dept. of Human Genetics, Kwan Lab
%
% MATLAB toolbox dependencies: Image Processing Toolbox 
%
%% List of longaxis external MATLAB functions
%
% (Most are already included in longaxis)
%
%       CoherenceFilter (compiled C code is not included)
%           Written by Dirk-Jan Kroon  
%           https://www.mathworks.com/matlabcentral/fileexchange/25449-image-edge-enhancing-coherence-filter-toolbox
% 
%       ellipsoid_fit (included in longaxis.m)
%           Written by Yury Petrov
%           https://www.mathworks.com/matlabcentral/fileexchange/24693-ellipsoid-fit
% 
%       ExactMinBoundCircle (included in longaxis.m)
%           Written by Anton Semechko
%           https://www.mathworks.com/matlabcentral/fileexchange/48725-exact-minimum-bounding-spheres-circles
% 
%       ExactMinBoundSphere3D (included in longaxis.m)
%           Written by Anton Semechko
%           https://www.mathworks.com/matlabcentral/fileexchange/48725-exact-minimum-bounding-spheres-circles
% 
%       ordfilt3 (included in longaxis.m)
%           Written by Olivier Salvado
%           https://www.mathworks.com/matlabcentral/fileexchange/5722-ordfilt3
% 
%       SurfaceIntersection (included in longaxis.m, with an edit in the main function: Look for "START Keith-edit" )
%           Written by Jaroslaw Tuszynski
%           https://www.mathworks.com/matlabcentral/fileexchange/48613-surface-intersection
%   
%% START of longaxis.m code
% ------------------------------------------------------------------------------------------------------------


function varargout = longaxis(varargin)
    % Last Modified by GUIDE v2.5 24-Oct-2019 12:01:54
    % initialization code start - DO NOT EDIT
    gui_Singleton = 1;
    gui_State = struct('gui_Name',       mfilename, ...
                       'gui_Singleton',  gui_Singleton, ...
                       'gui_OpeningFcn', @longaxis_OpeningFcn, ...
                       'gui_OutputFcn',  @longaxis_OutputFcn, ...
                       'gui_LayoutFcn',  @longaxis_LayoutFcn, ...
                       'gui_Callback',   []);
    if nargin && ischar(varargin{1})
        gui_State.gui_Callback = str2func(varargin{1});
    end

    if nargout
        [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
    else
        gui_mainfcn(gui_State, varargin{:});
    end
    % initialization code end - DO NOT EDIT
% -------------------------------------------------------------------------------------------------
function longaxis_OpeningFcn(hObject, eventdata, handles, varargin)

      handles.output = hObject; 

      global LongAxis_MainHandle     
      LongAxis_MainHandle = hObject;
           
      handles.MainFigure1.Name = 'Longaxis - v1.0';
      
      G = groot;
      set(handles.MainFigure1,'Position',[150, G.ScreenSize(1,4)-150-875, 522, 875])  
      
      handles.MainFigure1.Name = 'Longaxis';
      set(handles.Create_3D_Rendering_Button,'Visible','off')
      set(handles.ImageFileLocationDisplay, 'String', '<<< no image data loaded >>>')
      set(handles.HandednessLabel,'Visible','off')
      set(handles.EdgeCellsCheck,'Visible','off')
      
      set(handles.Z_slider,'Enable','off')
      set(handles.Z_Display,'Visible','off')
      set(handles.FilterVolumeDisplay,'Visible','off')
      set(handles.Select_Region_Button,'Value',0,'Enable','off','Visible','off')
      set(handles.Input_Region_Button, 'Value',0,'Enable','off','Visible','off')
      set(handles.Set_z1_Button,'Enable','off','Style','togglebutton')
      set(handles.Set_z2_Button,'Enable','off','Style','togglebutton')
      set(handles.PositionDisplay,'Visible','off')
      set(handles.CoordsPanel,'Visible','off') 
      
      set(handles.SaveImageDataButton,'Visible','on','Enable','off')  
      set(handles.Navigation_Figure,'Visible','off')
      set(handles.SelectedCellAxis,'Visible','off')
         
      set(handles.CellSpecsDisplayAxis,'Visible','off')
      set(handles.NavigationPanel,'Visible','on','Position',[1 1 522 825])
      set(handles.NavigationPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
                                                  'BackgroundColor',[0.4 0.4 0.4])
      set(handles.DisplayPanel,'Visible','off','Position',[1 1 522 825])
      set(handles.DisplayPanelButton,'Value',0)
      set(handles.DataPanel,'Visible','off','Position',[1 1 522 825])
      set(handles.DataPanelButton,'Value',0)

      handles.CellList.ButtonDownFcn  = [];
      handles.CellList.KeyPressFcn = [];
      handles.CellList.FontSize = 7.5;
      
      set(handles.X_Plane_Slider,'Enable','off')
      set(handles.XSliceDisplay,'Enable','off')
      set(handles.XLow,'Enable','off')
      set(handles.XHigh,'Enable','off')
      set(handles.XSliceCheck,'String','X Slice','Enable','off')
                  
      set(handles.Y_Plane_Slider,'Enable','off')
      set(handles.YSliceDisplay,'Enable','off')
      set(handles.YLow,'Enable','off')
      set(handles.YHigh,'Enable','off')
      set(handles.YSliceCheck,'String','Y Slice','Enable','off')
      
      set(handles.Z_Plane_Slider,'Enable','off')
      set(handles.ZSliceDisplay,'Enable','off')
      set(handles.ZLow,'Enable','off')
      set(handles.ZHigh,'Enable','off')
      set(handles.ZSliceCheck,'String','Z Slice','Enable','off') 
      set(handles.SliceOrLineCheck,'Value',0)
      
      set(handles.RecordIntersectionButton,'Enable','off')
      set(handles.CalculateConvergencePointButton,'Enable','off')
      set(handles.BuildUrchinPlotButton,'Enable','off')
      
          handles.FaceTransparency = 40;
      set(handles.FaceTransparencySlider, 'SliderStep',[1/100 10/100],'Min',0,'Max',100,...
          'Value',handles.FaceTransparency,'Enable','off')
      set(handles.FaceTransparencyDisplay,'String','Face Transparency:  40%','Enable','off')
          handles.MeshTransparency = 15;    
      set(handles.MeshTransparencySlider, 'SliderStep',[1/100 10/100],'Min',0,'Max',100,...
          'Value',handles.MeshTransparency,'Enable','off')
      set(handles.MeshTransparencyDisplay,'String','Mesh Transparency: 15%','Enable','off')
          handles.HLFaceTransparency = 70;    
      set(handles.HLTransparencySlider, 'SliderStep',[1/100 10/100],'Min',0,'Max',100,...
          'Value',handles.HLFaceTransparency,'Enable','off')
      set(handles.HLTransparencyDisplay,'String','HL Face Transparency: 70%','Enable','off')
          handles.HLMeshTransparency = 0;    
      set(handles.HLMeshTransparencySlider, 'SliderStep',[1/100 10/100],'Min',0,'Max',100,...
          'Value',handles.HLMeshTransparency,'Enable','off')
      set(handles.HLMeshTransparencyDisplay,'String','HL Mesh Transparency: 0%','Enable','off')
          handles.SliceTransparency = 100;    
      set(handles.SliceTransparencySlider, 'SliderStep',[1/100 10/100],'Min',0,'Max',100,...
          'Value',handles.SliceTransparency,'Enable','off')
      set(handles.SliceTransparencyDisplay,'String','Slice Transparency: 100%','Enable','off')
      set(handles.SliceSmoothingMenu,'Value',1)
      set(handles.SliceSaturateMenu, 'Value',1)
      
      set(handles.ShowAxesCheck,'Value',true,'Enable','off')
      set(handles.ShowBoxCheck, 'Value',true,'Enable','off')
          handles.ShowAxes  = true;
          handles.ShowBox   = true;
          handles.ViewAngle = 10;
      set(handles.ViewAngleSlider,'SliderStep',[1/100 1/10],'Min',5,'Max',15,...
          'Value',handles.ViewAngle,'Enable','off')
      set(handles.ViewAngleDisplay,'String','View Angle Zoom: 10','Enable','off')
          handles.ShowFace = true;
      set(handles.FaceCheck,'Value',handles.ShowFace,'Enable','off')
          handles.FaceColor = [0.5 0.5 0.5];
      set(handles.FaceColorButton,'BackgroundColor',handles.FaceColor,'Enable','off')
          handles.ShowMesh = false;
      set(handles.MeshCheck,'Value',handles.ShowMesh,'Enable','off','Value',0)
          handles.MeshColor = [0 0 0];
      set(handles.MeshColorButton,'BackgroundColor',handles.MeshColor,'Enable','off')
          handles.HighlightColor  = [0.8 0 0];
      set(handles.HighlightColorButton,'BackgroundColor',handles.HighlightColor,'Enable','off')  
          handles.BackgroundColor = [1 1 1];
      set(handles.BackgroundColorButton,'BackgroundColor',handles.BackgroundColor,'Enable','off')
          handles.AxesColor = [0.1 0.1 0.1];
      set(handles.AxesColorButton,'BackgroundColor',handles.AxesColor,'Enable','off')
          handles.GridColor = [0.1 0.1 0.1];
      set(handles.GridColorButton,'BackgroundColor',handles.GridColor,'Enable','off')
      
      set(handles.CamProjButton,'String','Proj: Perspective','Value',0,'Enable','off');  
          handles.Projection = 'perspective';    
      set(handles.ViewXZ_Button,'Enable','off')  
      set(handles.ViewYZ_Button,'Enable','off') 
      set(handles.ViewXY_Button,'Enable','off')  
      set(handles.ViewNegXZ_Button,'Enable','off')  
      set(handles.ViewNegYZ_Button,'Enable','off') 
      set(handles.ViewNegXY_Button,'Enable','off') 
      
      handles.SingleCellViewAngle = 11;    
      set(handles.SingleCellViewAngleSlider,'SliderStep',[1/100 1/10],'Min',5,'Max',15,'Value',...
                                                          handles.SingleCellViewAngle,'Enable','off')   
          handles.ShowVectors = false;
      set(handles.VectorDisplay_Listbox,'Value',1,'Enable','off')  
          handles.VectorColor = [1 0 1];
      set(handles.VectorColor_Button,'BackgroundColor',handles.VectorColor,'Enable','off')  
      set(handles.PolarHistButton,'Enable','off')
      set(handles.PolarHistButton_Point,'Enable','off')
      set(handles.VectorRadiusInput,'Enable','off')
      set(handles.VectorLengthInput,'Enable','off')
     
      set(handles.Pixel_Width_Input,'String','-')
      set(handles.Z_Step_Input,'String','-')
          handles.PixelWidth = 0.21;
          handles.ZStep = 0.42;
          handles.LowSizeFilter  = 5000;
          handles.HighSizeFilter = 80000;
      set(handles.EdgeCellsCheck,'Value',0)
      set(handles.Low_Size_Filter_Input, 'String',num2str(handles.LowSizeFilter ))
      set(handles.High_Size_Filter_Input,'String',num2str(handles.HighSizeFilter))
      
      PW = str2double(get(handles.Pixel_Width_Input,'String')); % Pixel Width (um)
      ZS = str2double(get(handles.Z_Step_Input,'String'));      % Z-Step (um)
      VS = ZS.*PW^2; % um^3
      handles.VoxelSize = VS;
    
      text0 = ['1 voxel = ',      sprintf('%5.4f',handles.VoxelSize),          ' ', ...
                texlabel('mu'), 'm', texlabel('^3')];
      text1 = ['Low Filter =  ',  sprintf('%5.1f',VS*handles.LowSizeFilter),   ' ', ...
                texlabel('mu'), 'm', texlabel('^3')];
      text2 = ['High Filter =  ', sprintf('%4.1f',VS*handles.HighSizeFilter),  ' ', ...
                texlabel('mu'), 'm', texlabel('^3')];
           
      handles.FilterText = text(handles.FilterVolumeDisplay,1,0.5,{text0, text1 , text2},...
                                'FontName','Monospaced','FontWeight','bold',...
                                'FontSize',9,'Color',[0 0 0],'HorizontalAlignment','right');
      
      set(handles.DataAndEllipsoidPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
          'BackgroundColor',[0.4 0.4 0.4])
      set(handles.FitPanel,'Position',[159 666 360 120],'Visible','on')
      set(handles.SizeFilterPanelButton,'Value',0)
      set(handles.FilterPanel,'Position',[159 666 360 120],'Visible','off')
      
      set(handles.DataFitTechnique_PullDown,'Value',1,'Enable','off','Visible','on');                        
      set(handles.SingleCellDisplayStyle_PullDown,'Value',2,'Enable','off')
      set(handles.HideEdgeCellsButton,'Enable','off')
      
      set(handles.R1R2FilterButton,'Enable','off')
      set(handles.R2R3FilterButton,'Enable','off')
      set(handles.VolumeDiffFilterButton,'Enable','off')
      set(handles.MBSD_MBCD_FilterButton,'Enable','off')
      set(handles.MBSDFilterButton,'Enable','off')
      
      set(handles.HideHLedCellsButton,'Enable','off')
      set(handles.ReverseVisibleCellsButton,'Enable','off')
      set(handles.csvOutputButton,'Enable','off')
      set(handles.csvInputButton,'Enable','off')
      set(handles.HideAllButton,'Enable','off')
      set(handles.UnHLAll_Button,'Enable','off')
      set(handles.ResetAllCellsButton,'Enable','off')
      set(handles.OnlyHLCellsVis_Button,'Enable','off')
      set(handles.ApplySizeFilterButton,'Enable','off')
      set(handles.SaveAnalysisButton,'Enable','off')
      set(handles.LoadAnalysisButton,'Enable','off')
      set(handles.ExportData_Button,'Enable','off')
      set(handles.Refresh3D_Button,'Enable','off')
      set(handles.SingleCellHLCheck,'Enable','off','Value',1)
      
      set(handles.ViewCellsNearSliceMenu,'Enable','off','Value',1)
      set(handles.ViewCellsNearSliceRangeInput,'Enable','off','String','5')
          handles.ViewCellsNearPlane = 0;
          handles.ViewCellsNearPlaneRange = 10;
      set(handles.ViewCellsNearSliceRangeInput,'String','10')
      
        handles.SingleCellHighLight = true;
        handles.RenderingFigure = -1;
        handles.DoXSlice = false;
        handles.DoYSlice = false;
        handles.DoZSlice = false;
        handles.XSliceHandle = [];
        handles.XSliceBorderHandle = [];
        handles.YSliceHandle = [];
        handles.YSliceBorderHandle = [];
        handles.ZSliceHandle = [];
        handles.ZSliceBorderHandle = [];
        handles.XSliceValue = [];
        handles.YSliceValue = [];
        handles.ZSliceValue = [];
        handles.ZXSliceIntersectionHandle = [];
        handles.ZYSliceIntersectionHandle = [];
        handles.XYSliceIntersectionHandle = [];
        handles.Rotate_Option = 0;
        handles.XAxisLimits = [];
        handles.YAxisLimits = [];
        handles.Region_X = [];
        handles.Region_Y = [];
        handles.Z1 = [];
        handles.Z2 = [];
        handles.sPix = [];
        handles.ePix = [];
        handles.Ztext = [];
        handles.CellText = [];
        handles.CellText2 = [];
        handles.CellText3 = [];
        
        handles.DataFitMethod = 'nofit';
        handles.SingleCellDisplayStyle = 'datasurface';
        handles.CurrentlySelectedCell = 0;
        handles.PartialCell = [];
        handles.CamLight1 = [];
        handles.CamLight2 = [];
        handles.CamLight3 = [];
        
        %handles.DataTable.Data = cell(0,4);
        handles.CellList.Value = 1;
        handles.CellList.String = {''};
        handles.CellList.Enable = 'off';
        handles.CellList.FontName = 'Monospaced';
        
        handles.IsoObjXYZ = [];
        handles.IsoCapXYZ = [];
        
        handles.VectorType = 1;
        handles.VectorLength = 10;
        handles.VectorRadius = 0.6;
        handles.VectorData = [];
        handles.VectorHandles = [];
        handles.CellData = [];
        handles.COM = [];
        
        handles.CellIndices = [];
        handles.CellSizes   = [];
        handles.ObjVisible  = false(0,0);
        handles.ObjSelected = false(0,0);
        handles.ObjNearSliceView = true(0,0);
        handles.ViewCellsNearPlane = 1;
        
        handles.BinaryVoxels = [];
        handles.DistanceTransform = [];
        handles.subDT = [];
        handles.IntersectionPoint = []; 
        handles.SliceOrLine = 'Slice';
        handles.CP = [];
        handles.PopOutControllerHandle = [];
        % handles.ImageVolumeForSlices = [];
        set(handles.IntersectionPointDisplay,'String','')
        set(handles.VectorRadiusInput,'String',num2str(handles.VectorRadius))
        set(handles.VectorLengthInput,'String',num2str(handles.VectorLength))
        
        set(0,'CurrentFigure',handles.MainFigure1)
        set(gca,'Color',get(handles.MainFigure1,'Color'))

        ColorMaps = [{'parula'},{'jet'},{'cool'},  ...
                     {'hot'},{'winter'},{'spring'},...
                     {'summer'},{'bone'},{'gray'}, ...
                     {'copper'},{'pink'},{'autumn'}];

        set(handles.ShowColorbarCheck,'Enable','off')            
        set(handles.ColormapPulldown,'String',ColorMaps,'Enable','off','Value',1)
        
        handles.ColorMap = 'parula';
        handles.ColorbarHandle  = [];
        handles.CellExportData  = [];
        handles.AxisLineHandles = [];
        handles.FilterParam = [];
        
        handles.UndoButtonRecordedVisActions = false(0,1);
        % handles.UndoButtonRecordedHighLightActions = false(0,1); 
        handles.nRecordings = 100;
        
        guidata(hObject, handles);

% -------------------------------------------------------------------------------------------------
function varargout = longaxis_OutputFcn(hObject, eventdata, handles) 

         varargout{1} = handles.output;

% -------------------------------------------------------------------------------------------------
function Select_File_Button_Callback(hObject, eventdata, handles)
        
        set(handles.Select_File_Button,'Value',0)
%         [FileName,PathName,FilterIndex] = uigetfile({'*.lsm; *.tif'},'Select Z-Stack File');
           
          HANDLES = SelectFile(handles.MainFigure1);
          waitfor(HANDLES.SelectFile)           % wait for SelectFile to execute
          % grab updated longaxis handles variable that was edited by SelectFile.m
          handles = guidata(handles.MainFigure1);   
    
                if ~isequal(handles.File,0) 
                        %-----------------------------------------------------------------
                            set(handles.Pixel_Width_Input,'String',handles.PixelWidth); 
                            set(handles.Z_Step_Input,     'String',handles.ZStep); 
                        %-----------------------------------------------------------------
                            handles.FileName = [handles.Path handles.File]; % Record directory
                            info = imfinfo(handles.FileName);
                            NZ = length(info);
                            handles.ImX = info(1).Width;
                            handles.ImY = info(1).Height;
                        %-------------------------------------------------------------------------
                            Step = 1; 
                            handles.nZ = NZ;
                        %--------------------------------------------------------------------------
                            ind = 0;
                            h = waitbar(0,'');
                            for k = 1:Step:NZ
                                 ind = ind + 1;
                                 waitbar(ind/handles.nZ,h,['Reading Images: ' num2str(ind) ...
                                     ' of ' num2str(handles.nZ)])
                                 %--------------------------------------------------------------------
                                 ImageZ = imread(handles.FileName,k);                % Read in Image
                                 if isequal(k,1)
                                    obj = class(ImageZ);
                                    switch obj
                                        case 'uint8'
                                            handles.IMstack = zeros(handles.ImY,handles.ImX,handles.nZ,'uint8'); % Create Space for Image Array
                                        case 'uint16'
                                            handles.IMstack = zeros(handles.ImY,handles.ImX,handles.nZ,'uint16'); % Create Space for Image Array
                                    end
                                    handles.BinaryVoxels = false(handles.ImY,handles.ImX,...
                                        handles.nZ);    % Create Space for Binary Image Array
                                 end
                                 handles.IMstack(:,:,ind) = imsaturate(ImageZ,0.1);    
                                 % Saturate Z slice pixels to 1%
                            end
                            close(h)
                            delete(h)
                        % -----------------------------------------------------------------------------------
                            [BA, DT] = ProcessImageStack(handles.IMstack);
                            handles.BinaryVoxels = BA;
                            handles.DistanceTransform = single(DT);

                            handles.Z = 1;
                            set(handles.Navigation_Figure,'Visible','on')
                            set(handles.Create_3D_Rendering_Button,'Visible','on','Enable','off')
                            set(handles.HandednessLabel,'Visible','on')   
                            set(handles.EdgeCellsCheck,'Visible','on')
                            set(handles.ImageFileLocationDisplay,'String',handles.FileName)
                            set(handles.Z_slider,'Visible','on')
                            set(handles.Z_slider,'SliderStep',[1/handles.nZ 10/handles.nZ],'Min',1,...
                                'Max',handles.nZ,'Value',1)
                            set(handles.Select_Region_Button,'Visible','on','Enable','on')
                            set(handles.Set_z1_Button,'Visible','on','String', 'z1 = 1','Enable','on')
                            set(handles.Set_z2_Button,'Visible','on','String',['z2 = ' num2str(handles.nZ)])
                            set(handles.PositionDisplay,'Visible','on')
                            set(handles.NavigationPanel,'Visible','on')
                            set(handles.SaveImageDataButton,'Enable','on')  
                            set(handles.Z_slider,'Enable','on')
                            set(handles.Z_Display,'Visible','on')
                            set(handles.Select_Region_Button,'Value',0,'Enable','on','Visible','on')
                            set(handles.Input_Region_Button,'Value',0,'Enable','on','Visible','on')
                            set(handles.Set_z1_Button,'Enable','on','Style','togglebutton')
                            set(handles.Set_z2_Button,'Enable','on','Style','togglebutton')
                            set(handles.PositionDisplay,'Visible','on')
                            set(handles.CoordsPanel,'Visible','on')  

                            handles.Z1 = 1;
                            handles.Z2 = handles.nZ;
                            [nY,nX,nZ] = size(handles.IMstack);
                            dX = handles.PixelWidth; % Pixel width (microns)
                            dY = dX;   
                            dZ = handles.ZStep;           % Z depth (microns)
                            handles.VoxelSize = dZ.*dX^2; % um^3 (uL)

                            handles.ImXdata  = single(linspace(0, nX*dX, nX)');
                            handles.ImYdata  = single(linspace(0, nY*dY, nY)');
                            handles.ImZdata  = single(linspace(0, nZ*dZ, nZ)');

                            handles.XAxisLimits = [0 handles.ImXdata(end)];
                            handles.YAxisLimits = [0 handles.ImYdata(end)];    

                            handles.Z = round(get(handles.Z_slider,'Value'));
                            z  = sprintf('%3d',handles.Z);
                            zm = handles.Z*handles.ZStep;

                            if ishandle(handles.Ztext)
                                delete(handles.Ztext)
                            end

                            text1 = [' Z: ' z  ' (' sprintf('%4.1f',zm) ' ' texlabel('mu') 'm)'];
                            dZ    = handles.Z2 - handles.Z1 + 1;
                            dZs   = sprintf('%3d',dZ);
                            dZsm  = dZ * handles.ZStep;
                            text2 = [texlabel('delta') 'Z: ' dZs ' (' sprintf('%4.1f',dZsm) ' '...
                                texlabel('mu') 'm)'];

                            handles.Ztext = text(handles.Z_Display,0,0.5,{text1 , text2},...
                                                  'FontName','Monospaced','FontWeight','bold',...
                                                  'FontSize',11,'Color',[0.64 0.08 0.18]);

                            set(handles.Z_Display,'Visible','off')
                            handles = Update_Navigation_Figure(handles);
                            set(handles.MainFigure1,'KeyPressFcn',@ShortCuts,...
                                                    'WindowButtonMotionFcn',@MotionFcn)
                    end

             guidata(hObject,handles)

%------------------------------------------------------------------------------------------------------   
function handles = Refresh_Rendering(handles)

                handles.CurrentlySelectedCell = 0;
                handles.CellList.Value = 1;
                handles.CellList.Enable = 'off';
                handles.CellList.String = {''};
                
                handles.VectorHandles = [];
                handles.VectorData = [];
                handles.ViewCellsNearSlice = 1;
                
                handles.ReverseXaxisCheck.Value = 0;
                handles.ReverseYaxisCheck.Value = 0;
                handles.ReverseZaxisCheck.Value = 0;                
                
                set(handles.ViewCellsNearSliceMenu,'Value',1)
                set(handles.Create_3D_Rendering_Button,'Value',0)
                set(handles.R1R2FilterButton,'Enable','off')
                set(handles.R2R3FilterButton,'Enable','off')
                set(handles.MBSD_MBCD_FilterButton,'Enable','off')
                set(handles.VolumeDiffFilterButton,'Enable','off')
                set(handles.MBSDFilterButton,'Enable','off')
                set(handles.VectorDisplay_Listbox,'Value',1,'Enable','off')
                set(handles.DataFitTechnique_PullDown,'Value',1)
                set(handles.FaceCheck,'Value',1)
                handles.IsoSurfaceHandles = cell(0,0);
                handles.IsoCapHandles = cell(0,0);
            %-----------------------------------------------------------------------------------------
                handles.DataFitMethod = 'nofit';
                handles.ShowVectors = false;
                handles.ShowFace = true;
                
            % Create Figure if it doesn't exist, or bring it to the front if it does -----------------
                
                handles = CreateRenderingFigure(handles);
                
            % Specify Sub_Region of Volume to be Rendered -------------------------------------------
                xr = (handles.sPix(1,2):handles.ePix(1,2))';   % x index range
                yr = (handles.sPix(1,1):handles.ePix(1,1))';   % y index range
                zr = (handles.Z1:handles.Z2)';                 % z index range

                a = handles.AxisRange; 
                axis(handles.AxisHandle,a)
                cla(handles.AxisHandle);
                %LH = findobj('Type','Light');
                %delete(LH);
                
                set(handles.AxisHandle,'Color',handles.BackgroundColor,...
                                       'DataAspectRatio',[1 1 1],'LineWidth',1,...
                                       'CameraPositionMode','auto','CameraTargetMode','auto',...
                                       'CameraUpVectorMode','auto','BoxStyle','full',...
                                       'CameraViewAngleMode','manual','CameraViewAngle',handles.ViewAngle,...
                                       'XColor',handles.AxesColor,...
                                       'YColor',handles.AxesColor,...
                                       'ZColor',handles.AxesColor,...
                                       'GridColor',handles.GridColor,...
                                       'YDir','reverse')
                                   
                xlabel(handles.AxisHandle,'X (\mum)'); 
                ylabel(handles.AxisHandle,'Y (\mum)'); 
                zlabel(handles.AxisHandle,'Z (\mum)'); 
                camproj(handles.AxisHandle,handles.Projection)
                
            %-------------------------------------------------------------------------
                if handles.ShowFace 
                    FC = handles.FaceColor;  
                    FCC = 0.8.*handles.FaceColor;
                else
                    FC = 'none';  FCC = 'none';
                end 

                if handles.ShowMesh 
                    MC = handles.MeshColor;  
                    MCC = 0.8.*handles.MeshColor;
                else
                    MC = 'none';  MCC = 'none';
                end
            %-------------------------------------------------------------------------
              
                h1 = waitbar(0,'');
                loc = get(h1,'Position');
                set(h1,'Position',[30 60 loc(3) loc(4)])
               
                nObjs = length(handles.IsoObjXYZ);
                
                handles.IsoSurfaceHandles = mat2cell( gobjects(nObjs,1), ones(nObjs,1) );
                handles.IsoCapHandles     = mat2cell( gobjects(nObjs,1), ones(nObjs,1) );
                WBS = max([10, round(sqrt(nObjs))]);
                
                figure(handles.RenderingFigure)
                
                for n = 1:nObjs
                        % Create IsoSurfaces and plot patch objects -----------------------------------------
                        handles.IsoSurfaceHandles{n,1} = patch(handles.AxisHandle,...
                                            'XData',handles.IsoObjXYZ{n,1}.DataPts.X,...
                                            'YData',handles.IsoObjXYZ{n,1}.DataPts.Y,...
                                            'ZData',handles.IsoObjXYZ{n,1}.DataPts.Z); 

                        set(handles.IsoSurfaceHandles{n,1},'FaceColor',FC,'EdgeColor',MC,...
                                                           'EdgeAlpha',handles.MeshTransparency/100,...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                           'FaceLighting','gouraud','EdgeLighting','flat',...
                                                           'LineWidth',1,...
                                                           'BackFaceLighting','unlit',...
                                                           'ButtonDownFcn',@PatchBDF,...
                                                           'AmbientStrength', 0.3 ,...
                                                           'DiffuseStrength', 0.3 ,...
                                                           'SpecularStrength', 1.0  ,...
                                                           'SpecularExponent', 25,...
                                                           'SpecularColorReflectance', 0.5);

                        % Create IsoCaps and plot patch objects ----------------------------------------------

                        handles.IsoCapHandles{n,1} = patch(handles.AxisHandle,...
                                                        'XData',handles.IsoCapXYZ{n,1}.DataPts.X,...
                                                        'YData',handles.IsoCapXYZ{n,1}.DataPts.Y,...
                                                        'ZData',handles.IsoCapXYZ{n,1}.DataPts.Z);

                        set(handles.IsoCapHandles{n,1},'FaceColor',FCC,'EdgeColor','none',...
                                                       'FaceAlpha',handles.FaceTransparency/100,...
                                                       'FaceLighting','gouraud','EdgeLighting','flat',...
                                                       'BackFaceLighting','unlit','ButtonDownFcn',@PatchBDF,...
                                                       'AmbientStrength', 0.3 ,...
                                                       'DiffuseStrength', 0.3 ,...
                                                       'SpecularStrength', 1.0  ,...
                                                       'SpecularExponent', 25,...
                                                       'SpecularColorReflectance', 0.5);
                        
                        if isequal(n,1)
                                daspect(handles.AxisHandle,[1,1,1])
                                if handles.ShowBox
                                    box(handles.AxisHandle,'on');  
                                else
                                    box(handles.AxisHandle,'off');
                                end
                                %-----------------------------------
                                if handles.ShowAxes; 
                                    grid(handles.AxisHandle,'on')
                                    grid(handles.AxisHandle,'minor')
                                else
                                    grid(handles.AxisHandle,'off');
                                end
                        end
                        %---------------------------------------------------------------
                        if isequal(rem(n,WBS),0)
                            waitbar(n/nObjs,h1,'Creating 3D Rendering')
                        end
                        %---------------------------------------------------------------
                        drawnow update
                end

                % -----------------------------------------------------------------------------------------
                handles.nObjs = nObjs;
                
                hold(handles.AxisHandle,   'on')
                camlight(handles.AxisHandle,   30,  89)
                camlight(handles.AxisHandle,   30, -89)
                camlight(handles.AxisHandle,  100,  10)
                camlight(handles.AxisHandle, -100,  10)
                hold(handles.AxisHandle,   'off')
                
%                 camlight(handles.AxisHandle,45,45,'infinite');
%                 camlight(handles.AxisHandle,320,18,'local')
%                 camlight(handles.AxisHandle,'right'); 
             
                %lighting(handles.AxisHandle,'gouraud')
                camproj(handles.AxisHandle,'perspective')  
                
                %=============================================================================================
                
                set(handles.X_Plane_Slider,'Min',a(1),'Max',a(2),'SliderStep',...
                        [0.02/(a(2) - a(1)) 1/(a(2) - a(1))],'Value',a(1),'Enable','off')
                handles.XSliceValue = a(1);
                set(handles.XSliceDisplay,'String',sprintf('%5.5f',a(1)),'Enable','off')
                set(handles.XLow, 'String',sprintf('%5.2f',a(1)),'Enable','off')
                set(handles.XHigh,'String',sprintf('%5.2f',a(2)),'Enable','off')
                set(handles.XSliceCheck,'Value',0,'Enable','on')

                set(handles.Y_Plane_Slider,'Min',a(3),'Max',a(4),'SliderStep',...
                        [0.02/(a(4) - a(3)) 1/(a(4) - a(3))],'Value',a(3),'Enable','off')
                handles.YSliceValue = a(3);
                set(handles.YSliceDisplay,'String',sprintf('%5.2f',a(3)),'Enable','off')
                set(handles.YLow, 'String',sprintf('%5.2f',a(3)),'Enable','off')
                set(handles.YHigh,'String',sprintf('%5.2f',a(4)),'Enable','off')
                set(handles.YSliceCheck,'Value',0,'Enable','on')

                set(handles.Z_Plane_Slider,'Min',a(5),'Max',a(6),'SliderStep',...
                        [0.02/(a(6) - a(5)) 1/(a(6) - a(5))],'Value',a(5),'Enable','off')
                handles.ZSliceValue = a(5);
                set(handles.ZSliceDisplay,'String',sprintf('%5.1f',a(5)),'Enable','off')
                set(handles.ZLow, 'String',sprintf('%5.2f',a(5)),'Enable','off')
                set(handles.ZHigh,'String',sprintf('%5.2f',a(6)),'Enable','off')
                set(handles.ZSliceCheck,'Value',0,'Enable','on')
                
                set(handles.SliceTransparencySlider,'Enable','off')
                
                handles.DoXSlice = false;
                handles.DoYSlice = false;
                handles.DoZSlice = false;
            %---------------------------------------------------------------------
                set(handles.FaceTransparencySlider, 'Enable','on')
                set(handles.FaceTransparencyDisplay,'Enable','on')
                set(handles.MeshTransparencyDisplay,'Enable','on')
                set(handles.MeshTransparencySlider, 'Enable','on')
                set(handles.HLTransparencySlider, 'Enable','on')
                set(handles.HLTransparencyDisplay,'Enable','on')
                set(handles.HLMeshTransparencySlider, 'Enable','on')
                set(handles.HLMeshTransparencyDisplay,'Enable','on')
                set(handles.ViewAngleSlider,'Enable','on')
                set(handles.ViewAngleDisplay,'Enable','on')
                set(handles.FaceCheck,'Enable','on')
                set(handles.FaceColorButton,'Enable','on')
                set(handles.MeshCheck,'Enable','on')
                set(handles.MeshColorButton,'Enable','on')
                set(handles.BackgroundColorButton,'Enable','on')
                set(handles.AxesColorButton,'Enable','on')
                set(handles.GridColorButton,'Enable','on')
                set(handles.CamProjButton,'String','Proj: Perspective','Value',0,'Enable','on');  
                set(handles.ColormapPulldown,'Enable','on')
                set(handles.SelectedCellAxis,'Visible','on','Color',get(handles.MainFigure1,'Color'))
                set(handles.ViewXZ_Button,'Enable','on')  
                set(handles.ViewYZ_Button,'Enable','on') 
                set(handles.ViewXY_Button,'Enable','on')  
                set(handles.ViewNegXZ_Button,'Enable','on')  
                set(handles.ViewNegYZ_Button,'Enable','on') 
                set(handles.ViewNegXY_Button,'Enable','on') 
                if nObjs > 0    
                    handles = Update_SingleCellAxis(handles,1);  
                end
                set(handles.DataFitTechnique_PullDown,'Enable','on','Visible','on');                        
                set(handles.SingleCellDisplayStyle_PullDown,'Enable','on')
                set(handles.HighlightColorButton,'Enable','on')  
                set(handles.ShowAxesCheck,'Enable','on')
                set(handles.ShowBoxCheck,'Enable','on')
                    set(handles.HideHLedCellsButton,'Enable','on')
                    set(handles.ReverseVisibleCellsButton,'Enable','on')
                    set(handles.csvOutputButton,'Enable','on')
                    set(handles.csvInputButton,'Enable','on')
                set(handles.HideEdgeCellsButton,'Enable','on')
                set(handles.HideAllButton,'Enable','on')
                set(handles.UnHLAll_Button,'Enable','on')
                set(handles.OnlyHLCellsVis_Button,'Enable','on')
                set(handles.ResetAllCellsButton,'Enable','on')
                set(handles.ApplySizeFilterButton,'Enable','on')
                set(handles.ShowColorbarCheck,'Enable','on')     
                set(handles.BackgroundColorButton,'Enable','on') 
                set(handles.SaveAnalysisButton,'Enable','on')
                set(handles.LoadAnalysisButton,'Enable','on')
                set(handles.ExportData_Button,'Enable','on')
                set(handles.Refresh3D_Button,'Enable','on')
                set(handles.SingleCellViewAngleSlider,'Enable','on')
                set(handles.SingleCellHLCheck,'Enable','on')
                set(handles.ViewCellsNearSliceMenu,'Enable','on')
                set(handles.ViewCellsNearSliceRangeInput,'Enable','on')
                set(handles.MBSDFilterButton,'Enable','on')
                % Update Cell List box ================================================================
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices, handles.CellSizes,...
                                                                   handles.ObjVisible,  handles.ObjSelected);

                    handles.CellList.KeyPressFcn = @ShortCuts; 
                    handles.CellList.Value = 1;
                    handles.CellList.Enable = 'on';
                    handles.CurrentlySelectedCell = 1;
                %======================================================================================  
                handles.UndoButtonRecordedVisActions = false(0,1);
                
            drawnow %expose   
            close(h1)
%------------------------------------------------------------------------------------------------------    
function handles = Update_Navigation_Figure(handles)
    
                set(0,'CurrentFigure',handles.MainFigure1)
                set(handles.MainFigure1,'CurrentAxes',handles.Navigation_Figure)
            % Create Image---------------------------------------------------  
                handles.NavigationImage = imshow(squeeze(handles.IMstack(:,:,handles.Z)),...
                'XData',handles.ImXdata,'YData',handles.ImYdata);
            % Grab Axis handle----------------------------------------------                             
                handles.NavigationAxis = get(handles.Navigation_Figure,'Children');
            % Put image on axis --------------------------------------------
                set(handles.NavigationAxis,'CData',handles.NavigationImage.CData,...
                                           'XData',handles.NavigationImage.XData,...
                                           'YData',handles.NavigationImage.YData)

                set(handles.Navigation_Figure,'XLim',handles.XAxisLimits,...
                                              'YLim',handles.YAxisLimits)  
                                      
                set(handles.Navigation_Figure,'FontSize',8)                          
                
                axis on
                
                ylabel('Y (\mum)','FontWeight','norm','FontSize',10)
                xlabel('X (\mum)','FontWeight','norm','FontSize',10)
            
                if ~isempty(handles.Region_X)
                    hold on, plot(handles.Region_X,handles.Region_Y,'-c'), hold off
                end
                
%------------------------------------------------------------------------------------------------------
function CustomizeFigure(FH)
        
        c1 = cameratoolbar(FH,'Show');
        a = findall(FH);
        b1 = findall(a,'ToolTipString','Zoom In');
            set(b1,'Visible','Off')
        b2 = findall(a,'ToolTipString','Zoom Out');
            set(b2,'Visible','Off')
        b3 = findall(a,'ToolTipString','Data Cursor');
            set(b3,'Visible','Off')
        b4 = findall(a,'ToolTipString','Brush/Select Data');
            set(b4,'Visible','Off')
        b5 = findall(a,'ToolTipString','Pan');
            set(b5,'Visible','Off')
        b6 = findall(a,'ToolTipString','Link Plot');
            set(b6,'Visible','Off')
        b7 = findall(a,'ToolTipString','Insert Colorbar');
            set(b7,'Visible','Off')
        b8 = findall(a,'ToolTipString','Insert Legend');
            set(b8,'Visible','Off')
        b9 = findall(a,'ToolTipString','New Figure');
            set(b9,'Visible','Off')
        b10 = findall(a,'ToolTipString','Open File');
            set(b10,'Visible','Off')
        b11 = findall(a,'ToolTipString','Print Figure');
            set(b11,'Visible','Off')
        b12 = findall(a,'ToolTipString','Toggle Scene Light');
            set(b12,'Visible','Off')
        b13 = findall(a,'ToolTipString','Orthographic Projection');
            set(b13,'Visible','Off')
        b14 = findall(a,'ToolTipString','Perspective Projection');
            set(b14,'Visible','Off')
        b15 = findall(a,'ToolTipString','Move Camera Forward/Back');
            set(b15,'Visible','Off')
        b16 = findall(a,'ToolTipString','Stop Camera/Light Motion');
            set(b16,'Visible','Off')
        %-----------------------------------------------------------------------    
        hToolbar = findall(FH,'tag','FigureToolBar');
        cToolbar = findall(FH,'tag','CameraToolBar');
        t1 = uitoolbar(FH);
        %-----------------------------------------------------------------------   
        Obj = findall(hToolbar,'tag','Standard.SaveFigure');
            set(Obj,'Parent',t1,'Separator','off')
        Obj = findall(cToolbar,'tag','orbit');
            set(Obj,'Parent',t1,'Separator','on')
        Obj = findall(cToolbar,'tag','orbitscenelight');
            set(Obj,'Parent',t1)    
        Obj = findall(cToolbar,'tag','pan');
            set(Obj,'Parent',t1)        
        Obj = findall(cToolbar,'tag','dollyhv');
            set(Obj,'Parent',t1)       
        Obj = findall(cToolbar,'tag','zoom');
            set(Obj,'Parent',t1)
        Obj = findall(cToolbar,'tag','roll');
            set(Obj,'Parent',t1)    
        Obj = findall(cToolbar,'tag','x');
            set(Obj,'Parent',t1)     
        Obj = findall(cToolbar,'tag','y');
            set(Obj,'Parent',t1)     
        Obj = findall(cToolbar,'tag','z');
            set(Obj,'Parent',t1)       
        Obj = findall(cToolbar,'tag','none');
            set(Obj,'Parent',t1)      
        Obj = findall(cToolbar,'tag','reset');
            set(Obj,'Parent',t1)       
        %Obj = findall(hToolbar,'tag','Standard.EditPlot');
          %  set(Obj,'Parent',t1)      
        %Obj = findall(hToolbar,'tag','Exploration.Rotate');
            %set(Obj,'Parent',t1)         
        Obj = findall(hToolbar,'tag','Plottools.PlottoolsOff');
            set(Obj,'Parent',t1)    
        Obj = findall(hToolbar,'tag','Plottools.PlottoolsOn');
            set(Obj,'Parent',t1)     
        set(hToolbar,'Visible','off')
        set(cToolbar,'Visible','off')    
        drawnow    
        
        
%------------------------------------------------------------------------------------------------------
function RenderFigureCloseFcn(src,callbackdata)
    
    button = questdlg('Are you sure you want to close the rendering window?',...
                      'Quit Verification','Yes','No','No');
    
    if strcmp(button,'Yes')
        set(src,'CloseRequestFcn','')
        delete(src)
    end 

%------------------------------------------------------------------------------------------------------    
function handles = CreateRenderingFigure(handles);   
    
        if isgraphics(handles.RenderingFigure); 
            delete(handles.RenderingFigure) % For simplification and avoiding bugs, 
                        % lets just get rid of the old figure and create a new one.
        end

        handles.RenderingFigure = figure(12345); clf; % Create Rendering Figure Window

        set(handles.RenderingFigure,'ToolBar','none','MenuBar','figure','Color',handles.BackgroundColor,...
                        'NumberTitle','off',...
                        'Name',['"R" toggles ROTATE/POINTER.    "V" toggles VISIBILITY.    ',...
                        '"H" toggles HIGHLIGHTING.    "S" starts MULTI-CELL HIGHLIGHTING.    "U" UNDO.'],...
                        'KeyPressFcn',@ShortCuts,...
                        'CloseRequestFcn',@RenderFigureCloseFcn,...
                        'Renderer','opengl',...
                        'BusyAction','cancel') 
                                
        handles.AxisHandle = axes(handles.RenderingFigure); % Create Axes in that figure                        
        handles.AxisHandle.BusyAction = 'cancel';
        
        rotate3d(handles.RenderingFigure,'off')
        
%------------------------------------------------------------------------------------------------------   
function handles = KeyPressWithRotate3DFix(handles);    

% This code fixes MATLAB's 'bug' that won't allow a figure's Key-Press 
% Functions to work while in Rotate3d mode
% http://undocumentedmatlab.com/blog/enabling-user-callbacks-during-zoom-pan   
% Currently works for R2017b.
    
        try 
            % !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            % This may need to be updated in future MATLAB releases.
            %!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            
            % Fix for main longaxis main figure ----------------------
            hManager =    uigetmodemanager(handles.MainFigure1); 
            [hManager.WindowListenerHandles.Enabled] =  deal(false);  
            set(handles.MainFigure1, 'WindowKeyPressFcn',   []);
            set(handles.MainFigure1, 'KeyPressFcn', @ShortCuts);            
            
            % Fix for Rendering figure -------------------------------
            hManager =    uigetmodemanager(handles.RenderingFigure); 
            [hManager.WindowListenerHandles.Enabled] =  deal(false);  
            set(handles.RenderingFigure, 'WindowKeyPressFcn',   []);
            set(handles.RenderingFigure, 'KeyPressFcn', @ShortCuts);
            
        catch
            warning('Warning: KeyPressWithRotate3DFix function is not working properly')
        end
    
        
        
% ------------------------------------------------------------------------------------------------------
function Create_3D_Rendering_Button_Callback(hObject, eventdata, handles)
    
                st1 = tic;
                                
                handles.CellList.Value = 1;
                handles.CellList.Enable = 'off';
                handles.CurrentlySelectedCell = 0;
                handles.ViewCellsNearSlice = 1;
                handles.UndoButtonRecordedVisActions = false(0,1);
                
                handles.ReverseXaxisCheck.Value = 0;
                handles.ReverseYaxisCheck.Value = 0;
                handles.ReverseZaxisCheck.Value = 0;
                
                set(handles.Create_3D_Rendering_Button,'Value',0)
                set(handles.VectorDisplay_Listbox,'Value',1,'Enable','off')
                set(handles.R1R2FilterButton,'Enable','off')
                set(handles.R2R3FilterButton,'Enable','off')
                set(handles.MBSD_MBCD_FilterButton,'Enable','off')
                set(handles.VolumeDiffFilterButton,'Enable','off')
                set(handles.MBSDFilterButton,'Enable','off')
                set(handles.DataFitTechnique_PullDown,'Value',1)
                set(handles.FaceCheck,'Value',1)
                set(handles.CellList,'ListboxTop',1)
                set(handles.ViewCellsNearSliceMenu,'Value',1)
                handles.IsoSurfaceHandles = cell(0,0);
                handles.IsoCapHandles = cell(0,0);
                handles.IsoSurfaceIdentifier = cell(0,0);
                handles.IsoCapIdentifier = cell(0,0);
                handles.IsoObjXYZ = [];
                handles.IsoCapXYZ = [];
                
                handles.CellIndices = [];
                handles.CellSizes   = [];
                handles.ObjVisible  = false(0,0);
                handles.ObjSelected = false(0,0);
                handles.ObjNearSliceView = true(0,0);
                handles.COM = [];
                
                handles.PartialCell = [];
                handles.V = [];
                handles.sX = [];
                handles.sY = [];
                handles.sZ = [];
                handles.CellData = [];
                handles.subDT = [];
                handles.VectorHandles = [];
                handles.VectorData = [];
            %----------------------------------------------------------------------------------
                handles.DataFitMethod = 'nofit';
                handles.ShowVectors = false;
                handles.ShowFace = true;
            %-----------------------------------------------------------------------------------
                [nY,nX,nZ] = size(handles.IMstack);
                dX = handles.PixelWidth; % Pixel width (microns)
                dY = dX;   
                dZ = handles.ZStep;      % Z depth (microns)
                x  = single(linspace(0, nX*dX, nX))';
                y  = single(linspace(0, nY*dY, nY))';
                z  = single(linspace(0, nZ*dZ, nZ))'; 
           % If Pop-Out Controller is open, close it -------------------------------------------     
                if isgraphics(handles.PopOutControllerHandle)
                    delete(handles.PopOutControllerHandle)
                end
           %---- Start progress-bar ------------------------------------------------------------  
                h1  = waitbar(0,''); 
                WBS = 10;
                loc = get(h1,'Position');
                set(h1,'Position',[30 60 loc(3) loc(4)])
                drawnow                                                                     
                                                              waitbar(1/WBS,h1,'(1/10) Segmenting Cells...')                                               
           % Create X,Y,Z coordinate system for all the pixels ---------------------------------
                [X,Y,Z] = meshgrid(x,y,z);  
                
           % Create Figure if it doesn't exist, or bring it to the front if it does ------------
                handles = CreateRenderingFigure(handles);
                
            %############################################################################################## 
                % This code fixes MATLAB's 'bug' that won't allow a figure's 
                % Key-Press Functions to work while in Rotate3d mode
                % http://undocumentedmatlab.com/blog/enabling-user-callbacks-during-zoom-pan 
                handles = KeyPressWithRotate3DFix(handles);
            
            % ##############################################################################################
            
            % Specify Sub_Region of Volume to be Rendered ---------------------------------------
                xr = uint16(handles.sPix(1,2):handles.ePix(1,2))';   % x index range
                yr = uint16(handles.sPix(1,1):handles.ePix(1,1))';   % y index range
                zr = uint16(handles.Z1:handles.Z2)';                 % z index range
                
                sX = X(yr,xr,zr); 
                sY = Y(yr,xr,zr); 
                sZ = Z(yr,xr,zr);
                
                handles.RenderedSubVolumeIndices = [yr(1), yr(end), xr(1), xr(end), zr(1), zr(end)];
                
                handles.sX = sX;
                handles.sY = sY;
                handles.sZ = sZ;                                                        
                handles.SubImStack =  handles.IMstack(yr,xr,zr);
                
                a = double([x(xr(1)), x(xr(end)), y(yr(1)), y(yr(end)), z(zr(1)), z(zr(end))]);
                handles.AxisRange = a;
                axis(handles.AxisHandle,a)
                
                set(handles.AxisHandle,'Color',handles.BackgroundColor,...
                                       'DataAspectRatio',[1 1 1],'LineWidth',1,...
                                       'CameraPositionMode','auto','CameraTargetMode','auto',...
                                       'CameraUpVectorMode','auto','BoxStyle','full',...
                                       'CameraViewAngleMode','manual',...
                                       'CameraViewAngle',handles.ViewAngle,...
                                       'XColor',handles.AxesColor,...
                                       'YColor',handles.AxesColor,...
                                       'ZColor',handles.AxesColor,...
                                       'GridColor',handles.GridColor,...
                                       'YDir','reverse',...
                                       'TickDir','both')

                camproj(handles.AxisHandle, handles.Projection)

                if handles.ShowFace 
                    FC = handles.FaceColor;    
                    FCC = 0.8.*handles.FaceColor;
                else
                    FC  = 'none';  FCC = 'none';
                end

                if handles.ShowMesh 
                    MC = handles.MeshColor;     
                    MCC = 0.8.*handles.MeshColor;
                else
                    MC  = 'none';  MCC = 'none';
                end
                
                % START - 3D Image Processing 
                DT1 = single(handles.DistanceTransform(yr,xr,zr));
                handles.subDT = DT1;                       waitbar(2/WBS,h1,'(2/10) Applying Min/Max Filter')  
                    %------------------------------------------------------      
                    % 3x3x3 voxel sliding 3D Minimum and Maximum Filter on 3D Distance Transform (DT): 
                    % Source: https://www.mathworks.com/matlabcentral/fileexchange/22044-ordfilt3 
                
                N = 3;
                DT2min = ordfilt3_modified(DT1, 1  , N, 'symmetric'); % 3x3x3 voxel sliding 3D Minimum Filter 
                DT2max = ordfilt3_modified(DT1, N^3, N, 'symmetric'); % 3x3x3 voxel sliding 3D Maximum Filter

                DT2 = (DT2min + DT2max)./2;                waitbar(3/WBS,h1,'(3/10) Applying Median Filter')
                DT3 = medfilt3(DT2,[3 3 3]); % 3x3x3 sliding 3D Median Filter on 3D DT                     

                                                           waitbar(4/WBS,h1,'(4/10) Finding ExtendedMins 1/4')
                M2  = imextendedmin(DT3,2);                waitbar(5/WBS,h1,'(5/10) Finding ExtendedMins 2/4')
                M3  = imextendedmin(DT3,3);                waitbar(6/WBS,h1,'(6/10) Finding ExtendedMins 3/4')
                M4  = imextendedmin(DT3,4);                waitbar(7/WBS,h1,'(7/10) Finding ExtendedMins 4/4')
                M5  = imextendedmin(DT3,5);  

                M = logical(M2 + M3 + M4 + M5);                    
                DT3(M)         = -Inf;
                DT3(DT3 < -15) = -Inf;  
                                                           waitbar(8/WBS,h1,'(8/10) Calculating Watershed')  
                WS = logical(watershed(DT3));                           
                % END - 3D Image Processing     
                
                
            % Count and Label all Objects --------------------------------------------
                    WS2 = bwareaopen(WS,handles.LowSizeFilter); % High Pass Filter Object sizes
            % Remove Edge Objects --------------------------------------------------------------------------- 
                    if ~handles.EdgeCellsCheck.Value            
                                                           waitbar(9/WBS,h1,'(9/10) Removing Edge Cells')  
                        WS2 = imclearborder(WS2,26);
                    end
            %-------------------------------------------------------------------------------------------------  
                                                           waitbar(10/WBS,h1,'(10/10) Labeling Binary Objects')  
                    [L ,nObjs] = bwlabeln(WS2,26);  % Label all objects with a unique number
                    L = single(L);             % Change from Double to Single precision to save memory space
                 %-------------------------------------------------------------------------
                    handles.V = L;
                    [iL,jL,kL] = size(L);               
                    A = true(iL,jL,kL); % Pre-allocate space
                 %-------------------------------------------------------------------------
                    % Some initializing for Rendering FOR loop
                    n = 0;
                    axis(handles.AxisHandle,a)
                    se2 = strel('sphere',1);
                    % nObjs = numel(ObjLabel); --------------------------------------------------------------
                    % Preallocate graphics object space
                    handles.IsoSurfaceHandles = mat2cell( gobjects(nObjs,1), ones(nObjs,1) ); 
                    handles.IsoCapHandles     = mat2cell( gobjects(nObjs,1), ones(nObjs,1) );
                    handles.ObjSelected = false(nObjs,1);
                    handles.ObjNearSliceView = true(nObjs,1);
                    % Waitbar initial conditions ------------------------------------------------------------
                    T = zeros(nObjs,1);
                    N = zeros(nObjs,1);
                    WBS = max([10, round(sqrt(nObjs))]);
            %--------------------------------------------------------------------------------
                    handles.COM = zeros(nObjs,3);
                    display(['Segmentation Time: ' num2str(toc(st1)) ' sec'])
                    st2 = tic;
            %--------------------------------------------------------------------------------
            for n = 1:nObjs
                    % Start creating IsoSurfaces for each individual object -----------------------------
                    A(A == 1) = 0;              % Use logical indexing to reset A to all zeros
                    %A(L == ObjLabel(n)) = 1;    % Grab current cell object to Sub-Binary Volume A.
                    A(L == n) = 1;    % Grab current cell object to Sub-Binary Volume A.
                    %------------------------------------------------------------------------------------
                    % Create Sub-subregion with just Object to improve processing speeds (mainly dilation)
                    k = find(A);
                    pad = 5;   % Use pad to make space for smoothing, also need some pad for rendering,
                               % otherwise cells all get selected as edge cells.
                    [I,J,K] = ind2sub([iL jL kL],k);
                    In = max([min(I)-pad  1]); % Imin
                    Ix = min([max(I)+pad iL]); % Imax
                    Jn = max([min(J)-pad  1]); % Jmin
                    Jx = min([max(J)+pad jL]); % Jmax
                    Kn = max([min(K)-pad  1]); % Kmin
                    Kx = min([max(K)+pad kL]); % Kmax
                    Xs =       sX(In:Ix,Jn:Jx,Kn:Kx);
                    Ys =       sY(In:Ix,Jn:Jx,Kn:Kx);
                    Zs =       sZ(In:Ix,Jn:Jx,Kn:Kx);
                    S  = double(A(In:Ix,Jn:Jx,Kn:Kx));
                    Vs = smooth3(S,'box',3);   % 3D smooth to create a gradient at the cell boundary
                                               % ISOSURFACE seems to need a gradient to work reliably
                    % Measure Object's Voxel Size ------------------------------------------------------------
                            m = find(S);
                            ObjSize = numel(m); % Object size in Voxels
                    % Measure/Record Object Size and Center of Mass ------------------------------------------
                            % RP = regionprops3(A,"PrincipalAxisLength"); Not using REGIONPROPS3 
                            % because my voxels are not necessarily square. 
                            % (using ellipsoid_fit functin combined with surface points obtained 
                            % from isosurface function.)
                            Xc = mean(Xs(m));     
                            Yc = mean(Ys(m));
                            Zc = mean(Zs(m));
                            handles.CellData{n,1}.CellIndex = n;
                            handles.CellData{n,1}.CellVolume = ObjSize * handles.VoxelSize; % microns^3   
                            % handles.VoxelSize = dZ.*dX^2;
                            handles.CellData{n,1}.CellCenterOfMass = [Xc Yc Zc]; % microns
                            % microns % This variable gets used in MULTI-CELL Selection
                            handles.COM(n,:) = [Xc Yc Zc]; 
                            % I thought it would be better to have COM as a non-cell arrayed variable.
                            % I was hoping it would speed up processing for several functions.
                    % Create IsoSurfaces and plot patch objects ----------------------------------------------
                            s1 = isosurface(Xs,Ys,Zs,Vs,0.5);
                            handles.IsoSurfaceHandles{n,1} = patch(handles.AxisHandle,reducepatch(s1,0.3)); 
                            set(handles.IsoSurfaceHandles{n,1},'FaceColor',FC,'EdgeColor',MC,...
                                                               'EdgeAlpha',handles.MeshTransparency/100,...
                                                               'FaceAlpha',handles.FaceTransparency/100,...
                                                               'FaceLighting','gouraud',...
                                                               'EdgeLighting','flat','LineWidth',1,...
                                                               'BackFaceLighting','unlit',...
                                                               'ButtonDownFcn',@PatchBDF,...
                                                               'AmbientStrength', 0.3 ,...
                                                               'DiffuseStrength', 0.3 ,...
                                                               'SpecularStrength', 1.0  ,...
                                                               'SpecularExponent', 25,...
                                                               'SpecularColorReflectance', 0.5 );
                    % Create IsoCaps and plot patch objects --------------------------------------------------
                            handles.IsoCapHandles{n,1} = patch(handles.AxisHandle,isocaps(Xs,Ys,Zs,Vs,0.3));
                            set(handles.IsoCapHandles{n,1},'FaceColor',FCC,'EdgeColor','none',...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                           'FaceLighting','gouraud','EdgeLighting','flat',...
                                                           'BackFaceLighting','unlit',...
                                                           'ButtonDownFcn',@PatchBDF,...
                                                           'AmbientStrength', 0.3 ,...
                                                           'DiffuseStrength', 0.3 ,...
                                                           'SpecularStrength', 1.0  ,...
                                                           'SpecularExponent', 25,...
                                                           'SpecularColorReflectance', 0.5 );                            

                    % Now Create a unique Object Identifier value so that 
                    %I can backtrack to which object was selected
                    % according to Index number 'n' in the PatchBDF function. This will allow me to delete the
                    % corresponding IsoCap and grab the X,Y,Z data. 
                    % (There's probably an easier way to do this but I haven't figured it out yet)

                            if isempty(handles.IsoSurfaceHandles{n,1}.XData)
                                handles.ObjVisible(n,1) = false;
                                 % Object Identifier is a 3x3 array of x,y,z, numbers
                                handles.IsoSurfaceIdentifier{n,1} = zeros(3,3,'double');
                                
                                           handles.IsoObjXYZ{n,1}.DataPts.X = [];
                                           handles.IsoObjXYZ{n,1}.DataPts.Y = [];
                                           handles.IsoObjXYZ{n,1}.DataPts.Z = [];
                            else
                                handles.ObjVisible(n,1) = true;
                                handles.IsoSurfaceIdentifier{n,1} = ...
                                                            [handles.IsoSurfaceHandles{n,1}.XData(:,1),...
                                                             handles.IsoSurfaceHandles{n,1}.YData(:,1),...
                                                             handles.IsoSurfaceHandles{n,1}.ZData(:,1)];   
                                                                 
                                   handles.IsoObjXYZ{n,1}.DataPts.X = handles.IsoSurfaceHandles{n,1}.XData;
                                   handles.IsoObjXYZ{n,1}.DataPts.Y = handles.IsoSurfaceHandles{n,1}.YData;
                                   handles.IsoObjXYZ{n,1}.DataPts.Z = handles.IsoSurfaceHandles{n,1}.ZData;
                            end
                            %---------------------------------------------------------------------------------
                            
                            if isempty(handles.IsoCapHandles{n,1}.XData)
                                % Is this a partial cell? (A cell close to the selection edge)
                                handles.PartialCell(n,1) = false; 
                                handles.IsoCapIdentifier{n,1} = zeros(3,3,'double');
                                
                                    handles.IsoCapXYZ{n,1}.DataPts.X = [];
                                    handles.IsoCapXYZ{n,1}.DataPts.Y = [];
                                    handles.IsoCapXYZ{n,1}.DataPts.Z = [];
                            else
                                handles.PartialCell(n,1) = true;
                                
                                    handles.IsoCapXYZ{n,1}.DataPts.X = handles.IsoCapHandles{n,1}.XData;
                                    handles.IsoCapXYZ{n,1}.DataPts.Y = handles.IsoCapHandles{n,1}.YData;
                                    handles.IsoCapXYZ{n,1}.DataPts.Z = handles.IsoCapHandles{n,1}.ZData;
                                    
                                handles.IsoCapIdentifier{n,1} =   [handles.IsoCapHandles{n,1}.XData(:,1),...
                                                                   handles.IsoCapHandles{n,1}.YData(:,1),...
                                                                   handles.IsoCapHandles{n,1}.ZData(:,1)];
                            end
                            %---------------------------------------------------------------------------------
                            [MinRadius,SC,~] = ...
                                        ExactMinBoundSphere3D([mean(handles.IsoObjXYZ{n,1}.DataPts.X)',...
                                                               mean(handles.IsoObjXYZ{n,1}.DataPts.Y)',...
                                                               mean(handles.IsoObjXYZ{n,1}.DataPts.Z)']); 
                                                               % Use this function to calculate cell size
                                                                  
                            handles.CellData{n,1}.MinBoundingSphereRadiusOfCell = MinRadius;
                            handles.CellData{n,1}.CenterOfMinBoundingSphere = SC;
                            %--------------------------------------------------------------------------------
                            if isequal(n,1)
                                daspect(handles.AxisHandle,[1,1,1])
                                view(handles.AxisHandle,130,25)
                                axis(handles.AxisHandle,a)
                                grid(handles.AxisHandle,'on')
                                grid(handles.AxisHandle,'minor')
                                if handles.ShowBox
                                    box(handles.AxisHandle,'on')
                                else
                                    box(handles.AxisHandle,'off')
                                end
                                %---------------------------------------
                                if handles.ShowAxes
                                    axis(handles.AxisHandle,'on')
                                else
                                    axis(handles.AxisHandle,'off')
                                end
                            end
                            %---------------------------------------
                            handles.CellIndices(n,1) = n;
                            handles.CellSizes(n,1)   = ObjSize;
                        % Waitbar Update =====================================================================  
                              LIM = 5;
                              if isequal(rem(n,WBS),0)
                                    t_now = toc(st2);  
                                    T(n,1) = t_now;
                                    N(n,1) = n;
                                    % ------------------------------------------------------------------
                                    if n <= LIM    
                                        Xt = N(1:n,1);       Yt = T(1:n,1);
                                    else
                                        Xt = N(n-LIM:n,1);   Yt = T(n-LIM:n,1);
                                    end
                                    % ------------------------------------------------------------------
                                    if numel(Xt) > 1
                                        p = polyfit(Xt,Yt,1);
                                        t_remains = (polyval(p, nObjs) - t_now);
                                        if t_remains > 60
                                            waitbar(n/nObjs,h1,['Creating 3D Rendering...',...
                                                sprintf('%4.1f', 100*n/nObjs),'%   ', sprintf('%4.2f',t_remains/60), ' min'])
                                        else
                                            waitbar(n/nObjs,h1,['Creating 3D Rendering...',...
                                                sprintf('%4.1f', 100*n/nObjs),'%   ', sprintf('%3.1f',t_remains), ' sec'])
                                        end
                                    end
                                    drawnow
                              end
                        % =================================================================================
            end
            
            display(['Rendering Time: ' num2str(toc(st2)) ' sec' ])
            handles.nObjs = n;
            
            hold(handles.AxisHandle,   'on')
                camlight(handles.AxisHandle,   30,  89)
                camlight(handles.AxisHandle,   30, -89)
                camlight(handles.AxisHandle,  100,  10)
                camlight(handles.AxisHandle, -100,  10)                     
            hold(handles.AxisHandle,   'off')
            
%             CL1 = camlight(handles.AxisHandle,-58, 9,'infinite');
%             CL2 = camlight(handles.AxisHandle,-24, 14,'infinite');
%             CL3 = camlight(handles.AxisHandle,231, 10,'infinite');
%            hold off
           % lighting(handles.AxisHandle,'gouraud')
            camproj(handles.AxisHandle,'perspective')  
            xlabel(handles.AxisHandle,'X (\mum)'); 
            ylabel(handles.AxisHandle,'Y (\mum)'); 
            zlabel(handles.AxisHandle,'Z (\mum)'); 
            %-------------------------------------------------------------------------------------------------
            % Update Cell List box
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            handles.CellList.KeyPressFcn = @ShortCuts;  %{@CellListKeyPressFcn,   handles};
            handles.CellList.Value = 1;
            handles.CurrentlySelectedCell = 1;
            handles.CellList.Enable = 'on';
            %===============================================================================================
            set(handles.X_Plane_Slider,'Min',a(1),'Max',a(2),'SliderStep',...
                [0.02/(a(2)-a(1)), 1/(a(2)-a(1))],'Value',a(1),'Enable','off')
            handles.XSliceValue = a(1);
            set(handles.XSliceDisplay,'String',sprintf('%5.5f',a(1)),'Enable','off')
            set(handles.XLow, 'String',sprintf('%5.2f',a(1)),'Enable','off')
            set(handles.XHigh,'String',sprintf('%5.2f',a(2)),'Enable','off')
            set(handles.XSliceCheck,'Value',0,'Enable','on')
                    
            set(handles.Y_Plane_Slider,'Min',a(3),'Max',a(4),'SliderStep',...
                [0.02/(a(4)-a(3)), 1/(a(4)-a(3))],'Value',a(3),'Enable','off')
            handles.YSliceValue = a(3);
            set(handles.YSliceDisplay,'String',sprintf('%5.2f',a(3)),'Enable','off')
            set(handles.YLow, 'String',sprintf('%5.2f',a(3)),'Enable','off')
            set(handles.YHigh,'String',sprintf('%5.2f',a(4)),'Enable','off')
            set(handles.YSliceCheck,'Value',0,'Enable','on')
                    
            set(handles.Z_Plane_Slider,'Min',a(5),'Max',a(6),'SliderStep',...
                [0.02/(a(6)-a(5)), 1/(a(6)-a(5))],'Value',a(5),'Enable','off')
            handles.ZSliceValue = a(5);
            set(handles.ZSliceDisplay,'String',sprintf('%5.1f',a(5)),'Enable','off')
            set(handles.ZLow, 'String',sprintf('%5.2f',a(5)),'Enable','off')
            set(handles.ZHigh,'String',sprintf('%5.2f',a(6)),'Enable','off')
            set(handles.ZSliceCheck,'Value',0,'Enable','on')
            
            set(handles.SliceTransparencySlider,'Enable','off')
            
            handles.DoXSlice = false;
            handles.DoYSlice = false;
            handles.DoZSlice = false;
            
            set(handles.FaceTransparencySlider, 'Enable','on')
            set(handles.FaceTransparencyDisplay,'Enable','on')
            set(handles.MeshTransparencySlider, 'Enable','on')
            set(handles.MeshTransparencyDisplay,'Enable','on')
            set(handles.HLTransparencySlider, 'Enable','on')
            set(handles.HLTransparencyDisplay,'Enable','on')
            set(handles.HLMeshTransparencySlider, 'Enable','on')
            set(handles.HLMeshTransparencyDisplay,'Enable','on')
            set(handles.ViewAngleSlider,'Enable','on')
            set(handles.ViewAngleDisplay,'Enable','on')
            set(handles.FaceCheck,'Enable','on')
            set(handles.FaceColorButton,'Enable','on')
            set(handles.MeshCheck,'Enable','on')
            set(handles.MeshColorButton,'Enable','on')
            set(handles.BackgroundColorButton,'Enable','on')
            set(handles.AxesColorButton,'Enable','on')
            set(handles.GridColorButton,'Enable','on')
            set(handles.CamProjButton,'String','Proj: Perspective','Value',0,'Enable','on');  
            set(handles.ColormapPulldown,'Enable','on')
            set(handles.SelectedCellAxis,'Visible','on','Color',get(handles.MainFigure1,'Color'))
            set(handles.ViewXZ_Button,'Enable','on')  
            set(handles.ViewYZ_Button,'Enable','on') 
            set(handles.ViewXY_Button,'Enable','on')  
            set(handles.ViewNegXZ_Button,'Enable','on')  
            set(handles.ViewNegYZ_Button,'Enable','on') 
            set(handles.ViewNegXY_Button,'Enable','on') 
            if n > 0    
                handles = Update_SingleCellAxis(handles,1);  
            end
            set(handles.DataFitTechnique_PullDown,'Enable','on','Visible','on');                        
            set(handles.SingleCellDisplayStyle_PullDown,'Enable','on')
            set(handles.HighlightColorButton,'Enable','on')  
            set(handles.ShowAxesCheck,'Enable','on')
            set(handles.ShowBoxCheck,'Enable','on')
            set(handles.HideHLedCellsButton,'Enable','on')
            set(handles.ReverseVisibleCellsButton,'Enable','on')
            set(handles.csvOutputButton,'Enable','on')
            set(handles.csvInputButton,'Enable','on')
            set(handles.HideEdgeCellsButton,'Enable','on')
            set(handles.HideAllButton,'Enable','on')
            set(handles.UnHLAll_Button,'Enable','on')
            set(handles.OnlyHLCellsVis_Button,'Enable','on')
            set(handles.ResetAllCellsButton,'Enable','on')
            set(handles.ApplySizeFilterButton,'Enable','on')
            set(handles.ShowColorbarCheck,'Enable','on')     
            set(handles.BackgroundColorButton,'Enable','on')  
            set(handles.SaveAnalysisButton,'Enable','on')
            set(handles.LoadAnalysisButton,'Enable','on')
            set(handles.ExportData_Button,'Enable','on')
            set(handles.Refresh3D_Button,'Enable','on')
            set(handles.SingleCellViewAngleSlider,'Enable','on')
            set(handles.SingleCellHLCheck,'Enable','on')
            set(handles.MBSDFilterButton,'Enable','on')
            
            set(handles.RecordIntersectionButton,'Enable','off')
            set(handles.CalculateConvergencePointButton,'Enable','off')
            set(handles.BuildUrchinPlotButton,'Enable','off')
            
            set(handles.ViewCellsNearSliceMenu,'Enable','on')
            set(handles.ViewCellsNearSliceRangeInput,'Enable','on')
            
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            %======================================================================================         
            guidata(hObject,handles)
            
            drawnow
            try close(h1); end            
           
%--------------------------------------------------------------------------------------------------
function handles = Update_Rendering(handles)
        
        % Create Figure if it doesn't exist, or bring it to the front if it does -----------
        %try delete(handles.RenderingFigure); catch; end    
       
        % Create Figure if it doesn't exist, or bring it to the front if it does -----------
        if isgraphics(handles.RenderingFigure); 
             rotate3d(handles.RenderingFigure,'off')

            %#################################################################################### 
            % This code fixes MATLAB's 'bug' that won't allow a figure's Key-Press 
            % Functions to work while in Rotate3d mode
            % http://undocumentedmatlab.com/blog/enabling-user-callbacks-during-zoom-pan    
                handles = KeyPressWithRotate3DFix(handles);
            %#################################################################################### 
                set(handles.RenderingFigure,'Color',handles.BackgroundColor)      
                set(handles.AxisHandle,'Color',     handles.BackgroundColor,...
                                       'XColor',    handles.AxesColor,...
                                       'YColor',    handles.AxesColor,...
                                       'ZColor',    handles.AxesColor,...
                                       'GridColor', handles.GridColor)
            %------------------------------------------------------------------------------------   
%                  CM = lines(7);%lines(30);
%                  Cindex = randi(7,handles.nObjs,1);
            %------------------------------------------------------------------------------------
            for n = 1:handles.nObjs
                if handles.ShowFace 
                    FC = handles.FaceColor; % CM(Cindex(n,1),:)
                    FCC = 0.8.*handles.FaceColor;
                else
                    FC = 'none'; 
                    FCC = 'none';
                end

                if handles.ShowMesh 
                    MC = handles.MeshColor; 
                    MCC = 0.8.*handles.MeshColor; % CM(Cindex(n,1),:);
                else
                    MC = 'none'; 
                    MCC = 'none';
                end

                if handles.ObjVisible(n,1) 
                    if ~handles.ObjSelected(n,1) || ~handles.ShowFace
                        set(handles.IsoSurfaceHandles{n,1},'FaceColor',FC,...
                                                           'EdgeColor',MCC,...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                           'EdgeAlpha',handles.MeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                            set(handles.IsoCapHandles{n,1},'FaceColor',FCC,...
                                                           'EdgeColor','none',...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                            'EdgeAlpha',handles.MeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                    else
                        set(handles.IsoSurfaceHandles{n,1},'FaceColor',handles.HighlightColor,...
                                                           'EdgeColor',0.5.*handles.HighlightColor,...
                                                           'FaceAlpha',handles.HLFaceTransparency/100,...
                                                           'EdgeAlpha',handles.HLMeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                            set(handles.IsoCapHandles{n,1},'FaceColor',handles.HighlightColor,...
                                                           'EdgeColor','none',...
                                                           'FaceAlpha',handles.HLFaceTransparency/100,...
                                                           'EdgeAlpha',handles.HLMeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                    end
                else
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                    set(handles.IsoCapHandles{n,1},    'Visible','off')
                end
            end
            
        end
              
%------------------------------------------------------------------------------------------------------               
function [XL,YL,ZL] = UnitVec2Line(xi,yj,zk,cx,cy,cz,L)

    %   xi = x coordinate of unit vector
    %   yi = y coordinate of unit vector
    %   zi = z coordinate of unit vector
    %
    %   cx = x coordinate of line center point
    %   cy = y coordinate of line center point
    %   cz = z coordinate of line center point
    %   L = Half length of line
    
    M = linspace(-L,L,3);
    
    xv = xi*M; % X component
    yv = yj*M; % Y Component
    zv = zk*M; % Z Component
    
    XL = cx + xv;
    YL = cy + yv;
    ZL = cz + zv;
        
%------------------------------------------------------------------------------------------------------                
 function handles = Update_SingleCellAxis(handles,index)      
       
        if ~isempty(index) && ~isequal(index,0)
         
            cla(handles.SelectedCellAxis)
            
                       X = mean(handles.IsoSurfaceHandles{index,:}.XData)';
                       Y = mean(handles.IsoSurfaceHandles{index,:}.YData)';
                       Z = mean(handles.IsoSurfaceHandles{index,:}.ZData)';   
                       nVal = numel(X); 
                       COM = double(handles.CellData{index}.CellCenterOfMass);

                       Xmin = min(X); Xmax = max(X);
                       Ymin = min(Y); Ymax = max(Y);
                       Zmin = min(Z); Zmax = max(Z);
                       
                       if isfield(handles.CellData{index,1},'MinBoundingSphereRadiusOfCell');
                            MinDiameter = 2*handles.CellData{index,1}.MinBoundingSphereRadiusOfCell;
                            SC = handles.CellData{index,1}.CenterOfMinBoundingSphere;
                       else
                            MinDiameter = 0;
                            SC = 0;
                       end 
                       
                       switch handles.SingleCellDisplayStyle
                           case 'nodata'
                                
                           case 'datasurface' % Create Cell Surface
                                % Create IsoSurface
                                FS = handles.IsoSurfaceHandles{index,1}.Faces;
                                VS = handles.IsoSurfaceHandles{index,1}.Vertices;
                                    
                                VSorigin = [VS(:,1)-Xmin, VS(:,2)-Ymin, VS(:,3)-Zmin];
                                % For use with calulcated cross sectional Min 
                                % Bounding Circle through center of ellipsoid
                                        CellSurface.faces = FS; 
                                        CellSurface.vertices = VSorigin;
                                %----------------------------------------------------------------------------
                                patch(handles.SelectedCellAxis,'Faces',FS,'Vertices',VSorigin,...
                                                   'FaceColor',handles.FaceColor,...
                                                   'EdgeColor',handles.MeshColor,...
                                                   'FaceAlpha',handles.FaceTransparency/100,...
                                                   'EdgeAlpha',handles.MeshTransparency/100,...
                                                   'Visible','on')
                                % Create IsoCap
                                FC = handles.IsoCapHandles{index}.Faces;
                                VC = handles.IsoCapHandles{index}.Vertices;    
                                VCorigin = [VC(:,1)-Xmin, VC(:,2)-Ymin, VC(:,3)-Zmin];
                                patch(handles.SelectedCellAxis,'Faces',FC,'Vertices',VCorigin,...
                                    'FaceColor',0.8*handles.FaceColor,...
                                                               'EdgeColor','none',...
                                                               'FaceAlpha',handles.FaceTransparency/100,...
                                                               'EdgeAlpha',handles.MeshTransparency/100,...
                                                               'Visible','on')
                                
                                % Plot center of mass point --------------------------------------------------                           
                                hold(handles.SelectedCellAxis,'on')
                                    plot3(handles.SelectedCellAxis, COM(1)-Xmin, ...
                                        COM(2)-Ymin, COM(3)-Zmin,'.','MarkerSize',20,'Color','r')  
                                hold(handles.SelectedCellAxis,'off')                           

                           case 'datapoints' 
                                FS = handles.IsoSurfaceHandles{index,1}.Faces;
                                VS = handles.IsoSurfaceHandles{index,1}.Vertices;
                                    
                                VSorigin = [VS(:,1)-Xmin, VS(:,2)-Ymin, VS(:,3)-Zmin];
                                % For use with calulcated cross sectional Min 
                                % Bounding Circle through center of ellipsoid
                                        CellSurface.faces = FS; 
                                        CellSurface.vertices = VSorigin;
                                % Plot center of mass point --------------------------------------------------
                                hold(handles.SelectedCellAxis,'on')
                                    plot3(handles.SelectedCellAxis, X-Xmin, Y-Ymin, Z-Zmin,'.',...
                                        'MarkerSize',4,'Color',[0 0 0])
                                    plot3(handles.SelectedCellAxis, COM(1)-Xmin,...
                                        COM(2)-Ymin, COM(3)-Zmin,'.','MarkerSize',20,'Color','r')  
                                hold(handles.SelectedCellAxis,'off')
                       end
                       
                        

                     switch handles.DataFitMethod
                         case 'ellipsoidfit'
                            % Calculate Ellipsoid Equation Fit ----------------
                                [c, r, ev, v, chi2] = ellipsoid_fit([X Y Z], '' );
                            % Draw fit ----------------------------------------
                                mind = min( [ X Y Z ] );
                                maxd = max( [ X Y Z ] );
                                nsteps = 50;
                                step = ( maxd - mind ) / nsteps;
                                [Xm,Ym,Zm] = meshgrid( linspace( mind(1) - 20*step(1),...
                                                       maxd(1) + 20*step(1), nsteps ),...
                                                       linspace( mind(2) - 20*step(2),...
                                                       maxd(2) + 20*step(2), nsteps ),...
                                                       linspace( mind(3) - 20*step(3),...
                                                       maxd(3) + 20*step(3), nsteps ) );
                                %  v = the 10 parameters describing the ellipsoid/conic algebraically: 
                                %  Ax^2 + By^2 + Cz^2 + 2Dxy + 2Exz + 2Fyz + 2Gx + 2Hy + 2Iz + J = 0  
                                Ellipsoid = v(1) *Xm.*Xm +   v(2)*Ym.*Ym +   v(3) * Zm.*Zm + ...
                                          2*v(4) *Xm.*Ym + 2*v(5)*Xm.*Zm + 2*v(6) * Ym.*Zm + ...
                                          2*v(7) *Xm     + 2*v(8)*Ym     + 2*v(9) * Zm;
                                      
                                hold(handles.SelectedCellAxis,'on')
                                    p = patch(handles.SelectedCellAxis, ...
                                        isosurface( Xm-Xmin, Ym-Ymin, Zm-Zmin, Ellipsoid, -v(10) ) );
                                hold(handles.SelectedCellAxis,'off')
                                
                                set(p,'FaceColor',[1 0 0],'EdgeColor',[0.3 0 0],'FaceAlpha',0.1,'EdgeAlpha',0.2 );

                                axmin = min([min(mean(p.XData)) min(X)]);
                                axmax = max([max(mean(p.XData)) max(X)]);
                                aymin = min([min(mean(p.YData)) min(Y)]);
                                aymax = max([max(mean(p.YData)) max(Y)]);
                                azmin = min([min(mean(p.ZData)) min(Z)]);
                                azmax = max([max(mean(p.ZData)) max(Z)]);
                                xpad = 0.1*(axmax-axmin);
                                ypad = 0.1*(aymax-aymin);
                                zpad = 0.1*(azmax-azmin);

%           axis(handles.SelectedCellAxis,[axmin - xpad - Xmin, axmax + xpad - Xmin, aymin - ypad - Ymin,...
%                                             aymax + ypad - Ymin, azmin - zpad - Zmin, azmax + zpad - Zmin])

                                [XL1,YL1,ZL1] = UnitVec2Line(ev(1,1),ev(2,1),ev(3,1),c(1),c(2),c(3),r(1)); 
                                [XL2,YL2,ZL2] = UnitVec2Line(ev(1,2),ev(2,2),ev(3,2),c(1),c(2),c(3),r(2));
                                [XL3,YL3,ZL3] = UnitVec2Line(ev(1,3),ev(2,3),ev(3,3),c(1),c(2),c(3),r(3));
                                
                                hold(handles.SelectedCellAxis,'on')
                                    plot3(handles.SelectedCellAxis, XL1-Xmin,YL1-Ymin,ZL1-Zmin, '-',...
                                        'LineWidth', 3, 'Color', [0   0   0.7]) % Plot Major Axis Line
                                    plot3(handles.SelectedCellAxis, XL2-Xmin,YL2-Ymin,ZL2-Zmin, '-',...
                                        'LineWidth', 2, 'Color', [0.7 0   0  ]) % 
                                    plot3(handles.SelectedCellAxis, XL3-Xmin,YL3-Ymin,ZL3-Zmin, '-',...
                                        'LineWidth', 2, 'Color', [0   0.5 0  ])
                                hold(handles.SelectedCellAxis,'off')
                                
                                % Calculate Minimum Bounding Circle on a plane perpendicular
                                % to R1 and intersecting Ellipsoid Center
                                    
                                    % C  = [c(1,1)-Xmin, c(2,1)-Ymin, c(3,1)-Zmin]; %  Center of Ellipsoid
                                    C  = [COM(1,1)-Xmin, COM(1,2)-Ymin, COM(1,3)-Zmin]; % Center of Cell
                                    R1 = [ev(1,1), ev(2,1), ev(3,1)];
                                    R2 = [ev(1,2), ev(2,2), ev(3,2)];
                                    R3 = [ev(1,3), ev(2,3), ev(3,3)];
                                    rmag = sqrt(r(2)^2 + r(3)^2);
                                    MBCD = CalculateMBCDIntersectingPlane(handles.SelectedCellAxis,...
                                                                          CellSurface, C, R1, R2, R3, rmag);   
                                                            
                                % ----------------------------------------------------------------------------
                                CellSize = handles.VoxelSize * handles.CellSizes(index,1);
                               
                                text1 = ['Cell: ', sprintf('%4.0d',index),  '      CellVolume: ', ...
                                                   sprintf('%#.6g',CellSize), ' ', ...
                                                   texlabel('mu'), 'm', texlabel('^3')];    
                                              
                                test1b = ['Center of Mass:   < ', sprintf('%#.5g',COM(1)), ', ',...
                                                                  sprintf('%#.5g',COM(2)), ', ',...
                                                                  sprintf('%#.5g',COM(3)), ' >'];
                                                             
                                test1c = ['Min Bounding Sphere Diam (MBSD): ',...
                                           sprintf('%#.5g',MinDiameter), ' ', texlabel('mu'), 'm'];
                                                             
                                text2  = ['Ellipsoid Center: < ', sprintf('%#.5g',c(1,1)),  ', ', ...
                                                                  sprintf('%#.5g',c(2,1)),  ', ',...
                                                                  sprintf('%#.5g',c(3,1)), ' >'];
                                                  
                                text3 = ['uVec1: [ ', sprintf('%+4.3f',ev(1,1)), '  ', ...
                                                      sprintf('%+4.3f',ev(2,1)), '  ', ...
                                                      sprintf('%+4.3f',ev(3,1)), ' ]  r1: ', ...
                                                      sprintf('%#.4g',r(1))];
                                                  
                                text4 = ['uVec2: [ ', sprintf('%+4.3f',ev(1,2)), '  ', ...
                                                      sprintf('%+4.3f',ev(2,2)), '  ', ...
                                                      sprintf('%+4.3f',ev(3,2)), ' ]  r2: ', ...
                                                      sprintf('%#.4g',r(2))];  
                                                  
                                text5 = ['uVec3: [ ', sprintf('%+4.3f',ev(1,3)), '  ', ...
                                                      sprintf('%+4.3f',ev(2,3)), '  ', ...
                                                       sprintf('%+4.3f',ev(3,3)), ' ]  r3: ', ...
                                                      sprintf('%#.4g',r(3))]; 
                                                  
                                EV = (4/3)*pi*r(1)*r(2)*r(3);
                                
                                text6  = ['r1/r2: ',        sprintf('%#.4g',r(1)./r(2)),...
                                          '  r2/r3: ',      sprintf('%#.4g',r(2)./r(3)),...
                                          '  EllipVol: ',   sprintf('%#.5g',EV)];
                                      
                                text6b = ['MBCD(' texlabel('mu') 'm): ' sprintf('%#.3g',MBCD), ' ',...
                                                 texlabel('mu'), 'm',...
                                          '         MBSD/MBCD: ' sprintf('%#.3g',MinDiameter/MBCD) ];     
                                
                                text7 = ['AveFitDev(AFD): ',     sprintf('%1.3f',sqrt(chi2./nVal)),...
                                         '  VolPerDiff(PVD): ',  ...
                                         sprintf('%#.3g',abs(100*(CellSize-EV)/CellSize))];
                                
                         case 'nofit'
                             %Draw Minimum Bounding Sphere ------------------------------------------------  
                             if ~isequal(MinDiameter,0)
                                [SX,SY,SZ] = sphere(40);
                                    SX = (MinDiameter/2).*SX + SC(1) - Xmin;
                                    SY = (MinDiameter/2).*SY + SC(2) - Ymin;
                                    SZ = (MinDiameter/2).*SZ + SC(3) - Zmin;
                                hold(handles.SelectedCellAxis,'on')
                                    S = surf(handles.SelectedCellAxis,SX,SY,SZ);
                                    S.FaceAlpha = 0.05;
                                    S.FaceColor = [0,0,1];
                                    S.EdgeAlpha = 0.1;
                                    S.EdgeColor = 'none';
                                hold(handles.SelectedCellAxis,'off')
                             end
                             %-----------------------------------------------------------------------------  
                            CellSize = handles.VoxelSize * handles.CellSizes(index,1);
                            COM = handles.CellData{index}.CellCenterOfMass;
                            
                            text1 = ['Cell: ', sprintf('%4.0d',index),  '      CellVolume: ',...
                                      sprintf('%#.6g',CellSize), ' ', texlabel('mu'), 'm', texlabel('^3')];   
                                  
                            test1b = ['Center of Mass:   < ', sprintf('%#.5g',COM(1)), ', ',...
                                                              sprintf('%#.5g',COM(2)), ', ',...
                                                              sprintf('%#.5g',COM(3)), ' >'];
                                                         
                            test1c = ['Min Bounding Sphere Diam (MBSD): ',...
                                     sprintf('%#.3g',MinDiameter), ' ', texlabel('mu'), 'm'];
                            
                            text2  = 'Ellipsoid Center: ';
                            text3  = 'uVec1: ';
                            text4  = 'uVec2: ';
                            text5  = 'uVec3: '; 
                            text6  = 'r1/r2: ';
                            text6b = [ 'MBCD(', texlabel('mu'), 'm): ' ]; 
                            text7  = 'AveFitDev(AFD): ';
                     end
                    
                    set(handles.SelectedCellAxis,'Color',handles.MainFigure1.Color,...
                                       'FontSize',8,...
                                       'DataAspectRatio',[1 1 1],...
                                       'CameraPositionMode','auto','CameraTargetMode','auto',...
                                       'CameraUpVectorMode','auto','BoxStyle','full',...
                                       'CameraViewAngleMode','manual',...
                                       'CameraViewAngle',handles.SingleCellViewAngle,...
                                       'XColor',[0 0 0],...
                                       'YColor',[0 0 0],...
                                       'ZColor',[0 0 0],...
                                       'GridColor',[0 0 0])
                                   
                    rotate3d(handles.SelectedCellAxis,'on')  
                    
                    %######################################################################################  
                    % This code fixes MATLAB 'bug' that won't allow a figure's 
                    % Key-Press Functions to work while in Rotate3d mode
                    % http://undocumentedmatlab.com/blog/enabling-user-callbacks-during-zoom-pan       
                        handles = KeyPressWithRotate3DFix(handles);
                    % ######################################################################################  
                    
                    daspect(handles.SelectedCellAxis,[1,1,1])
                    view(handles.SelectedCellAxis,3)
%                     camlight(handles.SelectedCellAxis,'left');
%                     camlight(handles.SelectedCellAxis,'right')
                    camlight(handles.SelectedCellAxis,   30,  89)
                    camlight(handles.SelectedCellAxis,   30, -89)
                    camlight(handles.SelectedCellAxis,  100,  10)
                    camlight(handles.SelectedCellAxis, -100,  10) 

                    %lighting(handles.SelectedCellAxis,'gouraud')
                    camproj(handles.SelectedCellAxis,'perspective')
                    box(handles.SelectedCellAxis,'off')
                    grid(handles.SelectedCellAxis,'on')
                    axis(handles.SelectedCellAxis,'tight')       
                    xlabel(handles.SelectedCellAxis,'X (\mum)'); 
                    ylabel(handles.SelectedCellAxis,'Y (\mum)'); 
                    zlabel(handles.SelectedCellAxis,'Z (\mum)'); 
                    
                 %----------------------------------------------------------------------------------------- 
                    %set(0,'CurrentFigure',handles.MainFigure1)
                    %set(handles.MainFigure1,'CurrentAxes',handles.CellSpecsDisplayAxis)
                    set(handles.CellSpecsDisplayAxis,'Visible','off')
                    cla(handles.CellSpecsDisplayAxis)
                    axis(handles.CellSpecsDisplayAxis,[0 1 0 1])

                    handles.CellText3 = text(handles.CellSpecsDisplayAxis,0.07,0.85,{text1,test1b,test1c},...
                        'FontName','Monospaced','FontWeight','bold','FontSize',8.5,...
                        'Color',[0 0 0],  'Interpreter','tex');

                    handles.CellText = text(handles.CellSpecsDisplayAxis,0.07,-0.08,...
                        {text2,text3,text4,text5,text6,text6b,text7},...
                        'FontName','Monospaced','FontWeight','bold','FontSize',8.5,...
                        'Color',[0 0 0.8],'Interpreter','tex');

                    if handles.PartialCell(index,1)
                        text4 = 'Partial';
                        tc1 = [0.5 0 0];
                    else
                        text4 = 'Complete ';
                        tc1 = [0 0.5 0];
                    end

                    if handles.ObjVisible(index,1)
                        text5 = 'Visible';
                        tc2 = [0 0.5 0];
                    else
                        text5 = 'Hidden';
                        tc2 = [0.5 0 0];
                    end

                    handles.CellText2 = text(handles.CellSpecsDisplayAxis,0.28,-0.9,text4,...
                                        'FontName','Ariel','FontWeight','bold','FontSize',11,'Color',tc1);
                    handles.CellText3 = text(handles.CellSpecsDisplayAxis,0.50,-0.9,text5,...
                                        'FontName','Ariel','FontWeight','bold','FontSize',11,'Color',tc2);                     

        end   
        
%------------------------------------------------------------------------------------------------------    
function [MBCD] = CalculateMBCDIntersectingPlane(Axis,CellSurface,C,R1,R2,R3,r);    
    
        try   
            % Create Plane in an octagon shape ----------
            Rot2 = RotationMatrix3D([0,0,1], R1);
            [Xplane,Yplane,~] = cylinder(1.4*r,8);
            Zplane = zeros(size(Xplane));

            M3 = Rot2*[ [Xplane(1,:)] ;...
                        [Yplane(1,:)] ;...
                        [Zplane(1,:)]   ];

            x = M3(1,:)' + C(1,1);
            y = M3(2,:)' + C(1,2);
            z = M3(3,:)' + C(1,3);
            
            %Plane = patch(Axis,'XData',x,'YData',y,'ZData',z,'FaceColor',[0 0 1],'FaceAlpha',0.1);  
            %--------------------------------------------
            %T = [[1,10,2,1];[2,10,3,2];[3,10,4,3];[4,10,5,4];[5,10,6,5];[6,10,7,6];[7,10,8,7];[8,10,9,8]];
            DTP = delaunayTriangulation(x,y,z); % Create Surface Triangulation for Plane
            [Surface1.faces, Surface1.vertices] = freeBoundary(DTP);  
            [~, iS1] = SurfaceIntersection(Surface1, CellSurface); %CellSurface);

            Rot1 = RotationMatrix3D(R1,[0,0,1]);
            % Rotate Intersection Points to XY plane so that MinBoundingCircle can be fit
            M1 = Rot1*[ iS1.vertices(:,1)'-C(1,1) ;...
                        iS1.vertices(:,2)'-C(1,2) ;...
                        iS1.vertices(:,3)'-C(1,3)   ];

            [radius,CircleCenter,Xb] = ExactMinBoundCircle([ M1(1,:)', M1(2,:)' ]); 
            MBCD = 2*radius;
            % Create Circle with diameter same as MBCD ------------------------
            [Xcircle, Ycircle, ~] = cylinder(radius,100);

            Xcircle = Xcircle(1,:) + CircleCenter(1,1);
            Ycircle = Ycircle(1,:) + CircleCenter(1,2);
            Zcircle = zeros(size(Ycircle));

            M2 = Rot2*[ Xcircle ;...
                        Ycircle ;...
                        Zcircle   ];

            MBCxyz = [M2(1,:)' + C(1,1), M2(2,:)' + C(1,2), M2(3,:)'+C(1,3)];   
            if ~isa(Axis,'double')
                hold(Axis,'on')
                    Plane = patch(Axis,'XData',x,'YData',y,'ZData',z,'FaceColor',[1 0 1],'FaceAlpha',0.1);  
                    CS = patch(Axis,'Faces', iS1.faces, 'Vertices', iS1.vertices,...
                        'EdgeColor',[0 1 1], 'LineWidth', 2.0);
                    plot3(Axis, MBCxyz(:,1), MBCxyz(:,2), MBCxyz(:,3),'-k','LineWidth',2)
                hold(Axis,'off')
            end
            
        catch
            MBCD = 0;
            %disp('Error Calculating MBCD')
        end    
        
%------------------------------------------------------------------------------------------------------            
    function handles = Update_Vectors(handles)      
        
                if handles.ShowVectors
                    Vis = find(handles.ObjVisible);
                    for k = 1:length(Vis)
                            set(handles.VectorHandles{k,1},...
                               'FaceColor',handles.VectorColor,...
                               'EdgeColor','none',...
                               'EdgeAlpha',1,...
                               'FaceAlpha',1,...
                               'FaceLighting','flat',...
                               'EdgeLighting','flat',...
                               'BackFaceLighting','lit','Visible','on')
                    end
                end
        
%------------------------------------------------------------------------------------------------------                            
function handles = Add_Vectors_To_Main_Figure(handles)
        
    
        % TEMP CODE ------------------------------------------------------------------------------------
%             nVec = size(handles.VectorData,1);
%             CellVec = zeros(nVec,3); 
%             CellCOM = zeros(nVec,3); 
% 
%             for n = 1:nVec  
%                 CellVec(n,:) = handles.VectorData{n,1}.EigenVectors(:,1)';
%                 CellIndex    = handles.VectorData{n,1}.CellIndex;
%                 CellCOM(n,:) = handles.CellData{CellIndex,1}.CellCenterOfMass;
%             end
%            
%             [p,u,q,v] = CreateAllLineCombinations(CellCOM, CellVec);
%             CCMP = ClosestConvergenceMidPoints(p,u,q,v); % Calculate midpoints of closest convergence for all vectors combinations
%             ConvergencePoint = mean(CCMP,1); 
%             ColorMap = jet(9);
        %-------------------------------------------------------------------------------------------------
        
        Vis = find(handles.ObjVisible);
        handles.VectorData = [];
        switch handles.ShowVectors
            case true
                    % Fit ellipsoid to data and render vectors for each cell-------------------------------
                    for k = 1:length(Vis)
                        index = Vis(k);
                        set(0,'CurrentFigure',handles.RenderingFigure)
                        set(handles.RenderingFigure,'CurrentAxes',handles.AxisHandle)

                        X = mean(handles.IsoObjXYZ{index}.DataPts.X)';
                        Y = mean(handles.IsoObjXYZ{index}.DataPts.Y)';
                        Z = mean(handles.IsoObjXYZ{index}.DataPts.Z)';   
                        % Center of Data Points (center of mass of cell)
                        CM = handles.CellData{index,1}.CellCenterOfMass;   

                        [c, r, ev, v, chi2] = ellipsoid_fit([X,Y,Z],'');   % Calculate Ellpispod Fit
                        handles.VectorData{k,1}.CellIndex = index; 
                        handles.VectorData{k,1}.EllipsoidCenter = c;
                        handles.VectorData{k,1}.EllipsoidVolume = (4/3)*pi*r(1)*r(2)*r(3);
                        handles.VectorData{k,1}.EigenVectors = ev;
                        handles.VectorData{k,1}.Radius = r;
                        handles.VectorData{k,1}.EllipsoidEquationParam = v; % Ax^2 + By^2 + Cz^2 + 2Dxy + 2Exz + 2Fyz + 2Gx + 2Hy + 2Iz + J = 0
                        handles.VectorData{k,1}.chi2 = chi2;
                        handles.VectorData{k,1}.NormChi2 = chi2./numel(X);
                        handles.VectorData{k,1}.XYZDataCentroid = CM;
                        handles.VectorData{k,1}.CellDataVolume = handles.CellData{index,1}.CellVolume;
                        handles.VectorData{k,1}.MBSD = 2*handles.CellData{index,1}.MinBoundingSphereRadiusOfCell;
                        handles.VectorData{k,1}.MBSC = handles.CellData{index,1}.CenterOfMinBoundingSphere;
                    end
                    
                    % TEMP CODE: Calculate MBCD and grab MBSD ===================================================================
%                         nVec = size(handles.VectorData,1);
%                         CellVec = zeros(nVec,3); 
%                         CellCOM = zeros(nVec,3); 
% 
%                         for n = 1:nVec  
%                             CellVec(n,:) = handles.VectorData{n,1}.EigenVectors(:,1)';
%                             CellIndex    = handles.VectorData{n,1}.CellIndex;
%                             CellCOM(n,:) = handles.CellData{CellIndex,1}.CellCenterOfMass;
%                         end
%           
%                         [p,u,q,v] = CreateAllLineCombinations(CellCOM, CellVec);
%                         CCMP = ClosestConvergenceMidPoints(p,u,q,v); % Calculate midpoints of closest convergence for all vectors combinations
%                         ConvergencePoint = mean(CCMP,1); %    
%                     
%                         [MBSD, MBCD] = Calculate_MBSD_MBCD(handles); % Ellipsoid fit and Vectors must be turned on
%                         MBSD_MBCD_ratio = MBSD./MBCD;
                    %=================================================================================================                  
                    
                    
                    for k = 1:length(Vis)
                        % Create 3D Cylindrical Surfaces -----------------------------------------------------
                            [x,y,z] = cylinder(handles.VectorRadius,15);
                        % Turn Cylinder into Cone - if option is selected ------------------------------------
                            if isequal(3,handles.VectorType)
                                [~,nC] = size(x);
                                x(1,:) = zeros(1,nC);
                                y(1,:) = zeros(1,nC);
                            elseif isequal(4,handles.VectorType) % Reverse Cone
                                [~,nC] = size(x);
                                x(2,:) = zeros(1,nC);
                                y(2,:) = zeros(1,nC);
                            end
                        % -----------------------------------------------------------------------------------
                        L  = handles.VectorLength;
                        
                        z  = L*(z - 0.5); % Create Unit-Length Origin-Centered Cylinder ---------------------
                        
                        % TEMP CODE -------------------------------------------------------------------------
                            %z = L*(MBSD_MBCD_ratio(k,1)-0.99).*(z-0.5); 
                        %-------------------------------------------------------------------------------------    
                        
                            ev = handles.VectorData{k,1}.EigenVectors;
                        % Calculate Rotation Matrix (change ev vector to render other axes)
                        R  = RotationMatrix3D([0 0 1], ev(:,1)'); 
                        M1 = [x(1,:); y(1,:); z(1,:)]; 
                        M2 = [x(2,:); y(2,:); z(2,:)];
                        R1 = R*M1; % Rotate 
                        R2 = R*M2;
                        XR = [R1(1,:); R2(1,:)];
                        YR = [R1(2,:); R2(2,:)];
                        ZR = [R1(3,:); R2(3,:)];
                        %-----Render longaxis vector objects (cylinder, cones...)
                        % at center of mass location of each cell
                        
                        % TEMP CODE ----------------------------------------------------------------
%                             VecAngle = CalculateOrientationAngle( ConvergencePoint,...
%                                                               handles.VectorData{k,1}.XYZDataCentroid,...
%                                                               ev(:,1)' );  
%                             Color = AssignColorBasedOnAngle(ColorMap, VecAngle);
                        % END TEMP CODE ------------------------------------------------------------
                        
                            CM = handles.VectorData{k,1}.XYZDataCentroid;    
                            hold(handles.AxisHandle,'on')
                                handles.VectorHandles{k,1} = ...
                                    patch(surf2patch( XR+CM(1,1), YR+CM(1,2), ZR+CM(1,3) ));
                                set(handles.VectorHandles{k,1},...
                                       'FaceColor',handles.VectorColor,... %Color
                                       'EdgeColor','none',...
                                       'EdgeAlpha',1,...
                                       'FaceAlpha',1,...
                                       'FaceLighting','flat',...
                                       'EdgeLighting','flat',...
                                       'BackFaceLighting','lit','Visible','on')
                            hold(handles.AxisHandle,'off')
                        %------------------------------------------------------------------------------------  
                    end
                
            case false
                set(0,'CurrentFigure',handles.RenderingFigure)
                set(handles.RenderingFigure,'CurrentAxes',handles.AxisHandle)
                N = length(handles.VectorHandles);
                for n = 1:N
                    if isgraphics(handles.VectorHandles{n,1})
                        delete(handles.VectorHandles{n,1})
                    end
                end
                handles.VectorHandles = [];
        end
        
%------------------------------------------------------------------------------------------------------                       
function handles = Update_Single_Cell(handles,n)
                
            %figure(handles.RenderingFigure)
            set(handles.RenderingFigure,'Color',handles.BackgroundColor)      
            set(handles.AxisHandle,'Color',handles.BackgroundColor,...
                                   'XColor',handles.AxesColor,...
                                   'YColor',handles.AxesColor,...
                                   'ZColor',handles.AxesColor,...
                                   'GridColor',handles.GridColor)
                    
            if handles.ShowFace 
                FC = handles.FaceColor; 
                FCC = 0.8.*handles.FaceColor;
            else
                FC = 'none'; 
                FCC = 'none';
            end

            if handles.ShowMesh 
                MC = handles.MeshColor; 
                MCC = 0.8.*handles.MeshColor;
            else
                MC = 'none'; 
                MCC = 'none';
            end
            
            if handles.ObjVisible(n,1)
                    if ~handles.ObjSelected(n,1)
                        set(handles.IsoSurfaceHandles{n,1},'FaceColor',FC,...
                                                           'EdgeColor',MCC,...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                           'EdgeAlpha',handles.MeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)

                            set(handles.IsoCapHandles{n,1},'FaceColor',FCC,...
                                                           'EdgeColor','none',...
                                                           'FaceAlpha',handles.FaceTransparency/100,...
                                                           'EdgeAlpha',handles.MeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                    else
                        set(handles.IsoSurfaceHandles{n,1},'FaceColor',handles.HighlightColor,...
                                                           'EdgeColor',0.5.*handles.HighlightColor,...
                                                           'FaceAlpha',handles.HLFaceTransparency/100,...
                                                           'EdgeAlpha',handles.HLMeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)

                            set(handles.IsoCapHandles{n,1},'FaceColor',handles.HighlightColor,...
                                                           'EdgeColor','none',...
                                                           'FaceAlpha',handles.HLFaceTransparency/100,...
                                                           'EdgeAlpha',handles.HLMeshTransparency/100,...
                                                           'Visible','on',...
                                                           'ButtonDownFcn',@PatchBDF)
                    end
            else
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                    set(handles.IsoCapHandles{n,1},'Visible','off')
            end
            drawnow
%------------------------------------------------------------------------------------------------------               
function BlankFunction(src,evnt)
    
    
    
%------------------------------------------------------------------------------------------------------        
%function CellListButtonDownFcn(src,evnt)
            
%             global LongAxis_MainHandle  
%            
%             if ~isequal(12345,get(gcf,'Number'))
%                 if ~isequal(evnt.Indices(1,2),1) || ~isequal(evnt.Indices(1,2),2) 
%                     handles = guidata(LongAxis_MainHandle);
%                     handles.ListSelection = evnt.Indices;
%                     handles.ObjVisible = cell2mat(src.Data(:,3));
%                     handles.ObjSelected = cell2mat(src.Data(:,4));
%                     index = find(cell2mat(handles.DataTable.Data(:,1)) == evnt.Indices(1,1));
%                     handles = Update_Single_Cell(handles,index);
%                     % -------------------------------------------------------------------------
%                         set(0,'CurrentFigure',handles.MainFigure1)
%                         set(handles.MainFigure1,'CurrentAxes',handles.CellSpecsDisplayAxis)
%                         axis([0 1 0 1])
% 
%                         if ishandle(handles.CellText3);  delete(handles.CellText3); end
% 
%                         if handles.DataTable.Data{index,3}
%                             text5 = 'Visible';
%                             tc2 = [0 0.5 0];
%                         else
%                             text5 = 'Hidden ';
%                             tc2 = [0.5 0 0];
%                         end
% 
%                         handles.CellText3 = text(handles.CellSpecsDisplayAxis,0.5,-0.55,text5,...
%                                         'FontName','Ariel','FontWeight','bold','FontSize',11,'Color',tc2);   
% 
%                         nvis = sum(double(handles.ObjVisible));
%                         set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])            
%                         guidata(LongAxis_MainHandle,handles)
%                     % -------------------------------------------------------------------------
%                 end 
%             end
            
%------------------------------------------------------------------------------------------------------
%function CellListSelection(src,evnt)
           
%             global LongAxis_MainHandle  
%             
%             if ~isequal(12345,get(gcf,'Number')) && ~isequal(0,size(evnt.Indices,1))
%                 if isequal(evnt.Indices(1,2),1) || isequal(evnt.Indices(1,2),2) 
%                     handles = guidata(LongAxis_MainHandle);
%                     handles.ListSelection = evnt.Indices; 
%                     index = find(cell2mat(handles.DataTable.Data(:,1)) == evnt.Indices(1,1)); 
%                     handles = Update_SingleCellAxis(handles,index); 
%                     
%                     handles.CurrentlySelectedCell = index;
%                     
%                     nvis = sum(double(handles.ObjVisible));
%                     set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)]);
%                     
%                     guidata(LongAxis_MainHandle,handles);
%                     set(0,'CurrentFigure',handles.MainFigure1)
%                 end
%             end
          
%------------------------------------------------------------------------------------------------------
function PatchBDF(src,~) % Executes when one of the rendered 3D cells is clicked on
                
            global LongAxis_MainHandle  
            handles = guidata(LongAxis_MainHandle);
            nObjects = length(handles.IsoSurfaceHandles);
            N = 0;
            %-------------------------------------------------------------------------------------------
            % Figure out which object was selected (compare XYZ with Identifier_XYZ values from rendering)
                for n = 1:nObjects
                    ObjID = handles.IsoSurfaceIdentifier{n,1};
                    CapID = handles.IsoCapIdentifier{n,1};
                    SelID = [src.XData(:,1), src.YData(:,1), src.ZData(:,1)];

                    ObjDiff = ObjID - SelID;
                    CapDiff = CapID - SelID;

                    if handles.ObjVisible(n,1)
                        % If this is the selected IsoSurface
                        if isequal(zeros(3,3), ObjDiff) || isequal(zeros(3,3), CapDiff) 
                            N = n; % N is the current selected cell index
                            break
                        end
                    end
                end
            %-------------------------------------------------------------------------------------------
            % Check for previously HL'ed cells and un-HL them if in single-cell-selection mode
                if handles.SingleCellHighLight
                    K = find(handles.ObjSelected);
                    if numel(K) > 1
                        handles.ObjSelected = false(nObjects,1);
                    end
                    for k = 1:numel(K)
                        if ~isequal(K(k),N)
                            handles.ObjSelected(K(k),1)    = false;
                            handles = Update_Single_Cell(handles,K(k));
                        end
                    end
                end
            %------------------------------------------------------------------------------------------
            if ~isequal(0,N)
            Selected = handles.ObjSelected(N,1);
                if Selected % Cell is already HighLighted (HL), so now un-HL it
                    if handles.SingleCellHighLight % ----------------
                        handles.ObjSelected = false(nObjects,1);
                        handles.CurrentlySelectedCell = 0;
                    end
                    % -----------------------------------------------------------
                    handles.ObjSelected(N,1) = false; % Redundant for single-cell-selection
                    % ------------------------------------------------------------
                else % Cell is not HL'ed. So now HL it
                     % For single-cell-selection only ---------------------------
                    if handles.SingleCellHighLight % ----------------
                        handles.ObjSelected = false(nObjects,1);
                    end
                    handles.ObjSelected(N,1) = true;
                    handles.CurrentlySelectedCell = N;
                    % ----------------------------------------------------------
                end
                set(handles.RecentCellSelectionDisplay, 'String', ['Recent Cell Select: ' num2str(N)])
            end
            
            %-----------------------------------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices, handles.CellSizes,...
                                                                handles.ObjVisible,  handles.ObjSelected);
            handles = Update_Single_Cell(handles,N);
            handles = Update_SingleCellAxis(handles,N); 
            %-----------------------------------------------------------------------------------
            
            handles.CellList.Value = N;
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            guidata(LongAxis_MainHandle,handles)
        

%------------------------------------------------------------------------------------------------------
function ShortCuts(src,evnt)
            
            global LongAxis_MainHandle   
            handles = guidata(LongAxis_MainHandle); 
            %=================================================================================================
            if ~isequal(handles.nObjs, length(handles.COM)) || isempty(handles.COM)
                handles.COM = zeros(handles.nObjs,3);
                for k = 1:handles.nObjs
                    % Center of Data Points (center of mass of cell)
                    handles.COM(k,:) = handles.CellData{k,1}.CellCenterOfMass; 
                end 
            end 
            %================================================================================================
            key = double(lower(evnt.Character));
            LBT = handles.CellList.ListboxTop;
            
            if isnumeric(key) && ~isempty(key)
                switch key
                    %----------------------------------------------------------------------------------------    
                    case 114 % 'r' or 'R'
                       set(0,'CurrentFigure',handles.RenderingFigure)
                       rotate3d                      
                       %######################################################################################  
                        % This code fixes MATLAB 'bug' that won't allow a figure's 
                        % Key-Press Functions to work while in Rotate3d mode
                        % http://undocumentedmatlab.com/blog/enabling-user-callbacks-during-zoom-pan     
                            handles = KeyPressWithRotate3DFix(handles);
                        % ##################################################################################  
                    %-----------------------------------------------------------------------------------------               
                    case 28 %Left Arrow - 
                       
                    %-----------------------------------------------------------------------------------------    
                    case 29 %Right Arrow - 
                       
                    %-----------------------------------------------------------------------------------------    
                    case 31 %Down Arrow 
                        index = handles.CellList.Value;
                        N = length(handles.CellList.String);
                        if ~isequal(index,N)
                            index = index + 1;
                            handles.CellList.Value = index;
                            handles.CurrentlySelectedCell = index;
                            set(handles.RecentCellSelectionDisplay,'String',...
                            ['Recent Cell Select: ' num2str(index)])
                            handles = Update_SingleCellAxis(handles,index); 
                            set(handles.nCellsVisibleDisplay,'String',...
                                ['nCells Visible: ' num2str(sum(handles.ObjVisible(:))) ]);
                        end
                    %----------------------------------------------------------------------------------------                  
                    case 30 %Up Arrow 
                        index = handles.CellList.Value;
                        if ~isequal(index,1)
                            index = index - 1;
                            handles.CellList.Value = index;
                            handles.CurrentlySelectedCell = index;
                            set(handles.RecentCellSelectionDisplay,'String',...
                            ['Recent Cell Select: ' num2str(index)])
                            handles = Update_SingleCellAxis(handles,index); 
                            set(handles.nCellsVisibleDisplay,'String',...
                                ['nCells Visible: ' num2str(sum(handles.ObjVisible(:))) ]);
                        end
                    %----------------------------------------------------------------------------------------        
                    case 104 % 'h' or 'H' key press
                            % Check to see that there is a cell that is highlighted
                            if ~isequal(handles.CurrentlySelectedCell,0) 
                                    N = handles.CurrentlySelectedCell;
                                    if handles.ObjSelected(N,1) 
                                        % If Object is already Highlighted ----
                                        handles.ObjVisible(N,1)  = true;
                                        handles.ObjSelected(N,1) = false;
                                        handles = Update_Single_Cell(handles,N);
                                        handles = Update_SingleCellAxis(handles,N); 
                                    else
                                        % If Object is NOT Highlighted --------
                                        % Check if SingleCellHighlight Mode is checked
                                        if handles.SingleCellHighLight 
                                            % If so unhighlight all other highlighted 
                                            % cells before highlighting this one------------------------------
                                            idx = find(handles.ObjSelected(:,1))';
                                            nObj = length(handles.ObjSelected(:,1));
                                            handles.ObjSelected(:,1) = false(nObj,1);
                                            for ii = idx
                                                handles = Update_Single_Cell(handles,ii);
                                            end
                                            %-----------------------------------------------------------------
                                        end 
                                        handles.ObjVisible(N,1)  = true;
                                        handles.ObjSelected(N,1) = true;
                                        handles = Update_Single_Cell(handles,N);
                                        handles = Update_SingleCellAxis(handles,N); 
                                    end
                                    handles.CellList.String = ...
                                        CreateCellListStringArray(handles.CellIndices, handles.CellSizes,...
                                                                  handles.ObjVisible, handles.ObjSelected); 
                            end
                            
                    %----------------------------------------------------------------------------------------    
                    case 115 % 's' or 'S'
                        % START: Turn ButtonDownFunctions OFF for all the cell renderings -----------------
                            for n = 1:handles.nObjs
                                set(handles.IsoSurfaceHandles{n,1},'ButtonDownFcn','')
                            end
                        % ---------------------------------------------------------------------------------
                        
                        test1 = any([(isequal(handles.ViewCellsNearPlane,2) && handles.DoXSlice),...
                                     (isequal(handles.ViewCellsNearPlane,3) && handles.DoYSlice),...
                                     (isequal(handles.ViewCellsNearPlane,4) && handles.DoZSlice)]);
                                 
                        test2 = isequal(handles.Projection,'orthographic');
                        
                        [az,el] = view(handles.AxisHandle);
                        ViewVec = [az,el];
                           
                        if     isequal(ViewVec,[   0,  90 ]); rView = 'posXY'; test3 = true; 
                        elseif isequal(ViewVec,[   0, -90 ]); rView = 'negXY'; test3 = true;
                        elseif isequal(ViewVec,[   0,   0 ]); rView = 'posXZ'; test3 = true;
                        elseif isequal(ViewVec,[ 180,   0 ]); rView = 'negXZ'; test3 = true;
                        elseif isequal(ViewVec,[  90,   0 ]); rView = 'posYZ'; test3 = true;
                        elseif isequal(ViewVec,[ -90,   0 ]); rView = 'negYZ'; test3 = true;
                        else                                  rView = '';      test3 = false;
                        end
                        
                        if ~test2 || ~test3 
                            % Error Boxes --------------------------------------------------------------------
                            if ~test2 && ~test3
                              hmes = errordlg({'For MULTI-CELL HIGHLIGHTING to work, go to the IMAGE panel';...
                                                'and make the following adjustments:';...
                                                 '      - Proj: ORTHOGRAPHIC';...
                                                 '      - Select the VIEW as +/-XZ, +/-YZ, or +/-XY';' '},...
                                                 'Selection-Mode Error');
                            elseif ~test2
                              hmes = errordlg({'For MULTI-CELL HIGHLIGHTING to work, go to the IMAGE panel';...
                                                 'and make the following adjustments:';...
                                                 '      - Proj: ORTHOGRAPHIC'; ' '},...
                                                 'Selection-Mode Error');
                            elseif ~test3
                              hmes = errordlg({'For MULTI-CELL HIGHLIGHTING to work, go to the IMAGE panel';...
                                                 'and make the following adjustments:';...
                                                 '      - Select the VIEW as +/-XZ, +/-YZ, or +/-XY'; ' '},...
                                                 'Selection-Mode Error');
                            end % ----------------------------------------------------------------------------
                            
                        else % Start Region Selection ||||||||||||||||||||||||||||||||||||||||||||||||||||||||
                             try   
                                global POINTDATA 
                                                                
                                set(0,'CurrentFigure',handles.RenderingFigure)
                                set(handles.RenderingFigure,'Pointer','crosshair')
                                rotate3d(handles.AxisHandle,'off'); 
                                zoom(handles.AxisHandle,'off'); 
                                pan(handles.AxisHandle,'off')
                                %-----------------------------------------------------------------------------
                                     POINTDATA.Figure    = handles.RenderingFigure;
                                     POINTDATA.Axis      = handles.AxisHandle;
                                     POINTDATA.Limits    = handles.AxisRange;
                                     POINTDATA.rView     = rView;
                                     POINTDATA.COM       = handles.COM;
                                     POINTDATA.ONSV      = handles.ObjNearSliceView;
                                     POINTDATA.ObjVis    = handles.ObjVisible;
                                     POINTDATA.ObjSel    = handles.ObjSelected;
                                %-----------------------------------------------------------------------------
                                % Initiate Rectangle by waiting for first-point-click on figure window
                                    k = waitforbuttonpress; 
                                % Grab first point and record it
                                    p = get(handles.AxisHandle, 'CurrentPoint');  
                                    POINTDATA.p1 = p(1,:);
                                % Turn on Motion function that updates rectangle drawing in real time
                                    set(handles.RenderingFigure, 'WindowButtonMotionFcn',...
                                                                 @DrawSelectionRectangle,...
                                                                 'WindowButtonDownFcn'  ,...
                                                                 @GrabSelectionNewPoint) 
                                % waitfor next point to be selected, record it, and draw finalized triangle
                                    waitfor(POINTDATA.Figure, 'WindowButtonDownFcn'  , '');                 
                                %-----------------------------------------------------------------------------
                                handles.ObjSelected = POINTDATA.ObjSel;
                                clear POINTDATA
                                set(handles.RenderingFigure, 'WindowButtonMotionFcn', '',...
                                                             'WindowButtonDownFcn'  , '')
                                                         
                                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                                    handles.CellSizes,...
                                                                                    handles.ObjVisible,...
                                                                                    handles.ObjSelected);                         
                             %||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
                              
                             end
                             
                            % START: Turn ButtonDownFunctions back ON for all the cell renderings ----
                                for n = 1:handles.nObjs
                                    set(handles.IsoSurfaceHandles{n,1},'ButtonDownFcn',@PatchBDF)
                                end
                            % ------------------------------------------------------------------------
                             
                        end
                        
                        set(handles.RenderingFigure,'Pointer','arrow')    
                %---------------------------------------------------------------------------------------------  
                    case 117 % 'u' or 'U' Key Press
                            
                            [M,N] = size(handles.UndoButtonRecordedVisActions);

                            if M > 0
                                    FH = WaitToUpdateRendering;
                                    drawnow
                                    %Find only the cells that need to be changed
                                    idx = find(abs(diff([handles.ObjVisible,...
                                        handles.UndoButtonRecordedVisActions(:,1)],1,2)))'; 
                                    handles.ObjVisible  = handles.UndoButtonRecordedVisActions(:,1);
                                    handles.ObjSelected = false(size(handles.ObjVisible,1),1);
                                    handles.UndoButtonRecordedVisActions(:,1) = [];
                                    
                                    if isequal(numel(handles.UndoButtonRecordedVisActions),0)
                                        handles.UndoButtonRecordedVisActions = false(0,1);  
                                    end 
                                    
                                    L = length(handles.ObjVisible);     Toggle = [{'off'};{'on'}];

                                    if handles.ViewCellsNearPlane == 1
                                        for k = idx
                                            set(handles.IsoSurfaceHandles{k,1}, 'Visible',...
                                                Toggle{ handles.ObjVisible(k,1) + 1},...
                                                'FaceColor', handles.FaceColor)
                                            set(handles.IsoCapHandles{k,1},     'Visible',...
                                                Toggle{ handles.ObjVisible(k,1) + 1},...
                                                'FaceColor', handles.FaceColor)
                                        end
                                    else
                                        handles = Update_Cells_Near_Slice(handles);
                                    end

                                    nvis = sum(double(handles.ObjVisible));
                                    set(handles.nCellsVisibleDisplay,'String',...
                                        ['nCells Visible: ' num2str(nvis)]) 
                                    
                                   %-------------Update Cell List box ----------------------------------------
                                   handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                                        handles.CellSizes,...
                                                                                        handles.ObjVisible,...
                                                                                        handles.ObjSelected);
                                    %-------------------------------------------------------------------------
                                    drawnow
                                    try close(FH); end    
                            end
                        
                %---------------------------------------------------------------------------------------------    
                    case 118 % 'v' or 'V' Key press
                            % Turn Visibility of selected object OFF or ON ===================================  
                            if any(handles.ObjSelected) % Check to see if there are cells Highlighted.
                                % If so, change Visibility to 'off'
                                %-- Record Visibility State for Undo Button ----------------------------------
                                    handles = UpdateActionRecordingsForUNDO(handles);
                                %-----------------------------------------------------------------------------  
                                ind1 = find(handles.ObjSelected);
                                for k = ind1'
                                    set(handles.IsoSurfaceHandles{k},'Visible','off',...
                                        'FaceColor',handles.FaceColor)%,'EdgeColor',handles.MeshColor)
                                    set(handles.IsoCapHandles{k},    'Visible','off',...
                                        'FaceColor',handles.FaceColor)%,'EdgeColor',handles.MeshColor) 
                                    handles.ObjSelected(k,1) = false;
                                    handles.ObjVisible(k,1)  = false;
                                end
                                
                            else
                                    % Check to see that there is a cell that is highlighted in Cell list box
                                    if ~isequal(handles.CurrentlySelectedCell,0) 
                                            %-- Record Visibility State for Undo Button -----------------------
                                            handles = UpdateActionRecordingsForUNDO(handles);
                                            %------------------------------------------------------------------
                                            N = handles.CurrentlySelectedCell;
                                            if handles.ObjVisible(N,1) % If Object is already visible ---------
                                                    handles.ObjSelected(N,1) = false;
                                                    handles.ObjVisible(N,1)  = false;
                                                    handles.CellList.ListboxTop = LBT;
                                                    % Turn off Visibility of Selected Cell ----------
                                                    set(handles.IsoSurfaceHandles{N},'Visible','off',...
                                                        'FaceColor',handles.FaceColor)
                                                    set(handles.IsoCapHandles{N},    'Visible','off',...
                                                        'FaceColor',handles.FaceColor)
                                                    handles = Update_SingleCellAxis(handles,N);    
                                                    % -----------------------------------------------
                                                    if ~isempty(handles.VectorHandles)
                                                            V = zeros(length(handles.VectorData),1); 
                                                            for k = 1:length(V)
                                                                V(k,1) = handles.VectorData{k,1}.CellIndex; 
                                                            end
                                                            Vind = find(V == N);
                                                            delete(handles.VectorHandles{Vind,1})
                                                    end
                                            else
                                                    handles.ObjSelected(N,1) = false;
                                                    handles.ObjVisible(N,1)  = true;
                                                    handles.CellList.ListboxTop = LBT;
                                                    % Turn off Visibility of Selected Cell ----------
                                                    if handles.ShowFace; FC = handles.FaceColor; else; FC = 'none'; end
                                                    if handles.ShowMesh; MC = handles.MeshColor; else; MC = 'none'; end
                                                    set(handles.IsoSurfaceHandles{N},'Visible','on',...
                                                        'FaceColor',FC,...
                                                        'FaceAlpha',handles.FaceTransparency/100,...
                                                        'EdgeColor',MC,...
                                                        'EdgeAlpha',handles.MeshTransparency/100)
                                                    set(handles.IsoCapHandles{N},'Visible','on',...
                                                        'FaceColor',FC,...
                                                        'FaceAlpha',handles.FaceTransparency/100,...
                                                        'EdgeColor',MC,...
                                                        'EdgeAlpha',handles.MeshTransparency/100)
                                                    handles = Update_SingleCellAxis(handles,N);    
                                            end
                                    end
                            end
                            
                            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                                handles.CellSizes,...
                                                                                handles.ObjVisible,...
                                                                                handles.ObjSelected); 
                            drawnow
                            %set(0,'CurrentFigure',handles.MainFigure1)
                            nvis = sum(double(handles.ObjVisible));
                            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
                end %========================================================================================
            end
            
            %set(handles.RenderingFigure,'Pointer','arrow')
            
            guidata(LongAxis_MainHandle,handles)
        
            
%------------------------------------------------------------------------------------------------------    
function handles = UpdateActionRecordingsForUNDO(handles)
    
    handles.UndoButtonRecordedVisActions = [handles.ObjVisible, handles.UndoButtonRecordedVisActions]; 

    if size(handles.UndoButtonRecordedVisActions,2) > handles.nRecordings
        handles.UndoButtonRecordedVisActions = handles.UndoButtonRecordedVisActions(:,1:handles.nRecordings);
    end

%------------------------------------------------------------------------------------------------------        
function DrawSelectionRectangle(src,evnt)

        global POINTDATA
        global LongAxis_MainHandle  
        
        handles = guidata(LongAxis_MainHandle);
        
        s1 = POINTDATA.p1;
        s = get(POINTDATA.Axis,'CurrentPoint');
        s2 = s(1,:);
        POINTDATA.p2 = s2;
        P = sort([s1;s2]);
            p1 = P(1,:);
            p2 = P(2,:);
            d = diff(P);
        ind = find(~logical(d));  % ~logical(d);
            x1 = P(1,1); x2 = P(2,1);
            y1 = P(1,2); y2 = P(2,2);
            z1 = P(1,3); z2 = P(2,3);
            
        %--------------------------------------------------------    
        B = logical(handles.ViewCellsNearSliceMenu.Value - 1);   
        switch B
            case 1
                ind1 = find(POINTDATA.ONSV & POINTDATA.ObjVis);    
            case 0
                ind1 = find(POINTDATA.ObjVis);
        end
        %--------------------------------------------------------
        
        %|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
        if ~isempty(ind) && isequal(length(ind),1)   
            switch ind
                    %-----------------------------------------------------------------------------
                case 1 % YZ
                    %-----------------------------------------------------------------------------
                    x = [x1;x1;x1;x1;x1];
                    y = [y1;y2;y2;y1;y1];
                    z = [z1;z1;z2;z2;z1];
                    for k = ind1'
                        if (handles.COM(k,2) <= y2 && handles.COM(k,2) >= y1 &&...
                            handles.COM(k,3) <= z2 && handles.COM(k,3) >= z1)
                        
                            set(handles.IsoSurfaceHandles{k,1},'FaceColor',handles.HighlightColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.HighlightColor)
                            end
                            POINTDATA.ObjSel(k,1) = true;
                        else
                            set(handles.IsoSurfaceHandles{k,1},'FaceColor',handles.FaceColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.FaceColor)
                            end
                            POINTDATA.ObjSel(k,1) = false;
                        end
                    end
                    %-----------------------------------------------------------------------------
                case 2 % XZ
                    %-----------------------------------------------------------------------------
                    x = [x1;x2;x2;x1;x1];
                    y = [y1;y1;y1;y1;y1];
                    z = [z1;z1;z2;z2;z1];
                    for k = ind1'
                        if (handles.COM(k,1) <= x2 && handles.COM(k,1) >= x1 &&...
                            handles.COM(k,3) <= z2 && handles.COM(k,3) >= z1)
                        
                            set(handles.IsoSurfaceHandles{k},'FaceColor',handles.HighlightColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.HighlightColor)
                            end
                            POINTDATA.ObjSel(k,1) = true;
                        else
                            set(handles.IsoSurfaceHandles{k},'FaceColor',handles.FaceColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.FaceColor)
                            end
                            POINTDATA.ObjSel(k,1) = false;
                        end
                    end
                    %-----------------------------------------------------------------------------
                case 3 % XY
                    %-----------------------------------------------------------------------------
                    x = [x1;x2;x2;x1;x1];
                    y = [y1;y1;y2;y2;y1];
                    z = [z1;z1;z1;z1;z1];
                    for k = ind1'
                        if (handles.COM(k,1) <= x2 && handles.COM(k,1) >= x1 &&...
                            handles.COM(k,2) <= y2 && handles.COM(k,2) >= y1)
                            set(handles.IsoSurfaceHandles{k},'FaceColor',handles.HighlightColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.HighlightColor)
                            end
                            POINTDATA.ObjSel(k,1) = true;
                        else
                            set(handles.IsoSurfaceHandles{k},'FaceColor',handles.FaceColor)
                            if handles.PartialCell(k,1)
                                set(handles.IsoCapHandles{k,1},'FaceColor',handles.FaceColor)
                            end
                            POINTDATA.ObjSel(k,1) = false;
                        end
                    end
                    %-----------------------------------------------------------------------------
            end
            
            set(0,'CurrentFigure',POINTDATA.Figure)
            %-------------------------------------------
            if isfield(POINTDATA,'HR')
                if isgraphics(POINTDATA.HR); delete(POINTDATA.HR); end
            end
            %-------------------------------------------
            hold(POINTDATA.Axis,'on')
                POINTDATA.HR = plot3(x,y,z,'-.c','LineWidth',1.5);
            hold(POINTDATA.Axis,'off')
        end
        
        
%------------------------------------------------------------------------------------------------------       
function GrabSelectionNewPoint(src,evnt)
    
        global POINTDATA 
       
        set(POINTDATA.Figure,'WindowButtonDownFcn','',...
                             'WindowButtonMotionFcn','',...
                             'WindowStyle','Normal')
        %-----------------------------------------
        if isfield(POINTDATA,'HR')
            if isgraphics(POINTDATA.HR)
                delete(POINTDATA.HR)
            end
        end
        %-----------------------------------------

           
    
%------------------------------------------------------------------------------------------------------           
function MotionFcn(src,evnt)
       
            global LongAxis_MainHandle  
            handles = guidata(LongAxis_MainHandle);
            
            p1 = get(handles.Navigation_Figure,'CurrentPoint');
            px = p1(1,1); py = p1(1,2);
            sX = handles.XAxisLimits(1,2)/handles.ImX;
            sY = handles.YAxisLimits(1,2)/handles.ImY;
            Xpixel = ceil(px/sX);
            Ypixel = ceil(py/sY);
            
            if isempty(handles.sPix)
                text3 = '     < no selection >   ';
                text4 = '                        ';
                text5 = '                        ';
            else
                text3 = '      Selected Region:  ';
                text4 = '      R1   C1   R2   C2 ';   
                text5 = [ '      ' sprintf('%3.0i',handles.sPix(1,1))...
                              '  ' sprintf('%3.0i',handles.sPix(1,2))...
                              '  ' sprintf('%3.0i',handles.ePix(1,1))...
                              '  ' sprintf('%3.0i',handles.ePix(1,2))];
            end           
            
            if ~isempty(handles.XAxisLimits)
                if     px < handles.XAxisLimits(1,1) || px > handles.XAxisLimits(1,2)
                        text0 = '           X      Y';
                        text1 = 'microns: ';
                        text2 = 'pixels: ';
                elseif py < handles.YAxisLimits(1,1) || py > handles.YAxisLimits(1,2)
                        text0 = '           X      Y';
                        text1 = 'microns: ';
                        text2 = 'pixels: ';
                else
                        text0 = '           X      Y';
                        text1 = ['microns: ' sprintf('%5.1f',px)     '  '  sprintf('%5.1f',py)];
                        text2 = ['pixels: '  sprintf('%4.0f',Xpixel) '   ' sprintf('%4.0f',Ypixel)];
                end
                set(handles.PositionDisplay,'String',[{text0};{text1};{text2};{text3};{text4};{text5}],...
                                            'FontName','monospaced')
            end
            
            guidata(LongAxis_MainHandle,handles)
            
%------------------------------------------------------------------------------------------------------        
function Navigation_Figure_CreateFcn(hObject, eventdata, handles)


    
    
%------------------------------------------------------------------------------------------------------        
function Z_slider_Callback(hObject, eventdata, handles)

                handles.Z = round(get(handles.Z_slider,'Value'));
                z  = sprintf('%3d',handles.Z);
                zm = handles.Z * handles.ZStep;
                
                if ishandle(handles.Ztext)
                     delete(handles.Ztext)
                end
                
                text1 = [' Z: ' z  ' (' sprintf('%4.1f',zm) ' ' texlabel('mu') 'm)'];
                
                dZ    = handles.Z2 - handles.Z1 + 1;
                dZs   = sprintf('%3d',dZ);
                dZsm  = dZ * handles.ZStep;
                text2 = [texlabel('delta') 'Z: ' dZs ' (' sprintf('%4.1f',dZsm) ' ' texlabel('mu') 'm)'];
                
                set(handles.MainFigure1,'CurrentAxes',handles.Z_Display)
                
                cla
                
                handles.Ztext = text(handles.Z_Display,0,0.5,{text1 , text2},...
                                    'FontName','Monospaced','FontWeight','bold',...
                                    'FontSize',11,'Color',[0.64 0.08 0.18]);
                                
                set(handles.Z_Display,'Visible','off')
                
                handles = Update_Navigation_Figure(handles);
                
                guidata(hObject,handles)

                
%------------------------------------------------------------------------------------------------------        
function Z_slider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
        

%------------------------------------------------------------------------------------------------------        
function Pixel_Width_Input_Callback(hObject, eventdata, handles)

        PW = str2double(get(handles.Pixel_Width_Input,'String')); % Pixel Width (um)
        
        if ~isnan(PW)
            handles.PixelWidth = PW;
            set(handles.Pixel_Width_Input,'String',handles.PixelWidth); 
        else
            set(handles.Pixel_Width_Input,'String',handles.PixelWidth);
        end        
                
        ZS = handles.ZStep;
        VS = ZS.*PW^2; % um^3 (uL)
        handles.VoxelSize = VS;
        set(handles.Low_Size_Filter_Input, 'String', sprintf('%4d', handles.LowSizeFilter ));
        set(handles.High_Size_Filter_Input,'String', sprintf('%4d', handles.HighSizeFilter));

text0 = ['1 voxel = '      sprintf('%5.4f',handles.VoxelSize)          ' ' texlabel('mu') 'm' texlabel('^3')];
text1 = ['Low Filter =  '  sprintf('%5.1f',VS*handles.LowSizeFilter)   ' ' texlabel('mu') 'm' texlabel('^3')];
text2 = ['High Filter =  ' sprintf('%4.1f',VS*handles.HighSizeFilter)  ' ' texlabel('mu') 'm' texlabel('^3')];

        if ishandle(handles.FilterText)
            delete(handles.FilterText)
        end

        handles.FilterText = text(handles.FilterVolumeDisplay, 1, 0.5,{text0, text1 , text2},...
                                               'FontName','Monospaced','FontWeight','bold',...
                                               'FontSize', 9,'Color', [0 0 0],...
                                               'HorizontalAlignment','right');

        set(handles.FilterVolumeDisplay,'Visible','off')
                    
        guidata(hObject,handles)


%------------------------------------------------------------------------------------------------------            
function Pixel_Width_Input_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end


%------------------------------------------------------------------------------------------------------        
function Z_Step_Input_Callback(hObject, eventdata, handles)

        ZS = str2double(get(handles.Z_Step_Input,'String')); % Pixel Width (um)
        
        if ~isnan(ZS)
            handles.ZStep = ZS;
            set(handles.Z_Step_Input,'String',handles.ZStep); 
        else
            set(handles.Z_Step_Input,'String',handles.ZStep);
        end        
                
        PW = handles.PixelWidth;

        VS = ZS.*PW^2; % um^3 (uL)
        handles.VoxelSize = VS;
        set(handles.Low_Size_Filter_Input, 'String',sprintf('%4d',handles.LowSizeFilter ));
        set(handles.High_Size_Filter_Input,'String',sprintf('%4d',handles.HighSizeFilter));

text0 = ['1 voxel = '      sprintf('%5.4f',handles.VoxelSize)          ' ' texlabel('mu') 'm' texlabel('^3')];
text1 = ['Low Filter =  '  sprintf('%5.1f',VS*handles.LowSizeFilter)   ' ' texlabel('mu') 'm' texlabel('^3')];
text2 = ['High Filter =  ' sprintf('%4.1f',VS*handles.HighSizeFilter)  ' ' texlabel('mu') 'm' texlabel('^3')];

        if ishandle(handles.FilterText)
            delete(handles.FilterText)
        end

        handles.FilterText = text(handles.FilterVolumeDisplay, 1, 0.5,{text0, text1 , text2},...
                                               'FontName','Monospaced',...
                                               'FontWeight','bold',...
                                               'FontSize', 9,'Color', [0 0 0],...
                                               'HorizontalAlignment','right');

        set(handles.FilterVolumeDisplay,'Visible','off')
                    
        guidata(hObject,handles)

%------------------------------------------------------------------------------------------------------        
function Z_Step_Input_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end
    
%------------------------------------------------------------------------------------------------------          
function DrawRectangle(src,evnt)

        global POINTDATA 

        p1 = POINTDATA.p1;
        p = get(POINTDATA.handles.Navigation_Figure,'CurrentPoint');
        p2 = p(1,1:2);
        
        px = p2(1,1); py = p2(1,2);
        
        pdiff  = p1-p2;
        signX  = -pdiff(1,1)/abs(pdiff(1,1));
        signY  = -pdiff(1,2)/abs(pdiff(1,2));
        W = abs(pdiff(1));
        H = abs(pdiff(2));

        x = [p1(1,1)  p1(1,1)          p1(1,1)+signX*W  p1(1,1)+signX*W  p1(1,1)];
        y = [p1(1,2)  p1(1,2)+signY*H  p1(1,2)+signY*H  p1(1,2)          p1(1,2)];
          
        POINTDATA.x = x;
        POINTDATA.y = y;
    
        set(0,'CurrentFigure',POINTDATA.h)
        POINTDATA.handles = Update_Navigation_Figure(POINTDATA.handles);
        hold on,plot(POINTDATA.x,POINTDATA.y,'-y'), hold off
        
        sX = POINTDATA.handles.XAxisLimits(1,2)/POINTDATA.handles.ImX;
        sY = POINTDATA.handles.YAxisLimits(1,2)/POINTDATA.handles.ImY;
        Wp = ceil(W/sX);
        Hp = ceil(H/sY);
        Xpixel = ceil(px/sX);
        Ypixel = ceil(py/sY); 
        
        text0 =  '           X      Y';
        text1 = ['microns: ' sprintf('%5.1f',px)     '  '  sprintf('%5.1f',py)];
        text2 = ['pixels: '  sprintf('%4.0f',Xpixel) '   ' sprintf('%4.0f',Ypixel)];
        text3 =  '           W      H        A';
        text4 = ['microns: ' sprintf('%5.1f',W)   '  ' sprintf('%5.1f',H)  '  ' sprintf('%7.1f',W*H)];
        text5 = ['pixels: '  sprintf('%4.0f',Wp) '   ' sprintf('%4.0f',Hp) '  ' sprintf('%7.0f',Wp*Hp)];
        
        set(POINTDATA.handles.PositionDisplay,'String',...
                    [{text0};{text1};{text2};{text3};{text4};{text5}],...
                    'FontName','monospaced')         
                
        SP = [min([p1(1,1) p2(1,1)]), min([p1(1,2) p2(1,2)])]; % Upper Left Corner of Rectangle (in microns)
        POINTDATA.sPixel = ceil([SP(1,2)/sY       SP(1,1)/sX]);
        POINTDATA.ePixel = ceil([SP(1,2)/sY + Hp  SP(1,1)/sX + Wp]);
        
        
%------------------------------------------------------------------------------------------------------       
function GrabNewPoint(src,evnt)
    
        global POINTDATA 
       
        set(POINTDATA.h,'WindowButtonDownFcn','','WindowButtonMotionFcn','','WindowStyle','Normal')
        POINTDATA.handles = Update_Navigation_Figure(POINTDATA.handles);
        
        hold on
        plot(POINTDATA.x,POINTDATA.y,'-c')
        hold off
        
        
%------------------------------------------------------------------------------------------------------     
function Select_Region_Button_Callback(hObject, eventdata, handles)
    
        global POINTDATA 

        set(handles.Select_Region_Button,'Value',0)
        
        set(0,'CurrentFigure',handles.MainFigure1)
        rotate3d off
        zoom off
        pan off
        
        handles.Region_X = [];
        handles.Region_Y = [];
        handles = Update_Navigation_Figure(handles);
    
        POINTDATA.handles   = handles;
        POINTDATA.Size      = handles.YAxisLimits(1,2);
        POINTDATA.h         = handles.MainFigure1;
        %---------------------------------------------------------------
            % Initiate Rectangle by waiting for first-point-click on figure window
                k = waitforbuttonpress; 
            % Grab first point and record it
                p = get(handles.Navigation_Figure,'CurrentPoint');  
                POINTDATA.p1  = p(1,1:2); 
            % Turn on Motion function that updates rectangle drawing in real time
                set(handles.MainFigure1,'WindowButtonMotionFcn',...
                    @DrawRectangle,'WindowButtonDownFcn',@GrabNewPoint) 
            % waitfor next point to be selected, record it, and draw finalized triangle
                waitfor(POINTDATA.h,'WindowButtonDownFcn','');                 
        %---------------------------------------------------------------
        handles.Region_X = POINTDATA.x;
        handles.Region_Y = POINTDATA.y;
        
        handles.sPix = POINTDATA.sPixel; % Start Pixel for selected region
        handles.ePix = POINTDATA.ePixel; % End Pixel for selected region
        
        %---------------------------------------------------------------------
        % Check values to make sure they're within the matrix indices range 
            if  handles.sPix(1,1) < 1
                handles.sPix(1,1) = 1;
            elseif handles.sPix(1,1) > handles.ImY
                   handles.sPix(1,1) = handles.ImY;
            end
            
            if  handles.sPix(1,2) < 1
                handles.sPix(1,2) = 1;
            elseif handles.sPix(1,2) > handles.ImX
                   handles.sPix(1,2) = handles.ImX;
            end
            
            if  handles.ePix(1,1) > handles.ImY
                handles.ePix(1,1) = handles.ImY;
            elseif handles.ePix(1,1) < 1
                   handles.ePix(1,1) = 1;
            end
            
            if  handles.ePix(1,2) > handles.ImX
                handles.ePix(1,2) = handles.ImX;
            elseif handles.ePix(1,2) < 1
                   handles.ePix(1,2) = 1;
            end
        % --------------------------------------------------------------------
        
        clear POINTDATA
        
        set(handles.MainFigure1,'WindowButtonMotionFcn',@MotionFcn)
        set(handles.Create_3D_Rendering_Button,'Enable','on')
        set(handles.HandednessLabel,'Visible','on') 
        
        guidata(hObject,handles)
        

%------------------------------------------------------------------------------------------------------    
function Set_z1_Button_Callback(hObject, eventdata, handles)
        
        val = logical(get(handles.Set_z1_Button,'Value'));
        
        if val && ~isequal(handles.Z,handles.Z2) && ~isequal(handles.Z,handles.nZ)
            set(handles.Set_z1_Button,'String',['z1 = ' num2str(handles.Z)],'Value',1)            
            handles.Z1 = handles.Z;
            r = handles.Z2 - handles.Z1;
            set(handles.Z_slider,'SliderStep',[1/r 10/r],'Min',handles.Z1,...
                'Max',handles.Z2,'Value',handles.Z)
        else
            set(handles.Set_z1_Button,'String','z1 = 1','Value',0)
            handles.Z1 = 1;
            r = handles.Z2 - handles.Z1;
            set(handles.Z_slider,'SliderStep',[1/r 10/r],'Min',handles.Z1,...
                'Max',handles.Z2,'Value',handles.Z)
        end

        
                handles.Z = round(get(handles.Z_slider,'Value'));
                z  = sprintf('%3d',handles.Z);
                zm = handles.Z * handles.ZStep;
                if ishandle(handles.Ztext)
                    delete(handles.Ztext)
                end
                
                text1 = [' Z: ' z  ' (' sprintf('%4.1f',zm) ' ' texlabel('mu') 'm)'];
                
                dZ    = handles.Z2 - handles.Z1 + 1;
                dZs   = sprintf('%3d',dZ);
                dZsm  = dZ * handles.ZStep;
                text2 = [texlabel('delta') 'Z: ' dZs ' (' sprintf('%4.1f',dZsm) ' ' texlabel('mu') 'm)'];
                
                handles.Ztext = text(handles.Z_Display,0,0.5,{text1 , text2},...
                    'FontName','Monospaced','FontWeight','bold','FontSize',11,'Color',[0.64 0.08 0.18]);
                set(handles.Z_Display,'Visible','off')
        
                
        guidata(hObject,handles)
        
%------------------------------------------------------------------------------------------------------    
function Set_z2_Button_Callback(hObject, eventdata, handles)

        val = logical(get(handles.Set_z2_Button,'Value'));
        
        if val && ~isequal(handles.Z,handles.Z1) && ~isequal(handles.Z,handles.nZ)
            set(handles.Set_z2_Button,'String',['z2 = ' num2str(handles.Z)],'Value',1)            
            handles.Z2 = handles.Z;
            r = handles.Z2 - handles.Z1;
            set(handles.Z_slider,'SliderStep',[1/r 10/r],...
                'Min',handles.Z1,'Max',handles.Z2,'Value',handles.Z)
        else
            set(handles.Set_z2_Button,'String',['z2 = ' num2str(handles.nZ)],'Value',0)
            handles.Z2 = handles.nZ;
            r = handles.Z2 - handles.Z1;
            set(handles.Z_slider,'SliderStep',[1/r 10/r],...
                'Min',handles.Z1,'Max',handles.Z2,'Value',handles.Z)
        end

                handles.Z = round(get(handles.Z_slider,'Value'));
                z  = sprintf('%3d',handles.Z);
                zm = handles.Z * handles.ZStep;
                if ishandle(handles.Ztext)
                    delete(handles.Ztext)
                end
                
                text1 = [' Z: ' z  ' (' sprintf('%4.1f',zm) ' ' texlabel('mu') 'm)'];
                
                dZ    = handles.Z2 - handles.Z1 + 1;
                dZs   = sprintf('%3d',dZ);
                dZsm  = dZ * handles.ZStep;
                text2 = [texlabel('delta') 'Z: ' dZs ' (' sprintf('%4.1f',dZsm) ' ' texlabel('mu') 'm)'];
                
                handles.Ztext = text(handles.Z_Display,0,0.5,{text1 , text2},...
                    'FontName','Monospaced','FontWeight','bold','FontSize',11,'Color',[0.64 0.08 0.18]);
                set(handles.Z_Display,'Visible','off')
        
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function Low_Size_Filter_Input_Callback(hObject, eventdata, handles)

            LowVal =  round(str2double(get(handles.Low_Size_Filter_Input, 'String')));

            if ~isnan(LowVal)
                handles.LowSizeFilter = LowVal;
                set(handles.Low_Size_Filter_Input,'String',sprintf('%4d',handles.LowSizeFilter));
            else
                set(handles.Low_Size_Filter_Input,'String',sprintf('%4d',handles.LowSizeFilter))
            end        

            PW = handles.PixelWidth; % Pixel Width (um)
            ZS = handles.ZStep;      % Z-Step (um)

            VS = ZS.*PW^2; % um^3 (uL)
            handles.VoxelSize = VS;
            set(handles.Low_Size_Filter_Input,  'String', sprintf('%4d',handles.LowSizeFilter));
            set(handles.High_Size_Filter_Input, 'String', sprintf('%4d',handles.HighSizeFilter));

            text0 = ['1 voxel = '      sprintf('%5.4f',handles.VoxelSize)         ...
                ' ' texlabel('mu') 'm' texlabel('^3')];
            text1 = ['Low Filter =  '  sprintf('%5.1f',VS*handles.LowSizeFilter)  ...
                ' ' texlabel('mu') 'm' texlabel('^3')];
            text2 = ['High Filter =  ' sprintf('%4.1f',VS*handles.HighSizeFilter) ...
                ' ' texlabel('mu') 'm' texlabel('^3')];

            if ishandle(handles.FilterText);
                delete(handles.FilterText)
            end

            handles.FilterText = text(handles.FilterVolumeDisplay,1,0.5,{text0, text1 , text2},...
                                                        'FontName','Monospaced','FontWeight','bold',...
                                                        'FontSize',9,'Color',[0 0 0],...
                                                        'HorizontalAlignment','right');

            set(handles.FilterVolumeDisplay,'Visible','off')

            guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function Low_Size_Filter_Input_CreateFcn(hObject, eventdata, handles)

            if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
                set(hObject,'BackgroundColor','white');
            end


%----------------------------------------------------------------------------------------------------
function NavigationPanelButton_Callback(hObject, eventdata, handles)

          set(handles.NavigationPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
              'BackgroundColor',[0.4 0.4 0.4])
            set(handles.NavigationPanel,'Visible','on')
          set(handles.DisplayPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.DisplayPanel,'Visible','off')
          set(handles.DataPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.DataPanel,'Visible','off')
        
        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function DisplayPanelButton_Callback(hObject, eventdata, handles)

          set(handles.NavigationPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.NavigationPanel,'Visible','off')
          set(handles.DisplayPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
              'BackgroundColor',[0.4 0.4 0.4])
            set(handles.DisplayPanel,'Visible','on')
          set(handles.DataPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.DataPanel,'Visible','off')

        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function DataPanelButton_Callback(hObject, eventdata, handles)

          set(handles.NavigationPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.NavigationPanel,'Visible','off')
          set(handles.DisplayPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
              'BackgroundColor',[0.8 0.8 0.8])
            set(handles.DisplayPanel,'Visible','off')
          set(handles.DataPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
              'BackgroundColor',[0.4 0.4 0.4])
            set(handles.DataPanel,'Visible','on')
        
      guidata(hObject,handles)
      
%----------------------------------------------------------------------------------------------------
function X_Plane_Slider_Callback(hObject, eventdata, handles)

            xval = get(handles.X_Plane_Slider,'Value');
            handles.XSliceValue = xval;
            set(handles.XSliceDisplay,'String',sprintf('%5.2f',xval)) 
            
            % Update Pop-Out Controller ---------------------------------------------------------
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                H.X_Plane_Slider.Value = handles.XSliceValue;
                H.XSliceDisplay.String = sprintf('%5.2f',xval);
                H.XSliceValue = xval;
                guidata(handles.PopOutControllerHandle,H)
            end
            %------------------------------------------------------------------------------------
            if isgraphics(handles.XSliceHandle);              
                delete(handles.XSliceHandle);              end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle); end
            if isgraphics(handles.XSliceBorderHandle);        
                delete(handles.XSliceBorderHandle);        end
            if isgraphics(handles.CP);                        
                delete(handles.CP);                        end
            
            handles = Update_Slice_Plot(handles,1);
            handles = Update_Cells_Near_Slice(handles);   
            
            guidata(hObject,handles)
            
%----------------------------------------------------------------------------------------------------
function X_Plane_Slider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
    
%----------------------------------------------------------------------------------------------------
function handles = Update_Slice_Plot(handles,Plane)
    
            a = handles.AxisRange;
            % handles.RenderedSubVolumeIndices = [yr(1) yr(end) xr(1) xr(end) zr(1) zr(end)];
            I1   = handles.SubImStack;
            Xmin = handles.sX(1,1,1);
            Xmax = handles.sX(1,end,1);
            Ymin = handles.sY(1,1,1);
            Ymax = handles.sY(end,1,1);
            Zmin = handles.sZ(1,1,1);
            Zmax = handles.sZ(1,1,end);
            
            switch handles.SliceSmoothingMenu.Value;
                case 1; sm =   0;
                case 2; sm = 0.5;
                case 3; sm = 1.0;
                case 4; sm = 1.5;
                case 5; sm = 2.0;
                case 6; sm = 2.5;
                case 7; sm = 3.0;                    
            end
                        
            switch handles.SliceSaturateMenu.Value;
                case 1;  sat =  0;
                case 2;  sat =  2;
                case 3;  sat =  5;
                case 4;  sat = 10;
                case 5;  sat = 15;
                case 6;  sat = 20;
                case 7;  sat = 25;
            end
            
            hold(handles.AxisHandle,'on')
            
            if strcmp(handles.SliceOrLine,'Slice')
                    LineWidth = 1.5;
                    LineColor = [0 0 0];
                    switch Plane
                        case 1
                                XDiff = abs(squeeze(handles.sX(1,:,1)) - handles.XSliceValue);
                                [~,indx] = min((XDiff));
                                
                                %Smooth and Saturate ------------------------------------------------------------  
                                    if isequal(sm,0);   G = squeeze( I1(:,indx(1),:) );
                                    else;               G = imgaussfilt( squeeze( I1(:,indx(1),:) ) , [sm sm] );
                                    end
                                    SIx = imsaturate( G, sat);
                                %--------------------------------------------------------------------------------
%                                 IMx = imsaturate( squeeze(I1(:,indx(1),:)) , sat);
%                                 SIx = Smooth2D(double(IMx),2*sm-1); % Apply 2D smoothing based on user selection
%                                 SIx = 255*SIx./max(SIx(:));   

                                hs1 = surf(handles.AxisHandle,...
                                           handles.XSliceValue + zeros([ size(handles.sX,1),...
                                           size(handles.sX,3) ]),...
                                           squeeze(handles.sY(:,1,:)),...
                                           squeeze(handles.sZ(:,1,:)),...
                                           SIx); 

                                %shading flat

                                handles.XSliceHandle = hs1;
                                hs1.FaceColor = 'flat';
                                hs1.FaceAlpha = handles.SliceTransparency/100;
                                hs1.EdgeColor = 'none';
                                hs1.DiffuseStrength = 0;
                                hs1.SpecularStrength = 0;
                                hs1.AmbientStrength = 1;
                                hs1.BackFaceLighting = 'reverselit';

                                handles.XSliceBorderHandle = line(handles.AxisHandle,...
                                                                  ones(5,1)*handles.XSliceValue,...
                                                                  [Ymin;Ymin;Ymax;Ymax;Ymin],...
                                                                  [Zmin;Zmax;Zmax;Zmin;Zmin],...
                                                                  'LineWidth',LineWidth,'Color',handles.AxesColor,...
                                                                  'AlignVertexCenters','on',...
                                                                  'LineSmoothing','on');

                        case 2
                                YDiff = abs(squeeze(handles.sY(:,1,1)) - handles.YSliceValue);
                                [~,indy] = min((YDiff));
                                %Smooth and Saturate ------------------------------------------------------------  
                                    if isequal(sm,0);   G = squeeze( I1(indy(1),:,:) );
                                    else;               G = imgaussfilt( squeeze( I1(indy(1),:,:) ) , [sm sm] );
                                    end
                                    SIy = imsaturate( G, sat);
                                %-------------------------------------------------------------------------------- 
%                                 IMy = imsaturate(squeeze(I1(indy(1),:,:)),sat);
%                                 SIy = Smooth2D(double(IMy),2*sm-1);
%                                 SIy = 255*SIy./max(SIy(:));   

                                hs2 = surf(handles.AxisHandle,...
                                           squeeze(handles.sX(1,:,:)),...
                                           handles.YSliceValue + zeros([ size(handles.sX,2),...
                                           size(handles.sX,3) ]),...
                                           squeeze(handles.sZ(1,:,:)),...
                                           SIy); 

                                %shading flat
                                    
                                handles.YSliceHandle = hs2;
                                hs2.FaceColor = 'flat';
                                hs2.FaceAlpha = handles.SliceTransparency/100;
                                hs2.EdgeColor = 'none';
                                hs2.DiffuseStrength = 0;
                                hs2.SpecularStrength = 0;
                                hs2.AmbientStrength = 1;
                                hs2.BackFaceLighting = 'reverselit';

                                handles.YSliceBorderHandle = line(handles.AxisHandle,...
                                                                  [Xmin;Xmin;Xmax;Xmax;Xmin],...
                                                                  ones(5,1)*handles.YSliceValue,...
                                                                  [Zmin;Zmax;Zmax;Zmin;Zmin],...
                                                                  'LineWidth',LineWidth,'Color',handles.AxesColor,...
                                                                  'AlignVertexCenters','on',...
                                                                  'LineSmoothing','on');

                        case 3
                                ZDiff = abs(squeeze(handles.sZ(1,1,:)) - handles.ZSliceValue);
                                [~,indz] = min((ZDiff));
                                %Smooth and Saturate ------------------------------------------------------------  
                                    if isequal(sm,0);   G = squeeze( I1(:,:,indz(1)) );
                                    else;               G = imgaussfilt( squeeze( I1(:,:,indz(1)) ) , [sm sm] );
                                    end
                                    SIz = imsaturate( G, sat);
                                %--------------------------------------------------------------------------------
%                                 IMz = imsaturate( squeeze(I1(:,:,indz(1))),sat );
%                                 SIz = Smooth2D(double(IMz),2*sm-1);
%                                 SIz = 255*SIz./max(SIz(:));       

                                hs3 = surf(handles.AxisHandle,...
                                           squeeze(handles.sX(:,:,1)),...
                                           squeeze(handles.sY(:,:,1)),...
                                           handles.ZSliceValue + zeros([ size(handles.sX,1),...
                                           size(handles.sX,2) ]),...
                                           SIz); 

                                %shading flat
                                
                                handles.ZSliceHandle = hs3;
                                hs3.FaceColor = 'flat'; 
                                hs3.FaceAlpha = handles.SliceTransparency/100;
                                hs3.EdgeColor = 'none';
                                hs3.DiffuseStrength  = 0;  
                                hs3.SpecularStrength = 0;
                                hs3.AmbientStrength  = 1;
                                hs3.BackFaceLighting = 'reverselit';

                                handles.ZSliceBorderHandle = line(handles.AxisHandle,...
                                                          [Xmin;Xmin;Xmax;Xmax;Xmin],...
                                                          [Ymin;Ymax;Ymax;Ymin;Ymin],...
                                                          ones(5,1)*handles.ZSliceValue,...
                                                          'LineWidth',LineWidth,'Color',handles.AxesColor,...
                                                          'AlignVertexCenters','on','LineSmoothing','on');
                    end
                    
            else
                
                LineWidth = 2;
                LineColor = handles.AxesColor;
                if ~isgraphics(handles.CP)
                    if handles.DoXSlice && handles.DoYSlice && handles.DoZSlice
                        handles.CP = scatter3(handles.AxisHandle, handles.XSliceValue,...
                                                                  handles.YSliceValue,...
                                                                  handles.ZSliceValue);
                        handles.CP.LineWidth = 1;
                        handles.CP.SizeData = 50;
                        handles.CP.CData = handles.HighlightColor;
                    end
                end
                
            end
            
            % Draw Axis Lines between Slice planes -----------------------------------------------------
          
                if  handles.DoZSlice && handles.DoXSlice
                        if ~isgraphics(handles.ZXSliceIntersectionHandle) 
                              handles.ZXSliceIntersectionHandle = line(handles.AxisHandle,...
                                                              [handles.XSliceValue; handles.XSliceValue],...
                                                              [Ymin; Ymax],...
                                                              [handles.ZSliceValue; handles.ZSliceValue],...
                                                              'LineWidth',LineWidth,'Color',handles.AxesColor,...%LineColor); 
                                                              'AlignVertexCenters','on'); 

                        elseif isempty(handles.ZXSliceIntersectionHandle)
                              handles.ZXSliceIntersectionHandle = line(handles.AxisHandle,...
                                                              [handles.XSliceValue; handles.XSliceValue],...
                                                              [Ymin; Ymax],...
                                                              [handles.ZSliceValue; handles.ZSliceValue],...
                                                              'LineWidth',LineWidth,'Color',handles.AxesColor,... %LineColor); 
                                                              'AlignVertexCenters','on'); 
                        end
                end


                if handles.DoZSlice && handles.DoYSlice
                        if ~isgraphics(handles.ZYSliceIntersectionHandle) 
                              handles.ZYSliceIntersectionHandle = line(handles.AxisHandle,...
                                                              [Xmin; Xmax],...
                                                              [handles.YSliceValue; handles.YSliceValue],...
                                                              [handles.ZSliceValue; handles.ZSliceValue],...
                                                              'LineWidth',LineWidth,'Color',handles.AxesColor,...%LineColor,...
                                                              'AlignVertexCenters','on'); 

                        elseif isempty(handles.ZYSliceIntersectionHandle)
                             handles.ZYSliceIntersectionHandle = line(handles.AxisHandle,...
                                                             [Xmin; Xmax],...
                                                             [handles.YSliceValue; handles.YSliceValue],...
                                                             [handles.ZSliceValue; handles.ZSliceValue],...
                                                             'LineWidth',LineWidth,'Color',handles.AxesColor,...%LineColor,...
                                                             'AlignVertexCenters','on'); 
                        end
                end


                if handles.DoXSlice && handles.DoYSlice
                        if ~isgraphics(handles.XYSliceIntersectionHandle) 
                              handles.XYSliceIntersectionHandle = line(handles.AxisHandle,...
                                                              [handles.XSliceValue; handles.XSliceValue],...
                                                              [handles.YSliceValue; handles.YSliceValue],...
                                                              [Zmin; Zmax],...
                                                              'LineWidth',LineWidth,'Color',handles.AxesColor,...%LineColor,...
                                                              'AlignVertexCenters','on');  

                        elseif isempty(handles.XYSliceIntersectionHandle)
                              handles.XYSliceIntersectionHandle = line(handles.AxisHandle,...
                                                              [handles.XSliceValue; handles.XSliceValue],...
                                                              [handles.YSliceValue; handles.YSliceValue],...
                                                              [Zmin; Zmax],...
                                                              'LineWidth',LineWidth,'Color',handles.AxesColor,...%LineColor,...
                                                              'AlignVertexCenters','on');  
                        end
                end  
      
            
           %-------------------------------------------------------------------------------------
           colormap(eval([handles.ColorMap '(25)']))
           hold(handles.AxisHandle,'off')
           
%----------------------------------------------------------------------------------------------------
function XSliceCheck_Callback(hObject, eventdata, handles)

             
        handles.DoXSlice = logical(get(handles.XSliceCheck,'Value'));
        handles.DoYSlice = logical(get(handles.YSliceCheck,'Value'));
        handles.DoZSlice = logical(get(handles.ZSliceCheck,'Value'));
            
        if handles.DoXSlice
                set(handles.X_Plane_Slider,'Enable','on')
                set(handles.XSliceDisplay,'Enable','on')
                set(handles.XLow,'Enable','on')
                set(handles.XHigh,'Enable','on')
                %---------------------------------------------------------------
                if isgraphics(handles.PopOutControllerHandle)
                    H = guidata(handles.PopOutControllerHandle);
                    set(H.XSliceCheck,'Value',handles.DoXSlice)
                    set(H.X_Plane_Slider,'Enable','on')
                    set(H.XSliceDisplay,'Enable','on')
                    set(H.XLow,'Enable','on')
                    set(H.XHigh,'Enable','on')
                    H.DoXSlice = true;
                    guidata(handles.PopOutControllerHandle,H)
                end
                %---------------------------------------------------------------
                if isgraphics(handles.CP); 
                    delete(handles.CP);
                end
                handles = Update_Slice_Plot(handles,1);
                handles = Update_Cells_Near_Slice(handles);
                
        else
                set(handles.X_Plane_Slider,'Enable','off')
                set(handles.XSliceDisplay,'Enable','off')
                set(handles.XLow,'Enable','off')
                set(handles.XHigh,'Enable','off')
                handles.DoXSlice = false;
                %---------------------------------------------------------------
                if isgraphics(handles.PopOutControllerHandle)
                    H = guidata(handles.PopOutControllerHandle);
                    set(H.XSliceCheck,'Value',handles.DoXSlice)
                    set(H.X_Plane_Slider,'Enable','off')
                    set(H.XSliceDisplay,'Enable','off')
                    set(H.XLow,'Enable','off')
                    set(H.XHigh,'Enable','off')
                    H.DoXSlice = false;
                    guidata(handles.PopOutControllerHandle,H)
                end
                %---------------------------------------------------------------
                handles = Update_Cells_Near_Slice(handles);

                if isgraphics(handles.XSliceHandle);              
                    delete(handles.XSliceHandle);              end
                if isgraphics(handles.ZXSliceIntersectionHandle); 
                    delete(handles.ZXSliceIntersectionHandle); end
                if isgraphics(handles.XYSliceIntersectionHandle); 
                    delete(handles.XYSliceIntersectionHandle); end
                if isgraphics(handles.XSliceBorderHandle);        
                    delete(handles.XSliceBorderHandle);        end
                if isgraphics(handles.CP);                        
                    delete(handles.CP);                        end
        end
        
        
        if handles.DoXSlice && handles.DoYSlice && handles.DoZSlice
            set(handles.RecordIntersectionButton,'Enable','on')
        else
            set(handles.RecordIntersectionButton,'Enable','off')
        end
        
        if all([~handles.DoXSlice, ~handles.DoYSlice, ~handles.DoZSlice])
            obj1 = findall(handles.RenderingFigure,'Type','Surface');
            obj2 = findall(handles.RenderingFigure,'Type','Line');
            delete(obj1)
            delete(obj2)
        end
        
        if any([handles.DoXSlice, handles.DoYSlice, handles.DoZSlice])
            set(handles.SliceTransparencySlider,'Enable','on')
            set(handles.SliceTransparencyDisplay,'Enable','on')
            if isgraphics(handles.PopOutControllerHandle)
                set(H.SliceTransparencySlider,'Enable','on')
                set(H.SliceTransparencyDisplay,'Enable','on')
            end
        else
            set(handles.SliceTransparencySlider,'Enable','off')
            set(handles.SliceTransparencyDisplay,'Enable','off')
            if isgraphics(handles.PopOutControllerHandle)
                set(H.SliceTransparencySlider,'Enable','off')
                set(H.SliceTransparencyDisplay,'Enable','off')
            end    
        end
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function Y_Plane_Slider_Callback(hObject, eventdata, handles)

            yval = get(handles.Y_Plane_Slider,'Value');
        
            handles.YSliceValue = yval;
            set(handles.YSliceDisplay,'String',sprintf('%5.2f',yval)) 
            
            % Update Pop-Out Controller ---------------------------------------------------------
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                H.Y_Plane_Slider.Value = handles.YSliceValue;
                H.YSliceDisplay.String = sprintf('%5.2f',yval);
                H.YSliceValue = yval;
                guidata(handles.PopOutControllerHandle,H)
            end
            %------------------------------------------------------------------------------------
            if isgraphics(handles.YSliceHandle);              
                delete(handles.YSliceHandle);              end            
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle); end            
            if isgraphics(handles.ZYSliceIntersectionHandle); 
                delete(handles.ZYSliceIntersectionHandle); end            
            if isgraphics(handles.YSliceBorderHandle);        
                delete(handles.YSliceBorderHandle);        end            
            if isgraphics(handles.CP);                        
                delete(handles.CP);                        end
            
            handles = Update_Slice_Plot(handles,2);
            handles = Update_Cells_Near_Slice(handles);
            
            guidata(hObject,handles)
            
%----------------------------------------------------------------------------------------------------
function Y_Plane_Slider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end

%----------------------------------------------------------------------------------------------------
function YSliceCheck_Callback(hObject, eventdata, handles)

                      
            handles.DoXSlice = logical(get(handles.XSliceCheck,'Value'));
            handles.DoYSlice = logical(get(handles.YSliceCheck,'Value'));
            handles.DoZSlice = logical(get(handles.ZSliceCheck,'Value'));

            if handles.DoYSlice
                set(handles.Y_Plane_Slider,'Enable','on')
                set(handles.YSliceDisplay,'Enable','on')
                set(handles.YLow,'Enable','on')
                set(handles.YHigh,'Enable','on')
                %---------------------------------------------------------------
                if isgraphics(handles.PopOutControllerHandle)
                    H = guidata(handles.PopOutControllerHandle);
                    set(H.YSliceCheck,'Value',handles.DoYSlice)
                    set(H.Y_Plane_Slider,'Enable','on')
                    set(H.YSliceDisplay,'Enable','on')
                    set(H.YLow,'Enable','on')
                    set(H.YHigh,'Enable','on')
                    H.DoYSlice = true;
                    guidata(handles.PopOutControllerHandle,H)
                end
                %---------------------------------------------------------------
                if isgraphics(handles.CP); 
                    delete(handles.CP); 
                end
                handles.DoYSlice = true;
                handles = Update_Slice_Plot(handles,2);
                handles = Update_Cells_Near_Slice(handles);
                
            else
                set(handles.Y_Plane_Slider,'Enable','off')
                set(handles.YSliceDisplay,'Enable','off')
                set(handles.YLow,'Enable','off')
                set(handles.YHigh,'Enable','off')
                handles.DoYSlice = false;
                %---------------------------------------------------------------
                if isgraphics(handles.PopOutControllerHandle)
                    H = guidata(handles.PopOutControllerHandle);
                    set(H.YSliceCheck,'Value',handles.DoYSlice)
                    set(H.Y_Plane_Slider,'Enable','off')
                    set(H.YSliceDisplay,'Enable','off')
                    set(H.YLow,'Enable','off')
                    set(H.YHigh,'Enable','off')
                    H.DoYSlice = false;
                    guidata(handles.PopOutControllerHandle,H)
                end
                %---------------------------------------------------------------
                handles = Update_Cells_Near_Slice(handles);
                
                if isgraphics(handles.YSliceHandle);              
                    delete(handles.YSliceHandle);              end                
                if isgraphics(handles.ZYSliceIntersectionHandle); 
                    delete(handles.ZYSliceIntersectionHandle); end            
                if isgraphics(handles.XYSliceIntersectionHandle); 
                    delete(handles.XYSliceIntersectionHandle); end                
                if isgraphics(handles.YSliceBorderHandle);        
                    delete(handles.YSliceBorderHandle);        end                
                if isgraphics(handles.CP);                        
                    delete(handles.CP);                        end
            end

            if handles.DoXSlice && handles.DoYSlice && handles.DoZSlice
                set(handles.RecordIntersectionButton,'Enable','on')
            else
                set(handles.RecordIntersectionButton,'Enable','off')
            end
            
            if all([~handles.DoXSlice, ~handles.DoYSlice, ~handles.DoZSlice])
                obj1 = findall(handles.RenderingFigure,'Type','Surface');
                obj2 = findall(handles.RenderingFigure,'Type','Line');
                delete(obj1)
                delete(obj2)
            end

            if any([handles.DoXSlice, handles.DoYSlice, handles.DoZSlice])
                set(handles.SliceTransparencySlider,'Enable','on')
                set(handles.SliceTransparencyDisplay,'Enable','on')
                if isgraphics(handles.PopOutControllerHandle)
                    set(H.SliceTransparencySlider,'Enable','on')
                    set(H.SliceTransparencyDisplay,'Enable','on')
                end
            else
                set(handles.SliceTransparencySlider,'Enable','off')
                set(handles.SliceTransparencyDisplay,'Enable','off')
                 if isgraphics(handles.PopOutControllerHandle)
                    set(H.SliceTransparencySlider,'Enable','off')
                    set(H.SliceTransparencyDisplay,'Enable','off')
                end
            end
            
            guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function Z_Plane_Slider_Callback(hObject, eventdata, handles)
 
            zval = get(handles.Z_Plane_Slider,'Value'); % <----
            handles.ZSliceValue = zval;
            set(handles.ZSliceDisplay,'String',sprintf('%5.2f',zval)) 
            
            % Update Pop-Out Controller ---------------------------------------------------------
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                H.Z_Plane_Slider.Value = handles.ZSliceValue;
                H.ZSliceDisplay.String = sprintf('%5.2f',zval);
                H.ZSliceValue = zval;
                guidata(handles.PopOutControllerHandle,H)
            end
            %------------------------------------------------------------------------------------
            
            if isgraphics(handles.ZSliceHandle);              
                delete(handles.ZSliceHandle);              end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.ZYSliceIntersectionHandle); 
                delete(handles.ZYSliceIntersectionHandle); end
            if isgraphics(handles.ZSliceBorderHandle);        
                delete(handles.ZSliceBorderHandle);        end
            if isgraphics(handles.CP);                        
                delete(handles.CP);                        end
            
            handles = Update_Slice_Plot(handles,3);
            handles = Update_Cells_Near_Slice(handles);
            
            guidata(hObject,handles)
    
%----------------------------------------------------------------------------------------------------
function Z_Plane_Slider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
        
%----------------------------------------------------------------------------------------------------
function ZSliceCheck_Callback(hObject, eventdata, handles)

    
            
        handles.DoXSlice = logical(get(handles.XSliceCheck,'Value'));
        handles.DoYSlice = logical(get(handles.YSliceCheck,'Value'));
        handles.DoZSlice = logical(get(handles.ZSliceCheck,'Value'));
        
        if handles.DoZSlice
            set(handles.Z_Plane_Slider,'Enable','on')
            set(handles.ZSliceDisplay,'Enable','on')
            set(handles.ZLow,'Enable','on')
            set(handles.ZHigh,'Enable','on')
            %---------------------------------------------------------------
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                set(H.ZSliceCheck,'Value',handles.DoZSlice)
                set(H.Z_Plane_Slider,'Enable','on')
                set(H.ZSliceDisplay,'Enable','on')
                set(H.ZLow,'Enable','on')
                set(H.ZHigh,'Enable','on')
                H.DoZSlice = true;
                guidata(handles.PopOutControllerHandle,H)
            end
            %---------------------------------------------------------------
            
            if isgraphics(handles.CP); 
                delete(handles.CP); 
            end
            handles.DoZSlice = true;
            handles = Update_Slice_Plot(handles,3);
            handles = Update_Cells_Near_Slice(handles);
        else
            set(handles.Z_Plane_Slider,'Enable','off')
            set(handles.ZSliceDisplay,'Enable','off')
            set(handles.ZLow,'Enable','off')
            set(handles.ZHigh,'Enable','off')
            handles.DoZSlice = false;
            %---------------------------------------------------------------
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                set(H.ZSliceCheck,'Value',handles.DoZSlice)
                set(H.Z_Plane_Slider,'Enable','off')
                set(H.ZSliceDisplay,'Enable','off')
                set(H.ZLow,'Enable','off')
                set(H.ZHigh,'Enable','off')
                H.DoZSlice = false;
                guidata(handles.PopOutControllerHandle,H)
            end
            %---------------------------------------------------------------
            handles = Update_Cells_Near_Slice(handles);
            
            % set(0,'CurrentFigure',handles.RenderingFigure)
            
            if isgraphics(handles.ZSliceHandle);              
                delete(handles.ZSliceHandle);              end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.ZYSliceIntersectionHandle); 
                delete(handles.ZYSliceIntersectionHandle); end
            if isgraphics(handles.ZSliceBorderHandle);        
                delete(handles.ZSliceBorderHandle);        end
            if isgraphics(handles.CP);                        
                delete(handles.CP);                        end
            
        end
        
        if handles.DoXSlice && handles.DoYSlice && handles.DoZSlice
            set(handles.RecordIntersectionButton,'Enable','on')
        else
            set(handles.RecordIntersectionButton,'Enable','off')
        end
        
        if all([~handles.DoXSlice, ~handles.DoYSlice, ~handles.DoZSlice])
            obj1 = findall(handles.RenderingFigure,'Type','Surface');
            obj2 = findall(handles.RenderingFigure,'Type','Line');
            delete(obj1)
            delete(obj2)
        end
                
        
        if any([handles.DoXSlice, handles.DoYSlice, handles.DoZSlice])
            set(handles.SliceTransparencySlider,'Enable','on')
            set(handles.SliceTransparencyDisplay,'Enable','on')
            if isgraphics(handles.PopOutControllerHandle)
                set(H.SliceTransparencySlider,'Enable','on')
                set(H.SliceTransparencyDisplay,'Enable','on')
            end
        else
            set(handles.SliceTransparencySlider,'Enable','off')
            set(handles.SliceTransparencyDisplay,'Enable','off')
            if isgraphics(handles.PopOutControllerHandle)
                set(H.SliceTransparencySlider,'Enable','off')
                set(H.SliceTransparencyDisplay,'Enable','off')
            end
        end
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function ColormapPulldown_Callback(hObject, eventdata, handles)

        val = get(handles.ColormapPulldown,'Value');
        figure(handles.RenderingFigure);
        colormap(eval(handles.ColormapPulldown.String{val}))
        handles.ColorMap = handles.ColormapPulldown.String{val};
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function ColormapPulldown_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end
      
%----------------------------------------------------------------------------------------------------
function CamProjButton_Callback(hObject, eventdata, handles)

        val = logical(get(handles.CamProjButton,'Value'));
        
        figure(handles.RenderingFigure)
        
        if val
            set(handles.CamProjButton,'String','Proj: Orthographic','Value',1);
            handles.Projection = 'orthographic';
            camproj(handles.Projection)
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                set(H.CamProjButton,'String','Proj: Orthographic','Value',1);
                H.Projection = 'orthographic';
            end
        else
            set(handles.CamProjButton,'String','Proj: Perspective','Value',0);
            handles.Projection = 'perspective';
            camproj(handles.Projection)
            if isgraphics(handles.PopOutControllerHandle)
                H = guidata(handles.PopOutControllerHandle);
                set(H.CamProjButton,'String','Proj: Perspective','Value',0);
                H.Projection = 'perspective';
            end
        end
            
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function FaceTransparencySlider_Callback(hObject, eventdata, handles)
            
        FH = WaitToUpdateRendering;
        drawnow
        
        val = round(get(handles.FaceTransparencySlider,'Value'));
        set(handles.FaceTransparencySlider,'Value',val)
        set(handles.FaceTransparencyDisplay,'String',['Face Transparency: ' sprintf('%3.0f',val) '%'])
        handles.FaceTransparency = val;
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        
        try; close(FH); end
        
        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function FaceTransparencySlider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end

%----------------------------------------------------------------------------------------------------
function ViewAngleDisplay_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
        
%----------------------------------------------------------------------------------------------------
function FaceColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.FaceColor = c;
            handles.FaceColorButton.Value = 0;
            handles.FaceColorButton.BackgroundColor = handles.FaceColor;
        else
            handles.FaceColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        guidata(hObject,handles)
         
%----------------------------------------------------------------------------------------------------
function FaceCheck_Callback(hObject, eventdata, handles)
        
        handles.ShowFace = logical(handles.FaceCheck.Value);
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function MeshColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.MeshColor = c;
            handles.MeshColorButton.Value = 0;
            handles.MeshColorButton.BackgroundColor = handles.MeshColor;
        else
            handles.MeshColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function MeshCheck_Callback(hObject, eventdata, handles)

        handles.ShowMesh = logical(handles.MeshCheck.Value);
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function BackgroundColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.BackgroundColorButton.Value = 0;
            handles.BackgroundColorButton.BackgroundColor = c;
            handles.BackgroundColor = c;
        else
            handles.BackgroundColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        
        guidata(hObject,handles)


%----------------------------------------------------------------------------------------------------
function AxesColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.AxesColorButton.Value = 0;
            handles.AxesColorButton.BackgroundColor = c;
            handles.AxesColor = c;
        else
            handles.AxesColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        
        guidata(hObject,handles)


%----------------------------------------------------------------------------------------------------
function GridColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.GridColorButton.Value = 0;
            handles.GridColorButton.BackgroundColor = c;
            handles.GridColor = c;
        else
            handles.GridColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function MeshTransparencySlider_Callback(hObject, eventdata, handles)

        FH = WaitToUpdateRendering; drawnow
        
        val = round(get(handles.MeshTransparencySlider,'Value'));
        set(handles.MeshTransparencySlider,'Value',val)
        set(handles.MeshTransparencyDisplay,'String',['Mesh Transparency: ' sprintf('%3.0f',val) '%'])
        handles.MeshTransparency = val;
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        
        try; close(FH); end
        
        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function MeshTransparencySlider_CreateFcn(hObject, eventdata, handles)


        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end

%----------------------------------------------------------------------------------------------------
function ViewAngleSlider_Callback(hObject, eventdata, handles)

        val = (round(10*get(handles.ViewAngleSlider,'Value')))./10;
        set(handles.ViewAngleSlider,'Value',val)
        set(handles.ViewAngleDisplay,'String',['View Angle Zoom: ' sprintf('%3.1f',val) ' deg'])
        handles.ViewAngle = val;
        set(handles.AxisHandle,'CameraViewAngle',handles.ViewAngle)
        %-----------------------------------------------------------------------------------------
        if isgraphics(handles.PopOutControllerHandle)
            H = guidata(handles.PopOutControllerHandle);
            H.ViewAngleSlider.Value = val;
            H.ViewAngleDisplay.String = ['View Angle Zoom: ' sprintf('%3.1f',val) ' deg'];
            H.ViewAngle = val;
            guidata(handles.PopOutControllerHandle,H)
        end
        %-----------------------------------------------------------------------------------------
        guidata(hObject,handles)
        
%----------------------------------------------------------------------------------------------------
function ViewAngleSlider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
   
%----------------------------------------------------------------------------------------------------
function HighlightColorButton_Callback(hObject, eventdata, handles)

        c = uisetcolor;
        
        if ~isequal(0,c)
            handles.HighlightColorButton.Value = 0;
            handles.HighlightColorButton.BackgroundColor = c;
            handles.HighlightColor = c;
        else
            handles.HighlightColorButton.Value = 0;
        end
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function HighlightColorButton_CreateFcn(hObject, eventdata, handles)
    

%----------------------------------------------------------------------------------------------------
function High_Size_Filter_Input_Callback(hObject, eventdata, handles)

    
        HighVal =  round(str2double(get(handles.High_Size_Filter_Input, 'String')));
        
        if ~isnan(HighVal)
            handles.HighSizeFilter = HighVal;
            set(handles.High_Size_Filter_Input,'String',sprintf('%4d',handles.HighSizeFilter));
        else
            
            set(handles.High_Size_Filter_Input,'String',sprintf('%4d',handles.HighSizeFilter))
        end        
        
        PW = str2double(get(handles.Pixel_Width_Input,'String')); % Pixel Width (um)
        ZS = str2double(get(handles.Z_Step_Input,'String'));      % Z-Step (um)

        VS = ZS.*PW^2; % um^3 (uL)
        handles.VoxelSize = VS;
        set(handles.Low_Size_Filter_Input, 'String',sprintf('%4d',handles.LowSizeFilter));
        set(handles.High_Size_Filter_Input,'String',sprintf('%4d',handles.HighSizeFilter));

        text0 = ['1 voxel = ',      sprintf('%5.4f',handles.VoxelSize),...
                 ' ', texlabel('mu'), 'm', texlabel('^3')];
        text1 = ['Low Filter =  ',  sprintf('%5.1f',VS*handles.LowSizeFilter),   ' ',...
            texlabel('mu'), 'm', texlabel('^3')];
        text2 = ['High Filter =  ', sprintf('%4.1f',VS*handles.HighSizeFilter),  ' ',...
            texlabel('mu'), 'm', texlabel('^3')];

        if ishandle(handles.FilterText)
            delete(handles.FilterText)
        end

        handles.FilterText = text(handles.FilterVolumeDisplay,1,0.5,{text0, text1 , text2},...
                                               'FontName','Monospaced',...
                                               'FontWeight','bold',...
                                               'FontSize',9,'Color',[0 0 0],...
                                               'HorizontalAlignment','right');

        set(handles.FilterVolumeDisplay,'Visible','off')
                    
        guidata(hObject,handles)

%----------------------------------------------------------------------------------------------------
function High_Size_Filter_Input_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end

% --------------------------------------------------------------------
function [ center, radii, evecs, v, chi2 ] = ellipsoid_fit( X, equals )
            %
        % Fit an ellispoid/sphere/paraboloid/hyperboloid to a set of xyz data points:
        %
        %   [center, radii, evecs, pars ] = ellipsoid_fit( X )
        %   [center, radii, evecs, pars ] = ellipsoid_fit( [x y z] );
        %   [center, radii, evecs, pars ] = ellipsoid_fit( X, 1 );
        %   [center, radii, evecs, pars ] = ellipsoid_fit( X, 2, 'xz' );
        %   [center, radii, evecs, pars ] = ellipsoid_fit( X, 3 );
        %
        % Parameters:
        % * X, [x y z]   - Cartesian data, n x 3 matrix or three n x 1 vectors
        % * flag         - '' or empty fits an arbitrary ellipsoid (default),
        %                - 'xy' fits a spheroid with x- and y- radii equal
        %                - 'xz' fits a spheroid with x- and z- radii equal
        %                - 'xyz' fits a sphere
        %                - '0' fits an ellipsoid with its axes aligned along [x y z] axes
        %                - '0xy' the same with x- and y- radii equal
        %                - '0xz' the same with x- and z- radii equal
        %
        % Output:
        % * center    -  ellispoid or other conic center coordinates [xc; yc; zc]
        % * radii     -  ellipsoid or other conic radii [a; b; c]
        % * evecs     -  the radii directions as columns of the 3x3 matrix
        % * v         -  the 10 parameters describing the ellipsoid / conic algebraically: 
        %                Ax^2 + By^2 + Cz^2 + 2Dxy + 2Exz + 2Fyz + 2Gx + 2Hy + 2Iz + J = 0
        % * chi2      -  residual sum of squared errors (chi^2e), this chi2 is in th 
        %                coordinate frame in which the ellipsoid is a unit sphere.
        %
        % Author:
        % Yury Petrov, Oculus VR
        % Date:
        % September, 2015
        %

        narginchk( 1, 3 );  % check input arguments
        if nargin == 1
            equals = ''; % no constraints by default
        end

        if size( X, 2 ) ~= 3
            error( 'Input data must have three columns!' );
        else
            x = X( :, 1 );
            y = X( :, 2 );
            z = X( :, 3 );
        end

        % need nine or more data points
        if length( x ) < 9 && strcmp( equals, '' ) 
           error( 'Must have at least 9 points to fit a unique ellipsoid' );
        end
        if length( x ) < 8 && ( strcmp( equals, 'xy' ) || strcmp( equals, 'xz' ) )
           error( 'Must have at least 8 points to fit a unique ellipsoid with two equal radii' );
        end
        if length( x ) < 6 && strcmp( equals, '0' )
           error( 'Must have at least 6 points to fit a unique oriented ellipsoid' );
        end
        if length( x ) < 5 && ( strcmp( equals, '0xy' ) || strcmp( equals, '0xz' ) )
           error( 'Must have at least 5 points to fit a unique oriented ellipsoid with two equal radii' );
        end
        if length( x ) < 4 && strcmp( equals, 'xyz' );
           error( 'Must have at least 4 points to fit a unique sphere' );
        end

        % fit ellipsoid in the form Ax^2 + By^2 + Cz^2 + 2Dxy + 2Exz + 2Fyz + 2Gx +
        % 2Hy + 2Iz + J = 0 and A + B + C = 3 constraint removing one extra
        % parameter
        if strcmp( equals, '' )
            D = [ x .* x + y .* y - 2 * z .* z, ...
                x .* x + z .* z - 2 * y .* y, ...
                2 * x .* y, ...
                2 * x .* z, ...
                2 * y .* z, ...
                2 * x, ...
                2 * y, ...
                2 * z, ...
                1 + 0 * x ];  % ndatapoints x 9 ellipsoid parameters
        elseif strcmp( equals, 'xy' )
            D = [ x .* x + y .* y - 2 * z .* z, ...
                2 * x .* y, ...
                2 * x .* z, ...
                2 * y .* z, ...
                2 * x, ...
                2 * y, ...
                2 * z, ...
                1 + 0 * x ];  % ndatapoints x 8 ellipsoid parameters
        elseif strcmp( equals, 'xz' )
            D = [ x .* x + z .* z - 2 * y .* y, ...
                2 * x .* y, ...
                2 * x .* z, ...
                2 * y .* z, ...
                2 * x, ...
                2 * y, ...
                2 * z, ...
                1 + 0 * x ];  % ndatapoints x 8 ellipsoid parameters
            % fit ellipsoid in the form Ax^2 + By^2 + Cz^2 + 2Gx + 2Hy + 2Iz = 1
        elseif strcmp( equals, '0' )
            D = [ x .* x + y .* y - 2 * z .* z, ...
                  x .* x + z .* z - 2 * y .* y, ...
                  2 * x, ...
                  2 * y, ... 
                  2 * z, ... 
                  1 + 0 * x ];  % ndatapoints x 6 ellipsoid parameters
            % fit ellipsoid in the form Ax^2 + By^2 + Cz^2 + 2Gx + 2Hy + 2Iz = 1,
            % where A = B or B = C or A = C
        elseif strcmp( equals, '0xy' )
            D = [ x .* x + y .* y - 2 * z .* z, ...
                  2 * x, ...
                  2 * y, ... 
                  2 * z, ... 
                  1 + 0 * x ];  % ndatapoints x 5 ellipsoid parameters
        elseif strcmp( equals, '0xz' )
            D = [ x .* x + z .* z - 2 * y .* y, ...
                  2 * x, ...
                  2 * y, ... 
                  2 * z, ... 
                  1 + 0 * x ];  % ndatapoints x 5 ellipsoid parameters
             % fit sphere in the form A(x^2 + y^2 + z^2) + 2Gx + 2Hy + 2Iz = 1
        elseif strcmp( equals, 'xyz' )
            D = [ 2 * x, ...
                  2 * y, ... 
                  2 * z, ... 
                  1 + 0 * x ];  % ndatapoints x 4 ellipsoid parameters
        else
            error( [ 'Unknown parameter value ' equals '!' ] );
        end

        % solve the normal system of equations
        d2 = x .* x + y .* y + z .* z; % the RHS of the llsq problem (y's)
        
        warning off
        u = ( D' * D ) \ ( D' * d2 );  % solution to the normal equations
        % find the residual sum of errors
        % chi2 = sum( ( 1 - ( D * u ) ./ d2 ).^2 ); 
        % this chi2 is in the coordinate frame in which the ellipsoid is a unit sphere.

        % find the ellipsoid parameters
        % convert back to the conventional algebraic form
        if strcmp( equals, '' )
            v(1) = u(1) +     u(2) - 1;
            v(2) = u(1) - 2 * u(2) - 1;
            v(3) = u(2) - 2 * u(1) - 1;
            v( 4 : 10 ) = u( 3 : 9 );
        elseif strcmp( equals, 'xy' )
            v(1) = u(1) - 1;
            v(2) = u(1) - 1;
            v(3) = -2 * u(1) - 1;
            v( 4 : 10 ) = u( 2 : 8 );
        elseif strcmp( equals, 'xz' )
            v(1) = u(1) - 1;
            v(2) = -2 * u(1) - 1;
            v(3) = u(1) - 1;
            v( 4 : 10 ) = u( 2 : 8 );
        elseif strcmp( equals, '0' )
            v(1) = u(1) +     u(2) - 1;
            v(2) = u(1) - 2 * u(2) - 1;
            v(3) = u(2) - 2 * u(1) - 1;
            v = [ v(1) v(2) v(3) 0 0 0 u( 3 : 6 )' ];
        elseif strcmp( equals, '0xy' )
            v(1) = u(1) - 1;
            v(2) = u(1) - 1;
            v(3) = -2 * u(1) - 1;
            v = [ v(1) v(2) v(3) 0 0 0 u( 2 : 5 )' ];
        elseif strcmp( equals, '0xz' )
            v(1) = u(1) - 1;
            v(2) = -2 * u(1) - 1;
            v(3) = u(1) - 1;
            v = [ v(1) v(2) v(3) 0 0 0 u( 2 : 5 )' ];
        elseif strcmp( equals, 'xyz' )
            v = [ -1 -1 -1 0 0 0 u( 1 : 4 )' ];
        end
        v = v';

        % form the algebraic form of the ellipsoid
        A = [ v(1) v(4) v(5) v(7); ...
              v(4) v(2) v(6) v(8); ...
              v(5) v(6) v(3) v(9); ...
              v(7) v(8) v(9) v(10) ];
        % find the center of the ellipsoid
        center = -A( 1:3, 1:3 ) \ v( 7:9 );
        % form the corresponding translation matrix
        T = eye( 4 );
        T( 4, 1:3 ) = center';
        % translate to the center
        R = T * A * T';
        % solve the eigenproblem
        [ evecs, evals ] = eig( R( 1:3, 1:3 ) / -R( 4, 4 ) );
        radii = sqrt( 1 ./ diag( abs( evals ) ) );
        sgns = sign( diag( evals ) );
        radii = radii .* sgns;

        % calculate difference of the fitted points from the actual data normalized by the conic radii
        d = [ x - center(1), y - center(2), z - center(3) ]; % shift data to origin
        d = d * evecs; % rotate to cardinal axes of the conic;
        d = [ d(:,1) / radii(1), d(:,2) / radii(2), d(:,3) / radii(3) ]; % normalize to the conic radii
        chi2 = sum( abs( 1 - sum( d.^2 .* repmat( sgns', size( d, 1 ), 1 ), 2 ) ) );

        if abs( v(end) ) > 1e-6
            v = -v / v(end); % normalize to the more conventional form with constant term = -1
        else
            v = -sign( v(end) ) * v;
        end


%----------------------------------------------------------------------------------------------------
function SingleCellDisplayStyle_PullDown_Callback(hObject, eventdata, handles)

            val = get(handles.SingleCellDisplayStyle_PullDown,'Value');

            switch val
                case 1
                    handles.SingleCellDisplayStyle = 'nodata';
                case 2
                    handles.SingleCellDisplayStyle = 'datasurface';
                case 3
                    handles.SingleCellDisplayStyle = 'datapoints';
            end

            handles = Update_SingleCellAxis(handles, handles.CurrentlySelectedCell);
            
            guidata(hObject,handles)


%----------------------------------------------------------------------------------------------------
function SingleCellDisplayStyle_PullDown_CreateFcn(hObject, eventdata, handles)

            if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
                set(hObject,'BackgroundColor','white');
            end


%----------------------------------------------------------------------------------------------------
function DataFitTechnique_PullDown_Callback(hObject, eventdata, handles)

            val = get(handles.DataFitTechnique_PullDown,'Value');

            switch val
                case 1
                    handles.DataFitMethod = 'nofit';
                    set(handles.VectorDisplay_Listbox,'Enable','off','Value',1)  
                    % Turn off Vectors -----------------------------------------
                    handles.ShowVectors = false;
                    set(handles.VectorDisplay_Listbox,'Enable','off','Value',1)
                    set(handles.VectorColor_Button,'Enable','off')
                    set(handles.VectorRadiusInput,'Enable','off')
                    set(handles.VectorLengthInput,'Enable','off')
                    set(handles.PolarHistButton,'Enable','off')
                    set(handles.PolarHistButton_Point,'Enable','off')
                    set(handles.VectorRadiusInput,'Enable','off')
                    set(handles.VectorLengthInput,'Enable','off')
                    set(handles.R1R2FilterButton,'Enable','off')
                    set(handles.MBSD_MBCD_FilterButton,'Enable','off')
                    set(handles.R2R3FilterButton,'Enable','off')
                    set(handles.VolumeDiffFilterButton,'Enable','off')
                    set(handles.CalculateConvergencePointButton,'Enable','off')
                    set(handles.BuildUrchinPlotButton,'Enable','off')
                    for k = 1:length(handles.VectorHandles)
                        delete(handles.VectorHandles{k,1})
                    end
                    handles.VectorHandles = [];
                    handles.VectorData = [];
                    %------------------------------------------------------------
                case 2
                    handles.DataFitMethod = 'ellipsoidfit';
                    set(handles.VectorDisplay_Listbox,'Enable','on','Value',1) 
            end
            
            handles = Update_SingleCellAxis(handles, handles.CurrentlySelectedCell);
            
            guidata(hObject,handles)
            
%----------------------------------------------------------------------------------------------------
function DataFitTechnique_PullDown_CreateFcn(hObject, eventdata, handles)

            if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
                set(hObject,'BackgroundColor','white');
            end


%----------------------------------------------------------------------------------------------------
function HideEdgeCellsButton_Callback(hObject, eventdata, handles)
                
            %-- Record Visibility State for Undo Button -----------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %------------------------------------------------------------------------------------------------  

            FP = WaitToProcessDialogue; % try; close(FP); end
            % Data = handles.DataTable.Data;
            nObjects = length(handles.IsoSurfaceHandles);
            
            for n = 1:nObjects
                if handles.PartialCell(n,1)
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                    set(handles.IsoCapHandles{n,1},'Visible','off')
                    handles.ObjVisible(n,1) = false;
                    handles.ObjSelected(n,1) = false;
                end
            end
            handles = Update_Cells_Near_Slice(handles);
            drawnow
            
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------
            
            set(0,'CurrentFigure',handles.RenderingFigure)
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            guidata(hObject,handles)    
            
            try close(FP); end
            
%----------------------------------------------------------------------------------------------------
function ResetAllCellsButton_Callback(hObject, eventdata, handles)

            %-- Record Visibility State for Undo Button -----------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %------------------------------------------------------------------------------------------------  

            FP = WaitToProcessDialogue; % try; close(FP); end
            drawnow
            % Data = handles.DataTable.Data;
            nObjects = length(handles.IsoSurfaceHandles);
            handles.ObjVisible  = true(nObjects,1);
            handles.ObjSelected = false(nObjects,1);
            
            for n = 1:nObjects
                    set(handles.IsoSurfaceHandles{n,1},'Visible','on')
                    set(handles.IsoCapHandles{n,1},'Visible','on')
                    %handles = Update_Single_Cell(handles,n);
            end
                              
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------
            
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            set(0,'CurrentFigure',handles.RenderingFigure)
            handles = Update_Cells_Near_Slice(handles);
                                                            
            %-- Record Action for Undo Button -------------------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %-----------------------------------------------------------------------------------------------    
            
            guidata(hObject,handles)
            
            drawnow 
            
            try close(FP); end
    
%----------------------------------------------------------------------------------------------------
function ShowAxesCheck_Callback(hObject, eventdata, handles)

            val = logical(get(handles.ShowAxesCheck,'Value'));

            if val
                handles.ShowAxes = true;
                set(0,'CurrentFigure',handles.RenderingFigure)
                axis on
            else
                handles.ShowAxes = false;
                set(0,'CurrentFigure',handles.RenderingFigure)
                axis off
            end

            guidata(hObject,handles)
    
    
%----------------------------------------------------------------------------------------------------
function ShowBoxCheck_Callback(hObject, eventdata, handles)

    
            val = logical(get(handles.ShowBoxCheck,'Value'));

            if val
                handles.ShowBox = true;
                set(0,'CurrentFigure',handles.RenderingFigure)
                box on
            else
                handles.ShowBox = false;
                set(0,'CurrentFigure',handles.RenderingFigure)
                box off
            end

            guidata(hObject,handles)
    
        
%----------------------------------------------------------------------------------------------------
function ShowColorbarCheck_Callback(hObject, eventdata, handles)
    
            
            val = logical(get(handles.ShowColorbarCheck,'Value'));
            set(0,'CurrentFigure',handles.RenderingFigure)
            
            if val && any([handles.DoXSlice ; handles.DoYSlice ; handles.DoZSlice])
                handles.ColorbarHandle = colorbar;
                handles.ColorbarHandle.Label.String = 'Pixel Intensity (8bit)';
                handles.ColorbarHandle.Label.FontSize = 12;
                handles.ColorbarHandle.Ticks = [0 50 100 150 200 250];
                caxis([0 250]);
                hold off
                axis(handles.AxisRange)
            else 
                if ishandle(handles.ColorbarHandle)
                    delete(handles.ColorbarHandle)
                end
                
            end
    
            guidata(hObject,handles)
            
%----------------------------------------------------------------------------------------------------
function HideAllButton_Callback(hObject, eventdata, handles)

             FP = WaitToProcessDialogue; % try; close(FP); end   
             drawnow
            %-- Record Visibility State for Undo Button -----------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %------------------------------------------------------------------------------------------------  
    
           
            
            nObjects = length(handles.IsoSurfaceHandles);
            handles.ObjVisible  = false(nObjects,1);
            handles.ObjSelected = false(nObjects,1);
            
            for n = 1:nObjects
                set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                set(handles.IsoCapHandles{n,1},'Visible','off')
            end
            
            drawnow
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------
            set(0,'CurrentFigure',handles.RenderingFigure)
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            guidata(hObject,handles)

            try close(FP); end   
            
%-----------------------------------------------------------------------------------------------
function UnHLAll_Button_Callback(hObject, eventdata, handles)
    
        button = questdlg('Are you sure you want to Un-Highlight all cells?',...
            'Quit Verification','Yes','No','No');
        if strcmp(button,'Yes')
            FP = WaitToUpdateRendering; 
            drawnow
            nObjects = length(handles.IsoSurfaceHandles);
            handles.ObjSelected = false(nObjects,1);
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------  
            set(0,'CurrentFigure',handles.RenderingFigure)
            handles = Update_Rendering(handles);
            handles = Update_Cells_Near_Slice(handles);
            drawnow
            guidata(hObject,handles)
            try close(FP); end   
        end
        
%-----------------------------------------------------------------------------------------------
function SaveImageDataButton_Callback(hObject, eventdata, handles)
                   
                [FileName,PathName,FilterIndex] = uiputfile('*.mat','Save Post-Processed Image Data');
            
                        HANDLES.FileName     = handles.FileName;
                        HANDLES.nZ           = handles.nZ;
                        HANDLES.ImX          = handles.ImX;
                        HANDLES.ImY          = handles.ImY;
                        HANDLES.IMStack      = handles.IMstack;   % Create Space for Raw Data Image Array
                        HANDLES.BinaryVoxels = handles.BinaryVoxels; % Create Space for Binary Image Array
                        HANDLES.DistanceTransform  = handles.DistanceTransform;
                        %------------------------------------------------------------------------------
                        HANDLES.Z           = 1; 
                        HANDLES.Z1          = handles.Z1;
                        HANDLES.Z2          = handles.Z2;
                        HANDLES.PixelWidth  = handles.PixelWidth; % Pixel width (microns)
                        HANDLES.ZStep       = handles.ZStep;      % Z depth (microns)
                        HANDLES.ImXdata     = handles.ImXdata;
                        HANDLES.ImYdata     = handles.ImYdata;
                        HANDLES.ImZdata     = handles.ImZdata;
                        HANDLES.XAxisLimits = handles.XAxisLimits;
                        HANDLES.YAxisLimits = handles.YAxisLimits; 
                        HANDLES.Ztext       = handles.Ztext;
                        %------------------------------------------------------------------------------
                        HANDLES.ShowFace    = handles.ShowFace;
                        HANDLES.ShowMesh    = handles.ShowMesh;
                        HANDLES.FaceTransparency = handles.FaceTransparency;
                        HANDLES.MeshTransparency = handles.MeshTransparency;
                        HANDLES.FaceColor       = handles.FaceColor;
                        HANDLES.MeshColor       = handles.MeshColor;
                        HANDLES.HighlightColor  = handles.HighlightColor;
                        HANDLES.BackgroundColor = handles.BackgroundColor;
                        HANDLES.AxesColor   = handles.AxesColor;
                        HANDLES.GridColor   = handles.GridColor;
                        HANDLES.Projection  = handles.Projection;
                        HANDLES.PixelWidth  = handles.PixelWidth;
                        HANDLES.ZStep       = handles.ZStep;
                        HANDLES.LowSizeFilter  = handles.LowSizeFilter;
                        HANDLES.HighSizeFilter = handles.HighSizeFilter;
                        HANDLES.VoxelSize      = handles.VoxelSize;
                        HANDLES.LowSizeFilter  = handles.LowSizeFilter;
                        HANDLES.HighSizeFilter = handles.HighSizeFilter;
                        %-----------------------------------------------------------------------------
%                         HANDLES.CellIndices = handles.CellIndices;
%                         HANDLES.CellSizes   = handles.CellSizes;
%                         HANDLES.ObjVisible  = handles.ObjVisible;
%                         HANDLES.ObjSelected = handles.ObjSelected;
                        % ---------------------------------------------------------------------------
                        % HANDLES.DataTable   = handles.DataTable.Data;
                        %-----------------------------------------------------------------------------
                        FH = WaitToSaveDialogue;
                        set(0,'CurrentFigure',FH)
                        drawnow
                        save([PathName FileName],'HANDLES','-v7.3')
                        close(FH)
                        
%-----------------------------------------------------------------------------------------------------
function LoadImageDataButton_Callback(hObject, eventdata, handles)

                        [FileName,PathName,FilterIndex] = uigetfile('*.mat','Select LongAxis Data File');
                        
                    if ~isequal(0,FileName)
                        
                        FH = WaitToLoadDialogue;
                        drawnow
                        load(fullfile(PathName, FileName),'-mat','HANDLES')  
                        close(FH)
                        if exist('HANDLES','var')
                            
                            %---------------------------------------------------------------
                            handles.FileName           = HANDLES.FileName;
                            handles.nZ                 = HANDLES.nZ;
                            handles.ImX                = HANDLES.ImX;
                            handles.ImY                = HANDLES.ImY;
                            handles.IMstack            = HANDLES.IMStack;    % Create Space for Image Array
                            % Create Space for Binary Image Array
                            handles.BinaryVoxels       = HANDLES.BinaryVoxels;   
                            handles.DistanceTransform  = HANDLES.DistanceTransform;
                            %---------------------------------------------------------------
                            handles.Z                = HANDLES.Z; 
                            handles.Z1               = HANDLES.Z1;
                            handles.Z2               = HANDLES.Z2;
                            handles.PixelWidth       = HANDLES.PixelWidth; % Pixel width (microns)
                            handles.ZStep            = HANDLES.ZStep;           % Z depth (microns)
                            handles.ImXdata          = HANDLES.ImXdata;
                            handles.ImYdata          = HANDLES.ImYdata;
                            handles.ImZdata          = HANDLES.ImZdata;
                            handles.XAxisLimits      = HANDLES.XAxisLimits;
                            handles.YAxisLimits      = HANDLES.YAxisLimits; 
                            %---------------------------------------------------------------
                            handles.FaceTransparency = HANDLES.FaceTransparency;
                            handles.MeshTransparency = HANDLES.MeshTransparency;
                            handles.ShowFace         = HANDLES.ShowFace;
                            handles.FaceColor        = HANDLES.FaceColor;
                            handles.ShowMesh         = HANDLES.ShowMesh;
                            handles.MeshColor        = HANDLES.MeshColor;
                            handles.HighlightColor   = HANDLES.HighlightColor;
                            handles.BackgroundColor  = HANDLES.BackgroundColor;
                            %----------------------------------------------------------------
                            handles.AxesColor        = HANDLES.AxesColor;
                            handles.GridColor        = HANDLES.GridColor;
                            handles.Projection       = HANDLES.Projection;
                            handles.PixelWidth       = HANDLES.PixelWidth;
                            handles.ZStep            = HANDLES.ZStep;
                            %handles.LowSizeFilter    = HANDLES.LowSizeFilter;
                            %handles.HighSizeFilter   = HANDLES.HighSizeFilter;
                            handles.VoxelSize        = HANDLES.VoxelSize;
                            %----------------------------------------------------------------
                            handles.CellIndices = [];
                            handles.CellSizes   = [];
                            handles.ObjVisible  = [];
                            handles.ObjSelected = [];
                            % Update Cell List ----------------------------------------------------------
                            handles.CellList.Value = 1;
                            handles.CellList.String = {''};
                            handles.CellList.Enable = 'off';
                            % ---------------------------------------------------------------------------
%                             handles.ObjVisible       = HANDLES.ObjVisible;
%                             handles.ObjSelected      = HANDLES.ObjSelected;
%                             handles.DataTable.Data   = HANDLES.DataTable;  
                            %----------------------------------------------------------------  

                            set(handles.Navigation_Figure,'Visible','on')
                            set(handles.ImageFileLocationDisplay,'String',[fullfile(PathName, FileName)])    
                            set(handles.Create_3D_Rendering_Button,'Visible','on','Enable','off')
                            set(handles.HandednessLabel,'Visible','on') 
                            set(handles.EdgeCellsCheck,'Visible','on')
                            set(handles.Z_slider,'Visible','on')
                            set(handles.Z_slider,'SliderStep',[1/handles.nZ 10/handles.nZ],'Min',1,...
                                'Max',handles.nZ,'Value',1,'Enable','on')
                            set(handles.Select_Region_Button,'Value',0,'Enable','on','Visible','on')
                            set(handles.Input_Region_Button,'Value',0,'Enable','on','Visible','on')
                            set(handles.Set_z1_Button,'Visible','on','String', 'z1 = 1','Enable','on')
                            set(handles.Set_z2_Button,'Visible','on','String',...
                                ['z2 = ' num2str(handles.nZ)],'Enable','on')
                            set(handles.PositionDisplay,'Visible','on')
                            set(handles.NavigationPanel,'Visible','on')
                            set(handles.SaveImageDataButton,'Enable','on')    
                            set(handles.Z_Display,'Visible','on')
                            set(handles.CoordsPanel,'Visible','on')  
                            set(handles.SaveAnalysisButton,'Enable','off')
                            set(handles.LoadAnalysisButton,'Enable','on')
                            set(handles.Pixel_Width_Input,'String',handles.PixelWidth); 
                            set(handles.Z_Step_Input,     'String',handles.ZStep); 
%                             handles.DataTable.CellSelectionCallback = [];
%                             handles.DataTable.CellEditCallback = [];
%                             handles.DataTable.Data = cell(0,4);
                            handles.Z1 = 1;
                            handles.Z2 = handles.nZ;
                            %-------------------------------------------------------------------------------         
                            handles.Z = round(get(handles.Z_slider,'Value'));
                            z  = sprintf('%3d',handles.Z);
                            zm = handles.Z * handles.ZStep;
                            if ishandle(handles.Ztext)
                                delete(handles.Ztext)
                            end
                            text1 = [' Z: ' z  ' (' sprintf('%4.1f',zm) ' ' texlabel('mu') 'm)'];
                            dZ    = handles.Z2 - handles.Z1 + 1;
                            dZs   = sprintf('%3d',dZ);
                            dZsm  = dZ * handles.ZStep;
                            text2 = [texlabel('delta'), 'Z: ', dZs, ' (' sprintf('%4.1f',dZsm),...
                                       ' ', texlabel('mu'), 'm)'];
                            handles.Ztext = text(handles.Z_Display,0,0.5,{text1 , text2},...
                                                  'FontName','Monospaced','FontWeight','bold',...
                                                  'FontSize',11,'Color',[0.64 0.08 0.18]);
                            set(handles.Z_Display,'Visible','off')
                            handles = Update_Navigation_Figure(handles);
                            
                            try; rotate3d(handles.RenderingFigure,'off'); end
                            
                            set(handles.MainFigure1,'KeyPressFcn',@ShortCuts,...
                                                    'WindowButtonMotionFcn',@MotionFcn)
                                            
                            guidata(hObject,handles)
                        else
                            errordlg('The file you selected is not a LongAxis Image Data file.');
                        end
                    end
                    
                    
%----------------------------------------------------------------------------------------------------------
function FH = WaitToSaveDialogue
    
        ScreenSize = get(0,'ScreenSize');  
        FH = figure;
        W = 420;
        H = 150;
        set(FH,'ToolBar','none','MenuBar','none',...
              'NumberTitle','off','Name','Saving Processed Data',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'Saving.'};{'Please wait,'};{'this may take a minute...'}],...
            'FontSize',14,'FontName','Monospaced')
    
    
 %----------------------------------------------------------------------------------------------------------   
 function FH = WaitToLoadDialogue
    
        ScreenSize = get(0,'ScreenSize');  
        FH = figure;
        W = 420;
        H = 150;
        set(FH,'ToolBar','none','MenuBar','none',...
              'NumberTitle','off','Name','Loading Data',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'Loading Data...'};{'Please wait,'};{'this may take a minute.'}],...
            'FontSize',14,'FontName','Monospaced')   

%-----------------------------------------------------------------------------------------------------------   
 function FH = WaitToUpdateRendering
    
        ScreenSize = get(0,'ScreenSize');  
        FH = figure;
        W = 320;
        H = 150;
        set(FH,'ToolBar','none','MenuBar','none','NumberTitle','off','Name','Updating Rendering',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'Updating Rendering...'}],'FontSize',14,'FontName','Monospaced')           
 %-----------------------------------------------------------------------------------------------------------   
 function FA = WaitToLoadAnalysisDialogue
    
        ScreenSize = get(0,'ScreenSize');  
        FA = figure;
        W = 420;
        H = 150;
        set(FA,'ToolBar','none','MenuBar','none',...
              'NumberTitle','off','Name','Loading Analysis File',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'Loading Analysis File...'};{'Please wait,'};{'this may take a minute.'}],...
            'FontSize',14,'FontName','Monospaced')   
 
%------------------------------------------------------------------------------------------------------------           
function FS = CalculatingMBSR    
    
        ScreenSize = get(0,'ScreenSize');  
        FS = figure;
        W = 520;
        H = 200;
        set(FS,'ToolBar','none','MenuBar','none',...
              'NumberTitle','off','Name','Calculating MBSR',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'For backwards compatibility,'};...
                      {'Calculating minimum bounding spheres.'};...
                      {'This will take several minutes.'};...
                      {'Resave this analysis file to skip this'};...
                      {'calculation in the future.'}],...
            'FontSize',14,'FontName','Monospaced')           
        
%------------------------------------------------------------------------------------------------------------   
 function FP = WaitToProcessDialogue
    
        ScreenSize = get(0,'ScreenSize');  
        FP = figure;
        W = 420;
        H = 150;
        set(FP,'ToolBar','none','MenuBar','none',...
              'NumberTitle','off','Name','Loading Data',...
              'Position',[(ScreenSize(3)/2 - W/2) (ScreenSize(4)/2 - H/2) W H])  
        a = gca;
        set(a,'Visible','off','XLim',[0 1],'YLim',[0 1])  
        text(a,0,0.5,[{'Processing Request.'};{'Please wait,'};{'this may take a minute...'}],...
            'FontSize',14,'FontName','Monospaced')        

        
%-----------------------------------------------------------------------------------------------------------   
function VectorDisplay_Listbox_Callback(hObject, eventdata, handles)

        val = get(handles.VectorDisplay_Listbox,'Value');
        handles.VectorType = val;
        if isequal(1,val)
            handles.ShowVectors = false;
            handles = Add_Vectors_To_Main_Figure(handles);
            set(handles.VectorColor_Button,'Enable','off')
            set(handles.VectorRadiusInput, 'Enable','off')
            set(handles.VectorLengthInput, 'Enable','off')
            set(handles.PolarHistButton,   'Enable','off')
            set(handles.PolarHistButton_Point,'Enable','off')
            set(handles.R1R2FilterButton,'Enable','off')
            set(handles.MBSD_MBCD_FilterButton,'Enable','off')
            set(handles.R2R3FilterButton,'Enable','off')
            set(handles.VolumeDiffFilterButton,'Enable','off')
            set(handles.CalculateConvergencePointButton,'Enable','off')
            set(handles.BuildUrchinPlotButton,'Enable','off')
        else
            handles.VectorType = val;
            if ~isempty(handles.VectorHandles) % Erase old vectors before creating new ones
                handles.ShowVectors = false;
                handles = Add_Vectors_To_Main_Figure(handles);
            end
            handles.ShowVectors = true;
            handles = Add_Vectors_To_Main_Figure(handles);
            set(handles.VectorColor_Button,'Enable','on')
            set(handles.VectorRadiusInput,'Enable','on')
            set(handles.VectorLengthInput,'Enable','on')
            set(handles.PolarHistButton,'Enable','on')
            set(handles.PolarHistButton_Point,'Enable','on')
            set(handles.R1R2FilterButton,'Enable','on')
            set(handles.MBSD_MBCD_FilterButton,'Enable','on')
            set(handles.R2R3FilterButton,'Enable','on')
            set(handles.VolumeDiffFilterButton,'Enable','on')
            set(handles.CalculateConvergencePointButton,'Enable','on')
            set(handles.BuildUrchinPlotButton,'Enable','on')
        end
        
        guidata(hObject,handles)
        
%-----------------------------------------------------------------------------------------------------------   
function VectorDisplay_Listbox_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end
        
        
%------------------------------------------------------------------------------------------------------------   
function  [RotationMatrix, RotationAngle] = RotationMatrix3D(U,V)

        % -------------------------------------------------------------------
        % Creates 3D rotation matrix 
        %
        % U = [Ux Uy Uz]; Starting position vector
        % V = [Vx Vy Vz]; Ending position vector
        %
        % KRC 11/2/18
        %
        % For explanation of calculation, see Euler-Rodriques formula
        % https://en.wikipedia.org/wiki/Euler-Rodrigues_formula
        % https://en.wikipedia.org/wiki/Rodrigues%27_rotation_formula
        % --------------------------------------------------------------------

         K = cross(U,V); % Calculate rotation axis vector K using cross product of U and V
        mK = norm(K);    % Calulate vector magnitude
        mU = norm(U);
        mV = norm(V);
         k = K./mK;       % Create unit vector
         
          
         if sign(dot(U,V)) >= 0
             t = asin(mK/(mU*mV)); % calculate rotation angle theta
         else
             t = pi - asin(mK/(mU*mV)); % calculate rotation angle theta
         end
        
        RotationAngle = t*180/pi;
         
        a = cos(t/2);
        b = k(1)*sin(t/2);
        c = k(2)*sin(t/2);
        d = k(3)*sin(t/2);
        
RotationMatrix = [[  (a^2 + b^2 - c^2 - d^2)           2*(b*c-a*d)                2*(b*d+a*c)        ];... 
                  [       2*(b*c+a*d)           (a^2 + c^2 - b^2 - d^2)           2*(c*d-a*b)        ];... 
                  [	      2*(b*d-a*c)                  2*(c*d+a*b)          (a^2 + d^2 - b^2 - c^2)  ]];
          
%-----------------------------------------------------------------------------------------------------------          
function VectorColor_Button_Callback(hObject, eventdata, handles)

            c = uisetcolor;

            if ~isequal(0,c)
                handles.VectorColor_Button.Value = 0;
                handles.VectorColor_Button.BackgroundColor = c;
                handles.VectorColor = c;
                handles = Update_Vectors(handles);     
            else
                handles.VectorColor_Button.Value = 0;
            end

            guidata(hObject,handles)
        
%---------------------------------------------------------------------------------------------------------  
function VectorLengthInput_Callback(hObject, eventdata, handles)

            val = str2double(get(handles.VectorLengthInput,'String'));

            if isnan(val)
                set(handles.VectorLengthInput,'String',num2str(handles.VectorLength))
            else
                handles.VectorLength = val;
                if ~isempty(handles.VectorHandles) % Erase old vectors before creating new ones
                    handles.ShowVectors = false;
                    handles = Add_Vectors_To_Main_Figure(handles);
                end
                handles.ShowVectors = true; % Redraw with new parameters
                handles = Add_Vectors_To_Main_Figure(handles);
            end

            guidata(hObject,handles)

%--------------------------------------------------------------------------------------------------------    
function VectorLengthInput_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end


%---------------------------------------------------------------------------------------------------------    
function VectorRadiusInput_Callback(hObject, eventdata, handles)
    
        val = str2double(get(handles.VectorRadiusInput,'String'));

        if isnan(val)
            set(handles.VectorRadiusInput,'String',num2str(handles.VectorRadius))
        else
            handles.VectorRadius = val;
            if ~isempty(handles.VectorHandles) % Erase old vectors before creating new ones
                handles.ShowVectors = false;
                handles = Add_Vectors_To_Main_Figure(handles);
            end
            handles.ShowVectors = true; % Redraw with new parameters
            handles = Add_Vectors_To_Main_Figure(handles);
        end

        guidata(hObject,handles)
    
%-------------------------------------------------------------------------------------------------------    
function VectorRadiusInput_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end
    
%-------------------------------------------------------------------------------------------------------    
function PolarHistButton_Callback(hObject, eventdata, handles)
    
        N = length(handles.VectorData);
        for k = 1:N
            r1 = handles.VectorData{k,1}.EigenVectors(:,1);
            XZ(k,1) = atan2(r1(3),r1(1)); 
            YZ(k,1) = atan2(r1(3),r1(2)); 
            XY(k,1) = atan2(r1(2),r1(1)); 
        end
        
        figure(2768)
        set(2768,'Color',[1 1 1])
        
        subplot(1,3,1); 
        p1 = polarhistogram([XZ; XZ-pi()],36);
        p1a = get(p1,'Parent');
        RL1 = get(p1a,'RLim');
        title('XZ plane')
        
        subplot(1,3,2); 
        p2 = polarhistogram([YZ; YZ-pi()],36);
        p2a = get(p2,'Parent');
        RL2 = get(p2a,'RLim');
        title('YZ plane')
        
        subplot(1,3,3); 
        p3 = polarhistogram([XY; XY-pi()],36);
        p3a = get(p3,'Parent');
        RL3 = get(p3a,'RLim');
        title('XY plane')
    
%---------------------------------------------------------------------------------
function ViewYZ_Button_Callback(hObject, eventdata, handles)

        if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,90,0) % view(-90,0)
        end
    
%---------------------------------------------------------------------------------
function ViewXZ_Button_Callback(hObject, eventdata, handles)

        if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,0,0) % view(180,0)
        end
    
%---------------------------------------------------------------------------------
function ViewXY_Button_Callback(hObject, eventdata, handles)

         if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,0,90) % view(0,-90)
         end

% ------------------------------------------------------------------------------------------------     
function ViewNegYZ_Button_Callback(hObject, eventdata, handles)

        if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,-90,0) 
        end

% ------------------------------------------------------------------------------------------------     
function ViewNegXZ_Button_Callback(hObject, eventdata, handles)
        
        if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,180,0) 
        end

% ------------------------------------------------------------------------------------------------     
function ViewNegXY_Button_Callback(hObject, eventdata, handles)

         if isgraphics(handles.AxisHandle)
            view(handles.AxisHandle,0,-90)
         end
    
%---------------------------------------------------------------------------------
function Input_Region_Button_Callback(hObject, eventdata, handles)

        prompt = {'R1:','C1:','R2:','C2:'};
        dlg_title = 'Input Selected Region:';
        num_lines = 1;
        defaultans = {'','','',''};
        answer = inputdlg(prompt,dlg_title,[1 50; 1 50; 1 50; 1 50],defaultans);
        if ~isempty(answer)
            v = str2double(answer);
            handles.sPix = [v(1,1), v(2,1)];
            handles.ePix = [v(3,1), v(4,1)];

            [R,C,~] = size(handles.IMstack);
            uPerPixX = diff(handles.Navigation_Figure.XLim)/C;
            uPerPixY = diff(handles.Navigation_Figure.YLim)/R;

            handles.Region_X = uPerPixX*[v(2,1) v(4,1) v(4,1) v(2,1) v(2,1)];
            handles.Region_Y = uPerPixY*[v(1,1) v(1,1) v(3,1) v(3,1) v(1,1)];

            set(0,'CurrentFigure',handles.MainFigure1)
            set(handles.MainFigure1,'CurrentAxes',handles.Navigation_Figure)

            handles = Update_Navigation_Figure(handles);
            set(handles.Create_3D_Rendering_Button,'Enable','on')
            set(handles.HandednessLabel,'Visible','on') 

            guidata(hObject,handles)
        end
        
        
%---------------------------------------------------------------------------------
function OnlyHLCellsVis_Button_Callback(hObject, eventdata, handles)

        button = questdlg('Are you sure you want to make only the highlighted cells visible?',...
            'Quit Verification','Yes','No','No');
        
        if strcmp(button,'Yes')
            
            %-- Record Visibility State for Undo Button -----------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %------------------------------------------------------------------------------------------------  
            
            FP = WaitToUpdateRendering; ; % try; close(FP); end
            drawnow
            
            nObjects = length(handles.ObjVisible);
            handles.ObjVisible = handles.ObjSelected;
            handles.ObjSelected = false(nObjects,1);
            
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % --------------------------------------------------------------------------- 
            
            set(0,'CurrentFigure',handles.RenderingFigure)
            
            handles = Update_Rendering(handles);
            handles = Update_Cells_Near_Slice(handles);
            
            drawnow
            
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])         
            
            guidata(hObject,handles)
            
            try close(FP); end
            
        end
        
%---------------------------------------------------------------------------------    
function u = CoherenceFilter(u,Options)
    
        % This function COHERENCEFILTER will perform Anisotropic Diffusion of a
        % 2D gray/color image or 3D image volume, Which will reduce the noise in
        % an image while preserving the region edges, and will smooth along
        % the image edges removing gaps due to noise.
        %
        % Don't forget to compile the c-code by executing compile_c_files.m
        % 
        % Iout = CoherenceFilter(Iin, Options)
        %
        % inputs,
        %   Iin : 2D gray/color image or 3D image volume. Use double datatype in 2D
        %            and single data type in 3D.  Range of image data must 
        %            be approximately [0 1]
        %   Options : Struct with filtering options
        %   
        % outputs,
        %   Iout : The anisotropic diffusion filtered image
        %
        % Options,
        %   Options.Scheme :  The numerical diffusion scheme used
        %                     'R', Rotation Invariant, Standard Discretization 
        %                          (implicit) 5x5 kernel (Default)
        %                     'O', Optimized Derivative Kernels
        %                     'I', Implicit Discretization (only works in 2D)
        %                     'S', Standard Discretization
        %                     'N', Non-negativity Discretization
        %   Options.T  :      The total diffusion time (default 5)
        %   Options.dt :      Diffusion time stepsize, in case of scheme H,R or I
        %                     defaults to 1, in case of scheme S or N defaults to
        %                     0.15. 
        %   Options.sigma :   Sigma of gaussian smoothing before calculation of the
        %                     image Hessian, default 1.                   
        %   Options.rho :     Rho gives the sigma of the Gaussian smoothing of the 
        %                     Hessian, default 1.
        %   Options.verbose : Show information about the filtering, values :
        %                     'none', 'iter' (default) , 'full'
        %   Options.eigenmode : There are many different equations to make an diffusion tensor,
        %						this value (only 3D) selects one.
        %					    0 (default) : Weickerts equation, line like kernel
        %						1 : Weickerts equation, plane like kernel
        %						2 : Edge enhancing diffusion (EED)
        %						3 : Coherence-enhancing diffusion (CED)
        %						4 : Hybrid Diffusion With Continuous Switch (HDCS)
        %
        % Constants which determine the amplitude of the diffusion smoothing in 
        % Weickert equation
        %   Options.C :     Default 1e-10
        %   Options.m :     Default 1
        %   Options.alpha : Default 0.001
        % Constants which are needed with CED, EED and HDCS eigenmode
        %   Options.lambda_e : Default 0.02, planar structure contrast
        %   Options.lambda_c : Default 0.02, tube like structure contrast
        %   Options.lambda_h : Default 0.5 , treshold between structure and noise
        %                     
        %
        % The basis of the method used is the one introduced by Weickert:
        %   1, Calculate Hessian from every pixel of the gaussian smoothed input image
        %   2, Gaussian Smooth the Hessian, and calculate its eigenvectors and values
        %      (Image edges give large eigenvalues, and the eigenvectors corresponding
        %         to those large eigenvalues describe the direction of the edge)
        %   3, The eigenvectors are used as diffusion tensor directions. The 
        %      amplitude of the diffusion in those 3 directions is determined
        %      by equations below.
        %   4, An Finite Difference scheme is used to do the diffusion
        %   5, Back to step 1, till a certain diffusion time is reached.
        %
        % Weickert equation 2D:
        %    lambda1 = alpha + (1 - alpha)*exp(-C/(mu1-mu2).^(2*m)); 
        %    lambda2 = alpha;
        %
        % 0 : 3D, Weickerts equation, plane line like kernel
        %    lambda1 = alpha + (1 - alpha)*exp(-C/(mu1-mu3).^(2*m)); 
        %    lambda2 = alpha;
        %    lambda3 = alpha;
        %   (with mu1 the largest eigenvalue and mu3 the smallest)
        % 1 : 3D, Weickerts equation, plane line like kernel
        %    lambda1 = alpha + (1 - alpha)*exp(-C/(mu1-mu3).^(2*m)); 
        %    lambda2 = alpha + (1 - alpha)*exp(-C/(mu2-mu3).^(2*m)); 
        %    lambda3 = alpha;
        %   (with mu1 the largest eigenvalue and mu3 the smallest)
        % 2 : 3D, Edge Enhancing diffusion
        %    lambda3e = 1;
        %    lambda2e = 1;
        %    lambda1e = 1 - exp(-3.31488 / (Gradient_Magnitude_Squared / lambda_e^2)^4);
        % 3 : 3D, Coherence Enhancing diffusion
        %    lambda1c = alpha + (1 - alpha)*exp(-ln(2)*lambda_c^2/(mu2/(alpha+mu3))^4)); 
        %    lambda2c = alpha;
        %    lambda3c = alpha;
        % 4 :  Hybrid Diffusion With Continuous Switch
        %	Xi : = (mu1 / (alpha+mu2)) - (mu2 / (alpha+mu3))
        %	epsilon = exp ( mu2*(lambda_h^2(Xi-abs(Xi)-2*mu3) )/ ( 2 * lambda_h^4) )
        %	lambda1 = (1 -epsilon) * lambda1c + epsilon *lambda1e;
        %	lambda2 = (1 -epsilon) * lambda2c + epsilon *lambda2e;
        %	lambda3 = (1 -epsilon) * lambda3c + epsilon *lambda3e;
        %
        % Notes:
        % - The standard and non-negative discretization only allow small time
        %   steps before they become unstable. The Implicit discretization 
        %   was introduced to allow larger diffusion time steps. 
        %   Previous schemes were not rotational invariant, under certain angles
        %   edges blur away. Thus Weickert introduced a rotational invariant scheme.
        %   His scheme sufferes from checkerboard artifacts, due to the central
        %   differences used. This code contains our own improved version of his 
        %   scheme in which  the data is upsampled before calculating the image 
        %   derivatives for the diffusion flux, to prevent those checkerboard artifacts.
        %  
        % - If the time step is choosing to large the scheme becomes unstable, this
        %   can be seen by setting verbose to 'full'. The image variance has to
        %   decrease every itteration if the scheme is stable.
        %
        % Literature used (for the full list see my own paper):
        %  - Weickert : "A Scheme for Coherence-Enhancing Diffusion Filtering
        %                   with Optimized Rotation Invariance"
        %  - Mendrik et al, "Noise Reduction in Computed Tomography Scans Using
        %					3-D Anisotropic Hybrid Diffusion With Continuous 
        %					Switch", October 2009
        %  - Weickert : "Anisotropic Diffusion in Image Processing", Thesis 1996
        %  - Laura Fritz : "Diffusion-Based Applications for Interactive Medical
        %                   Image Segmentation"
        %  - Siham Tabik, et al. : "Multiprocessing of Anisotropic Nonlinear
        %                          Diffusion for filtering 3D image"
        %  
        % example 2d,
        %   I = im2double(imread('images/sync_noise.png'));
        %   JS = CoherenceFilter(I,struct('T',15,'rho',10,'Scheme','S'));
        %   JN = CoherenceFilter(I,struct('T',15,'rho',10,'Scheme','N'));
        %   JR = CoherenceFilter(I,struct('T',15,'rho',10,'Scheme','R'));
        %   JI = CoherenceFilter(I,struct('T',15,'rho',10,'Scheme','I'));
        %   JO = CoherenceFilter(I,struct('T',15,'rho',10,'Scheme','O'));
        %   figure, 
        %   subplot(2,3,1), imshow(I), title('Before Filtering');
        %   subplot(2,3,2), imshow(JI), title('Standard Scheme');
        %   subplot(2,3,3), imshow(JN), title('Non Negative Scheme');
        %   subplot(2,3,4), imshow(JI), title('Implicit Scheme');
        %   subplot(2,3,5), imshow(JR), title('Rotation Invariant Scheme');
        %   subplot(2,3,6), imshow(JO), title('Optimized Scheme');
        % 
        % example 2d, color HDCS 2D not in literature
        %   I = im2double(imread('images/lena.jpg'));
        %   I = I+(rand(size(I))-0.5)*0.3;
        %   JO =      CoherenceFilter(I,struct('T',1,'dt',0.1,'rho',4,'Scheme','O','eigenmode',0));
        %   JO_EED =  CoherenceFilter(I,struct('T',1,'dt',0.1,'rho',4,'Scheme','O','eigenmode',2));
        %   JO_HDCS = CoherenceFilter(I,struct('T',1,'dt',0.1,'rho',4,'Scheme','O','eigenmode',4));
        %   JS_HDCS = CoherenceFilter(I,struct('T',1,'dt',0.1,'rho',4,'Scheme','S','eigenmode',4));
        %   JR_HDCS = CoherenceFilter(I,struct('T',1,'dt',0.1,'rho',4,'Scheme','R','eigenmode',4));
        %
        %   figure, 
        %   subplot(2,3,1), imshow(I), title('Before Filtering');
        %   subplot(2,3,2), imshow(JO), title('Optimized Scheme');
        %   subplot(2,3,3), imshow(JO_EED), title('Edge Enhancing Optimized Scheme');
        %   subplot(2,3,4), imshow(JO_HDCS), title('HDCS Optimized Scheme');
        %   subplot(2,3,5), imshow(JS_HDCS), title('HDCS Standard Scheme');
        %   subplot(2,3,6), imshow(JR_HDCS), title('Rotation invariant Scheme');
        %
        % example 3d,
        %	% First compile the c-code by executing compile_c_files.m
        %   load('images/sphere');
        %   showcs3(V);
        %   JR = CoherenceFilter(V,struct('T',50,'dt',2,'Scheme','R'));
        %   showcs3(JR);
        %
        % example 3d, Mendrik : Hybrid Diffusion October 2009
        %   load('images/sphere');
        %   showcs3(V);
        %   JS = CoherenceFilter(V,struct('T',5,'dt',0.15,'Scheme','S','eigenmode',4));
        %   JO = CoherenceFilter(V,struct('T',5,'dt',0.50,'Scheme','O','eigenmode',4));
        %   showcs3(JS);
        %   showcs3(JO);
        %
        % Written by D.Kroon University of Twente (February 2010)

        % add all needed function paths
        try
            functionname='CoherenceFilter.m';
            functiondir=which(functionname);
            functiondir=functiondir(1:end-length(functionname));
%             addpath([functiondir '/functions2D'])
%             addpath([functiondir '/functions3D'])
%             addpath([functiondir '/functions'])
        catch me
            % disp(me.message);
        end

        % Default parameters
        defaultoptions=struct('T',2,'dt',[],'sigma', 1, 'rho', 1, 'TensorType', 1,...
                              'eigenmode',0,'C', 1e-10, 'm',1,'alpha',0.001,'lambda_e',0.02,...
                              'lambda_c',0.02,'lambda_h',0.5,'RealDerivatives',false,...
                              'Scheme','R','verbose','iter');

        if(~exist('Options','var')),
            Options=defaultoptions;
        else
            tags = fieldnames(defaultoptions);
            for i=1:length(tags)
                if(~isfield(Options,tags{i})),  Options.(tags{i})=defaultoptions.(tags{i}); end
            end
            if(length(tags)~=length(fieldnames(Options))),
                warning('CoherenceFilter:unknownoption','unknown options found');
            end
        end

        if(isempty(Options.dt))
            switch lower(Options.Scheme)
              case 'r', Options.dt=0.15;
              case 'o', Options.dt=0.15;
              case 'i', Options.dt=0.15;
              case 's', Options.dt=0.15;
              case 'n', Options.dt=0.15;
              otherwise
                error('CoherenceFilter:unknownoption','unknown scheme');
            end
        end


        % Initialization
        dt_max = Options.dt; t = 0;

        % In case of 3D use single precision to save memory
        if(size(u,3)<4), u=double(u); else u=single(u); end 

        % Process time
        process_time=tic;

        % Show information 
        switch lower(Options.verbose(1))
        case 'i'
           % disp('Diffusion time   Sec. Elapsed');
        case 'f'
           % disp('Diffusion time   Sec. Elapsed   Image mean    Image variance');
        end        


        % Anisotropic diffusion main loop
        while (t < (Options.T-0.001))
            % Update time, adjust last time step to exactly finish at the wanted
            % diffusion time
            Options.dt = min(dt_max,Options.T-t); t = t + Options.dt;
            tn=toc(process_time);
            switch lower(Options.verbose(1))
            case 'n'
            case 'i'
                s=sprintf('    %5.0f        %5.0f    ',t,round(tn)); % disp(s);
            case 'f'
                s=sprintf('    %5.0f        %5.0f      %13.6g    %13.6g ',t,round(tn),...
                    mean(u(:)), var(u(:))); % disp(s);

            end        

            if(size(u,3)<4) % Check if 2D or 3D
                % Do a diffusion step
                if(strcmpi(Options.Scheme,'R')&&(Options.eigenmode==0)&&(exist('CoherenceFilterStep2D')==3))
                    u=CoherenceFilterStep2D(u,Options);
                else
                    u=Anisotropic_step2D(u,Options);
                end
            else
                % Do a diffusion step
                if(strcmpi(Options.Scheme,'R'))
                    u=CoherenceFilterStep3D(u,Options);
                else
                    u=Anisotropic_step3D(u,Options);
                end
            end
        end

        function u=Anisotropic_step2D(u,Options)
        % Perform tensor-driven diffusion filtering update

        % Gaussian smooth the image, for better gradients
        usigma=imgaussian(u,Options.sigma,4*Options.sigma);


        % Calculate the gradients
        switch lower(Options.Scheme)
          case {'r','o','i'}
            ux=derivatives(usigma,'x'); uy=derivatives(usigma,'y');
          case {'s','n'}
            [uy,ux]=gradient(usigma);
          otherwise
            error('CoherenceFilter:unknownoption','unknown scheme');
        end


        % Compute the 2D structure tensors J of the image
        [Jxx, Jxy, Jyy] = StructureTensor2D(ux,uy,Options.rho);

        % Compute the eigenvectors and values of the strucure tensors, v1 and v2, mu1 and mu2
        [mu1,mu2,v1x,v1y,v2x,v2y] = EigenVectors2D(Jxx,Jxy,Jyy);

        % Gradient magnitude squared
        gradA = ux.^2 + uy.^2;

        % Construct the edge preserving diffusion tensors D = [Dxx,Dxy;Dxy,Dyy]
        [Dxx,Dxy,Dyy] = ConstructDiffusionTensor2D(mu1,mu2,v1x,v1y,v2x,v2y,gradA,Options);

        % Do the image diffusion
        switch lower(Options.Scheme)
          case 'o'
              u=diffusion_scheme_2D_novel(u,Dxx,Dxy,Dyy,Options.dt);
              %u=diffusion_scheme_2D_high_rotation(u,Dxx,Dxy,Dyy,Options.dt,b);
          case 'r'
              u=diffusion_scheme_2D_rotation_invariant(u,Dxx,Dxy,Dyy,Options.dt);
          case 'i'
              u=diffusion_scheme_2D_implicit(u,Dxx,Dxy,Dyy,Options.dt);
          case 's'
              u=diffusion_scheme_2D_standard(u,Dxx,Dxy,Dyy,Options.dt);
          case 'n'
              u=diffusion_scheme_2D_non_negativity(u,Dxx,Dxy,Dyy,Options.dt);
          otherwise
            error('CoherenceFilter:unknownoption','unknown scheme');
        end

        function I=imgaussian(I,sigma,siz)
        % IMGAUSSIAN filters an 1D, 2D color/greyscale or 3D image with an 
        % Gaussian filter. This function uses for filtering IMFILTER or if 
        % compiled the fast  mex code imgaussian.c . Instead of using a 
        % multidimensional gaussian kernel, it uses the fact that a Gaussian 
        % filter can be separated in 1D gaussian kernels.
        %
        % J=IMGAUSSIAN(I,SIGMA,SIZE)
        %
        % inputs,
        %   I: The 1D, 2D greyscale/color, or 3D input image with 
        %           data type Single or Double
        %   SIGMA: The sigma used for the Gaussian kernel
        %   SIZE: Kernel size (single value) (default: sigma*6)
        % 
        % outputs,
        %   J: The gaussian filtered image
        %
        % note, compile the code with: mex imgaussian.c -v
        %
        % example,
        %   I = im2double(imread('peppers.png'));
        %   figure, imshow(imgaussian(I,10));
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        if(~exist('siz','var')), siz=sigma*6; end

        if(sigma>0)
            % Make 1D Gaussian kernel
            x=-ceil(siz/2):ceil(siz/2);
            H = exp(-(x.^2/(2*sigma^2)));
            H = H/sum(H(:));

            % Filter each dimension with the 1D Gaussian kernels\
            if(ndims(I)==1)
                I=imfilter(I,H, 'same' ,'replicate');
            elseif(ndims(I)==2)
                Hx=reshape(H,[length(H) 1]);
                Hy=reshape(H,[1 length(H)]);
                I=imfilter(imfilter(I,Hx, 'same' ,'replicate'),Hy, 'same' ,'replicate');
            elseif(ndims(I)==3)
                if(size(I,3)<4) % Detect if 3D or color image
                    Hx=reshape(H,[length(H) 1]);
                    Hy=reshape(H,[1 length(H)]);
                    for k=1:size(I,3)
                        I(:,:,k)=imfilter(imfilter(I(:,:,k),Hx, 'same' ,'replicate'),...
                            Hy, 'same' ,'replicate');
                    end
                else
                    Hx=reshape(H,[length(H) 1 1]);
                    Hy=reshape(H,[1 length(H) 1]);
                    Hz=reshape(H,[1 1 length(H)]);
                    size(I)
                    I=imfilter(imfilter(imfilter(I,Hx, 'full' ,'replicate'),Hy,...
                        'full' ,'replicate'),Hz, 'full' ,'replicate');
                    a=floor(length(H)/2);
                    I=I(1+a:end-a,1+a:end-a,1+a:end-a);
                end
            else
                error('imgaussian:input','unsupported input dimension');
            end
        end
        
        function u=Anisotropic_step3D(u,Options)
        % Perform tensor-driven diffusion filtering update

        % Gaussian smooth the image, for better gradients
        usigma=imgaussian(u,Options.sigma,4*Options.sigma);

        % Calculate the gradients
        ux=derivatives(usigma,'x');
        uy=derivatives(usigma,'y');
        uz=derivatives(usigma,'z');

        % Compute the 3D structure tensors J of the image
        [Jxx, Jxy, Jxz, Jyy, Jyz, Jzz] = StructureTensor3D(ux,uy,uz, Options.rho);

        % Gradient magnitude squared
        gradA=ux.^2+uy.^2+uz.^2;

        % Free memory
        clear ux; clear uy; clear uz;

        % Compute the eigenvectors and eigenvalues of the hessian and directly
        % use the equation of Weickert to convert them to diffusion tensors
        [Dxx,Dxy,Dxz,Dyy,Dyz,Dzz] = StructureTensor2DiffusionTensor3D(Jxx,Jxy,Jxz,Jyy,Jyz,Jzz,gradA,Options); 

        % Free memory
        clear J*;

        % Do the image diffusion
        switch lower(Options.Scheme)
          case 'o'
              u = diffusion_scheme_3D_novel(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
              %u=diffusion_scheme_3D_high_rotation(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
          case 'r'
              u = diffusion_scheme_3D_rotation_invariant(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
          case 'i'
              u = diffusion_scheme_3D_implicit(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
          case 's'
              u = diffusion_scheme_3D_standard(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
          case 'n'
              u = diffusion_scheme_3D_non_negativity(u,Dxx,Dxy,Dxz,Dyy,Dyz,Dzz,Options.dt);
          otherwise
            error('CoherenceFilter:unknownoption','unknown scheme');
        end

        %----------------------------------------------------------------------------------------------
        function D=derivatives(I,option)
        % Sobel like derivatives with Scharr rotation invariance stencil notations.
        %
        % D=derivatives(I,option)
        %
        % inputs,
        %   I : Input image 2D or 3D
        %   option : Derivative direction 'x', 'y' or 'z'
        %
        % outputs,
        %   D : Derivative of input image
        %
        % Written by D.Kroon University of Twente (September 2009)

        if((ndims(I)<2)||ndims(I)>3)
            error('derivatives:unknowdim','Only 2D and 3D supported');
        end
        is3d=(size(I,3)>3);

        m=1; sigma=1;
        switch lower(option)
            case 'x'
                if(is3d)
                    if(m==1)
                        Stencil=zeros(3,3,3);
                        Stencil(:,:,1)=[9 30 9; 0 0 0; -9 -30 -9];
                        Stencil(:,:,2)=[30 100 30; 0 0 0; -30 -100 -30];
                        Stencil(:,:,3)=[9 30 9; 0 0 0; -9 -30 -9];
                        Stencil=Stencil/512;
                    elseif(m==2)
                        b=floor(-3*sigma):ceil(3*sigma); [x,y,z]=ndgrid(b,b,b);
                        Stencil=-(x./(2*pi*sigma^4)).*exp(-(x.^2+y.^2+z.^2)/(2*sigma^2));
                    elseif(m==3)
                        Stencil=[1 0 -1];
                    end
                else
                    if(m==1)
                        Stencil= [3 10 3; 0 0 0; -3 -10 -3]/32;
                    elseif(m==2)
                        b=floor(-3*sigma):ceil(3*sigma); [x,y]=ndgrid(b,b);
                        Stencil=-(x./(2*pi*sigma^4)).*exp(-(x.^2+y.^2)/(2*sigma^2));
                    elseif(m==3)
                        Stencil=[1 0 -1];
                    end
                end
            case 'y'
                if(is3d)
                    if(m==1)
                        Stencil=zeros(3,3,3);
                        Stencil(:,:,1)=[9 0 -9; 30 0 -30; 9 0 -9];
                        Stencil(:,:,2)=[30  0 -30; 100 0 -100; 30  0 -30];
                        Stencil(:,:,3)=[9 0 -9; 30 0 -30; 9 0 -9];
                        Stencil=Stencil/512;
                    elseif(m==2)
                        b=floor(-3*sigma):ceil(3*sigma); [x,y,z]=ndgrid(b,b,b);
                        Stencil=-(y./(2*pi*sigma^4)).*exp(-(x.^2+y.^2+z.^2)/(2*sigma^2));
                    elseif(m==3)
                        Stencil=[1;0;-1];
                    end
                else
                    if(m==1)
                        Stencil= [3  0 -3; 10 0 -10; 3  0 -3]/32;
                    elseif(m==2)
                        b=floor(-3*sigma):ceil(3*sigma); [x,y]=ndgrid(b,b);
                        Stencil=-(y./(2*pi*sigma^4)).*exp(-(x.^2+y.^2)/(2*sigma^2));
                    elseif(m==3)
                        Stencil=[1;0;-1];
                    end
                end
            case 'z'
                if(is3d)
                    if(m==1)
                        Stencil=zeros(3,3,3);
                        Stencil(:,:,1)=[9  30  9; 30 100 30; 9  30  9];
                        Stencil(:,:,2)=[0 0 0; 0 0 0; 0 0 0];
                        Stencil(:,:,3)=[-9  -30  -9; -30 -100 -30; -9  -30  -9];
                        Stencil=Stencil/512;
                    elseif(m==2)
                        b=floor(-3*sigma):ceil(3*sigma); [x,y,z]=ndgrid(b,b,b);
                        Stencil=-(z./(2*pi*sigma^4)).*exp(-(x.^2+y.^2+z.^2)/(2*sigma^2));
                    elseif(m==3)
                        Stencil=zeros(1,1,3);
                        Stencil(:,:,1)=1; Stencil(:,:,3)=-1;
                    end

                else
                    error('derivatives:unknowopt','2D thus no z derivative');
                end
            otherwise
                error('derivatives:unknowopt','Unknow option found');
        end
        D=imfilter(I,Stencil,'conv','same','replicate');

        %----------------------------------------------------------------------------------------------
        function [Jxx, Jxy, Jyy]=StructureTensor2D(ux,uy,rho)
        % This function calculates the 2D
        % Jp ( grad(u) ) = conv ( Kp  , grad(u) * grad(u)^T ) 
        %
        % The 2x2 JP matrix is called structure tensor (second-moment matrix,
        % scatter matrix, Forstner interest operator)
        % J. Weickert "Coherence-Enhancing Shock filters"
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        % J(grad u_sigma)
        Jxx = sum(ux.^2,3)/size(ux,3);
        Jxy = sum(ux.*uy,3)/size(ux,3);
        Jyy = sum(uy.^2,3)/size(ux,3);

        % Do the gaussian smoothing of the structure tensor
        Jxx = imgaussian(Jxx,rho,6*rho);
        Jxy = imgaussian(Jxy,rho,6*rho);
        Jyy = imgaussian(Jyy,rho,6*rho);

        %----------------------------------------------------------------------------------------------
        function [Lambda1,Lambda2,I2x,I2y,I1x,I1y]=EigenVectors2D(Dxx,Dxy,Dyy)
        % This function computes the eigenvectors and eigen values of the 2D image
        % Hessian
        %
        % [mu1,mu2,v1x,v1y,v2x,v2y]=EigenVectors2D(Jxx,Jxy,Jyy)
        %
        % inputs, 
        %   Jxx, Jxy and Jyy : Matrices with the values of the Hessian tensors
        % 
        % outputs,
        %   mu1, mu2 : Matrices with eigen values
        %   v1x, v1y, v2x, v2y : Matrices with the eigen vectors
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        % Compute the eigenvectors of J, v1 and v2
        tmp = sqrt((Dxx - Dyy).^2 + 4*Dxy.^2);
        v2x = 2*Dxy; v2y = Dyy - Dxx + tmp;

        % Normalize
        mag = sqrt(v2x.^2 + v2y.^2); i = (mag ~= 0);
        v2x(i) = v2x(i)./mag(i);
        v2y(i) = v2y(i)./mag(i);

        % The eigenvectors are orthogonal
        v1x = -v2y; 
        v1y = v2x;

        % Compute the eigenvalues
        mu1 = 0.5*(Dxx + Dyy + tmp);
        mu2 = 0.5*(Dxx + Dyy - tmp);

        % Sort eigen values by absolute value abs(Lambda1)<abs(Lambda2)
        check=abs(mu1)>abs(mu2);

        Lambda1=mu1; Lambda1(check)=mu2(check);
        Lambda2=mu2; Lambda2(check)=mu1(check);

        I1x=v1x; I1y=v1y; I2x=v2x; I2y=v2y; 
        I1x(check)=v2x(check); I1y(check)=v2y(check);
        I2x(check)=v1x(check); I2y(check)=v1y(check);

        %----------------------------------------------------------------------------------------------
        function [Dxx,Dxy,Dyy]=ConstructDiffusionTensor2D(mu1,mu2,v1x,v1y,v2x,v2y,gradA,Options)
        % Construct the edge preserving diffusion tensor D = [a,b;b,c] such as
        % introduced by Weickert.
        %
        % http://www.mia.uni-saarland.de/weickert/Papers/book.pdf, pp 127-128
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        di=(mu1-mu2); di((di<1e-15)&(di>-1e-15))=1e-15;
        % Implicit if mu1 == mu2 then lambda1=alpha
        lambda1 = Options.alpha + (1 - Options.alpha)*exp(-Options.C./(di).^(2*Options.m)); 
        lambda2 = Options.alpha;

        % Scaling of diffusion tensors
        if((Options.eigenmode==0)||(Options.eigenmode==1)) % Weickert line shaped 
            di=(mu1-mu2); di((di<1e-15)&(di>-1e-15))=1e-15;
            lambda1 = Options.alpha + (1 - Options.alpha)*exp(-Options.C./di.^(2*Options.m)); 
            lambda2 = Options.alpha; 
        elseif(Options.eigenmode==2) % EED
            gradA=mean(gradA,3);
            lambda2 = 1 - exp(-3.31488./(gradA./Options.lambda_e^2).^4);
            lambda2(gradA<1e-15)=1;
            lambda1 = 1;
        elseif(Options.eigenmode==3) % CED
           di=(mu1-mu2); di((di<1e-15)&(di>-1e-15))=1e-15;
            lambda1 = Options.alpha + (1 - Options.alpha)*exp(-Options.C./di.^(2*Options.m)); 
            lambda2 = Options.alpha; 
        elseif(Options.eigenmode==4) % Hybrid Diffusion with Continous Switch
            gradA=mean(gradA,3);
            lambdae2 = 1 - exp(-3.31488./(gradA./Options.lambda_e^2).^4);
            lambdae2(gradA<1e-15)=1;
            lambdae1 = 1;

            di=(mu1-mu2); di((di<1e-15)&(di>-1e-15))=1e-15;
            lambdac1 = Options.alpha + (1 - Options.alpha)*exp(-Options.C./di.^(2*Options.m)); 
            lambdac2 = Options.alpha; 

            xi= (mu1-mu2);
            di=2.0*Options.lambda_h^4;
            epsilon = exp(mu1.*(Options.lambda_h^2.*(xi-abs(xi)))./di);

            lambda1 = (1-epsilon) .* lambdac1 + epsilon .* lambdae1;
            lambda2 = (1-epsilon) .* lambdac2 + epsilon .* lambdae2;
        end

        Dxx = lambda1.*v1x.^2   + lambda2.*v2x.^2;
        Dxy = lambda1.*v1x.*v1y + lambda2.*v2x.*v2y;
        Dyy = lambda1.*v1y.^2   + lambda2.*v2y.^2;

        %----------------------------------------------------------------------------------------------
        function u=diffusion_scheme_2D_implicit(u,Dxx,Dxy,Dyy,dt)
        % Diffusion scheme as introduced by Weickert  "Anisotropic Diffusion 
        % in Image Processing", Thesis 1996.
        %
        % This Implementation is based on Pascal Getreuer, "Weickert's
        % coherence-enhancing filter" which is also on Mathworks.
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        % Compute tensor-driven diffusion (as in [1] pp. 80-82)
        [N1,N2,N3] = size(u);
        id = [2:N1,N1]; iu = [1,1:N1-1];
        ir = [2:N2,N2]; il = [1,1:N2-1];

        % Diagonal neighbor intensity updates (amount of greyvalue flow from
        % neighbor) 

        % Page 95
        % This formula is equal to ( |b       | - b           +   |b    | - b    ) / ( 4*h1*h2 )
        %                            | i-1,j+1|    i-1,j+1        | i,j |    i,j
        Dul = max(0, Dxy(iu,il)) + max(0,Dxy); 
        Ddr = max(0, Dxy(id,ir)) + max(0,Dxy);
        Ddl = max(0,-Dxy(id,il)) + max(0,-Dxy);
        Dur = max(0,-Dxy(iu,ir)) + max(0,-Dxy);

        % Normal neighbor intensity updates 
        Dml = (Dyy(:,il) + Dyy) - (abs(Dxy(:,il)) + abs(Dxy));
        Dmr = (Dyy(:,ir) + Dyy) - (abs(Dxy(:,ir)) + abs(Dxy));
        Duc = (Dxx(iu,:) + Dxx) - (abs(Dxy(iu,:)) + abs(Dxy));
        Ddc = (Dxx(id,:) + Dxx) - (abs(Dxy(id,:)) + abs(Dxy));

        % Normalization term to preserve region average grey value
        Dmc = -(Dyy(:,il) + 2*Dyy + Dyy(:,ir)) + ... 
              -(Dxx(iu,:) + 2*Dxx + Dxx(id,:)) + ...  
              -(max(0, Dxy(iu,il)) + max(0,-Dxy(iu,ir))) + ...
              -(max(0,- Dxy(id,il)) + max(0,Dxy(id,ir))) + ...
              (abs(Dxy(:,il)) + abs(Dxy(:,ir)) + abs(Dxy(id,:)) + abs(Dxy(iu,:)) + 2*abs(Dxy));

        % Calculate Diffusion update 
        du=zeros(size(u));
        for Channel = 1:N3
            du(:,:,Channel)=0.5*dt*(Dul.*u(iu,il,Channel) + ...
                                    Dml.*u(:,il,Channel)  + ...
                                    Ddl.*u(id,il,Channel) + ...
                                    Duc.*u(iu,:,Channel)  + ...            
                                    Ddc.*u(id,:,Channel)  + ...
                                    Dur.*u(iu,ir,Channel) + ...
                                    Dmr.*u(:,ir,Channel)  + ...
                                    Ddr.*u(id,ir,Channel));
        end

        % Perform the edge preserving diffusion filtering on the image
        for Channel = 1:N3
            u(:,:,Channel) = (u(:,:,Channel) + du(:,:,Channel)) ./ (1-dt*0.5*Dmc);
        end

        %----------------------------------------------------------------------------------------------
        function u=diffusion_scheme_2D_non_negativity(u,Dxx,Dxy,Dyy,dt)
        % The Basic non_negativity diffusion equation. (Can be found in "A Scheme for
        % Coherence-Enhancing Diffusion Filtering with Optimized Rotation
        % Invariance" by Joachim Weickert
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        % Make positive and negative indices
        [N1,N2,N3] = size(u);
        px = [2:N1,N1]; nx = [1,1:N1-1];
        py = [2:N2,N2]; ny = [1,1:N2-1];

        % In literature a,b and c are used as variables 
        a=Dxx;b=Dxy;c=Dyy;

        % Stencil Weights
        A1 = (1/4)*((abs(b(nx, py))-b(nx,py)) + (abs(b)-b));
        A2 = (1/2)*( (c(:, py)+c) -(abs(b(:,py))+abs(b)));
        A3 = (1/4)*((abs(b(px, py))+b(px,py)) + (abs(b)+b));
        A4 = (1/2)*( (a(nx,: )+a) -(abs(b(nx,:))+abs(b)));
        %A5 =  - (a(nx,:) + 2*a+a(px,:)) ...
        %	  - (abs(b(nx,py))-b(nx,py)+abs(b(px,py))-b(px,py)) ...
        %	  - (abs(b(nx,ny))-b(nx,ny)+abs(b(px,ny))-b(px,ny)) ...
        %	  + (abs(b(nx,:))+abs(b(px,:))+abs(b(:,ny))+abs(b(:,py))+2*abs(b)) ...
        %	  - (c(:,ny) + 2*c+c(:,py));
        A6 = (1/2)*( (a(px,: )+a) -(abs(b(px,:))+abs(b)));
        A7 = (1/4)*((abs(b(nx, ny))+b(nx,ny)) + (abs(b)+b));
        A8 = (1/2)*( (c(:, ny)+c) -(abs(b(:,ny))+abs(b)));
        A9 = (1/4)*((abs(b(px, ny))-b(px,ny)) + (abs(b)-b));

        % Do the diffusion
        for Channel = 1:N3
          u(:,:,Channel)=  u(:,:,Channel)+dt*(A1.*(u(nx,py,Channel) -u(:,:,Channel))+ ...
                                              A2.*(u(:, py,Channel) -u(:,:,Channel))+ ...
                                              A3.*(u(px,py,Channel) -u(:,:,Channel))+ ...
                                              A4.*(u(nx,:,Channel)  -u(:,:,Channel))+ ...      
                                              A6.*(u(px,:,Channel)  -u(:,:,Channel))+ ...
                                              A7.*(u(nx,ny,Channel) -u(:,:,Channel))+ ...
                                              A8.*(u(:, ny,Channel) -u(:,:,Channel))+ ...
                                              A9.*(u(px,ny,Channel) -u(:,:,Channel)));
        end

        %----------------------------------------------------------------------------------------------
        function u=diffusion_scheme_2D_novel(u,Dxx,Dxy,Dyy,dt,par)
        Dxx=repmat(Dxx,[1 1 size(u,3)]);
        Dxy=repmat(Dxy,[1 1 size(u,3)]);
        Dyy=repmat(Dyy,[1 1 size(u,3)]);

        if(nargin<6)
        %     par=[0.007520981141059, 0.049564810649554, 0.031509665995882, ...
        %          0.037869547950557, 0.111394943940548, 0.448053798986724, ...
        %          0.081135611356868,	0.333881751894069, 0.936734100573009, ...
        %          0.000936487500442,	0.027595332069424, 0.194217089668822, ...
        %          0.006184018622016, 0.948352724021832];
        par=[0.00549691757211334,4.75686155670860e-10,3.15405721902292e-11,...
             0.00731109320628158,1.40937549145842e-10,0.0876322157772825,...
             0.0256808495553998,5.87110587298283e-11,0.171008417902939,...
             3.80805359553021e-12,9.86953381462523e-12,0.0231020787600445,...
             0.00638922328831119,0.0350184289706385];

        end


        Mxx =[par(1)  par(2)  par(3)  par(2)  par(1);
              par(4)  par(5)  par(6)  par(5)  par(4); 
             -par(7) -par(8) -par(9) -par(8) -par(7);
              par(4)  par(5)  par(6)  par(5)  par(4); 
              par(1)  par(2)  par(3)  par(2)  par(1)];
        Myy=Mxx';

        Mxy=[par(10) par(11)   0    -par(11) -par(10);
             par(11) par(12)   0    -par(12) -par(11);
               0        0      0        0       0
            -par(11) -par(12)  0    par(12) par(11);
            -par(10) -par(11)  0    par(11) par(10)];

        Mx= [par(13)  par(14)  par(13); 
                0 	    0 	      0; 
            -par(13) -par(14) -par(13)];
        My= Mx';

        ux=imfilter(u,Mx,'conv','same','replicate');
        uy=imfilter(u,My,'conv','same','replicate');
        div1=imfilter(Dxx,Mx,'conv','same','replicate')+imfilter(Dxy,My,'conv','same','replicate');
        div2=imfilter(Dxy,Mx,'conv','same','replicate')+imfilter(Dyy,My,'conv','same','replicate');
        du1= div1.*ux+div2.*uy;

        clear ux uy div1 div2

        uxx=imfilter(u,Mxx,'conv','same','replicate');
        uxy=imfilter(u,Mxy,'conv','same','replicate');
        uyy=imfilter(u,Myy,'conv','same','replicate');
        du2=uxx.*Dxx+2*uxy.*Dxy + uyy.*Dyy;

        clear uxx uxy uyy Dxx Dxy Dyy

        du=du1+du2;

        u=u+du*dt;

        u(~isfinite(u))=0;

        %----------------------------------------------------------------------------------------------
        function u=diffusion_scheme_2D_rotation_invariant(u,Dxx,Dxy,Dyy,dt)
        % Most diffusion discretizations are not rotation-invariant, probably
        % because they depend on a 3x3 stencil. 
        % This is an implementation of "A Scheme for Coherence-Enhancing Diffusion 
        % Filtering with Optimized Rotation invariance" by Joachim Weickert. 
        % Which is a basic and understandable direct discretization of the 
        % diffusion equation, which corresponds to a 5x5 stencil.
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        Dxx=repmat(Dxx,[1 1 size(u,3)]);
        Dxy=repmat(Dxy,[1 1 size(u,3)]);
        Dyy=repmat(Dyy,[1 1 size(u,3)]);

        ux=derivatives(u,'x');
        uy=derivatives(u,'y');

        % 3 : Calculate the flux components
        j1 = Dxx .* ux + Dxy .*uy;
        j2 = Dxy .* ux + Dyy .*uy;

        % 3.5 Flux on boundaries to zero
        j1(1,:,:)=0; j1(end,:,:)=0; j1(:,1,:)=0; j1(:,end,:)=0;
        j2(1,:,:)=0; j2(end,:,:)=0; j2(:,1,:)=0; j2(:,end,:)=0;

        % 4 : Calculate ... by means of the optimized derivative filters
        du = derivatives(j1,'x')+derivatives(j2,'y');

        % 5 : Update in an explicit way.
        u=u+du*dt;

        %----------------------------------------------------------------------------------------------
        function u=diffusion_scheme_2D_standard(u,Dxx,Dxy,Dyy,dt)
        % The standard diffusion equation. (Can be found in "A Scheme for
        % Coherence-Enhancing Diffusion Filtering with Optimized Rotation
        % Invariance" by Joachim Weickert
        % 
        % Function is written by D.Kroon University of Twente (September 2009)

        % Make positive and negative indices
        [N1,N2,N3] = size(u);
        px = [2:N1,N1]; nx = [1,1:N1-1];
        py = [2:N2,N2]; ny = [1,1:N2-1];

        % In literature a,b and c are used as variables 
        a=Dxx;b=Dxy;c=Dyy;

        % Stencil Weights
        A1=(1/4)*(b(nx,:)-b(:,py));
        A2=(1/2)*(c(:,py)+c);
        A3=(1/4)*(b(px,:)+b(:,py));
        A4=(1/2)*(a(nx,:)+a);
        %A5 = -(1/2)*(a(nx,:)+2*a+a(px,:)) -(1/2)*(c(:,ny)+2*c+c(:,py));
        A6=(1/2)*(a(px,:)+a);
        A7=(1/4)*(b(nx,:)+b(:,ny));
        A8=(1/2)*(c(:,ny)+c);
        A9=(1/4)*(b(px,:)-b(:,ny));

        for Channel = 1:N3
          u(:,:,Channel)=  u(:,:,Channel)+dt*(A1.*(u(nx,py,Channel) -u(:,:,Channel))+ ...
                                           A2.*(u(:, py,Channel) -u(:,:,Channel))+ ...
                                           A3.*(u(px,py,Channel) -u(:,:,Channel))+ ...
                                           A4.*(u(nx,:,Channel)  -u(:,:,Channel))+ ...      
                                           A6.*(u(px,:,Channel)  -u(:,:,Channel))+ ...
                                           A7.*(u(nx,ny,Channel) -u(:,:,Channel))+ ...
                                           A8.*(u(:, ny,Channel) -u(:,:,Channel))+ ...
                                           A9.*(u(px,ny,Channel) -u(:,:,Channel)));
        end

        %----------------------------------------------------------------------------------------------
        function [x11,x12,x22]=hessian(x)

        %m11=(1/8)*[1 6 1;-2 -12 -2; 1 6 1]';
        %m22=(1/8)*[1 6 1;-2 -12 -2; 1 6 1];
        %m12=1/4*[1 0 -1; 0 0 0; -1 0 1];

        % m11= [ 0.0491  0.0778  0.0491; 
        %       -0.0982 -0.1556 -0.0982; 
        %        0.0491  0.0778 0.0491];
        % m12=[ 0.0495 0 -0.0495; 
        %       0      0       0;
        %      -0.0495 0  0.0495];
        % m22=m11';

        x12=derivatives(derivatives(x,'x'),'y');
        xL=imresize2(x);
        xL1=derivatives(xL,'x');
        xL2=derivatives(xL,'y');
        xL11=derivatives(xL1,'x');
        xL22=derivatives(xL2,'y');
        x11=xL11(1:2:end,1:2:end);
        x22=xL22(1:2:end,1:2:end);


        %x11=imfilter(x,m11,'conv','same','replicate');
        %x12=imfilter(x,m12,'conv','same','replicate');
        %x22=imfilter(x,m22,'conv','same','replicate');

        %----------------------------------------------------------------------------------------------
        function [Iout]=ut_gauss(varargin)
        %ut_gauss	- 2-D filtering using Gaussian masks 
        %
        %   H = UT_GAUSS(I,SIGMA,DX,DY) filters the data in image I with a 2-D FIR
        %   filter whose PSF closely approximates a Gaussian function or one of its
        %   derivatives. The width (scale; standard deviation) of the Gaussian is
        %   SIGMA (default SIGMA=2).
        %
        %   Different types of masks can be specified by parameters DX,DY:
        %
        %       DX   - number of diferentiations in x direction
        %       DY   - number of diferentiations in y direction
        %
        %   Default: DX=0,DY=0.
        %
        %   - DX+DY must be less or equal to 2.
        %   - The size of the mask is 2*ceil(4*SIGMA)+1.
        %   - The elements of the PSF are obtained by area sampling of the
        %     continuous function, rather than impulse sampling. (Area sampling is
        %     equivalent to impulse sampling preceded by a prefilter. The prefilter
        %     prevents large aliasing errors that would otherwise occur if SIGMA is 
        %     too small (say, smaller than 1.5). However, the prefilter also introduces a
        %     resolution error that becomes noticeable if SIGMA is smaller than,
        %     say, 0.7. The response of the prefilter is a rectangular function with unit width).
        %   - UT_GAUSS uses IMFILTER with the replication option on.
        %
        %   Copyright: F. van der Heijden, F.vanderHeijden@utwente.nl
        %   Laboratory for Measurements and Instrumentation
        %   University of Twente, the Netherlands
        %   Version 1.0, date: 25-10-2004
        %
        %  See also IMFILTER
        [Iin,sigma,typein]=ParseInputs(varargin{:});

        winsiz = 2; %ceil(4*sigma);
        n=2*winsiz+1;


        %gaussian
        if strcmp(typein,'normal')
            kernel=create_gauss_kernel(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel),'replicate','conv');
            Iout=imfilter(double(Iout),double(kernel'),'replicate','conv');
        end

        %gauss-dx
        if strcmp(typein,'dx')
            kernel=create_gauss_kernel(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel'),'replicate','conv');
            kernel=create_gauss_kernel_x(sigma,n,winsiz);
            Iout=imfilter(double(Iout),double(kernel),'replicate','conv');
        end

        %gauss-dxdx
        if strcmp(typein,'dxdx')
            kernel=create_gauss_kernel(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel'),'replicate','conv');
            kernel=create_gauss_kernel_xx(sigma,n,winsiz);
            Iout=imfilter(double(Iout),double(kernel),'replicate','conv');
        end

        %gauss-dy
        if strcmp(typein,'dy')
            kernel=create_gauss_kernel(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel),'replicate','conv');
            kernel=create_gauss_kernel_x(sigma,n,winsiz);
            Iout=imfilter(double(Iout),double(kernel'),'replicate','conv');
        end

        %gauss-dydy
        if strcmp(typein,'dydy')
            kernel=create_gauss_kernel(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel),'replicate','conv');
            kernel=create_gauss_kernel_xx(sigma,n,winsiz);
            Iout=imfilter(double(Iout),double(kernel'),'replicate','conv');
        end

        %gauss-dxdy
        if strcmp(typein,'dxdy')
            kernel=create_gauss_kernel_x(sigma,n,winsiz);
            Iout=imfilter(double(Iin),double(kernel),'replicate','conv');
            Iout=imfilter(double(Iout),double(kernel'),'replicate','conv');
        end


        %----------------------------------------------------------------------
        % Subfunction ParseInputs
        %----------------------------------------------------------------------

        function [Iin,Sigma,typein] =  ParseInputs(varargin)

        error(nargchk(1,4,nargin));
        %MSG = NARGCHK(LOW,HIGH,N) returns an appropriate error message if
        %    N is not between low and high. If it is, return empty matrix.

        Iin = varargin{1};

        %defaults
        typein = 'normal';
        Sigma=2;

        methods = {'normal','dx','dxdx';'dy','dxdy','err';'dydy','err','err'};

        if nargin>1
            Sigma=varargin{2};%!!!! special braces to make it numerical
        end
        if nargin>2
            if nargin==4
                i = varargin{3};
                j = varargin{4};
                if ((j>2)|(i>2)|(j<0)|(i<0)|(round(i)~=i)|(round(j)~=j))
                    typein='err';
                else
                    typein = methods{j+1,i+1};
                end
                if strcmp(typein,'err')
                    disp('DX+DY must be less or equal to 2.');
                    error(['Invalid input string: ',num2str(varargin{3}),',',num2str(varargin{4}),'.']);
                end
            else
                error(['If DX is specified DY must be specified!!!']);
            end
        end


        if Sigma<0
            error('Sigma must be positive');
        end
        return

        %--------------------------------------------------------------------------
        %   Subfunction create_gauss_kernel
        %--------------------------------------------------------------------------
        function kernel=create_gauss_kernel(sigma,n,winsiz)
        kernel=zeros(1,n);
        c = 1.0/(sigma*sqrt(2));
        for i=1:winsiz+1
            hulp(i) = erf((i-1+0.5)*c)-erf((i-1-0.5)*c);
        end
        accu = hulp(1);
        for i=2:winsiz+1
            accu = accu+(2.0*hulp(i));
        end

        for i=1:winsiz
            kernel(winsiz+1-i) = (hulp(i+1)/accu);
            kernel(winsiz+1+i) = (hulp(i+1)/accu);
        end
        kernel(winsiz+1) = (hulp(1)/accu);
        return


        %--------------------------------------------------------------------------
        %   Subfunction create_gauss_kernel_x
        %--------------------------------------------------------------------------
        function kernel=create_gauss_kernel_x(sigma,n,winsiz)
        c =  1.0/(sigma*sqrt(2.0*pi));
        sigma2=sigma^2;
        kernel=zeros(1,n);

        for i=1:n
            x=i-winsiz-1;
            x1 = x - 0.5;
            x2 = x + 0.5;
            kernel(i)= c*(exp(-0.5*x2*x2/sigma2)-exp(-0.5*x1*x1/sigma2));
        end
        return


        %--------------------------------------------------------------------------
        %   Subfunction create_gauss_kernel_xx
        %--------------------------------------------------------------------------
        function kernel=create_gauss_kernel_xx(sigma,n,winsiz)
        c =  1.0/(sigma^3*sqrt(2.0*pi));
        sigma2=sigma^2;
        kernel=zeros(1,n);
        for i=1:n
            x=i-winsiz-1;
            x1 = x - 0.5;
            x2 = x + 0.5;
            if (i==1)
                kernel(i)= c*(-x2*exp(-0.5*x2*x2/sigma2));
            else
                if (i==n)
                    kernel(i)= c*(x1*exp(-0.5*x1*x1/sigma2));
                else
                    kernel(i)= c*(x1*exp(-0.5*x1*x1/sigma2)-x2*exp(-0.5*x2*x2/sigma2));
                end
            end
        end
        return
% 
% % End of CoherenceFilter and SubFunctions ------------------------------------------

function Vord = ordfilt3_modified(V,ord,N,pad)

% Process array in slightly overlapping pieces if the overall number of elements 
% exceeds memory capacity
    
    if numel(V) < 2^26 
        Vord = ordfilt3(V,ord,N,pad);
        
    else
        nZ = size(V,3);
        nS = ceil(nZ/100);
        subZ = floor(nZ/nS);
        Vord = zeros(size(V),'double');
        for n = 1:nS
            if n == 1 % First sub-section ------------------------------
                s = 1;                e = n*subZ;  
                Vsub = ordfilt3(V(:,:,s:e+3),ord,N,pad);
                Vord(:,:,s:e) = Vsub(:,:,1:end-3);
            elseif n == nS % Last sub-section --------------------------
                s = (n-1)*subZ+1;     e = nZ;
                Vsub = ordfilt3(V(:,:,s-3:e),ord,N,pad);
                Vord(:,:,s:e) = Vsub(:,:,4:end);
            else % non-end or beginning sub-sections -------------------
                s = (n-1)*subZ+1;     e = n*subZ;
                Vsub = ordfilt3(V(:,:,s-3:e+3),ord,N,pad);
                Vord(:,:,s:e) = Vsub(:,:,4:end-3);
            end
        end
    end

%-----------------------------------------------------------------------------------------
%-----------------------------------------------------------------------------------------
function [BA,DT,DI] = ProcessImageStack(I)

    % Process Confocal Image Stack -----------------------------
    %
    %  IS = Image Stack;
    %  BA = Binary Array;
    %  PI = Processed Images;
    %   
    %-----------------------------------------------------------

    count = size(I,3);
    h1 = waitbar(0,'Processing Images...');
    loc = get(h1,'Position');
    set(h1,'Position',[30 60 loc(3) loc(4)])

    %-----------------------------------    
    % Waitbar initial conditions -------
     T = zeros(count,1);
     N = zeros(count,1);
  
    %-----------------------------------
        BA = zeros(size(I),'logical');
        DT = zeros(size(I),'double');
        tic;
        for z = 1:count
            fraction = round(10*(100*z/count))/10;
            Image1 = squeeze(I(:,:,z));
            % [BI1, DT1] = Processing3(Image1);
            [BI1, DT1] = Processing2(Image1);
            BA(:,:,z)  = BI1;
            DT(:,:,z)  = DT1;
                
                % Waitbar Update -------------------------------------------------------                        
                    t_now = toc;  
                    T(z,1) = t_now;
                    N(z,1) = z;
                    LIM = 20;
                    
                    if z <= LIM    
                        Xt = N(1:z,1);
                        Yt = T(1:z,1);
                    else
                        Xt = N(z-LIM:z,1);
                        Yt = T(z-LIM:z,1);
                    end 
                    
                    if numel(Xt) > 1
                        p = polyfit(Xt,Yt,1);
                        t_remains = (polyval(p,count) - t_now);

                        if t_remains > 60
                            waitbar(z/count,h1,['Processing Images...' sprintf('%4.1f',100*z/count),...
                                            '%   ' sprintf('%4.2f', t_remains/60) ' min'])
                        else
                            waitbar(z/count,h1,['Processing Images...' sprintf('%4.1f',100*z/count),...
                                                '%   ' sprintf('%3.1f', t_remains) ' sec'])
                        end
                    end
                % ----------------------------------------------------------------------
        end
     
        close(h1)
        close(333)
        
  %------------------------------------------------------------------------------------------------------ 
  function SI = Smooth2D(Im,n)
        
            obj = class(Im);
            S = conv2(double(Im),ones(n)./n^2,'same');
            
            switch obj
                case 'double'
                    SI = S;
                case 'single'
                    SI = single(S);
                case 'uint8'
                    SI = uint8(S);
                case 'uint16'
                    SI = uint16(S);
            end
    
    %----------------------------------------------------------------------------------------------------     
    function [IM07,DT] = Processing2(IM00)
        
        % Define Image Saturation Function ---------------------------------------------
            % ImageSaturate = @(Im,percent) imadjust(Im,stretchlim(Im,[percent/100, (100-percent)/100]));
        % Define 2D Image Smoothing ----------------------------------------------------
            % Smooth2D = @(Im,n) conv2(double(Im),ones(n)./n^2,'same');
        % Define 2D Median Filter ------------------------------------------------------
            % MedFilt2 = @(Im,n) medfilt2(Im,[n,n],'symmetric');    
        % ==============================================================================
            IM01  = imsaturate(IM00,1);       
            IM02  = medfilt2(IM01,[7,7],'symmetric');      
            IM02  = Smooth2D(IM02,3);     
        % ------------------------------------------------------------------------------
            IM02  = imtophat(IM02,offsetstrel('ball',5,0,8));    
            IM03  = imsaturate(IM02,10);   
        % ------------------------------------------------------------------------------    
            if isa(IM03,'uint8')
                IM03b =  uint8(CoherenceFilter(IM03, struct('T',10,'dt',1,'Scheme','I'))); 
            else
                IM03b = uint16(CoherenceFilter(IM03, struct('T',10,'dt',1,'Scheme','I'))); 
            end
        % ------------------------------------------------------------------------------  
            IM04 = imerode(IM03b, strel('disk',1) );         
            IM05 = imbinarize(IM04,30/255);   
        % ------------------------------------------------------------------------------   
            DT = -bwdist(IM05); % DT is passed on to the 3D processing step
        %-------------------------------------------------------------------------------    
            mask = imextendedmin(DT,2);
            DT2  = imimposemin(DT,mask);
                ind = DT2 < -10;
            DT2(ind) = -Inf;
            IM07 = logical(watershed(DT2));    
        % ------------------------------------------------------------------------------ 
            IM08 = uint8(255*~IM07);
            IM09 = imfuse(IM08, IM01,'falsecolor');
            DisplayImage = [repmat(im2uint8(IM01),[1 1 3]), uint8(255*ones(size(IM09,1),3,3)),IM09];
            fh = figure(333);
                fh.ToolBar = 'none';
                fh.MenuBar = 'none';
            imshow(imresize(DisplayImage,0.75),'Border','tight')
            warning off
        

%-----------------------------------------------------------------------------------------            
function FiltBI = HighPassFilterBySize(BI,s)
    
    FiltBI = false(size(BI));
    
    [L, NUM] = bwlabeln(BI);
    for k = 1:NUM
        ind = find(L == k);
        N = numel(ind);
        if N > s
            FiltBI(ind) = 1;
        end
    end        
%-----------------------------------------------------------------------------------------
function IMS = imsaturate(Im,p)
%
%     Image Saturation (AutoContrast)
%           IMS = imsaturate(Im,p)
%
%           Im = 8bit grayscale image
%           p = percent saturation on each end of histogram (0-49)
%
% KRC 06/26/2009
%
            IMS = imadjust(Im,stretchlim(Im,[p/100 (100-p)/100]));
            
        
%-------------------------------------------------------------------------------------------
function FilteredImage = RollingBallFilt(Im,radius,varargin)
 
        % FilteredImage = RollingBallFilt(Im)
        %     Im = 8bit grayscale or RGB image
        %     radius is set to 50 pixels by default
        %
        % FilteredImage = RollingBallFilt(Im, radius)
        %     Im = 8bit grascale or RGB image
        %     radius = radius of rolling ball (in pixels)
        %
        %------------------------------------------------------
          L = length(varargin);

          switch L
                case 0
                      H = 0;
                case 1
                      H = varargin{1};
                otherwise
                      error('Too many imput arguements')
          end

          [R C Z] = size(Im); % Measure size

          if ~isequal(1,Z)
                Im = max(Im,[],3); % If image is RGB convert to grayscale
          end

          %radius = 50; % Paraboloid radius
                rf = 1;% 0.2; % Image resize factor
                r = ceil(radius*rf); % Make sure resized radius is an integer
          % Create Paraboloid structuring element
                SE = offsetstrel('ball',r,H,4); 
          % Resize image to speed up processing
                % Imr = imresize(Im,rf);
          % Apply 3x3 maximum filtering
                Imh = imhmax(Im,2,8);
          % Apply 3x3 smoothing (averaging)
                window = ones(3,3)/3^2; % Create averaging window
                Imhs = imfilter(Imh,window,'replicate','same');
          % Create background image
                b = imopen(Imhs,SE);
              % br = imresize(b,[R C]); % Resize to original dimensions
          % Subtract Background from Original Image      
                FilteredImage = imsubtract(Im ,b);
                
%------------------------------------------------------------------------------------                 
function [VecAngle, VecDist] = CalculateRelativeAngle(handles)
            
            if ~isempty(handles.IntersectionPoint) && ~isempty(handles.VectorData)
                %----------------------------------------------------
                N = length(handles.VectorData);
                IP = single(handles.IntersectionPoint');
                theta = zeros(N,1);
                d = theta;
                for k = 1:N
                    CP = handles.VectorData{k,1}.XYZDataCentroid'; 
                    LV  = (IP-CP);
                    uLV = LV./norm(LV);
                    RV = handles.VectorData{k,1}.EigenVectors(:,1);
                    uRV = RV./norm(RV);
                    theta(k,1) = asin(norm(cross(uLV,uRV)));  
                        X0 = IP;
                        X1 = CP;
                        X2 = CP + RV;
                    d(k,1) = norm(cross(X0-X1,X0-X2))/norm(X2-X1);   
                end
                VecAngle = (180/pi)*theta;
                VecDist  = d;
                %----------------------------------------------------
            else
                VecAngle = [];
                VecDist  = [];
            end
            
%------------------------------------------------------------------------------------                
function ExportData_Button_Callback(hObject, eventdata, handles)

[FileName,PathName] = uiputfile('*.txt');

if ~isequal(0,FileName)
        fileID = fopen([PathName FileName],'w');
        if isempty(handles.VectorData)
            % File Header 1 (cell data only) -------------------------------------------------------------
            fprintf(fileID,'%s\r\n','LongAxis Exported-Data File');
            fprintf(fileID,'%s\r\n\r\n',['Date: ' datestr(datetime('now'))]);
            fprintf(fileID,'%s\r\n',['Original Data File: ' handles.FileName]);
            fprintf(fileID,'%s [%i, %i, %i]\r\n',...
                'Original Data Resolution:  [#Xpixels, #Ypixels, #Zsteps] =',...
                                                      handles.ImX,handles.ImY,handles.nZ);
            fprintf(fileID,'%s %#.5g\r\n','Pixel Width (microns): ',handles.PixelWidth);
            fprintf(fileID,'%s %#.5g\r\n','Z-Step (microns): ',handles.ZStep);
            fprintf(fileID,'%s [%i, %i, %i, %i, %i, %i]\r\n',...
                'Selected Region Matrix Indices:  [R1, C1, R2, C2, Z1, Z2] =',...
                                          handles.sPix(1,1),handles.sPix(1,2),...
                                          handles.ePix(1,1),handles.ePix(1,2),handles.Z1,handles.Z2);
            fprintf(fileID,'%s [%#.5g, %#.5g, %#.5g, %#.5g, %#.5g, %#.5g]\r\n\r\n',...
                'Selected Region Axes Range (microns): [X1, X2, Y1, Y2, Z1, Z2] =',...
                           handles.AxisRange(1,1),handles.AxisRange(1,2),handles.AxisRange(1,3),...
                              handles.AxisRange(1,4),handles.AxisRange(1,5),handles.AxisRange(1,6));
            fprintf(fileID,'%s\r\n\r\n','======== Start Column Header Definitions =========');
            fprintf(fileID,'%s\r\n','Xc, Yc, Zc = center of mass XYZ coordinates of cell (microns)');
            fprintf(fileID,'%s\r\n',...
           'CellVol = number of voxels contained in 3d binary cell object then converted into cubic microns');
            fprintf(fileID,'%s\r\n','MBSD = Minimum Bounding Sphere Diameter (microns)')
            fprintf(fileID,'%s\r\n\r\n',...
                'MBSCx, MBSCy, MBSCz = X,Y,Z, coorinates of Minimum Bounding Sphere center (microns)')
            fprintf(fileID,'%s\r\n\r\n\r\n','======== End Column Header Definitions ============');
            % Data Column Headers -------------------------------------------------------------------------
            fprintf(fileID,'%s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\r\n','Cell#',...
                'Xc','Yc','Zc','CellVol','MBSD','MBSCx','MBSCy','MBSCz');
        else
            % File Header 2 (Cell data AND Ellipsoid data) ---------------------------------------------
            fprintf(fileID,'%s\r\n','LongAxis Exported-Data File');
            fprintf(fileID,'%s\r\n\r\n',['Date: ' datestr(datetime('now'))]);
            fprintf(fileID,'%s\r\n',['Original Data File: ' handles.FileName]);
            fprintf(fileID,'%s [%i, %i, %i]\r\n',...
                'Original Data Resolution:  [#Xpixels, #Ypixels, #Zsteps] =',...
                                                      handles.ImX,handles.ImY,handles.nZ);
            fprintf(fileID,'%s %#.5g\r\n','Pixel Width (microns): ',handles.PixelWidth);
            fprintf(fileID,'%s %#.5g\r\n','Z-Step (microns): ',handles.ZStep);

            fprintf(fileID,'%s [%i, %i, %i, %i, %i, %i]\r\n',...
                'Selected Region Matrix Indices:  [R1, C1, R2, C2, Z1, Z2] =',...
                                                      handles.sPix(1,1),handles.sPix(1,2),...
                                                      handles.ePix(1,1),handles.ePix(1,2),...
                                                      handles.Z1,       handles.Z2);
            fprintf(fileID,'%s [%#.5g, %#.5g, %#.5g, %#.5g, %#.5g, %#.5g]\r\n',...
                'Selected Region Axes Range (microns): [X1, X2, Y1, Y2, Z1, Z2] =',...
                                handles.AxisRange(1,1),handles.AxisRange(1,2),handles.AxisRange(1,3),...
                                handles.AxisRange(1,4),handles.AxisRange(1,5),handles.AxisRange(1,6));
            % -----------------------------------------------------------------------------------------------
            if isempty(handles.IntersectionPoint); 
                IPstring = '[ no point selected ]';
            else
                IPstring = sprintf('[%#.5g, %#.5g, %#.5g]',handles.IntersectionPoint(1,1),...
                                                           handles.IntersectionPoint(1,2),...
                                                           handles.IntersectionPoint(1,3));
            end
            fprintf(fileID,'%s\r\n\r\n',['Selected Intersection Point (microns): [X, Y, Z] = ' IPstring ]);
            fprintf(fileID,'%s\r\n',['Ellipsoid Fit Equation: Ax^2 + By^2 + Cz^2 + 2Dxy +',...
                      ' 2Exz + 2Fyz + 2Gx + 2Hy + 2Iz + J = 0']);   
            fprintf(fileID,'%s\r\n',['ellipsoid_fit MATLAB code author: Yury Petrov,',...
                      ' Oculus VR, Date: September, 2015']);
            fprintf(fileID,'%s\r\n\r\n',['MATLAB code for ellipsoid_fit code : ',...
                      'https://www.mathworks.com/matlabcentral/fileexchange/24693-ellipsoid-fit']);
            fprintf(fileID,'%s\r\n\r\n','======== Start Column Header Definitions =========');
            fprintf(fileID,'%s\r\n','Xc, Yc, Zc = center of mass XYZ coordinates of cell (microns)');
            fprintf(fileID,'%s\r\n',['CellVol = number of voxels contained in 3d binary cell',...
                      ' object converted into cubic microns']);
            fprintf(fileID,'%s\r\n','MBS = Minimum Bounding Sphere Diameter (microns)')
            fprintf(fileID,'%s\r\n',['MBSCx, MBSCy, MBSCz = X,Y,Z, coorinates of ',...
                       'Minimum Bounding Sphere center (microns)'])
            fprintf(fileID,'%s\r\n','Xe, Ye, Ze = center of ellipsoid XYZ coordinates (microns)');
            fprintf(fileID,'%s\r\n','EllipVol = volume of fitted ellipsoid (cubic microns)');
            fprintf(fileID,'%s\r\n',['uV1x, uV1y, ... uV3z = XYZ components of the three unit',...
                       ' vectors that define the ellipsoid semi-axes.']);
            fprintf(fileID,'%s\r\n',['r1, r2, r3 = radii of ellipsoid (magnitude ',...
                       'of semi-axes vectors) (microns)']);
            fprintf(fileID,'%s\r\n',['Vector-Point Angle = deviation angle between vectors and',...
                       ' intersection point (degrees)']);
            fprintf(fileID,'%s\r\n',['Vector-Point Distance = shortest distance between vectors',...
                       ' and intersection point (microns)']);
            fprintf(fileID,'%s\r\n',['MBCD@EllipseCenter = Minimum Bounding Circle Diameter of Cell',...
                       ' Cross Section Parallel to R2 and R3, and passing through [Xe,Ye,Ze]',...
                       ' (microns) [zero means the calculation failed]'])      
            fprintf(fileID,'%s\r\n',['MBCD@CellCenter = Minimum Bounding Circle Diameter of Cell Cross',...
                       ' Section Parallel to R2 and R3, and passing through [Xc,Yc,Zc]',...
                       ' (microns) [zero means the calculation failed]'])    
            fprintf(fileID,'%s\r\n',['Chi2 = residual sum of squared errors (chi^2),',...
                       ' this chi2 is in the coordinate frame in which the ellipsoid is a unit sphere']);
            fprintf(fileID,'%s\r\n\r\n','AveFitDev = Average Fit Deviation: sqrt(Chi2/NumDataPoints)');
            fprintf(fileID,'%s\r\n\r\n\r\n','======== End Column Header Definitions ============');
            % Data Column Headers -------------------------------------------------------------------------
            fprintf(fileID,['%s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t ',...
                            '%s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t ',...
              '%s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\r\n'],...
              'Cell#','Xc','Yc','Zc','CellVol','MBSD','MBSCx','MBSCy','MBSCz','Xe','Ye','Ze','EllipVol',...
                            'uV1x','uV1y','uV1z','uV2x','uV2y','uV2z','uV3x','uV3y','uV3z',...
                            'r1','r2','r3','Vector-Point Angle',' Vector-Point Distance',...
                            'MBCD@EllipseCenter','MBCD@CellCenter','Chi2','AveFitDev',...
                            'A','B','C','D','E','F','G','H','I','J');
        end
%----------------------------------------------------------------------------------------------------------
    if isempty(handles.VectorData)
        Vis = find(handles.ObjVisible);  
        N = numel(Vis);
        for k = 1:N
            index = Vis(k); 
            CI  = handles.CellData{index,1}.CellIndex;
                XYZ = handles.CellData{index,1}.CellCenterOfMass;
            Xdc = XYZ(1,1);
            Ydc = XYZ(1,2);
            Zdc = XYZ(1,3);
            CDV = handles.CellData{index,1}.CellVolume;
            MBSD = 2*handles.CellData{index,1}.MinBoundingSphereRadiusOfCell;
            MBSC = handles.CellData{index,1}.CenterOfMinBoundingSphere;
            fprintf(fileID,'%05i\t %.5e\t %.5e\t %.5e\t %.6e\t %#.5g\t %.5e\t %.5e\t %.5e\r\n',...
                CI,Xdc,Ydc,Zdc,CDV,MBSD,MBSC(1),MBSC(2),MBSC(3)); 
        end
    else
        [VecAngle, VecDist] = CalculateRelativeAngle(handles);            
        N = length(handles.VectorData);

        if isempty(VecAngle) 
            VecAngle = zeros(N,1);
            VecDist = zeros(N,1);
        end
        CIgrab = [];
        Vis = find(handles.ObjVisible);  
        H = waitbar(0);
        for k = 1:N
            index = Vis(k); 
            % K is index number in this case because 'VectorData' is 
            % created when 'Show Cylinder Vector' is turned on.
            CI  = handles.VectorData{k,1}.CellIndex;
                XYZDataCentroid = handles.VectorData{k,1}.XYZDataCentroid;
            Xdc = XYZDataCentroid(1,1);
            Ydc = XYZDataCentroid(1,2);
            Zdc = XYZDataCentroid(1,3);
            CDV = handles.VectorData{k,1}.CellDataVolume;
            % MBSD = 2*handles.CellData{index,1}.MinBoundingSphereRadiusOfCell;
            % MBSC = handles.CellData{index,1}.CenterOfMinBoundingSphere;
            MBSD = handles.VectorData{k,1}.MBSD;
            MBSC = handles.VectorData{k,1}.MBSC;
                EllipsoidCenter = handles.VectorData{k,1}.EllipsoidCenter; 
            Xec = EllipsoidCenter(1,1);
            Yec = EllipsoidCenter(2,1);
            Zec = EllipsoidCenter(3,1);
            EV = handles.VectorData{k,1}.EllipsoidVolume;
                EigenVectors = handles.VectorData{k,1}.EigenVectors;
            E1x = EigenVectors(1,1);
            E1y = EigenVectors(2,1);
            E1z = EigenVectors(3,1);    
            E2x = EigenVectors(1,2);
            E2y = EigenVectors(2,2);
            E2z = EigenVectors(3,2);
            E3x = EigenVectors(1,3);
            E3y = EigenVectors(2,3);
            E3z = EigenVectors(3,3);
                Radius = handles.VectorData{k,1}.Radius;
            R1 = Radius(1,1);
            R2 = Radius(2,1);
            R3 = Radius(3,1);
            %-------
            VA = VecAngle(k,1);
            VD = VecDist(k,1);
            %-------
          %|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
      % Calculate Minimum Bounding Circle of Cell at Ellipsoid center cross-section AND Cell Center of Mass
                index = Vis(k); 
                CellSurface.faces = handles.IsoSurfaceHandles{index,1}.Faces;; 
                CellSurface.vertices = handles.IsoSurfaceHandles{index,1}.Vertices;

                C1 = [Xec, Yec, Zec];
                C2 = double([Xdc, Ydc, Zdc]);
                r1 = [E1x, E1y, E1z];
                r2 = [E2x, E2y, E2z];;
                r3 = [E3x, E3y, E3z];;
                rmag = sqrt(R2.^2 + R3.^2);

               MBCD_EllipsCenter = CalculateMBCDIntersectingPlane( NaN, CellSurface, C1, r1, r2, r3, rmag); 
               MBCD_CellCenter   = CalculateMBCDIntersectingPlane( NaN, CellSurface, C2, r1, r2, r3, rmag); 

            %||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
            P = handles.VectorData{k,1}.EllipsoidEquationParam; 
                % Ax^2 + By^2 + Cz^2 + 2Dxy + 2Exz + 2Fyz + 2Gx + 2Hy + 2Iz + J = 0
            Pa = P(1);
            Pb = P(2);
            Pc = P(3);
            Pd = P(4);
            Pe = P(5);
            Pf = P(6);
            Pg = P(7);
            Ph = P(8);
            Pi = P(9);
            Pj = P(10);

            Chi2 = handles.VectorData{k,1}.chi2;
            nChi2 = handles.VectorData{k,1}.NormChi2;

            fprintf(fileID,'%05i\t %.5e\t %.5e\t %.5e\t ',  CI, Xdc, Ydc, Zdc); % 4 
            fprintf(fileID,'%.6e\t %#.5g\t %.5e\t %.5e\t %.5e\t %.5e\t %.5e\t %.5e\t ',...
                            CDV, MBSD, MBSC(1), MBSC(2), MBSC(3), Xec, Yec, Zec); % 4
fprintf(fileID,'%.6e\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t %+0.5f\t ',...
                            EV, E1x, E1y, E1z, E2x, E2y, E2z, E3x, E3y, E3z); % 10
            fprintf(fileID,'%.5e\t %.5e\t %.5e\t ', R1, R2, R3);  % 3
            fprintf(fileID,'%#.5g\t %#.5g\t', VA, VD);     % 2
            fprintf(fileID,'%#.5g\t %#.5g\t', MBCD_EllipsCenter, MBCD_CellCenter); %2
            fprintf(fileID,'%.5e\t %.5f\t ', Chi2, nChi2); % 2   
    fprintf(fileID,'%+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\t %+.5e\r\n',...
                            Pa, Pb, Pc, Pd, Pe, Pf, Pg, Ph, Pi, Pj); % 10 

            waitbar(k/N,H,'Exporting Data');             
        end

        try; close(H); end

    end
    fclose(fileID);  
    fclose('all');

end

%------------------------------------------------------------------------------------     
function PolarHistButton_Point_Callback(hObject, eventdata, handles)

        if ~isempty(handles.IntersectionPoint)
            N = length(handles.VectorData);
            IP = handles.IntersectionPoint';
            theta = zeros(N,1);
            d = theta;
            
            for k = 1:N
                CP = handles.VectorData{k,1}.XYZDataCentroid'; 
                LV  = (IP-CP);
                uLV = LV./norm(LV);
                RV = handles.VectorData{k,1}.EigenVectors(:,1);
                uRV = RV./norm(RV);
                theta(k,1) = asin(norm(cross(uLV,uRV)));  
                X0 = IP;
                X1 = CP;
                X2 = CP + RV;
                d(k,1) = norm(cross(X0-X1,X0-X2))/norm(X2-X1);                
            end

            figure(3768); clf
            set(3768,'Color',[1,1,1])
            subplot(1,2,1);cla
                p1 = histogram((180/pi).*theta,0:5:90);
                    x = p1.BinWidth/2 + p1.BinEdges(1:end-1);
                    y = p1.BinCounts;%./numel(theta);
                    xlim([0 90])
                hold on
                    plot(x,y,'.r','MarkerSize',10)
%                     [A,B,C,FWHM,X,Yfit] = GaussianEquationFit(x,y);
%                     [u,B,A,Mean,X,Yfit] = GumbelEquationFit(x,y);
%                     [A,B,C,FWHM,X,Yfit] = InverseGaussianEquationFit(x',y')
%                     plot(X,Yfit,'-r','LineWidth',1.5)
%                     title(['mode (gumbel equation fit) = ' sprintf('%6.3f',u) ' degrees'])
                    xlabel('Deviation Angle (degrees)')
                    ylabel('Counts')
                    grid on
                hold off
                 
            subplot(1,2,2); cla
                
                p2 = histogram(d,20); 
                x2 = p2.BinWidth/2 + p2.BinEdges(1:end-1);  
                y2 = p2.BinCounts;
%                 [u2,B2,A2,Mean2,X2,Yfit2] = GumbelEquationFit(x2,y2);
                hold on
                plot(x2,y2,'.r','MarkerSize',10)
%                 plot(X2,Yfit2,'-r','LineWidth',1.5)
%                 title(['mode (gumbel equation fit) = ' sprintf('%6.3f',u2) ' \mum'])
                xlabel('Distance from vector to point (\mum)')
                grid on
                set(handles.NavigationPanel,'BackgroundColor',[1,1,1])
                hold off
       
        else
            errordlg('You need to record an intersection on Image Panel')
        end
        
        
        
%------------------------------------------------------------------------------------
function [A,B,C,FWHM,X,Yfit] = GaussianEquationFit(x,y)
    %------------------------------------------------------
    % Gaussian Curve Fitting
    % [A,B,C,FWHM,X,Yfit] = GaussianEquationFit(x,y)
    %
    % Yfit = D + A*exp(-.5*((x-B)/C).^2); 
    %
    % -----------------------------------------------------
   
    N = numel(x);
    
    if N < 100
        X = linspace(min(x),max(x),100);
    else
        X = linspace(min(x),max(x),N);
    end
    % have to give the parameters some 'rough' start values
    [~,ind] = max(y);
    % a = [A B C D] starting values
    % a = [max(y); x(ind); diff([min(x) max(x)])/2; min(y)]; 
    a = [max(y); x(ind); diff([min(x) max(x)])/2]; 
    % Define Gaussian function with an anonymouns function handle having
    % parameters a(1),a(2),a(3),& a(4).
    % FitEquation = @(a,x) a(4) + a(1)*exp(-.5*((x-a(2))/a(3)).^2);
    FitEquation = @(a,x) a(1)*exp(-.5*((x-a(2))/a(3)).^2);
    % Apply Curve fitting function
    [v,~,~,~,~,~,~] = lsqcurvefit(FitEquation,a,x,y);
    A = v(1); B = v(2); C = v(3); %D = v(4);
    % Create new Y-data vector based on equation and fit parameters
    Yfit = A*exp(-.5*((X-B)/C).^2); 
    X = X';
    Yfit = Yfit';
    % Plot data created using Fit Equation on top of original y data in red
    % plot(X,Yfit,'b-',x,y,'.r')
    % Calculate tau, or Full Width at Half Max (FWHM)
    FWHM = 2.35482*C; % FWHM is 2.35482...*sigma
    
%------------------------------------------------------------------------------------  
function [u,B,A,Mean,X,Yfit] = GumbelEquationFit(x,y)
    %-----------------------------------------------------
    %
    % G = A*exp(-(z+exp(-z)))
    % where z = ((x-u)/B)
    % u = mode
    % mean = u+B*g (where g is Euler's constant)
    %
    %-----------------------------------------------------
    N = numel(x);

    if N < 100
        X = linspace(min(x),max(x),100)';
    else
        X = linspace(min(x),max(x),N)';
    end
    % have to give the parameters some 'rough' start values
    [val,ind] = max(y);
    % a = [B u] starting values
    % a = [max(y); x(ind)]; 
    u = x(ind);
    a = [1; u; 2.8*val]; 
    % Define Gumbel function with an anonymouns function handle having
    % parameters a(1),a(2)
    % B = a(1); u = a(2); A = a(3); 
    FitEquation = @(a,x) a(3)*exp(-(((x-a(2))/a(1)) + exp(-((x-a(2))/a(1)))));
    % Apply Curve fitting function
    [v,~,~,~,~,~,~] = lsqcurvefit(FitEquation,a,x,y);
    u = v(2); B = v(1); A = v(3);
    % Create new Y-data vector based on equation and fit parameters
    Yfit = A*exp(-(((X-u)/B) + exp(-((X-u)/B))));

    % Plot data created using Fit Equation on top of original y data in red
    % plot(X,Yfit,'b-',x,y,'.r')
    % Calculate tau, or Full Width at Half Max (FWHM)
    Mean = -psi(1)*B + u;

%------------------------------------------------------------------------------------
    function SliceOrLineCheck_Callback(hObject, eventdata, handles)
    
    if handles.SliceOrLineCheck.Value
        set(handles.XSliceCheck,'String','X Line')
        set(handles.YSliceCheck,'String','Y Line')
        set(handles.ZSliceCheck,'String','Z Line')
        handles.SliceOrLine = 'Line';
        
        if isgraphics(handles.XSliceHandle); delete(handles.XSliceHandle); end
        if isgraphics(handles.YSliceHandle); delete(handles.YSliceHandle); end
        if isgraphics(handles.ZSliceHandle); delete(handles.ZSliceHandle); end
        if isgraphics(handles.XYSliceIntersectionHandle); delete(handles.XYSliceIntersectionHandle); end
        if isgraphics(handles.ZXSliceIntersectionHandle); delete(handles.ZXSliceIntersectionHandle); end
        if isgraphics(handles.ZYSliceIntersectionHandle); delete(handles.ZYSliceIntersectionHandle); end
        if isgraphics(handles.XSliceBorderHandle); delete(handles.XSliceBorderHandle); end    
        if isgraphics(handles.YSliceBorderHandle); delete(handles.YSliceBorderHandle); end   
        if isgraphics(handles.ZSliceBorderHandle); delete(handles.ZSliceBorderHandle); end    
        if isgraphics(handles.CP); delete(handles.CP); end
        if handles.DoXSlice;  handles = Update_Slice_Plot(handles,1); end
        if handles.DoYSlice;  handles = Update_Slice_Plot(handles,2); end
        if handles.DoZSlice;  handles = Update_Slice_Plot(handles,3); end
    else
        set(handles.XSliceCheck,'String','X Slice')
        set(handles.YSliceCheck,'String','Y Slice')
        set(handles.ZSliceCheck,'String','Z Slice')
        handles.SliceOrLine = 'Slice';
            
        if isgraphics(handles.XSliceHandle); delete(handles.XSliceHandle); end
        if isgraphics(handles.YSliceHandle); delete(handles.YSliceHandle); end
        if isgraphics(handles.ZSliceHandle); delete(handles.ZSliceHandle); end
        if isgraphics(handles.XYSliceIntersectionHandle); delete(handles.XYSliceIntersectionHandle); end
        if isgraphics(handles.ZXSliceIntersectionHandle); delete(handles.ZXSliceIntersectionHandle); end
        if isgraphics(handles.ZYSliceIntersectionHandle); delete(handles.ZYSliceIntersectionHandle); end
        if isgraphics(handles.XSliceBorderHandle); delete(handles.XSliceBorderHandle); end    
        if isgraphics(handles.YSliceBorderHandle); delete(handles.YSliceBorderHandle); end   
        if isgraphics(handles.ZSliceBorderHandle); delete(handles.ZSliceBorderHandle); end    
        if isgraphics(handles.CP); delete(handles.CP); end

        if handles.DoXSlice;  handles = Update_Slice_Plot(handles,1); end
        if handles.DoYSlice;  handles = Update_Slice_Plot(handles,2); end
        if handles.DoZSlice;  handles = Update_Slice_Plot(handles,3); end
    end
      
    guidata(hObject,handles)
    
%------------------------------------------------------------------------------------     
function RecordIntersectionButton_Callback(hObject, eventdata, handles)

        if handles.DoXSlice && handles.DoYSlice && handles.DoZSlice
            x = handles.X_Plane_Slider.Value;
            y = handles.Y_Plane_Slider.Value;
            z = handles.Z_Plane_Slider.Value;
            handles.IntersectionPoint = [x y z];
            
            text1 = ['<x,y,z> = < '     sprintf('%5.2f',x)...
                                  ',  ' sprintf('%5.2f',y)...
                                  ',  ' sprintf('%5.2f',z) ' >'];
            
            set(handles.IntersectionPointDisplay,'String',text1,'FontWeight','normal',...
                        'Position',[14 9 411 20],'FontSize',11,'HorizontalAlignment','center')
        end

        guidata(hObject,handles)
        
%------------------------------------------------------------------------------------     
function SaveAnalysisButton_Callback(hObject, eventdata, handles)
        
        FH = WaitToSaveDialogue;
        
        DATA.IsoObjXYZ = handles.IsoObjXYZ;
        DATA.IsoCapXYZ = handles.IsoCapXYZ;
        DATA.IsoSurfaceIdentifier = handles.IsoSurfaceIdentifier;
        DATA.IsoCapIdentifier     = handles.IsoCapIdentifier;
        
        DATA.CellIndices = handles.CellIndices;
        DATA.CellSizes   = handles.CellSizes;
        DATA.ObjVisible  = handles.ObjVisible;
        DATA.ObjSelected = handles.ObjSelected;
        
        DATA.PartialCell = handles.PartialCell;
        DATA.sX = handles.sX;
        DATA.sY = handles.sY;
        DATA.sZ = handles.sZ;
        DATA.V  = handles.V;
        %========================================================================
        if isfield(handles,'SubImStack') 
            DATA.SubImStack  = handles.SubImStack;
        else
            xr   = (handles.sPix(1,2):handles.ePix(1,2))';   % x index range
            yr   = (handles.sPix(1,1):handles.ePix(1,1))';   % y index range
            zr   = (handles.Z1:handles.Z2)';                 % z index range
            DATA.SubImStack = handles.IMstack(yr,xr,zr);
        end
        %========================================================================= 
        % handles.RenderedSubVolumeIndices = [yr(1) yr(end) xr(1) xr(end) zr(1) zr(end)];
        
        if isfield(handles,'RenderedSubVolumeIndices') 
            DATA.RenderedSubVolumeIndices = handles.RenderedSubVolumeIndices;
        else
            xr   = (handles.sPix(1,2):handles.ePix(1,2))';   % x index range
            yr   = (handles.sPix(1,1):handles.ePix(1,1))';   % y index range
            zr   = (handles.Z1:handles.Z2)';       
            DATA.RenderedSubVolumeIndices = [yr(1) yr(end) xr(1) xr(end) zr(1) zr(end)];
        end
        %=========================================================================
        DATA.PixelWidth = handles.PixelWidth;
        DATA.ZStep = handles.ZStep;
           k = strfind(handles.FileName,'\');
        DATA.FileName = handles.FileName(k(end)+1:end);
        DATA.sPix = handles.sPix;
        DATA.ePix = handles.ePix;
        DATA.Z1   = handles.Z1;
        DATA.Z2   = handles.Z2;
        DATA.AxisRange = handles.AxisRange;
        DATA.FaceColor = handles.FaceColor;
        DATA.MeshColor = handles.MeshColor;
        DATA.subDT = handles.subDT;
        DATA.IntersectionPoint = handles.IntersectionPoint;
        DATA.LowSizeFilter  = handles.LowSizeFilter;
        DATA.HighSizeFilter = handles.HighSizeFilter;
        DATA.FilterParam = handles.FilterParam;
        DATA.CellData = handles.CellData;
       
        filters = {'*.mat','MAT-files (*.mat)'};
        [fn,pn,~] = uiputfile(filters, 'Input Analysis File save name', 'LongAxis_DataAnalysis');
        if ~isequal(fn,0)
            save([pn,fn],'DATA','-v7.3')
        end
        
        % uisave('DATA','LongAxis_DataAnalysis') 
        
        try close(FH); end
%------------------------------------------------------------------------------------     
function LoadAnalysisButton_Callback(hObject, eventdata, handles)
    
    [FileName,PathName,FilterIndex] = uigetfile('*.mat');
     
    
    if ~isequal(0,FileName)  
        FA = WaitToLoadAnalysisDialogue;
        drawnow
        load([PathName, FileName])
        if exist('DATA','var')
            handles.IsoObjXYZ = DATA.IsoObjXYZ;
            handles.IsoCapXYZ = DATA.IsoCapXYZ;
            handles.IsoSurfaceIdentifier = DATA.IsoSurfaceIdentifier;
            handles.IsoCapIdentifier     = DATA.IsoCapIdentifier;
                      
            handles.CellIndices = DATA.CellIndices;
            handles.CellSizes   = DATA.CellSizes;
            handles.ObjVisible  = DATA.ObjVisible;
            handles.ObjSelected = DATA.ObjSelected;
            
            handles.PartialCell = DATA.PartialCell;
            handles.sX = DATA.sX;
            handles.sY = DATA.sY;
            handles.sZ = DATA.sZ;  
            handles.V  = DATA.V; % Labled Object Array (cell objects)
            handles.PixelWidth = DATA.PixelWidth;
            handles.ZStep      = DATA.ZStep;
            handles.OriginalImageFileName = DATA.FileName;
            handles.sPix = DATA.sPix;
            handles.ePix = DATA.ePix;
            handles.Z1   = DATA.Z1;
            handles.Z2   = DATA.Z2;
            %========================================================================
            if isfield(DATA,'SubImStack') 
                handles.SubImStack = DATA.SubImStack;
            else
                xr   = (handles.sPix(1,2):handles.ePix(1,2))';   % x index range
                yr   = (handles.sPix(1,1):handles.ePix(1,1))';   % y index range
                zr   = (handles.Z1:handles.Z2)';                 % z index range
                handles.SubImStack = handles.IMstack(yr,xr,zr);
            end
            %========================================================================= 
            % handles.RenderedSubVolumeIndices = [yr(1) yr(end) xr(1) xr(end) zr(1) zr(end)];
            if isfield(DATA,'RenderedSubVolumeIndices') 
                handles.RenderedSubVolumeIndices = DATA.RenderedSubVolumeIndices;
            else
                xr   = (handles.sPix(1,2):handles.ePix(1,2))';   % x index range
                yr   = (handles.sPix(1,1):handles.ePix(1,1))';   % y index range
                zr   = (handles.Z1:handles.Z2)';       
                handles.RenderedSubVolumeIndices = [yr(1) yr(end) xr(1) xr(end) zr(1) zr(end)];
            end
            %=========================================================================
            handles.AxisRange = DATA.AxisRange;
            handles.FaceColor = DATA.FaceColor; 
                handles.FaceColorButton.BackgroundColor = handles.FaceColor;
            handles.MeshColor = DATA.MeshColor;
                handles.MeshColorButton.BackgroundColor = handles.MeshColor;
            handles.subDT     = DATA.subDT;
            handles.IntersectionPoint = DATA.IntersectionPoint;
            handles.LowSizeFilter  = DATA.LowSizeFilter;
                set(handles.Low_Size_Filter_Input, 'String',num2str(handles.LowSizeFilter))
            handles.HighSizeFilter = DATA.HighSizeFilter;
                set(handles.High_Size_Filter_Input,'String',num2str(handles.HighSizeFilter))
            handles.FilterParam = DATA.FilterParam;
            handles.CellData = DATA.CellData;
            
            % For backwards compatibility, check if MBSR is there. If not calculate them ------------------
            if ~isfield(handles.CellData{1,1},'MinBoundingSphereRadiusOfCell');
                FS = CalculatingMBSR;
                drawnow
                for n = 1:length(handles.CellData)
                    % Use this function to calculate cell size
                    [MinRadius,SC,~] = ExactMinBoundSphere3D([mean(handles.IsoObjXYZ{n,1}.DataPts.X)',...
                                                              mean(handles.IsoObjXYZ{n,1}.DataPts.Y)',...
                                                              mean(handles.IsoObjXYZ{n,1}.DataPts.Z)']); 
                
                    handles.CellData{n,1}.MinBoundingSphereRadiusOfCell = MinRadius;
                    handles.CellData{n,1}.CenterOfMinBoundingSphere = SC;
                end
                close(FS)
            end
            %----------------------------------------------------------------------------------------------             
            %handles.ImageVolumeForSlices = DATA.ImageVolumeForSlices;
            %--------------------------------------------------
                v(1,1) = handles.sPix(1,1);
                v(2,1) = handles.sPix(1,2);
                v(3,1) = handles.ePix(1,1);
                v(4,1) = handles.ePix(1,2);
            %--------------------------------------------------
            [R,C,~] = size(handles.IMstack);
            
            uPerPixX = diff(handles.Navigation_Figure.XLim)/C;
            uPerPixY = diff(handles.Navigation_Figure.YLim)/R;

            handles.Region_X = uPerPixX*[v(2,1) v(4,1) v(4,1) v(2,1) v(2,1)];
            handles.Region_Y = uPerPixY*[v(1,1) v(1,1) v(3,1) v(3,1) v(1,1)];

            %set(0,'CurrentFigure',handles.MainFigure1)
            %set(handles.MainFigure1,'CurrentAxes',handles.Navigation_Figure)
            set(handles.FaceColorButton,'BackgroundColor',handles.FaceColor)
            set(handles.MeshColorButton,'BackgroundColor',handles.MeshColor)
            
            % -------------------------------------------------------------------------------------
            if ~isempty(handles.IntersectionPoint)
                text1 = ['< x y z >  =  < '  sprintf('%5.2f',handles.IntersectionPoint(1))...
                                        '  ' sprintf('%5.2f',handles.IntersectionPoint(2))...
                                        '  ' sprintf('%5.2f',handles.IntersectionPoint(3)) ' >'];
                set(handles.IntersectionPointDisplay,'String',text1,'FontWeight','bold',...
                                                     'Position',[5 11 287 18],'FontSize',8,...
                                                     'HorizontalAlignment','center')
                set(handles.PolarHistButton_Point,'Enable','on')   
            else
                set(handles.IntersectionPointDisplay,'String','','FontWeight','bold',...
                                                     'Position',[5 11 287 18],'FontSize',8,...
                                                     'HorizontalAlignment','center')
                set(handles.PolarHistButton_Point,'Enable','off')
            end
            % -------------------------------------------------------------------------------------
            handles = Update_Navigation_Figure(handles);
            set(handles.Create_3D_Rendering_Button,'Enable','on')
            set(handles.HandednessLabel,'Visible','on') 
                        
            handles.CellList.Value = 1;
            handles.CellList.String = {''};
            handles.CellList.Enable = 'off';
            handles.CellList.KeyPressFcn   = []; 
            handles.COM = [];
            
            handles = Refresh_Rendering(handles);
            handles = Update_Rendering(handles);
               
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            set(handles.PolarHistButton,'Enable','on')
            
            set(handles.RecordIntersectionButton,'Enable','off')
            set(handles.CalculateConvergencePointButton,'Enable','off')
            set(handles.BuildUrchinPlotButton,'Enable','off')
            
            handles.UndoButtonRecordedVisActions = false(0,1);
            try; close(FA); end
            guidata(hObject,handles)
        else
            errordlg('The file you selected is not a LongAxis Analysis file.');
        end
    end  
    
    
%------------------------------------------------------------------------------------     
function ApplySizeFilterButton_Callback(hObject, eventdata, handles)
        
            %-- Record Visibility State for Undo Button --------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %---------------------------------------------------------------------------------------------  
    
           FP = WaitToProcessDialogue; % if isgraphics(FP); close(FP); end 
           nObjects = length(handles.IsoSurfaceHandles);
           
           % delete vectors if they are displayed ------------------
            if ~isempty(handles.VectorHandles)
                set(handles.VectorDisplay_Listbox,'Value',1);
                handles.ShowVectors = false;
                handles = Add_Vectors_To_Main_Figure(handles);
                set(handles.VectorColor_Button,'Enable','off')
                set(handles.VectorRadiusInput, 'Enable','off')
                set(handles.VectorLengthInput, 'Enable','off')
                set(handles.PolarHistButton,   'Enable','off')
                set(handles.PolarHistButton_Point,'Enable','off')
                set(handles.R1R2FilterButton,'Enable','off')
                set(handles.MBSD_MBCD_FilterButton,'Enable','off')
                set(handles.R2R3FilterButton,'Enable','off')
                set(handles.VolumeDiffFilterButton,'Enable','off')
            end
            %--------------------------------------------------------
            
            for n = 1:nObjects
                ObjSize = handles.CellSizes(n); % Sizes are in voxel
                if ObjSize < handles.LowSizeFilter || ObjSize > handles.HighSizeFilter
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                    set(handles.IsoCapHandles{n,1},'Visible','off')
                    handles.ObjVisible(n,1) = false;
                    handles.ObjSelected(n,1) = false;
                end
            end
            
            % Update Cell List box ----------------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % -------------------------------------------------------------------------------------
            set(0,'CurrentFigure',handles.RenderingFigure)
            
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            guidata(hObject,handles)
            
            if isgraphics(FP); close(FP); end 
            
            
%------------------------------------------------------------------------------------     
function Refresh3D_Button_Callback(hObject, eventdata, handles)
    
    choice = questdlg('Are you sure you want to Refresh Rendering?', ...
	'Warning', ...
	'YES','NO','NO');

    switch choice
        case 'YES'
            set(handles.CellList,'ListboxTop',1)
            handles = Refresh_Rendering(handles);
            handles = Update_Rendering(handles);
            
            guidata(hObject,handles)
        case 'NO'
            
    end

%-----------------------------------------------------------------------------------
function AboutButton_Callback(hObject, eventdata, handles)

    message = [{' Longaxis written and designed by: Keith R. Carney'};...
               {'     '};...
               {'         email: keith.carney@path.utah.edu '};... 
               {'            or:     ny2ak2ut@hotmail.com '};...
               {'     '};... 
               {'     '};... 
               {'    University of Utah '};...
               {'    Department of Human Genetics '};...
               {'    Kristen M. Kwan Lab, 2017 '};...
               {'     '};
               {'     '}];

    f = figure('NumberTitle','off',...
               'Position',[200 200 470 200],...
               'Name','About Longaxis',...
               'Resize','off',...
               'Toolbar','none',...
               'WindowStyle','normal',...
               'MenuBar','none');   
    
    uicontrol('Parent',f,'Style','text','FontName','FixedWidth','FontWeight','bold',...
         'FontSize',10,'String',message,'Position',[15 5 470 170],...
         'HorizontalAlignment','Left');
    

%-----------------------------------------------------------------------------------
function ShortCutButton_Callback(hObject, eventdata, handles)

    message = [{'LONGAXIS KEYBOARD SHORTCUTS:'};...
               {'     '};... 
               {'    "R"      Toggles pointer ROTATE or SELECTION '};...
               {'     '};...
               {'    "V"      Toggles cell VISIBILITY on/off'};...
               {'     '};... 
               {'    "H"      Toggles cell HIGHLIGHTING on/off'};...
               {'     '};...
               {'    "S"      Starts MULTI-CELL HIGHLIGHTING'};...
               {'     '};...
               {'    "U"      UNDO visibility changes (stores up to 100)'};...
               {'     '};...
               {'"UP/DOWN Arrow"     ADVANCE selected cell in cell-list'};...
               {'     '}];...

    f = figure('NumberTitle','off',...
               'Position',[200 300 500 250],...
               'Name','LongAxis Short Cuts',...
               'Resize','off',...
               'Toolbar','none',...
               'WindowStyle','normal',...
               'MenuBar','none');   
    
    uicontrol('Parent',f,'Style','text','FontName','FixedWidth','FontWeight','bold',...
         'FontSize',10,'String',message,'Position',[30 0 500 230],...
         'HorizontalAlignment','Left');
   
    
%-----------------------------------------------------------------------------------
function R1R2FilterButton_Callback(hObject, eventdata, handles)
    
        % ----------------------------------------------------------------
            prompt = {'r1/r2 min value:','r1/r2 max value:'};
            dlg_title = 'Input r1/r2 Filter Parameters:';
            defaultans = {'2','10'};

            if isfield(handles.FilterParam,'R1R2_Min_Value')
                if ~isempty(handles.FilterParam.R1R2_Min_Value)
                    defaultans = {num2str(handles.FilterParam.R1R2_Min_Value),...
                                  num2str(handles.FilterParam.R1R2_Max_Value)};
                end
            else
                defaultans = {'2','10'};
            end

            answer = inputdlg(prompt, dlg_title, [1 60; 1 60], defaultans);
        % ---------------------------------------------------------------  
        
        if ~isempty(answer)
            
                %-- Record Visibility State for Undo Button ------------------------------------------------
                    handles = UpdateActionRecordingsForUNDO(handles);
                %-------------------------------------------------------------------------------------------  
            
                FP = WaitToProcessDialogue; % try close(FP); end
                v = str2double(answer);

                handles.FilterParam.R1R2_Min_Value = v(1);
                handles.FilterParam.R1R2_Max_Value = v(2);

                %Data = handles.DataTable.Data;
                N = length(handles.VectorData);

                for ii = 1:N
                        ind = handles.VectorData{ii,1}.CellIndex;
                        r = handles.VectorData{ii,1}.Radius;
                        R1R2 = r(1)/r(2);
                        delete(handles.VectorHandles{ii,1})
                        if R1R2 < v(1) || R1R2 > v(2) 
                            set(handles.IsoSurfaceHandles{ind,1},'Visible','off')
                            set(handles.IsoCapHandles{ind,1},    'Visible','off')
                            handles.ObjVisible(ind,1)  = false;
                            handles.ObjSelected(ind,1) = false;
                            
                        end
                end
            
                handles.VectorHandles = [];


                %-------------Update Cell List box --------------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
                %------------------------------------------------------------------------------------------
                set(0,'CurrentFigure',handles.RenderingFigure)
                nvis = sum(double(handles.ObjVisible));
                set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
                
                handles = Add_Vectors_To_Main_Figure(handles);
                
                guidata(hObject,handles)
                
                try close(FP); end %#ok<*TRYNC>
        end

%-----------------------------------------------------------------------------------
function MBSD_MBCD_FilterButton_Callback(hObject, eventdata, handles)

      
        % --------------------------------------------------------------
            prompt = {'Input lower MBSD/MBCD ratio value','Input upper MBSD/MBCD ratio value'};
            dlg_title1 = 'MBSD/MBCD ratio band-pass filter';
            defaultans = [{'1.2'},{'6'}];
            answer = inputdlg(prompt, dlg_title1, [1 60], defaultans);
        % --------------------------------------------------------------
        
        if ~isempty(answer)
                %-- Record Visibility State for Undo Button ------------------------------------------------
                    handles = UpdateActionRecordingsForUNDO(handles);
                %-------------------------------------------------------------------------------------------  
                FP = WaitToProcessDialogue; % if isgraphics(FP); close(FP); end
                LowVal = str2double(answer{1,1});
                HighVal = str2double(answer{2,1});
                N = length(handles.VectorData);
                
                [MBSD, MBCD] = Calculate_MBSD_MBCD(handles);
                Ratio = MBSD./MBCD;
                
                for ii = 1:N
                    ind = handles.VectorData{ii,1}.CellIndex;
                    delete(handles.VectorHandles{ii,1})
                    if Ratio(ii,1) < LowVal || Ratio(ii,1) > HighVal
                        set(handles.IsoSurfaceHandles{ind,1},'Visible','off')
                        set(handles.IsoCapHandles{ind,1},    'Visible','off')
                        handles.ObjVisible(ind,1)  = false;
                        handles.ObjSelected(ind,1) = false;
                    end
                end

                handles.VectorHandles = [];
                %-------------Update Cell List box --------------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
                %------------------------------------------------------------------------------------------
                set(0,'CurrentFigure',handles.RenderingFigure) 
                nvis = sum(double(handles.ObjVisible));
                set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
                
                handles = Add_Vectors_To_Main_Figure(handles);
                guidata(hObject,handles)

                try close(FP); end
        end

% -----------------------------------------------------------------------------------
function DataAndEllipsoidPanelButton_Callback(hObject, eventdata, handles)
    
      set(handles.DataAndEllipsoidPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
          'BackgroundColor',[0.4 0.4 0.4])
      set(handles.FitPanel,'Position',[151 666 360 120],'Visible','on')
      set(handles.SizeFilterPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
          'BackgroundColor',[0.8 0.8 0.8])
      set(handles.FilterPanel,'Position',[151 666 360 120],'Visible','off')

% -----------------------------------------------------------------------------------
function SizeFilterPanelButton_Callback(hObject, eventdata, handles)
    
      set(handles.DataAndEllipsoidPanelButton,'Value',0,'ForegroundColor',[0.2 0.2 0.2],...
          'BackgroundColor',[0.8 0.8 0.8])
      set(handles.FitPanel,'Position',[151 666 360 120],'Visible','off')
      set(handles.SizeFilterPanelButton,'Value',1,'ForegroundColor',[1 1 1],...
          'BackgroundColor',[0.4 0.4 0.4])
      set(handles.FilterPanel,'Position',[151 666 360 120],'Visible','on')

% -----------------------------------------------------------------------------------
function Panel3_Callback(hObject, eventdata, handles)


% -----------------------------------------------------------------------------------
function SingleCellViewAngleSlider_Callback(hObject, eventdata, handles)
    
        val = (round(10*get(handles.SingleCellViewAngleSlider,'Value')))./10;
        set(handles.SingleCellViewAngleSlider,'Value',val)
        set(handles.SingleCellViewAngleDisplay,'String',['Zoom: ' sprintf('%3.1f',val) ' deg'])
        handles.SingleCellViewAngle = val;
        set(handles.SelectedCellAxis,'CameraViewAngle',handles.SingleCellViewAngle)
        
        guidata(hObject,handles)

% -----------------------------------------------------------------------------------
function SingleCellViewAngleSlider_CreateFcn(hObject, eventdata, handles)

    % Hint: slider controls usually have a light gray background.
    if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
        set(hObject,'BackgroundColor',[.9 .9 .9]);
    end


% --- Executes on button press in togglebutton10.
function togglebutton10_Callback(hObject, eventdata, handles)
% hObject    handle to togglebutton10 (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of togglebutton10

%-----------------------------------------------------------------------------------
function [V_ord] = ordfilt3(V0,ord,winSize,pad_opts)
    % ordfilt3:    Performs 3D order-statistic filtering on 3D volumetric data.
    %              The memory and computational overhead for such an operation
    %              can be extremely demanding. Here - memory efficiency has been 
    %              achieved with a recursive-split algorithm,
    %              allowing for far larger volumes and/or window sizes to be
    %              processed. 
    %              
    %              The basic operation is fairly simple - the volume is
    %              recursively split into 8 even sub-blocks, until sub-blocks
    %              are reached that are small enough for the filter to be
    %              computed with a single call (i.e. when there is enough free
    %              contiguous 
    %              memory to process the entire sub-block)
    %              The intermediate results are propagated back up the
    %              call stack which then fill output matrix (V_ord)
    %               
    %              By calling  [V_ord] = ordfilt3(V0,ord,3,pad_opts), 
    %              this code computes the 26-neighbourhood order statistic
    %              filter, which is the same as outputted by Olivier Salvado's implementation 
    %              (but which is non-splitting, and uses a fixed
    %              3*3*3 window.)
    %               
    %              Usage:
    %
    %       [V_ord] = ordfilt3(V0,ord,winSize,pad_opts)
    %
    %
    %       Inputs:
    %       V0: Numeric 3D volume. Supports all numeric classes
    %       ord: Speficies which order statistic to return.
    %           This can be a string, or a number 1<=ord<=winSize^3
    %           For example:
    %           ord = 'min' returns the minimum window value (same as ord = 1)
    %           ord = 'max' returns the maximum window value (same as ord =
    %           winSize^3)
    %           ord = 'med' returns the median window value
    %
    %       winSize: Size of filter window. Currently, only cubic windows are
    %           permitted, whose Length=Width=Height = winSize. This must be
    %           odd.
    %
    %       pad_opts: same as defined in 'padarray'
    %
    %       Outputs:
    %       V_ord - Order Statistic.
    %
    % (c) Toby Collins, Edinburgh University, UK, September 2008#
    %     toby.collins@gmail.com
    %     2008

    %check pad arguments:
    if ~exist('pad_opts','var')
        pad_opts = 'replicate';
    end

    if ~(mod(winSize,2)==1)
        error('ordfilt3: winSize mist be odd.');
    end

    %parse ord argument:
    if isnumeric(ord)
        if  ord<1||ord>winSize^3
            error('ord parameter is out of bounds');
        end
        if ord==1
            ord='min'; %more efficient to use 'min' rather than sorting
        end
        if ord==winSize^3
            ord='max'; %more efficient to use 'max' rather than sorting
        end
    end
    %check for valid ord string:
    if ischar(ord)
        switch ord
            case 'max'
            case 'min'
            case 'med'
            otherwise
                error('Invalid ord parameter');
        end
    end

    %check for valid winSize agrument:
    if mod(winSize,2)~=1
        error('Window size must be odd');
    end

    w = (winSize-1)/2;

    %store size of the volume:
    sz = size(V0,1)*size(V0,2)*size(V0,3);

    %pad the volume:
    V = (padarray(V0,[w w w],pad_opts));

    p = 0;%variable storing the number of elements in V0 which have been processed. 
    %This is used for outputting progress to terminal.


    % EDITED region -----------------------------------------------------
    %M = feature('memstats'); <--- Original Code    % get the amount of free contiguous system memory:
    [userview systemview] = memory;
    M = systemview.VirtualAddressSpace.Available;
    %--------------------------------------------------------------------

    f=0.4;
    M=M*f; %do not use all contiguous memory (additional memory is needed, for example, 
    %for sorting the within the window)
    %The factor f=0.4 is a good choice, but can be modified: 0<f<=1. Smaller
    %values have the effect of processing smaller sub-blocks (which looses
    %efficiency since there are more filter calls.) Larger values means that
    %you may encounter out-of-memory issues, since there may be insufficient
    %additional memory for the intermediate filter computations (e.g. sorting.)


    %get the data class of V0:
    T = whos('V0');
    dClass = T.class;


    %Now do the recursive call:
    V_ord = ordfilt_compute(V,ord,M,w,dClass,sz,p);
    
%----------------------------------------------------------------------------------------------
% Sub-function of ordfilt3 --------------------------------------------------------------------
function [B,p] = ordfilt_compute(V0,ord,M,w,dClass,sz,p)
    %ordfilt_compute: Recursively called for computing the 3D order-statistics:
    %       Inputs:
    %       V0: Padded numeric 3D volume. Supports all numeric classes.
    %       ord: Speficies which order statistic to return.
    %           This can be a string, or a number 1<=ord<=winSize^3
    %           For example:
    %           ord = 'min' returns the minimum window value (same as ord = 1)
    %           ord = 'max' returns the maximum window value (same as ord =
    %           winSize^3)
    %           ord = 'med' returns the median window value
    %
    %       M: Maximum number of bytes of contiguous memory available for
    %       computing the order statistic
    %
    %       w: window length either side of centre element
    %       dClass: data class of V0
    %       sz: number of elements in complete volume
    %       p: number of elements whose stats have already been computed.
    %
    %       Outputs:
    %       B: Order statistic for sub-block V0
    %       p: Updated number of elements that have been processed.
    %
    % (c) Toby Collins, Edinburgh University, UK, September 2008
    %     toby.collins@gmail.com
    %     2008


    S = size(V0);
    mid = round((S)/2);
    T = whos('V0');
    %test if we should evaluate data block stats:
    if (2*w+1)^3*T.bytes>M
        %no - so split the volume (8 sub-volumes and call ordfilt_compute on
        %each)
        V1 = V0(1:mid(1)+w,1:mid(2)+w,1:mid(3)+w);
        if sum(size(V1)==size(V0))==3 %Not enough free memory, since block size has not been reduced:
            error('Not enough free contiguous memory to compute order statistics.');       
        end
        [B1,p] = ordfilt_compute(V1,ord,M,w,dClass,sz,p); clear V1;

        V2 = V0(1:mid(1)+w,mid(2)-w+1:end,1:mid(3)+w);
        [B2,p]= ordfilt_compute(V2,ord,M,w,dClass,sz,p);  clear V2;

        V3 = V0(mid(1)-w+1:end,1:mid(2)+w,1:mid(3)+w);
        [B3,p] = ordfilt_compute(V3,ord,M,w,dClass,sz,p); clear V3;

        V4 = V0(mid(1)-w+1:end,mid(2)-w+1:end,1:mid(3)+w);
        [B4,p] = ordfilt_compute(V4,ord,M,w,dClass,sz,p); clear V4;

        V5 = V0(1:mid(1)+w,1:mid(2)+w,mid(3)-w+1:end);
        [B5,p] = ordfilt_compute(V5,ord,M,w,dClass,sz,p); clear V5;

        V6 = V0(1:mid(1)+w,mid(2)-w+1:end,mid(3)-w+1:end);
        [B6,p] = ordfilt_compute(V6,ord,M,w,dClass,sz,p); clear V6;

        V7 = V0(mid(1)-w+1:end,1:mid(2)+w,mid(3)-w+1:end);
        [B7,p] = ordfilt_compute(V7,ord,M,w,dClass,sz,p); clear V7;

        V8 = V0(mid(1)-w+1:end,mid(2)-w+1:end,mid(3)-w+1:end);
        [B8,p] = ordfilt_compute(V8,ord,M,w,dClass,sz,p); clear V8;

        %concatinate filtered sub-blocks:
        B = cat(3,cat(1,cat(2,B1,B2),cat(2,B3,B4)),cat(1,cat(2,B5,B6),cat(2,B7,B8)));
        clear B1 B2 B3 B4 B5 B6 B7 B8 V0;

    else
        %yes - compute it.

        %concatinated neighbouring elements along 4th dimension:
        Bfull = zeros([S-2*w,(2*w+1)^3],dClass);
        cc=0;
        for ii=-w:w
            ind1 = (w+1:S(1)-w)+ii;
            for jj=-w:w
                ind2 = (w+1:S(2)-w)+jj;
                for kk=-w:w
                    ind3 = (w+1:S(3)-w)+kk;
                    cc=cc+1;
                    Bfull(:,:,:,cc) = V0(ind1,ind2,ind3);
                end
            end
        end

        % Now perform the filtering:
        if isnumeric(ord)
            Bfull = sort(Bfull,4);
            B = Bfull(:,:,:,ord);
        else
            switch ord
                case 'max'
                    B=max(Bfull,[],4);
                case 'min'
                    B=min(Bfull,[],4);
                case 'med'
                    B=median(Bfull,4);
                otherwise
            end
        end
        %update p:
        p = p + (size(B,1))*(size(B,2))*(size(B,3));
        % disp(['ordfilt3: ' num2str(round(100*p/sz)) '% done']);    
    end
    
    
%-----------------------------------------------------------------------------------
function SingleCellHLCheck_Callback(hObject, eventdata, handles)
   
    handles.SingleCellHighLight = handles.SingleCellHLCheck.Value;    
    guidata(hObject,handles)    
        
%-----------------------------------------------------------------------------------        
function VolumeDiffFilterButton_Callback(hObject, eventdata, handles)
    
            prompt = {'Max percent difference in volume:'};
            dlg_title = 'Input max volume difference (%):';

            if isfield(handles.FilterParam,'VolPerDiffMaxValue')
                if ~isempty(handles.FilterParam.R1R2_Min_Value)
                    defaultans = {num2str(handles.FilterParam.VolPerDiffMaxValue)};
                end
            else
                defaultans = {'30'};
            end
            answer = inputdlg(prompt, dlg_title, [1 60], defaultans);
            
        % --------------------------------------------------------------
        if ~isempty(answer)
            
                %-- Record Visibility State for Undo Button -------------------------------------------------
                    handles = UpdateActionRecordingsForUNDO(handles);
                %--------------------------------------------------------------------------------------------  
            
                FP = WaitToProcessDialogue; % if isgraphics(FP); close(FP); end
                v = str2double(answer);
                handles.FilterParam.VolPerDiffMaxValue = v;
                % Data = handles.DataTable.Data;
                N = length(handles.VectorData);
                
                for ii = 1:N
                    ind = handles.VectorData{ii,1}.CellIndex;
                    VolCell  = handles.VectorData{ii,1}.CellDataVolume;
                    VolEllips = handles.VectorData{ii,1}.EllipsoidVolume;
                    VolDiff = abs(100*(VolCell - VolEllips)/VolCell);
                    delete(handles.VectorHandles{ii,1});
                    if VolDiff > v
                        set(handles.IsoSurfaceHandles{ind,1},'Visible','off')
                        set(handles.IsoCapHandles{ind,1},    'Visible','off')
                        handles.ObjVisible(ind,1)  = false;
                        handles.ObjSelected(ind,1) = false;
                       
                    end
                end

                handles.VectorHandles = [];
                
                %-------------Update Cell List box ---------------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
                %-------------------------------------------------------------------------------------------    
                
                set(0,'CurrentFigure',handles.RenderingFigure)
                nvis = sum(double(handles.ObjVisible));
                set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
                
                handles = Add_Vectors_To_Main_Figure(handles);
                
                guidata(hObject,handles)

                try close(FP); end
                
        end


% -----------------------------------------------------------------------------------
function R2R3FilterButton_Callback(hObject, eventdata, handles)

        % ----------------------------------------------------------------
            prompt = {'r2/r3 min value:','r2/r3 max value:'};
            dlg_title = 'Input r2/r3 Filter Parameters:';
            defaultans = {'1','1.75'};

            if isfield(handles.FilterParam,'R2R3_Min_Value')
                if ~isempty(handles.FilterParam.R2R3_Min_Value)
                    defaultans = {num2str(handles.FilterParam.R2R3_Min_Value),...
                                  num2str(handles.FilterParam.R2R3_Max_Value)};
                end
            else
                defaultans = {'0','1.75'};
            end

            answer = inputdlg(prompt, dlg_title, [1 60; 1 60], defaultans);
        % ---------------------------------------------------------------  
        
        if ~isempty(answer)
            
                %-- Record Visibility State for Undo Button ------------------------------------------------
                    handles = UpdateActionRecordingsForUNDO(handles);
                %-------------------------------------------------------------------------------------------  
                
                FP = WaitToProcessDialogue; % try close(FP); end
                v = str2double(answer);

                handles.FilterParam.R2R3_Min_Value = v(1);
                handles.FilterParam.R2R3_Max_Value = v(2);

                % Data = handles.DataTable.Data;
                N = length(handles.VectorData);

                for ii = 1:N
                        ind = handles.VectorData{ii,1}.CellIndex;
                        r = handles.VectorData{ii,1}.Radius;
                        R2R3 = r(2)/r(3);
                        delete(handles.VectorHandles{ii,1}) 
                        if R2R3 < v(1) || R2R3 > v(2) 
                            set(handles.IsoSurfaceHandles{ind,1},'Visible','off')
                            set(handles.IsoCapHandles{ind,1},    'Visible','off')
                            handles.ObjVisible(ind,1)  = false;
                            handles.ObjSelected(ind,1) = false;
                          
                        end
                end
            
                handles.VectorHandles = [];
                
                %-------------Update Cell List box --------------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
                %------------------------------------------------------------------------------------------
                
                set(0,'CurrentFigure',handles.RenderingFigure)
                nvis = sum(double(handles.ObjVisible));
                set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
                
                handles = Add_Vectors_To_Main_Figure(handles);
                
                guidata(hObject,handles)
                
                try close(FP); end %#ok<*TRYNC>
        end
        
% ------------------------------------------------------------------------------------------------
function LS = CreateCellListStringArray(CellIndices,CellSizes,IsCellVisible,IsCellHighLighted)

                % for N cells
                % CellIndex             (N,1) double prec array
                % CellSize (voxels)     (N,1) double prec array
                % IsCellVisible         (N,1) logical array
                % IsCellHighLighted     (N,1) logical array

                N = size(CellIndices,1);
                Cs = num2str([11111;  CellIndices]);  Cs = Cs(2:end,:);
                Ss = num2str([111111; CellSizes]);    Ss = Ss(2:end,:);
                B  = blanks(N)';
                Vs = B; 
                Vs(IsCellVisible) = 'V'; 
                Hs = B; 
                Hs(IsCellHighLighted) = 'H'; 

                SA = [Cs,B,Ss,B,B,Vs,B,B,Hs];
                LS = mat2cell(SA,ones(1,N),size(SA,2));  
    
% ------------------------------------------------------------------------------------------------
function CellList_Callback(hObject, eventdata, handles)
    
            index = handles.CellList.Value;
            handles.CurrentlySelectedCell = index;
            % Find highlighted cells and unhighlight when cell list is clicked
            idx = find(handles.ObjSelected)'; 
            handles.ObjSelected = false(handles.nObjs,1);

            for k = idx
                handles = Update_Single_Cell(handles,k);
            end

            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected); 
            handles = Update_SingleCellAxis(handles,index); 
            set(handles.RecentCellSelectionDisplay,'String',['Recent Cell Select: ' num2str(index)])
            set(handles.nCellsVisibleDisplay,'String',...
                [ 'nCells Visible: ' num2str(sum(handles.ObjVisible(:))) ]);

            guidata(hObject,handles);
                
% ------------------------------------------------------------------------------------------------
function CellList_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end

% ------------------------------------------------------------------------------------------------
function csvOutputButton_Callback(hObject, eventdata, handles)

       idx = find(handles.ObjVisible); 
       CSV = [];
       
       for ii = 1:length(idx)
            CSV = [CSV num2str(idx(ii)) ', '];
       end
       handles.CSV = CSV; 
       guidata(hObject,handles)
       
       h = IndexOutputWindow(handles.MainFigure1);
       
% ------------------------------------------------------------------------------------------------
function csvInputButton_Callback(hObject, eventdata, handles)

       h = IndexInputWindow(handles.MainFigure1);

% ------------------------------------------------------------------------------------------------
function ReverseVisibleCellsButton_Callback(hObject, eventdata, handles)

    button = questdlg('Are you sure you want to reverse Visible cells?',...
        'Quit Verification','Yes','No','No');
    
    if strcmp(button,'Yes')
        
            %-- Record Visibility State for Undo Button ------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %-------------------------------------------------------------------------------------------  
        
            FH = WaitToUpdateRendering;; % try; close(FP); end  
            drawnow
            %Data = handles.DataTable.Data;
            nObjects = length(handles.IsoSurfaceHandles);
            handles.ObjVisible  = ~handles.ObjVisible; % Reverse Visible Cells logic
            handles.ObjSelected =  false(nObjects,1);
            
            for n = 1:nObjects
                if handles.ObjVisible(n,1)
                    set(handles.IsoSurfaceHandles{n,1},'Visible','on')
                    set(handles.IsoCapHandles{n,1},'Visible','on')
                else
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                    set(handles.IsoCapHandles{n,1},'Visible','off')
                end
                
            end
            handles = Update_Cells_Near_Slice(handles);
            drawnow
            
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------
            set(0,'CurrentFigure',handles.RenderingFigure)
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])                  
                         
            guidata(hObject,handles)
            
            try close(FH); end       
    end

% ------------------------------------------------------------------------------------------------
function InputIntersectionButton_Callback(hObject, eventdata, handles)

        prompt = {'X:','Y:','Z:'};
        dlg_title = 'Input Intersection Point:';
        num_lines = 1;
        defaultans = {'','',''};
        answer = inputdlg(prompt,dlg_title,[1 50; 1 50; 1 50],defaultans);
        
        if ~isempty(answer)
           v = str2double(answer);
           x = v(1,1);
           y = v(2,1);
           z = v(3,1);
            
           handles.IntersectionPoint = [x y z];
           text1 = ['<x,y,z> = < '     sprintf('%5.2f',x)...
                                 ',  ' sprintf('%5.2f',y)...
                                 ',  ' sprintf('%5.2f',z) ' >'];

           set(handles.IntersectionPointDisplay,'String',text1,'FontWeight','normal',...
                                                'Position',[14, 9, 411, 20],'FontSize',11,...
                                                'HorizontalAlignment','center')
           guidata(hObject,handles)
        end

        
% ------------------------------------------------------------------------------------------------        
function HideHLedCellsButton_Callback(hObject, eventdata, handles)
    
    button = questdlg('Are you sure you want to hide the Highlighted cells?',...
                      'Quit Verification','Yes','No','No');
    
    if strcmp(button,'Yes')
            %-- Record Visibility State for Undo Button -----------------------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %------------------------------------------------------------------------------------------------  
        
            FP = WaitToUpdateRendering; % try; close(FP); end  
            drawnow
            nObjects =  length(handles.ObjSelected);
            handles.ObjVisible(handles.ObjSelected)  = false; 
            index = find(handles.ObjSelected)';
            handles.ObjSelected = false(nObjects,1);
            
            for n = index
                    set(handles.IsoSurfaceHandles{n,1},'Visible','off','FaceColor',...
                        handles.FaceColor,'EdgeColor',handles.MeshColor)
                    set(handles.IsoCapHandles{n,1},    'Visible','off','FaceColor',...
                        handles.FaceColor,'EdgeColor',handles.MeshColor)
            end
            
            drawnow
            
            % Update Cell List ----------------------------------------------------------
            handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                handles.CellSizes,...
                                                                handles.ObjVisible,...
                                                                handles.ObjSelected);
            % ---------------------------------------------------------------------------
            
            set(0,'CurrentFigure',handles.RenderingFigure)
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            handles = Update_Cells_Near_Slice(handles);
                                                            
            guidata(hObject,handles)

            try close(FP); end      
    end

% ------------------------------------------------------------------------------------------------        
function ViewCellsNearSliceMenu_Callback(hObject, eventdata, handles)
    
    handles.ViewCellsNearPlane = get(handles.ViewCellsNearSliceMenu,'Value');
    %----------------------------------------------------------------------------
    if isgraphics(handles.PopOutControllerHandle)
        H = guidata(handles.PopOutControllerHandle);
        H.ViewCellsNearSliceMenu.Value = handles.ViewCellsNearPlane;
        H.ViewCellsNearPlane = handles.ViewCellsNearPlane;
        guidata(handles.PopOutControllerHandle,H)
    end
    %----------------------------------------------------------------------------
    handles = Update_Cells_Near_Slice(handles);
    guidata(hObject,handles)
    
    
% ------------------------------------------------------------------------------------------------            
function handles = Update_Cells_Near_Slice(handles)
        
            if logical(handles.ViewCellsNearPlane - 1) &&...
                    logical(handles.DoXSlice + handles.DoYSlice + handles.DoZSlice)
                if (isequal(handles.ViewCellsNearPlane,2) && handles.DoXSlice) || ...
                   (isequal(handles.ViewCellsNearPlane,3) && handles.DoYSlice) || ...
                   (isequal(handles.ViewCellsNearPlane,4) && handles.DoZSlice)
                    handles.ObjNearSliceView = true(handles.nObjs,1); 
                    %----------------------------------------------------------------------------------------
                    if ~isequal(handles.nObjs, length(handles.COM)) || isempty(handles.COM)
                        handles.COM = zeros(handles.nObjs,3);
                        for k = 1:handles.nObjs
                            % Center of Data Points (center of mass of cell)
                            handles.COM(k,:) = handles.CellData{k,1}.CellCenterOfMass; 
                        end 
                    end 
                    %----------------------------------------------------------------------------------------
                    switch handles.ViewCellsNearPlane
                        case 1 % Turn OFF

                        case 2 % Only show cells near X Plane -----------------------------------
                            LowerBound  = handles.XSliceValue - handles.ViewCellsNearPlaneRange;
                            HigherBound = handles.XSliceValue + handles.ViewCellsNearPlaneRange;
                            handles.ObjNearSliceView( handles.COM(:,1)...
                                < LowerBound | handles.COM(:,1) > HigherBound ) = false;
                        case 3 % Only show cells near Y Plane ----------------------------------
                            LowerBound  = handles.YSliceValue - handles.ViewCellsNearPlaneRange;
                            HigherBound = handles.YSliceValue + handles.ViewCellsNearPlaneRange;
                            handles.ObjNearSliceView( handles.COM(:,2)...
                                < LowerBound | handles.COM(:,2) > HigherBound ) = false;
                        case 4 % Only show cells near Z Plane -----------------------------------
                            LowerBound  = handles.ZSliceValue - handles.ViewCellsNearPlaneRange;
                            HigherBound = handles.ZSliceValue + handles.ViewCellsNearPlaneRange;
                            handles.ObjNearSliceView( handles.COM(:,3)...
                                < LowerBound | handles.COM(:,3) > HigherBound ) = false;
                    end
                    %-----------------------------------------------------------------------------
                    for n = 1:handles.nObjs
                        if handles.ObjNearSliceView(n,1) && handles.ObjVisible(n,1)
                            set(handles.IsoSurfaceHandles{n,1},'Visible','on')
                            set(handles.IsoCapHandles{n,1},'Visible','on')
                        else
                            set(handles.IsoSurfaceHandles{n,1},'Visible','off')
                            set(handles.IsoCapHandles{n,1},'Visible','off')
                        end
                    end            
                    %-----------------------------------------------------------------------------
                end
            %-------------------------------------------------------------------------------------
            else
                    toggle = [{'off'};{'on'}];
                    for n = 1:handles.nObjs
                        set(handles.IsoSurfaceHandles{n,1},'Visible', ...
                            toggle{handles.ObjVisible(n,1)+1,1})
                        set(handles.IsoCapHandles{n,1},    'Visible', ...
                            toggle{handles.ObjVisible(n,1)+1,1})
                    end
            end


% ------------------------------------------------------------------------------------------------          
function ViewCellsNearSliceMenu_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'),...
                get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end

% ------------------------------------------------------------------------------------------------        
function ViewCellsNearSliceRangeInput_Callback(hObject, eventdata, handles)

        v = round(str2double(get(handles.ViewCellsNearSliceRangeInput,'String')),3,'significant');
        
        
        handles.ViewCellsNearSliceRangeInput.String = v;
        handles.ViewCellsNearPlaneRange = v;
        if isgraphics(handles.PopOutControllerHandle)
              H = guidata(handles.PopOutControllerHandle);
              H.ViewCellsNearSliceRangeInput.String = v;
              H.ViewCellsNearPlaneRange = v;
        end
        
        handles = Update_Cells_Near_Slice(handles); 
        guidata(hObject,handles)
    
% ------------------------------------------------------------------------------------------------        
function ViewCellsNearSliceRangeInput_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'),...
                get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end

% ------------------------------------------------------------------------------------------------     
function HLTransparencySlider_Callback(hObject, eventdata, handles)
               
        FH = WaitToUpdateRendering; drawnow
    
        val = round(get(handles.HLTransparencySlider,'Value'));
        set(handles.HLTransparencySlider, 'Value', val)
        set(handles.HLTransparencyDisplay,'String',...
            ['HL Transparency: ' sprintf('%3.0f',val) '%'])
        handles.HLFaceTransparency = val;
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        
        try; close(FH); end
        
        guidata(hObject,handles)

% ------------------------------------------------------------------------------------------------     
function HLTransparencySlider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end
    

% ------------------------------------------------------------------------------------------------     
function HLMeshTransparencySlider_Callback(hObject, eventdata, handles)

        FH = WaitToUpdateRendering; drawnow
        
        val = round(get(handles.HLMeshTransparencySlider, 'Value'));
        set(handles.HLMeshTransparencySlider,'Value', val)
        set(handles.HLMeshTransparencyDisplay,'String',...
            ['HL Mesh Transparency: ' sprintf('%3.0f',val) '%'])
        handles.HLMeshTransparency = val;
        
        handles = Update_Rendering(handles);
        handles = Update_Cells_Near_Slice(handles);
        
        try; close(FH); end
        
        guidata(hObject,handles)

% -----------------------------------------------------------------------------------------------     
function HLMeshTransparencySlider_CreateFcn(hObject, eventdata, handles)

        if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor',[.9 .9 .9]);
        end


% -----------------------------------------------------------------------------------------------     
function SliceTransparencySlider_Callback(hObject, eventdata, handles)

        FH = WaitToUpdateRendering; drawnow
        
        handles.SliceTransparency = round(get(handles.SliceTransparencySlider,'Value'));
        handles.SliceTransparencySlider.Value = handles.SliceTransparency;
        handles.SliceTransparencyDisplay.String = ...
            ['Slice Transparency: ' num2str(handles.SliceTransparency) '%'];
        
            if isgraphics(handles.XSliceHandle)
                handles.XSliceHandle.FaceAlpha = handles.SliceTransparency/100;
            end

            if isgraphics(handles.YSliceHandle)
                handles.YSliceHandle.FaceAlpha = handles.SliceTransparency/100;
            end

            if isgraphics(handles.ZSliceHandle)
                handles.ZSliceHandle.FaceAlpha = handles.SliceTransparency/100;
            end
        %------------------------------------------------------------------------------------
        if isgraphics(handles.PopOutControllerHandle)
            H = guidata(handles.PopOutControllerHandle);
            H.SliceTransparencySlider.Value = handles.SliceTransparencySlider.Value;
            H.SliceTransparencyDisplay.String =...
                ['Slice Transparency: ' num2str(handles.SliceTransparency) '%'];
            H.SliceTransparency = handles.SliceTransparency;
            guidata(handles.PopOutControllerHandle,H)
        end
        
        try; close(FH); end
        
        guidata(hObject,handles) 
        
% -----------------------------------------------------------------------------------------------     
function SliceTransparencySlider_CreateFcn(hObject, eventdata, handles)

    % Hint: slider controls usually have a light gray background.
    if isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
        set(hObject,'BackgroundColor',[.9 .9 .9]);
    end

% -----------------------------------------------------------------------------------------------     
function EdgeCellsCheck_Callback(hObject, eventdata, handles)


% -----------------------------------------------------------------------------------------------     
function SliceSmoothingMenu_Callback(hObject, eventdata, handles)

        if handles.DoXSlice
            if isgraphics(handles.XSliceHandle);              
                delete(handles.XSliceHandle); end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle); end            
            if isgraphics(handles.XSliceBorderHandle);        
                delete(handles.XSliceBorderHandle);        end
            
            handles = Update_Slice_Plot(handles,1);
        end
        
        if handles.DoYSlice 
            if isgraphics(handles.YSliceHandle);              
                delete(handles.YSliceHandle); end
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle); end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end        
            if isgraphics(handles.YSliceBorderHandle);        
                delete(handles.YSliceBorderHandle); end
            
            handles = Update_Slice_Plot(handles,2);    
        end
        
        if handles.DoZSlice
            if isgraphics(handles.ZSliceHandle);              
                delete(handles.ZSliceHandle); end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.ZYSliceIntersectionHandle); 
                delete(handles.ZYSliceIntersectionHandle); end        
            if isgraphics(handles.ZSliceBorderHandle);        
                delete(handles.ZSliceBorderHandle); end
            
            handles = Update_Slice_Plot(handles,3);
        end

        guidata(hObject,handles)
    
% ------------------------------------------------------------------------------------------------     
function SliceSmoothingMenu_CreateFcn(hObject, eventdata, handles)

        if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
            set(hObject,'BackgroundColor','white');
        end

% ------------------------------------------------------------------------------------------------     
function SliceSaturateMenu_Callback(hObject, eventdata, handles)

        if handles.DoXSlice
            if isgraphics(handles.XSliceHandle);              
                delete(handles.XSliceHandle);              
            end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle);    end
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle);    end            
            if isgraphics(handles.XSliceBorderHandle);        
                delete(handles.XSliceBorderHandle);           end
            handles = Update_Slice_Plot(handles,1);
        end
        
        if handles.DoYSlice 
            if isgraphics(handles.YSliceHandle);              
                delete(handles.YSliceHandle);              
            end
            if isgraphics(handles.XYSliceIntersectionHandle); 
                delete(handles.XYSliceIntersectionHandle); end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end        
            if isgraphics(handles.YSliceBorderHandle);        
                delete(handles.YSliceBorderHandle);        end
            handles = Update_Slice_Plot(handles,2);    
        end
        
        if handles.DoZSlice
            if isgraphics(handles.ZSliceHandle);              
                delete(handles.ZSliceHandle);              end
            if isgraphics(handles.ZXSliceIntersectionHandle); 
                delete(handles.ZXSliceIntersectionHandle); end
            if isgraphics(handles.ZYSliceIntersectionHandle); 
                delete(handles.ZYSliceIntersectionHandle); end        
            if isgraphics(handles.ZSliceBorderHandle);        
                delete(handles.ZSliceBorderHandle);        end
            handles = Update_Slice_Plot(handles,3);
        end

        guidata(hObject,handles)

% -----------------------------------------------------------------------------------------------     
function SliceSaturateMenu_CreateFcn(hObject, eventdata, handles)

    if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
        set(hObject,'BackgroundColor','white');
    end

% -----------------------------------------------------------------------------------------------     
function MainFigure1_CloseRequestFcn(hObject, eventdata, handles)

    button = questdlg('Are you sure you want to quit Longaxis?',...
                      'Quit Verification','Yes','No','No');
    
    if strcmp(button,'Yes')
        if isgraphics(handles.RenderingFigure); 
            % Remove Figure Close Function for Figure Window
            set(handles.RenderingFigure,'CloseRequestFcn','') 
            delete(handles.RenderingFigure)
        end
        if isgraphics(handles.PopOutControllerHandle)
            delete(handles.PopOutControllerHandle)
        end
        delete(hObject);
    end

%------------------------------------------------------------------------------------------------     
function SliceIsStepSizeCheckBox_Callback(hObject, eventdata, handles)
    
    
    V = handles.SliceIsStepSizeCheckBox.Value;
    a = handles.AxisRange;
    
    if V
        S = str2double(handles.ViewCellsNearSliceRangeInput.String);
        set(handles.X_Plane_Slider,'SliderStep',[S/(a(2)-a(1)) S/(a(2)-a(1))])
        set(handles.Y_Plane_Slider,'SliderStep',[S/(a(4)-a(3)) S/(a(4)-a(3))])
        set(handles.Z_Plane_Slider,'SliderStep',[S/(a(6)-a(5)) S/(a(6)-a(5))])
        %----------------------------------------------------------------------------
        if isgraphics(handles.PopOutControllerHandle)
            H = guidata(handles.PopOutControllerHandle);
            H.SliceIsStepSizeCheckBox.Value = V;
            set(H.X_Plane_Slider,'SliderStep',[S/(a(2)-a(1)) S/(a(2)-a(1))])
            set(H.Y_Plane_Slider,'SliderStep',[S/(a(4)-a(3)) S/(a(4)-a(3))])
            set(H.Z_Plane_Slider,'SliderStep',[S/(a(6)-a(5)) S/(a(6)-a(5))])
            guidata(handles.PopOutControllerHandle,H)
        end
        %----------------------------------------------------------------------------
    else
        S = 0.05;
        set(handles.X_Plane_Slider,'SliderStep',[S/(a(2)-a(1)) 1/(a(2)-a(1))])
        set(handles.Y_Plane_Slider,'SliderStep',[S/(a(4)-a(3)) 1/(a(4)-a(3))])
        set(handles.Z_Plane_Slider,'SliderStep',[S/(a(6)-a(5)) 1/(a(6)-a(5))])
        %----------------------------------------------------------------------------
        if isgraphics(handles.PopOutControllerHandle)
            H = guidata(handles.PopOutControllerHandle);
            H.SliceIsStepSizeCheckBox.Value = V;
            set(H.X_Plane_Slider,'SliderStep',[S/(a(2)-a(1)) 1/(a(2)-a(1))])
            set(H.Y_Plane_Slider,'SliderStep',[S/(a(4)-a(3)) 1/(a(4)-a(3))])
            set(H.Z_Plane_Slider,'SliderStep',[S/(a(6)-a(5)) 1/(a(6)-a(5))])
            guidata(handles.PopOutControllerHandle,H)
        end
        %----------------------------------------------------------------------------   
    end

    guidata(hObject,handles) 

% -----------------------------------------------------------------------------------------------     
function PopOutControllerButton_Callback(hObject, eventdata, handles)
    
        % example: HANDLE = SelectFile(handles.MainFigure1);
        
        % If Pop-Out Controller is already open, close it, then re-open
        if isgraphics(handles.PopOutControllerHandle) 
            close(handles.PopOutControllerHandle)
        end
        
        H = PopOut1(handles.MainFigure1);
        handles.PopOutControllerHandle = H;
        
        guidata(hObject,handles) 
        
% -----------------------------------------------------------------------------------------------     
function [R,C,Xb] = ExactMinBoundSphere3D(X)
    % Compute exact minimum bounding sphere of a 3D point cloud (or a 
    % triangular surface mesh) using Welzl's algorithm. 
    %
    %   - X     : M-by-3 list of point co-ordinates or a triangular surface 
    %             mesh specified as a TriRep object.
    %   - R     : radius of the sphere.
    %   - C     : 1-by-3 vector specifying the centroid of the sphere.
    %   - Xb    : subset of X, listing K-by-3 list of point coordinates from 
    %             which R and C were computed. See function titled 
    %             'FitSphere2Points' for more info.
    %
    % REREFERENCES:
    % [1] Welzl, E. (1991), 'Smallest enclosing disks (balls and ellipsoids)',
    %     Lecture Notes in Computer Science, Vol. 555, pp. 359-370
    %
    % AUTHOR: Anton Semechko (a.semechko@gmail.com)
    % DATE: Dec.2014
    %


    if isobject(X), X=X.X; end
    if size(X,2)~=3
        error('This function only works for 3D data')
    end
    if sum(isnan(X(:)) | isinf(X(:)))>0
        error('Point data contains NaN or Inf entries. Remove them and try again.')
    end

    % Get the convex hull of the point set
    F=convhulln(X);
    F=unique(F(:));
    X=X(F,:);

    % Randomly permute the point set
    idx=randperm(size(X,1));
    X=X(idx(:),:);

    % Get the minimum bounding sphere
    if size(X,1)<=4
        [R,C]=FitSphere2Points(X); 
        Xb=X;
        return
    end

    if size(X,1)<1E3
        try

            % Center and radius of the sphere
            [R,C]=B_MinSphere(X,[]);

            % Coordiantes of the points used to compute parameters of the 
            % minimum bounding sphere
            D=sum(bsxfun(@minus,X,C).^2,2);
            [D,idx]=sort(abs(D-R^2));
            Xb=X(idx(1:4),:);
            D=D(1:4);
            Xb=Xb(D<1E-6,:);
            [~,idx]=sort(Xb(:,1));
            Xb=Xb(idx,:);
            return
        catch
        end
    end

    % If we got to this point, then the recursion depth limit was reached. So 
    % need to break-up the the data into smaller sets and then recombine the 
    % results.
    M=size(X,1);
    dM=min(floor(M/4),300);
    res=mod(M,dM);
    n=ceil(M/dM);  
    idx=dM*ones(1,n);
    if res>0
        idx(end)=res;
    end

    if res<=0.25*dM 
        idx(n-1)=idx(n-1)+idx(n);
        idx(n)=[];
        n=n-1;
    end

    X=mat2cell(X,idx,3);
    Xb=[];
    for i=1:n

        % Center and radius of the sphere
        [R,C,Xi]=B_MinSphere([Xb;X{i}],[]);    

        % 40 points closest to the sphere
        if i<1
            D=abs(sum(bsxfun(@minus,Xi,C).^2,2)-R^2);
        else
            D=abs(sqrt(sum(bsxfun(@minus,Xi,C).^2,2))-R);
        end
        [D,idx]=sort(D);
        Xb=Xi(idx(1:40),:);

    end
    D=D(1:4);
    Xb=Xb(D/R*100<1E-3,:);
    [~,idx]=sort(Xb(:,1));
    Xb=Xb(idx,:);

        % --------------------------------------------------------------------------------------
        function [R,C,P]=B_MinSphere(P,B)

        if size(B,1)==4 || isempty(P)
            [R,C]=FitSphere2Points(B); % fit sphere to boundary points
            return
        end

        % Remove the last (i.e., end) point, p, from the list
        P_new=P;
        P_new(end,:)=[];
        p=P(end,:);

        % Check if p is on or inside the bounding sphere. If not, it must be
        % part of the new boundary.
        [R,C,P_new]=B_MinSphere(P_new,B); 
        if isnan(R) || isinf(R) || R<=eps
            chk=true;
        else
            chk=norm(p-C)>(R+eps);
        end

        if chk
            B=[p;B];
            [R,C]=B_MinSphere(P_new,B);
            P=[p;P_new];
        end

     


% ----------------------------------------------------------------------------------------------     
function [R,C] = FitSphere2Points(X)
    % Fit a sphere to a set of 2, 3, or at most 4 points in 3D space. Note that
    % point configurations with 3 collinear or 4 coplanar points do not have 
    % well-defined solutions (i.e., they lie on spheres with infinite radius).
    %
    %   - X     : M-by-3 array of point coordinates, where M<=4.
    %   - R     : radius of the sphere. R=Inf when the sphere is undefined, as 
    %             specified above.
    %   - C     : 1-by-3 vector specifying the centroid of the sphere. 
    %             C=nan(1,3) when the sphere is undefined, as specified above.
    %
    % AUTHOR: Anton Semechko (a.semechko@gmail.com)
    % DATE: Dec.2014
    %


    N=size(X,1);
    if N>4 
        error('Input must a N-by-3 array of point coordinates, with N<=4')
    end

    % Empty set
    if isempty(X)
        C=nan(1,3);
        R=nan; 
        return
    end

    % A single point
    if N==1
        C=X;
        R=0;
        return
    end

    % Line segment
    if N==2
        C=mean(X,1);
        R=norm(X(2,:)-X(1,:))/2;
        return
    end

    % Remove duplicate vertices, if there are any
    D=bsxfun(@minus,permute(X,[1 3 2]),permute(X,[3 1 2]));
    D=sqrt(sum(D.^2,3));
    D(1:(N+1):end)=Inf;
    chk=D<=1E-12;
    if sum(chk(:))>0
        for i=1:N
            if size(X,1)<=i, break; end
            idx=chk(i,:);
            idx(1:i)=false;
            idx=find(idx);
            chk(idx,:)=[];
            chk(:,idx)=[];
            X(idx,:)=[];
        end
        [R,C]=FitSphere2Points(X);
        return
    end


    % Three unique, though possibly collinear points
    tol=1E-2; % collinearity/co-planarity threshold (in degrees)
    if N==3

        % Check for collinearity
        D12=X(2,:)-X(1,:); D12=D12/norm(D12);
        D13=X(3,:)-X(1,:); D13=D13/norm(D13);

        chk=abs(D12*D13(:));
        chk(chk>1)=1;
        if acos(chk)/pi*180<tol
            R=inf;
            C=nan(1,3);
            return
        end

        % Make plane formed by the points parallel with the xy-plane  
        n=cross(D13,D12);
        n=n/norm(n);
        r=cross(n,[0 0 1]); r=acos(n(3))*r/norm(r); % Euler rotation vector
        Rmat=expm([0 -r(3) r(2); r(3) 0 -r(1); -r(2) r(1) 0]);
        Xr=(Rmat*X')'; 

        % Circle centroid
        x=Xr(:,1:2);
        A=2*bsxfun(@minus,x(2:3,:),x(1,:));
        b=sum(bsxfun(@minus,x(2:3,:).^2,x(1,:).^2),2);
        warning off
        C=(A\b)';

        % Circle radius
        R=sqrt(sum((x(1,:)-C).^2,2));     

        % Rotate centroid back into the original frame of reference
        C(3)=mean(Xr(:,3));
        C=(Rmat'*C(:))';
        return
    end


    % If we got to this point then we have 4 unique, though possibly co-linear
    % or co-planar points. 

    % Check if the the points are co-linear
    D12=X(2,:)-X(1,:); D12=D12/norm(D12);
    D13=X(3,:)-X(1,:); D13=D13/norm(D13);
    D14=X(4,:)-X(1,:); D14=D14/norm(D14);

    chk1=abs(D12*D13(:));
    chk1(chk1>1)=1;
    chk2=abs(D12*D14(:));
    chk2(chk2>1)=1;

    if acos(chk1)/pi*180<tol || acos(chk2)/pi*180<tol
        R=inf;
        C=nan(1,3);
        return
    end

    % Check if the the points are co-planar 
    n1=cross(D12,D13); n1=norm(n1);
    n2=cross(D12,D14); n2=norm(n2);

    chk=abs(n1*n2(:));
    chk(chk>1)=1;
    if acos(chk)/pi*180<tol
        R=inf;
        C=nan(1,3);
        return
    end

    % Centroid of the sphere
    A=2*bsxfun(@minus,X(2:end,:),X(1,:));
    b=sum(bsxfun(@minus,X(2:end,:).^2,X(1,:).^2),2);
    C=(A\b)';

    % Radius of the sphere
    R=sqrt(sum((X(1,:)-C).^2,2));


% -----------------------------------------------------------------------------------------------     
function MBSDFilterButton_Callback(hObject, eventdata, handles)

        % ----------------------------------------------------------------
            prompt = {'Min Diameter:','Max Diameter'};
            dlg_title = 'Input Min-Bounding-Sphere Filter Range:';
            defaultans = {'10','60'};

            if isfield(handles.FilterParam,'MBSD_Min_Value')
                if ~isempty(handles.FilterParam.MBSD_Min_Value)
                    defaultans = {num2str(handles.FilterParam.MBSD_Min_Value),...
                                  num2str(handles.FilterParam.MBSD_Max_Value)};
                end
            else
                defaultans = {'10','60'};
            end

            answer = inputdlg(prompt, dlg_title, [1 65; 1 65], defaultans);
        % ---------------------------------------------------------------  
        if ~isempty(answer)
            
            %-- Record Visibility State for Undo Button ----------------------------------------
                handles = UpdateActionRecordingsForUNDO(handles);
            %-----------------------------------------------------------------------------------    
            
            FP = WaitToProcessDialogue; % try close(FP); end
            v = str2double(answer);

            handles.FilterParam.MBSD_Min_Value = v(1);
            handles.FilterParam.MBSD_Max_Value = v(2);
            N = length(handles.CellData);

            for ii = 1:N
                ind  = handles.CellData{ii,1}.CellIndex;
                Diam = 2*handles.CellData{ii,1}.MinBoundingSphereRadiusOfCell;
                if Diam < v(1) || Diam > v(2) 
                    set(handles.IsoSurfaceHandles{ind,1},'Visible','off')
                    set(handles.IsoCapHandles{ind,1},    'Visible','off')
                    handles.ObjVisible(ind,1)  = false;
                    handles.ObjSelected(ind,1) = false;
                                       
                end
            end
            
            %-------------Update Cell List box --------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
            %------------------------------------------------------------------------------------
            set(0,'CurrentFigure',handles.RenderingFigure)
            nvis = sum(double(handles.ObjVisible));
            set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)])
            
            handles = Add_Vectors_To_Main_Figure(handles);
            guidata(hObject, handles)
            
            try close(FP); end %#ok<*TRYNC>
        end
    

%------------------------------------------------------------------------------------------------  
function Undo_Button_Callback(hObject, eventdata, handles)
    
    [M,N] = size(handles.UndoButtonRecordedVisActions);
    
    if M > 0
        FH = WaitToUpdateRendering;
        drawnow
        %Find only the cells that need to be changed
        idx = find(abs(diff([handles.ObjVisible ,...
            handles.UndoButtonRecordedVisActions(:,1)],1,2)))'; 
        handles.ObjVisible  = handles.UndoButtonRecordedVisActions(:,1);
        handles.ObjSelected = false(size(handles.ObjVisible,1),1);
        handles.UndoButtonRecordedVisActions(:,1) = [];
        
        if isequal(numel(handles.UndoButtonRecordedVisActions),0)
            handles.UndoButtonRecordedVisActions = false(0,1);  
        end    
        
        L = length(handles.ObjVisible);
        Toggle = [{'off'};{'on'}];

        if handles.ViewCellsNearPlane == 1
            for k = idx
                set(handles.IsoSurfaceHandles{k,1}, 'Visible',...
                    Toggle{ handles.ObjVisible(k,1) + 1}, 'FaceColor', handles.FaceColor )
                set(handles.IsoCapHandles{k,1},     'Visible',...
                    Toggle{ handles.ObjVisible(k,1) + 1}, 'FaceColor', handles.FaceColor )
            end
        else
            handles = Update_Cells_Near_Slice(handles);
        end
        
        nvis = sum(double(handles.ObjVisible));
        set(handles.nCellsVisibleDisplay,'String',['nCells Visible: ' num2str(nvis)]) 
        %-------------Update Cell List box ------------------------------------------------------
                handles.CellList.String = CreateCellListStringArray(handles.CellIndices,...
                                                                    handles.CellSizes,...
                                                                    handles.ObjVisible,...
                                                                    handles.ObjSelected);
        %----------------------------------------------------------------------------------------
        drawnow
        try close(FH); end    
        guidata(hObject,handles)
    end
    
%----------------------------------------------------------------------------------------------      
    
function [R,C,Xb]=ExactMinBoundCircle(X)
    % Compute exact minimum bounding circle of a 2D point cloud using Welzl's 
    % algorithm. 
    %
    %   - X     : M-by-2 list of point co-ordinates, where M is the total
    %             number of points.
    %   - R     : radius of the circle.
    %   - C     : 1-by-2 vector specifying the centroid of the circle.
    %   - Xb    : subset of X, listing K-by-2 list of point coordinates from 
    %             which R and C were computed. See function titled 
    %             'FitCirc2Points' for more info.
    %
    % REREFERENCES:
    % [1] Welzl, E. (1991), 'Smallest enclosing disks (balls and ellipsoids)',
    %     Lecture Notes in Computer Science, Vol. 555, pp. 359-370
    %
    % AUTHOR: Anton Semechko (a.semechko@gmail.com)
    % DATE: Dec.2014
    %
    if isobject(X), X=X.X; end
    if size(X,2)~=2
        error('This function only works for 2D data')
    end
    if sum(isnan(X(:)) | isinf(X(:)))>0
        error('Point data contains NaN or Inf entries. Remove them and try again.')
    end
    % Get the convex hull of the point set
    F=convhulln(X);
    F=unique(F(:));
    X=X(F,:);
    % Randomly permute the point set
    idx=randperm(size(X,1));
    X=X(idx(:),:);
    % Get the minimum bounding circle
    if size(X,1)<=3
        [R,C]=FitCirc2Points(X); 
        Xb=X;
        return
    end
    if size(X,1)<1E3
        try

            % Center and radius of the circle
            [R,C]=B_MinCircle(X,[]);

            % Coordiantes of the points used to compute parameters of the 
            % minimum bounding circle
            D=sum(bsxfun(@minus,X,C).^2,2);
            [D,idx]=sort(abs(D-R^2));
            Xb=X(idx(1:4),:);
            D=D(1:4);
            Xb=Xb(D<1E-6,:);
            [~,idx]=sort(Xb(:,1));
            Xb=Xb(idx,:);
            return
        catch
        end
    end

    % If we got to this point, then the recursion depth limit was reached. So 
    % need to break-up the the data into smaller sets and then recombine the 
    % results.
    M=size(X,1);
    dM=min(floor(M/4),300);
    res=mod(M,dM);
    n=ceil(M/dM);  
    idx=dM*ones(1,n);
    if res>0
        idx(end)=res;
    end

    if res<=0.25*dM 
        idx(n-1)=idx(n-1)+idx(n);
        idx(n)=[];
        n=n-1;
    end
    X=mat2cell(X,idx,2);
    Xb=[];
    for i=1:n

        % Center and radius of the circle
        [R,C,Xi]=B_MinCircle([Xb;X{i}],[]);    

        % 40 points closest to the circle
        if i<1
            D=abs(sum(bsxfun(@minus,Xi,C).^2,2)-R^2);
        else
            D=abs(sqrt(sum(bsxfun(@minus,Xi,C).^2,2))-R);
        end
        [D,idx]=sort(D);
        Xb=Xi(idx(1:40),:);

    end
    D=D(1:3);
    Xb=Xb(D/R*100<1E-3,:);
    [~,idx]=sort(Xb(:,1));
    Xb=Xb(idx,:);
%----------------------------------------------------------------------------------------------     
function [R,C,P]=B_MinCircle(P,B)
        
    if size(B,1)==3 || isempty(P)
        [R,C]=FitCircle2Points(B); % fit circle to boundary points
        return
    end
    
    % Remove the last (i.e., end) point, p, from the list
    P_new=P;
    P_new(end,:)=[];
    p=P(end,:);
        
    % Check if p is on or inside the bounding circle. If not, it must be
    % part of the new boundary.
    [R,C,P_new]=B_MinCircle(P_new,B); 
    if isnan(R) || isinf(R) || R<=eps
        chk=true;
    else
        chk=norm(p-C)>(R+eps);
    end
    
    if chk
        B=[p;B];
        [R,C]=B_MinCircle(P_new,B);
        P=[p;P_new];
    end
        
   
  
    
%---------------------------------------------------------------------------------------------      
function [R,C]=FitCircle2Points(X)
    % Fit a circle to a set of 2 or at most 3 points in 3D space. Note that
    % point configurations with 3 collinear points do not have well-defined 
    % solutions (i.e., they lie on circles with infinite radius).
    %
    %   - X     : M-by-2 array of point coordinates, where M<=3.
    %   - R     : radius of the circle. R=Inf when the circle is undefined, as 
    %             specified above.
    %   - C     : 1-by-2 vector specifying the centroid of the circle. 
    %             C=nan(1,2) when the circle is undefined, as specified above.
    %
    % AUTHOR: Anton Semechko (a.semechko@gmail.com)
    % DATE: Dec.2014
    %
    N=size(X,1);
    if N>3
        error('Input must a N-by-2 array of point coordinates, with N<=3')
    end
    % Empty set
    if isempty(X)
        C=nan(1,2);
        R=nan; 
        return
    end
    % A single point
    if N==1
        C=X;
        R=0;
        return
    end
    % Line segment
    if N==2
        C=mean(X,1);
        R=norm(X(2,:)-X(1,:))/2;
        return
    end
    % Remove duplicate vertices, if there are any
    D=bsxfun(@minus,permute(X,[1 3 2]),permute(X,[3 1 2]));
    D=sqrt(sum(D.^2,3));
    D(1:(N+1):end)=Inf;
    chk=D<=1E-12;
    if sum(chk(:))>0
        for i=1:(N-1)
            if size(X,1)<=i, break; end
            idx=chk(i,:);
            idx(1:i)=false;
            idx=find(idx);
            chk(idx,:)=[];
            chk(:,idx)=[];
            X(idx,:)=[];
        end
        [R,C]=FitCirc2Points(X);
        return
    end
    % Three unique, though possibly collinear points
    tol=1E-2; % collinearity/co-planarity threshold (in degrees)

    % Check for collinearity
    D12=X(2,:)-X(1,:); D12=D12/norm(D12);
    D13=X(3,:)-X(1,:); D13=D13/norm(D13);
    chk=abs(D12*D13(:));
    chk(chk>1)=1;
    if acos(chk)/pi*180<tol
        R=inf;
        C=nan(1,2);
        return
    end
    % Circle centroid
    A=2*bsxfun(@minus,X(2:3,:),X(1,:));
    b=sum(bsxfun(@minus,X(2:3,:).^2,X(1,:).^2),2);
    C=(A\b)';
    % Circle radius
    R=sqrt(sum((X(1,:)-C).^2,2));
    
    
    
%------------------------------------------------------------------------------------------------
function [intMatrix, intSurface] = SurfaceIntersection(surface1, surface2, varargin)
    %SURFACEINTERSECTION intersection of 2 surfaces
    % [intMatrix, intSurface] = SurfaceIntersection(surface1, surface2)
    % calculates the intersection of surfaces 1 and 2. Code can either return
    % just the matrix indicating which face of surface1 intersected with face
    % of surface2, which is calculated using Tomas Moller algorithm, or can
    % also return the actual line of intersection. In case when parts of the
    % surface 1 and 2 lay on the same plane the intersection is a 2D area
    % instead of 1D edge. In such a case the intersection area will be
    % triangulated and intSurface.edges will hold the edges of the
    % triangulation surface and intSurface.faces will hold the faces.
    %
    % INPUT:
    %  * surface1 & surface2 - two surfaces defined as structs or classes.
    %    Several inputs are possible:
    %    - struct with "faces" and "vertices" fields
    %    - 'triangulation' class (only the boundary surface will be used)
    %    - 'delaunayTriangulation' class
    %
    % OUTPUT:
    % * intMatrix - sparse Matrix with n1 x n2 dimension where n1 and n2 are
    %               number of faces in surfaces
    % * intSurface - a structure with following fields:
    %     intSurface.vertices - N x 3 array of unique points
    %     intSurface.edges    - N x 2 array of edge vertex ID's
    %     intSurface.faces    - N x 3 array of face vertex ID's
    %
    % ALGORITHM:
    % Based on Triangle/triangle intersection test routine by Tomas M?ller, 1997.
    %  See article "A Fast Triangle-Triangle Intersection Test",
    %  Journal of Graphics Tools, 2(2), 1997
    %  http://web.stanford.edu/class/cs277/resources/papers/Moller1997b.pdf
    %  http://fileadmin.cs.lth.se/cs/Personal/Tomas_Akenine-Moller/code/opttritri.txt
    % Get FACES and VERTICES inputs
    if isa(surface1, 'triangulation')
      [surface1.faces, surface1.vertices] = freeBoundary(surface1);
    elseif isa(surface1, 'delaunayTriangulation')
      S = surface1;
      surface1 = [];
      surface1.faces    = S.ConnectivityList;
      surface1.vertices = S.Points;
      clear S
    end
    if isa(surface2, 'triangulation')
      [surface2.faces, surface1.vertices] = freeBoundary(surface2);
    elseif isa(surface2, 'delaunayTriangulation')
      S = surface2;
      surface2 = [];
      surface2.faces    = S.ConnectivityList;
      surface2.vertices = S.Points;
      clear S
    end
    ok1 = isstruct(surface1) && isfield(surface1, 'vertices') && isfield(surface1, 'faces');
    ok2 = isstruct(surface2) && isfield(surface2, 'vertices') && isfield(surface2, 'faces');
    assert(ok1, 'Surface #1 must be a struct with "faces" and "vertices" fields' );
    assert(ok2, 'Surface #2 must be a struct with "faces" and "vertices" fields' );
    % Flip dimentions if necessery
    if size(surface1.faces,1)==3 && size(surface1.faces,2)~=3
      surface1.faces = surface1.faces';
    end
    if size(surface1.vertices,1)==3 && size(surface1.vertices,2)~=3
      surface1.vertices = surface1.vertices';
    end
    if size(surface2.faces,1)==3 && size(surface2.faces,2)~=3
      surface2.faces = surface2.faces';
    end
    if size(surface2.vertices,1)==3 && size(surface2.vertices,2)~=3
      surface2.vertices = surface2.vertices';
    end
    % Parse extra parameters
    getIntersection = (nargout>1);
    debug = true;
    PointRoundingTol = 1e6;
    algorithm = 'moller';
    k=1;
    nVarargs = length(varargin);
    while (k<=nVarargs)
      assert(ischar(varargin{k}), 'Incorrect input parameters')
      switch lower(varargin{k})
        case 'debug'
          debug = varargin{k+1}~=0;
          k = k+1;
        case 'algorithm'
          algorithm = lower(strtrim(varargin{k+1}));
          k = k+1;
        case 'pointroundingtol'
          PointRoundingTol = varargin{k+1};
          k = k+1;
      end
      k = k+1;
    end
    % Initialize variables
    epsilon = eps;
    nFace1 = size(surface1.faces,1);
    nFace2 = size(surface2.faces,1);
    nVert1 = size(surface1.vertices,1);
    nVert2 = size(surface2.vertices,1);
    % create strip down versions of MATLAB cross and dot function
    cross_prod = @(a,b) [...
      a(:,2).*b(:,3)-a(:,3).*b(:,2), ...
      a(:,3).*b(:,1)-a(:,1).*b(:,3), ...
      a(:,1).*b(:,2)-a(:,2).*b(:,1)];
    dot_prod = @(a,b) a(:,1).*b(:,1)+a(:,2).*b(:,2)+a(:,3).*b(:,3);
    normalize = @(V) bsxfun(@rdivide,V, sqrt(sum(V.^2,2)));
    % Initialize output variables
    % intersect is a nFace1 x nFace2 matrix. Possible values: -2 (do not know),
    % -1 (coplanar with unknown overlap), 0 (no intersections), 1 (intersects).
    % Negative values are internal only.
    % -2 indicates that there was no succesful test yet
    intMatrix  = zeros([nFace1,nFace2], 'int8')-2; 
    intSurface.vertices = [];
    intSurface.faces    = [];
    intSurface.edges    = [];
    % =======================================================================
    % === Stage 1 ==========================================================
    % =======================================================================
    % Each triangle is a subset of the plane it lies in, so for two triangles
    % to intersect they must overlap along the line of intersection of their
    % planes. Hence, a necessary condition for intersection is that each
    % triangle must intersect the plane of the other.
    % M?ller?s method begins by checking the mutual intersection of each
    % triangle with the plane of the other. To do so, it determines for each
    % triangle on which side of the other triangle?s supporting plane its
    % vertices lie. Now, if all vertices of one triangle lie on the same side
    % and no vertex is on the plane, the intersection is rejected.
    % compute plane equations for each triangle of the surface #1
    % plane equation #1: N1.X-d1=0
    V1 = surface1.vertices(surface1.faces(:,1),:);
    V2 = surface1.vertices(surface1.faces(:,2),:);
    V3 = surface1.vertices(surface1.faces(:,3),:);
    N1 = cross_prod(V2-V1,V3-V1); % array size nFace1 x 3
    N1 = normalize(N1);
    d1 = dot_prod(N1,V1);         % array size nFace1 x 1
    % Distance from surface #2 vertices to planes of surface #1
    % Calculate signed distance from all vertices of surface #2 to each plane
    % of of surface #1
    du = zeros(nFace1,nVert2);
    for iVert2 = 1:nVert2
      p = surface2.vertices(iVert2,:);
      du(:,iVert2) = N1(:,1)*p(1) + N1(:,2)*p(2) + N1(:,3)*p(3) - d1;
    end
    if debug
      assert(all(size(du)==[nFace1,nVert2]), 'Incorrect array dimensions: dv')
    end
    du(abs(du)<epsilon)=0; % robustness check
    % Distances from vertex 1, 2 & 3 of faces of surface #2 to planes of surface #1
    du1 = du(:,surface2.faces(:,1));
    du2 = du(:,surface2.faces(:,2));
    du3 = du(:,surface2.faces(:,3));
    if debug
      assert(all(size(du1)==size(intMatrix)), 'Incorrect array dimensions: du1')
    end
    clear du
    intMatrix(du1.*du2>0 & du1.*du3>0) = 0;   % same sign on all of them & not equal 0
    if(all(intMatrix==0)), return; end        % no intersections
    intMatrix(du1==0 & du2==0 & du3==0) = -1; % coplanar with unknown overlap
    % compute plane of triangle (U0,U1,U2)
    % plane equation 2: N2.X-d2=0
    U1 = surface2.vertices(surface2.faces(:,1),:);
    U2 = surface2.vertices(surface2.faces(:,2),:);
    U3 = surface2.vertices(surface2.faces(:,3),:);
    N2 = cross_prod(U2-U1,U3-U1); % array size nFace1 x 3
    N2 = normalize(N2);
    d2 = dot_prod(N2,U1);        % array size nFace1 x 1
    % Distance from surface #1 vertices to planes of surface #2
    % Calculate signed distance from all vertices of surface #1 to each plane
    % of of surface #2
    dv = zeros(nFace2,nVert1);
    for iVert1 = 1:nVert1
      p = surface1.vertices(iVert1,:);
      dv(:,iVert1) = N2(:,1)*p(1) + N2(:,2)*p(2) + N2(:,3)*p(3) - d2;
    end
    if debug
      assert(all(size(dv)==[nFace2,nVert1]), 'Incorrect array dimensions: dv')
    end
    dv(abs(dv)<epsilon)=0; % robustness check
    % Distances from vertex 1, 2 & 3 of faces of surface #1 to planes of surface #2
    dv1 = dv(:,surface1.faces(:,1))';
    dv2 = dv(:,surface1.faces(:,2))';
    dv3 = dv(:,surface1.faces(:,3))';
    if debug
      assert(all(size(dv1)==size(intMatrix)), 'Incorrect array dimensions: dv1')
    end
    clear dv
    intMatrix(dv1.*dv2>0 & dv1.*dv3>0) = 0;   % same sign on all of them & not equal 0
    if(all(intMatrix==0)), return; end        % no intersections
    intMatrix(dv1==0 & dv2==0 & dv3==0) = -1; % coplanar with unknown overlap
    % =======================================================================
    % === Stage 2 ==========================================================
    % =======================================================================
    % Process remaining (non-coplanar) triangle pairs
    tMsk = (intMatrix==-2);
    n = nnz(tMsk);
    if n>0
      
        
      %!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  
      % START Keith-edit ------------------
        idx = isnan(dv1+dv2+dv3);
        tMsk(idx) = 0;
      % END Keith-edit --------------------
      %!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      
      
      
      [face1, face2] = find(tMsk);
      switch lower(algorithm)
        case 'moller'
          if size(dv1(tMsk),1)==1
            dv = [dv1(tMsk)', dv2(tMsk)', dv3(tMsk)'];
            du = [du1(tMsk)', du2(tMsk)', du3(tMsk)'];
          else
            dv = [dv1(tMsk), dv2(tMsk), dv3(tMsk)];
            du = [du1(tMsk), du2(tMsk), du3(tMsk)];
          end
          [intMatrix(tMsk), intSurface] = TriangleIntersection3D_Moller(...
            V1(face1,:), V2(face1,:), V3(face1,:), N1(face1,:), d1(face1,:), dv, ...
            U1(face2,:), U2(face2,:), U3(face2,:), N2(face2,:), d2(face2,:), du, ...
            getIntersection, debug);
        case 'rapid'
          % Undocumented experimental feature. In some experiments I got
          % identical results as with Moller algorithm, but others gave
          % different results. Often faster tham Moller.
          intMatrix(tMsk) = TriangleIntersection3D_Rapid( ...
            V1(face1,:), V2(face1,:), V3(face1,:), ...
            U1(face2,:), U2(face2,:), U3(face2,:), N1(face1,:), N2(face2,:) );
        otherwise
          error('Unknown algorithm name');
      end
    end % if
    % Process coplanar triangle pairs. Pass #1:
    % compare the overlap of the bounding boxes
    tMsk = (intMatrix==-1);
    if nnz(tMsk)>0
      [face1, face2] = find(tMsk);
      overlap = true;
      for idim = 1:3
        v = [V1(face1,idim), V2(face1,idim), V3(face1,idim)];
        u = [U1(face2,idim), U2(face2,idim), U3(face2,idim)];
        t1 = min(v,[],2);
        t2 = max(v,[],2);
        s1 = min(u,[],2);
        s2 = max(u,[],2);
        overlap = overlap & (s1<=t2 & t1<=s2);
      end
      % if overlap intMatrix will remain "-1" otherwise it will change to "0"
      intMatrix(tMsk) = -1*overlap;
      clear v u t1 t2 s1 s2 overlap
    end
    % Process coplanar triangle pairs. Pass #2:
    % use edge-edge intersections
    tMsk = (intMatrix==-1);
    if nnz(tMsk)>0
      [face1, face2] = find(tMsk);

      % repack data prior to function call
      V(:,:,1)=V1(face1,:); V(:,:,2)=V2(face1,:); V(:,:,3)=V3(face1,:);
      U(:,:,1)=U1(face2,:); U(:,:,2)=U2(face2,:); U(:,:,3)=U3(face2,:);
      [intMatrix(tMsk), intSurface2] = TriangleIntersection2D(V, U, ...
        N1(face1,:), getIntersection, debug);

      % Merge surfaces
      if getIntersection
        np = size(intSurface.vertices,1);
        intSurface.vertices = [intSurface.vertices; intSurface2.vertices];
        intSurface.faces    = [intSurface.faces;    intSurface2.faces+np];
        intSurface.edges    = [intSurface.edges;    intSurface2.edges+np];
        if debug
          np = size(intSurface.vertices,1);
          assert(max(intSurface.faces(:))<=np, 'Bad surface definition')
          assert(max(intSurface.edges(:))<=np, 'Bad surface definition')
        end
      end
    end
    % Clean up the outputs
    intMatrix = sparse(double(intMatrix));
    if(getIntersection)
      % make point array unique
      P = round(intSurface.vertices*PointRoundingTol)/PointRoundingTol;
      [~,ia,ic] = unique(P,'rows'); % V = P(ia,:) and P = V(ic,:).
      intSurface.vertices = intSurface.vertices(ia,:);
      intSurface.faces = ic(intSurface.faces);
      intSurface.edges = ic(intSurface.edges);
    end

% ========================================================================
function [iMsk, intSurface] = TriangleIntersection3D_Moller(...
      V1, V2, V3, N1, d1, dv, ...
      U1, U2, U3, N2, d2, du, ...
      getIntersection, debug)
    %TriangleIntersection3D tests if 2 triangles defined in 3D intersect.
    % This is a secondary test following Tomas Moller algorithm
    %
    % INPUTS:
    %   V1, V2, V3, - Nx3 array of surface 1 triangle vertex coordinates
    %   U1, U2, U3, - Nx3 array of surface 2 triangle vertex coordinates
    %   N1, d1      - Nx3 array of surface 1 triangle plane equations N1.X-d1=0
    %   N2, d2      - Nx3 array of surface 2 triangle plane equations N2.X-d2=0
    %   dv          - Nx3 array of distances of surface 1 triangle vertices to surface 2 planes
    %   du          - Nx3 array of distances of surface 2 triangle vertices to surface 1 planes
    %   getIntersection - do we need to output the intersecting surface?
    %      Algorithm is much simpler if we do not.
    %   debug       - In the debugging mode much more extra "sanity check" test
    %      are performed.
    %
    % OUTPUT:
    %   iMsk - N x 1 intersection boolean mask marking which triangles overlap
    %   intSurface - intersection surface
    %
    % ALGORITHM:
    % The input triangles are guaranteed to intersect the line of intersection
    % of the two planes. Furthermore, these intersections form intervals on
    % this line, and the triangles overlap iff these intervals overlap as well.
    % Hence, the last part of  the algorithm computes a parametric equation
    % L(t) of the line of intersection of the two planes, finds the intervals
    % (i.e. scalar intervals on L(t)) for which the line lies inside each
    % triangle and performs a one-dimensional interval overlap test.
    if debug
      ok = size(N1,2)==3 && size(N2,2)==3 && size(dv,2)==3 && size(du,2)==3 && ...
        size(V1,2)==3 && size(V2,2)==3 && size(V3,2)==3 && ...
        size(U1,2)==3 && size(U2,2)==3 && size(U3,2)==3;
      assert(ok, 'Incorrect array dimensions');
    end
    % create strip down versions of MATLAB cross and dot function
    cross_prod = @(a,b) [...
      a(:,2).*b(:,3)-a(:,3).*b(:,2), ...
      a(:,3).*b(:,1)-a(:,1).*b(:,3), ...
      a(:,1).*b(:,2)-a(:,2).*b(:,1)];
    dot_prod = @(a,b) a(:,1).*b(:,1)+a(:,2).*b(:,2)+a(:,3).*b(:,3);
    normalize = @(V) bsxfun(@rdivide,V, sqrt(sum(V.^2,2)));
    % Find intervals of surface 1 and 2 triangles
    % compute the scalar intervals on L(t) for which the line lies inside each
    % triangle
    % Plane creates two open half-spaces. Find the odd vertex, which:
    % 1) if no or two vertices are on the plane than pick the vertex which is
    %    by itself in its half-space
    % 2) if one vertex is on the plane and the other two occupy the same
    %    half-space than pick the vertex on the plane
    % 3) if one vertex is on the plane and the other two occupy different
    %    half-spaces than pick one of the vertices off the plane
    % Find vertex using a look-up table "lut" with key calculated based on
    % sign of dv and du arrays
    lut = [0;3;3;2;1;3;2;2;1;1;2;3;3;0;3;3;2;1;1;2;2;3;1;2;3;3;0];
    n = numel(d1);
    rows = (1:n)';
    % order surface 1 triangle vertices
    a1 = lut(sign(dv)*[9; 3; 1] + 14); % calculate the key and call the look-up table
    [b1, c1] = otherDim(a1);
    if debug
      assert(all(a1>0), 'Something Wrong: triangles are coplanar')
    end
    a1 = sub2ind([n,3],rows,a1); % convert row and column IDs to array indecies
    b1 = sub2ind([n,3],rows,b1);
    c1 = sub2ind([n,3],rows,c1);
    % order surface 2 triangle vertices
    a2 = lut(sign(du)*[9; 3; 1] + 14); % calculate the key and call the look-up table
    [b2, c2] = otherDim(a2);
    if debug
      assert(all(a2>0), 'Something Wrong: triangles are coplanar')
    end
    a2 = sub2ind([n,3],rows,a2);
    b2 = sub2ind([n,3],rows,b2);
    c2 = sub2ind([n,3],rows,c2);
    % compute direction of L the line of intersection of 2 planes
    % containing 2 triangles. Line L parametric equation: t*D+O=0
    D = cross_prod(N1,N2);    % D must be perpendicular to both N1 and N2
    [~, maxDim] = max(abs(D),[],2); % compute and index to the largest component of D
    if(getIntersection)
      D = normalize(D);
      O = zeros(n,3);
      d = [d1, d2, zeros(n,1)];
      for r =1:n
        N = [N1(r,:); N2(r,:); 0, 0, 0];
        N(3,maxDim(r)) = 1;
        dd = d(r,:)';
        O(r,:) = (N\dd)'; %Solve systems of linear equations N*D3 = d for D3
      end
      clear N d dd
    end
    % projection of triangle(V1,V2,V3) and triangle(U1,U2,U3) onto intersection line
    % Vp and Up are Nx3 arrays with columns indicating corners of triangles 1 and 2
    if(getIntersection)
      Vp=[dot_prod(V1-O,D), dot_prod(V2-O,D), dot_prod(V3-O,D)];
      Up=[dot_prod(U1-O,D), dot_prod(U2-O,D), dot_prod(U3-O,D)];
    else
      % Project on one of the axis (closest to the intersection line) instead.
      % Simplified projection is faster and sufficient if we do not need
      % intersection line
      idx = sub2ind([n,3],rows,maxDim);
      Vp = [V1(idx), V2(idx), V3(idx)];
      Up = [U1(idx), U2(idx), U3(idx)];
    end
    clear V1 V2 V3 U1 U2 U3
    % Calculate surface 1 and 2 triangle intervals
    % t1 and t2 are intersection points of surface 1 with the intersection line
    % t*D+O=0, and s1 & s2 are intersection points of surface 2 with the same
    % line. Tomas Moller algorithm made this section much more complicated
    % trying to avoid divisions. However, I could not detect any speed-up.
    % Operations (ADD: 12; MUL:4 ; DIV:4 )
    t1 = Vp(a1) - (Vp(b1)-Vp(a1)).*dv(a1)./(dv(b1)-dv(a1));
    t2 = Vp(a1) - (Vp(c1)-Vp(a1)).*dv(a1)./(dv(c1)-dv(a1));
    s1 = Up(a2) - (Up(b2)-Up(a2)).*du(a2)./(du(b2)-du(a2));
    s2 = Up(a2) - (Up(c2)-Up(a2)).*du(a2)./(du(c2)-du(a2));
    % Order the intervals as to t1<t2 and s1<s2
    msk = t2<t1; % order t1 and t2 so t1<t2
    t = t1(msk); t1(msk)=t2(msk); t2(msk)=t; % swap
    msk = s2<s1; % order s1 and s2 so s1<s2
    t = s1(msk); s1(msk)=s2(msk); s2(msk)=t; % swap
    % Perform THE final test we were preparying for.
    % It test for the overlap of 2 1D intervals s1->s2 and t1->t2
    iMsk = (s1<t2 & t1<s2);
    % calculate intersection segments
    n = nnz(iMsk);
    if(getIntersection && n>0)
      % p1 = D*max(t1,s1) + O;    p2 = D*min(t2,s2) + O
      p1 = bsxfun(@times,D(iMsk,:),max(t1(iMsk),s1(iMsk))) + O(iMsk,:);
      p2 = bsxfun(@times,D(iMsk,:),min(t2(iMsk),s2(iMsk))) + O(iMsk,:);
      intSurface.vertices = [p1; p2];
      intSurface.faces    = [1:n; n+1:2*n; n+1:2*n]';
      intSurface.edges    = intSurface.faces(:,1:2);
    else
      intSurface.vertices = [];
      intSurface.faces    = [];
      intSurface.edges    = [];
    end 
    
% ========================================================================
function [overlap, intSurface] = TriangleIntersection2D(V, U, N, getIntersection, debug)
    % Triangles V(V0,V1,V2) and U(U0,U1,U2) are are coplanar. Do they overlap?
    % INPUTS:
    % N - array(n,3) of surface normals where V(i,:,:) and U(i,:,:) are on the same plane
    % V - array(n,3,3) (nFace x 3 dimensions x 3 vertices) of surface #1 vertices
    % U - array(n,3,3) (nFace x 3 dimensions x 3 vertices) of surface #2 vertices
    %
    % OUTPUT:
    %   iMsk - N x 1 intersection boolean mask marking which triangles overlap
    %   intSurface - intersection surface
    %  * parameters: vertices of triangle 1: V0,V1,V2
    %  *             vertices of triangle 2: U0,U1,U2
    %  * result    : returns 1 if the triangles intersect, otherwise 0
    % Constants needed for creating a mesh based on 3 to 6 points in a circle
    tri_mesh{6}  = [1 2 6; 2 4 6; 2 3 4; 4 5 6];
    tri_mesh{5}  = [1 2 3; 1 3 4; 4 5 1];
    tri_mesh{4}  = [1 2 3; 1 3 4];
    tri_mesh{3}  = 1:3;
    vertices = [];
    faces    = [];
    pairs    = [];  % each row corresponds to pair of faces. match row number with face number
    nVert    = 0;
    % use edge-edge intersections
    overlap = false(size(N,1),1);
    i1Idx = [1 1 1 2 2 2 3 3 3];
    i2Idx = [3 3 3 1 1 1 2 2 2];
    j1Idx = [1 2 3 1 2 3 1 2 3];
    j2Idx = [3 1 2 3 1 2 3 1 2];
    for row = 1:size(N,1)
      % When it is necesary to project 3D plane on 2D, dIdx will be the optimal
      % dimensions to use.
      [~, a] = max(abs(N(row,:))); 
      [b, c] = otherDim(a); 
      dIdx = [b, c]; 
      order = [];
      % test all edges of triangle 1 against the edges of triangle 2
      % triangles overlap if edges cross
      [edgeMat, P] = EdgesIntersect3D(...
        squeeze(V(row,:,i1Idx))',squeeze(V(row,:,i2Idx))', ...
        squeeze(U(row,:,j1Idx))',squeeze(U(row,:,j2Idx))');
      overlap(row) = any(edgeMat);
      if ~getIntersection && overlap(row), continue; end

      if ~overlap(row)
        % project onto an axis-aligned plane, that maximizes the area
        % of the triangles, compute indices: dIdx which correspond to 2 smallest N1
        % components.
        V2d = [V(row,dIdx,1); V(row,dIdx,2); V(row,dIdx,3)]; % each row is a 2D vertex
        U2d = [U(row,dIdx,1); U(row,dIdx,2); U(row,dIdx,3)];

        % test if tri1 is totally contained in tri2 or vice varsa
        if PointInTriangle2D(V2d(1,:), U2d) % tri1 is totally contained in tri2
          overlap(row) = true;
          order = 1:3;
        elseif PointInTriangle2D(U2d(1,:), V2d) % tri2 is totally contained in tri1
          overlap(row) = true;
          order = 4:6;
        end
        if overlap(row) && ~getIntersection, continue; end
        clear V2d U2d
      end

      % Build the intersection surface
      if getIntersection && overlap(row)
        %Assemble all the points which might be needed for desining
        %intersection polygon: Intersection points and points from triangle 1
        %and 2
        points   = [P(edgeMat,:); squeeze(V(row,:,:))'; squeeze(U(row,:,:))'];
        if isempty(order) % when one tri is totally contained in the other tri then order is set
          order = IntersectionPolygon(edgeMat>0, points, dIdx, debug);
          if isempty(order), continue; end
        end
        nPoint   = length(order);    % how many points will be added?
        nFace    = nPoint-2;         % how many faces will be added?
        vertices = [vertices; points(order,:)]; %#ok<*AGROW>
        faces    = [faces; nVert+tri_mesh{nPoint} ];
        % each row corresponds to pair of faces. match row number with face number
        pairs    = [pairs; row+zeros(nFace,1)];  
        nVert    = nVert + nPoint;
        if debug
          assert(max(faces(:))<=size(vertices,1), 'Bad surface definition')
        end
      end
    end % for
    % Prepare outputs
    intSurface.vertices = vertices;
    intSurface.faces    = faces;
    if isempty(faces)
      intSurface.edges = [];
    else
      intSurface.edges = [faces(:,1:2); faces(:,2:3); faces(:,[1,3])];
    end

% ========================================================================
function polygon = IntersectionPolygon(edgeMat, points, dIdx, debug)
    % edgeMat is an edge intersection matrix with 3 rows for edges between
    % the points 1-3, 1-2, & 2-3 of the triangle 1 and 3 columns for the same
    % edges of the triangle 2. If 2 edges intersect a point of intersection
    % is calculated and stored in array "points" followed by points of the
    % triangles 1 & 2.  This function calculates the polygon of the intersection
    % between 2 triangles.
    persistent orderLUT verified
    if isempty(orderLUT) || isempty(orderLUT{3})
      % This pre-calculated look-up table is used to quickly look up the order of
      % the vertices in array "points" which make up polygon of the intersection
      % between 2 triangles. A unique key is calculated for each edgeMat using
      % dot product between edgeMat(:) and [256 128 64 32 16 8 4 2 1], which is
      % used to look up point order around the polygon. Negative numbers in the
      % LUT indicate values which were not observed yet so they were not
      % independently verified.
      % reshape(sprintf('%09s',dec2base(key, 2)),3,3) will convert from the key
      % to matrix.
      OrderLUT = zeros(432,1);  
      OrderLUT(003) = 127;
      OrderLUT(005) = 128;
      OrderLUT(006) = 126;
      OrderLUT(009) = 124;
      OrderLUT(010) = 1427;
      OrderLUT(012) = 1428;
      OrderLUT(017) = 1427;
      OrderLUT(018) = 124;
      OrderLUT(020) = 1426;
      OrderLUT(024) = 127;
      OrderLUT(027) = 1243;
      OrderLUT(029) = 12438;
      OrderLUT(030) = 12034;
      OrderLUT(033) = 1428;
      OrderLUT(034) = 1426;
      OrderLUT(036) = 124;
      OrderLUT(040) = 128;
      OrderLUT(043) = 21834;
      OrderLUT(045) = 1243;
      OrderLUT(046) = 21349;
      OrderLUT(048) = 126;
      OrderLUT(051) = 12340;
      OrderLUT(053) = 12943;
      OrderLUT(054) = 1243;
      OrderLUT(065) = 125;
      OrderLUT(066) = 1527;
      OrderLUT(068) = 1825;
      OrderLUT(072) = 123;
      OrderLUT(080) = 1327;
      OrderLUT(083) = 15234;
      OrderLUT(085) = -15234;
      OrderLUT(086) = -15243;
      OrderLUT(090) = 13247;
      OrderLUT(092) = -13247;
      OrderLUT(096) = 1328;
      OrderLUT(099) = 152834;
      OrderLUT(101) = 15234;
      OrderLUT(102) = 152349;
      OrderLUT(106) = 132847;
      OrderLUT(108) = 13247;
      OrderLUT(114) = 102347;
      OrderLUT(116) = -13247;
      OrderLUT(129) = 1527;
      OrderLUT(130) = 125;
      OrderLUT(132) = 1526;
      OrderLUT(136) = 1327;
      OrderLUT(139) = 15243;
      OrderLUT(141) = 152438;
      OrderLUT(142) = 152034;
      OrderLUT(144) = 123;
      OrderLUT(153) = 12347;
      OrderLUT(156) = 123047;
      OrderLUT(160) = 1326;
      OrderLUT(163) = -152043;
      OrderLUT(165) = 13247;
      OrderLUT(166) = 15234;
      OrderLUT(169) = -182347;
      OrderLUT(172) = 193247;
      OrderLUT(177) = -132047;
      OrderLUT(180) = 13247;
      OrderLUT(192) = 127;
      OrderLUT(195) = 1243;
      OrderLUT(197) = 12438;
      OrderLUT(198) = 12034;
      OrderLUT(202) = 12364;
      OrderLUT(204) = 123648;
      OrderLUT(209) = 21364;
      OrderLUT(212) = -21364;
      OrderLUT(216) = 1243;
      OrderLUT(225) = -124638;
      OrderLUT(226) = 120364;
      OrderLUT(232) = 12438;
      OrderLUT(238) = 124356;
      OrderLUT(240) = 12034;
      OrderLUT(245) = -214356;
      OrderLUT(257) = 1528;
      OrderLUT(258) = 1526;
      OrderLUT(260) = 125;
      OrderLUT(264) = 1328;
      OrderLUT(267) = -152438;
      OrderLUT(269) = 15243;
      OrderLUT(270) = -152943;
      OrderLUT(272) = 1326;
      OrderLUT(275) = 152340;
      OrderLUT(277) = 152943;
      OrderLUT(278) = 15243;
      OrderLUT(281) = 182347;
      OrderLUT(282) = -103247;
      OrderLUT(288) = 123;
      OrderLUT(297) = 12347;
      OrderLUT(298) = -123947;
      OrderLUT(305) = 123947;
      OrderLUT(306) = 12347;
      OrderLUT(320) = 128;
      OrderLUT(323) = 21834;
      OrderLUT(325) = 1243;
      OrderLUT(326) = 21349;
      OrderLUT(330) = -123648;
      OrderLUT(332) = 12364;
      OrderLUT(337) = 183642;
      OrderLUT(340) = -129364;
      OrderLUT(344) = 21834;
      OrderLUT(350) = -124365;
      OrderLUT(353) = 12463;
      OrderLUT(354) = 136492;
      OrderLUT(360) = 1243;
      OrderLUT(368) = 12943;
      OrderLUT(371) = 126543;
      OrderLUT(384) = 126;
      OrderLUT(387) = 12340;
      OrderLUT(389) = 12943;
      OrderLUT(390) = 1243;
      OrderLUT(394) = -103642;
      OrderLUT(396) = 129364;
      OrderLUT(401) = 123640;
      OrderLUT(404) = 12364;
      OrderLUT(408) = 12340;
      OrderLUT(413) = 215643;
      OrderLUT(417) = -136492;
      OrderLUT(418) = 12463;
      OrderLUT(424) = 13492;
      OrderLUT(427) = -213456;
      OrderLUT(432) = 1342;

      % Convert to more convinient format
      orderLUT = cell(size(OrderLUT));
      for i = 1:size(OrderLUT,1)
        polygon = abs(OrderLUT(i));
        if polygon>0
          polygon = num2str(polygon)-48; % Convert from a single number to array of digits
          polygon(polygon==0) = 10;      % 0 stands for 10
          orderLUT{i} = polygon;
        end
      end
      % Negative numbers in the LUT indicate values which were not observed yet
      % so they were not independently verified.
      verified = OrderLUT>0;
      clear OrderLUT
    end
    % Calculate unique key for each edgeMat configuration
    key = dot(1*edgeMat(:)', [256 128 64 32 16 8 4 2 1]);
    assert(key<=432, 'Error: in IntersectionPolygon: key is out of bound');
    % Look up the point order around the polygon
    polygon = orderLUT{key};
    if (isempty(polygon))
      return
    end
    % in a rare case of 2 intersections there is ambiguity if one or two
    % vertices of the triangle lay inside the other triangle. OrderLUT stores
    % only the single vertex cases.
    nx = nnz(edgeMat(:));
    if nx==2
      pList = polygon;       % list of vertices to check
      pList(pList<=nx) = []; % keep only the triangle points of the polygon
      flip = false;    % was there a flip from single vertex to vertices case?
      for ip = 1:length(pList)
        p = pList(ip);                 % point to check
        t = floor((p-nx-1)/3);         % does it belong to triangle 0 or 1 (actually 1 or 2)
        tri = (1:3) + nx + 3*abs(1-t); % Points belonging to the other triangle
        if ~PointInTriangle2D(points(p,dIdx), points(tri,dIdx))
          d = nx+t*3;    % offset
          % "p-d" is vertex number of point just tested: 1, 2, or 3. "b, c" are
          % the other 2 vertices
          [b, c] = otherDim(p-d);
          polygon = [polygon(polygon~=p), b+d, c+d]; % remove i2 and add i0 and i1
          flip = true;
        end
      end
      if flip
        % if ther were any flips than use existing codes to figure out the
        % order of the points around the polygon
        DT = delaunayTriangulation(points(polygon,dIdx));
        idx = freeBoundary(DT)';
        idx(2,:) = [];
        polygon = polygon(idx);
      end
    end
    % Check to duplicate points
    tol = 1e6;
    P = round(points(polygon,:)*tol)/tol;
    [~,ia] = unique(P,'rows'); % V = P(ia,:) and P = V(ic,:).
    polygon = polygon(sort(ia));
    % Test the results using more expensive function
    doPlot = (~verified(key));
    if debug && length(polygon)>3
      DT = delaunayTriangulation(points(polygon,dIdx));
      idx = freeBoundary(DT)';
      idx(2,:) = [];
      k = max(abs(diff(idx)));
      %doPlot = (k>1 && k<(length(idx)-1)) || (~verified(key));
      assert(k==1 || k==(length(idx)-1), 'Two triangle intersection polygon is not convex')
    end
    if debug && doPlot % plot the interesting cases
      PlotTwoTriangles(points, polygon, 'm')
      title(sprintf('key = %i', key));
    end 
    
% ========================================================================
    function PlotTwoTriangles(points, polygon, color)
    % Plotting function used for debugging
    nx = size(points,1)-6;
    d = (max(points,[],1)-min(points,[],1))/200;
    figure(2)
    clf
    hold on
    line( points(nx+(1:2),1), points(nx+(1:2),2), points(nx+(1:2),3), 'Color', 'g');
    line( points(nx+(2:3),1), points(nx+(2:3),2), points(nx+(2:3),3), 'Color', 'g');
    line( points(nx+[1,3],1), points(nx+[1,3],2), points(nx+[1,3],3), 'Color', 'g');
    line( points(nx+(4:5),1), points(nx+(4:5),2), points(nx+(4:5),3), 'Color', 'b');
    line( points(nx+(5:6),1), points(nx+(5:6),2), points(nx+(5:6),3), 'Color', 'b');
    line( points(nx+[4,6],1), points(nx+[4,6],2), points(nx+[4,6],3), 'Color', 'b');
    plot3( points(:,1), points(:,2), points(:,3), 'm.');
    if (length(polygon)>2)
      idx = polygon([1:end, 1]);
      plot3( points(idx,1), points(idx,2),points(idx,3), 'Color', color, 'LineWidth', 1);
    end
    for i = 1:nx+6
      text(points(i,1)+d(1), points(i,2)+d(2), points(i,3), num2str(i))
    end
    
% ========================================================================
    function [intersect, X] = EdgesIntersect3D(V1,V2, U1,U2)
    %EdgesIntersectPoint3D calculates point of intersection of 2 coplanar
    % segments in 3D
    %
    % INPUTS:
    %   V1,V2 - 1 x 3 coordinates of endpoints of edge 1
    %   U1,U2 - 1 x 3 coordinates of endpoints of edge 2
    % OUTPUT:
    %   X - 1 x 3 coordinates of the intersection point
    A = V2-V1;
    B = U1-U2;
    C = U1-V1;
    % Solve system of equations [A,B,1] * [d;e;0] = C for d and e
    det3 = @(a,b) ... % determinant of a matrix with columns: [a, b, 1]
      a(:,1).*b(:,2)-a(:,3).*b(:,2) + ...
      a(:,2).*b(:,3)-a(:,2).*b(:,1) + ...
      a(:,3).*b(:,1)-a(:,1).*b(:,3);
  % https://en.wikipedia.org/wiki/Cramer%27s_rule#Explicit_formulas_for_small_systems
    f=det3(A,B); 
    t=det3(C,B)./f; % use Cramer's rule
    s=det3(A,C)./f;
    intersect = (t>=0 & t<=1 & s>=0 & s<=1);
    X = V1 + bsxfun(@times,A,t);
    
% ========================================================================
function inside = PointInTriangle2D(V1, U)
    % check if V1 is inside triangle U (U1,U2,U3)
    % Algorithm is checking on which side of the half-plane created by the
    % edges the point is. It uses sign of determinant to calculate orientation
    % of point triplets.
    % INPUTS:
    %   V1 - 1 x 2 coordinates of a point
    %   U  - 3 x 2 coordinates of endpoints of 3 edges of a triangle
    % OUTPUT:
    %   inside - a boolean or boolean array
    det2 = @(A,B,C) (A(:,1)-C(:,1))*(B(:,2)-C(:,2)) - (B(:,1)-C(:,1))*(A(:,2)-C(:,2));
    b1 = (det2(U(1,:), U(2,:), V1) > 0);
    b2 = (det2(U(2,:), U(3,:), V1) > 0);
    b3 = (det2(U(3,:), U(1,:), V1) > 0);
    inside = ((b1 == b2) & (b2 == b3)); % inside if same orientation for all 3 edges

% ========================================================================
function [b, c] = otherDim(a)
    % return set [1 2 3] without k
    b = mod(a+1,3)+1;  % b and c are vertices which are on the same side of the plane
    c = 6-a-b;         % a+b+c = 6
% ========================================================================
function overlap = TriangleIntersection3D_Rapid( v1, v2, v3, u1, u2, u3, n1, n2 )
    %TriangleIntersection3D tests if 2 triangles defined in 3D intersect.
    %
    % INPUTS:
    %   v1, v2, v3, - Nx3 array of surface 1 triangle vertex coordinates
    %   u1, u2, u3, - Nx3 array of surface 2 triangle vertex coordinates
    %   n1, n2      - Nx3 array of surface 1 & 2 triangle plane normals. Those
    %      are optional and if provided than the first 2 steps of the algorithm
    %      (which are equivalent to first 2 steps of Moller algorithm) will be 
    %      skipped.
    %
    % OUTPUT:
    %   iMsk - N x 1 intersection boolean mask marking which triangles overlap
    %
    % ALGORITHM:
    %   translated from the UNC-CH V-Collide RAPID code
    %    https://wwwx.cs.unc.edu/~geom/papers/COLLISION/vcol.pdf
    global V1 V2 V3 U1 U2 U3
    cross_prod = @(a,b) [...
      a(:,2).*b(:,3)-a(:,3).*b(:,2), ...
      a(:,3).*b(:,1)-a(:,1).*b(:,3), ...
      a(:,1).*b(:,2)-a(:,2).*b(:,1)];
    % shift t1 and t2 by p1#
    V1 = zeros(size(v1));
    V2 = v2-v1;
    V3 = v3-v1;
    U1 = u1-v1;
    U2 = u2-v1;
    U3 = u3-v1;
    clear v1 v2 v3 u1 u2 u3
    if(nargin<7)
      % now begin the series of tests
      n1 = cross_prod( V2-V1, V3-V1 ); % face normals
      n2 = cross_prod( U2-U1, U3-U1 ); % face normals
    end

    % test the face normals
    overlap = project6(n1) & project6(n2);
    V1 = V1(overlap,:);
    V2 = V2(overlap,:);
    V3 = V3(overlap,:);
    U1 = U1(overlap,:);
    U2 = U2(overlap,:);
    U3 = U3(overlap,:);
    n1 = n1(overlap,:);
    n2 = n2(overlap,:);
    % compute triangle edges
    e1 = V2-V1;
    e2 = V3-V2;
    e3 = V1-V3;
    f1 = U2-U1;
    f2 = U3-U2;
    f3 = U1-U3;
    % run more tests
    overlap2 = project6(cross_prod(e1, f1));
    overlap2 = project6(cross_prod(e1, f2)) & overlap2;
    overlap2 = project6(cross_prod(e1, f3)) & overlap2;
    overlap2 = project6(cross_prod(e2, f1)) & overlap2;
    overlap2 = project6(cross_prod(e2, f2)) & overlap2;
    overlap2 = project6(cross_prod(e2, f3)) & overlap2;
    overlap2 = project6(cross_prod(e3, f1)) & overlap2;
    overlap2 = project6(cross_prod(e3, f2)) & overlap2;
    overlap2 = project6(cross_prod(e3, f3)) & overlap2;
    overlap2 = project6(cross_prod(e1, n1)) & overlap2;
    overlap2 = project6(cross_prod(e2, n1)) & overlap2;
    overlap2 = project6(cross_prod(e3, n1)) & overlap2;
    overlap2 = project6(cross_prod(f1, n2)) & overlap2;
    overlap2 = project6(cross_prod(f2, n2)) & overlap2;
    overlap2 = project6(cross_prod(f3, n2)) & overlap2;
    overlap(overlap) = overlap2;

% ========================================================================
function pass = project6( p )
    % project all 6 vertices of both triangles onto vector p and check if two
    % projections overlap
    global V1 V2 V3 U1 U2 U3
    dot_prod = @(a,b) a(:,1).*b(:,1)+a(:,2).*b(:,2)+a(:,3).*b(:,3);
    % Project vertices of triangle 1 and find the bounds min1 and max1
    P = [dot_prod(p, V1), dot_prod(p, V2), dot_prod(p, V3)];
    max1 = max(P,[],2);
    min1 = min(P,[],2);
    % Project vertices of triangle 2 and find the bounds min1 and max1
    P = [dot_prod(p, U1), dot_prod(p, U2), dot_prod(p, U3)];
    max2 = max(P,[],2);
    min2 = min(P,[],2);
    % Compare the bounds to see if they overlap
    pass = (( min1 < max2 ) & ( min2 < max1 )) | ~dot_prod(p, p);
    
    
%------------------------------------------------------------------------------------    
function DeleteObjects(CellArray)

    if iscell(CellArray)
        L = length(CellArray);

        for k = 1:L
            delete(CellArray{k,1})
        end
    else
       delete(CellArray)
    end 
          
  
%------------------------------------------------------------------------------------    
function CalculateConvergencePointButton_Callback(hObject, eventdata, handles)
      
    % Concatenate ellipsoid vectors and cell centers-of-mass -----------------------------------
        nVec = size(handles.VectorData,1);
        CellVec = zeros(nVec,3); 
        CellCOM = zeros(nVec,3); 
        
        for n = 1:nVec  
            CellVec(n,:) = handles.VectorData{n,1}.EigenVectors(:,1)';
            CellIndex =    handles.VectorData{n,1}.CellIndex;
            CellCOM(n,:) = handles.CellData{CellIndex,1}.CellCenterOfMass;
        end
    %-------------------------------------------------------------------------------------------    
        [p,u,q,v] = CreateAllLineCombinations(CellCOM, CellVec);
        CCMP = ClosestConvergenceMidPoints(p,u,q,v); % Calculate midpoints of closest convergence for all vectors combinations
        CP = mean(CCMP,1); % Take mean of all convergence midpoints
   %--------------------------------------------------------------------------------------------     
        x = CP(1,1);
        y = CP(1,2);
        z = CP(1,3);
        handles.IntersectionPoint = [x y z];
        text1 = ['<x,y,z> = < '     sprintf('%5.2f',x)...
                              ',  ' sprintf('%5.2f',y)...
                              ',  ' sprintf('%5.2f',z) ' >'];
        set(handles.IntersectionPointDisplay,'String',text1,'FontWeight','normal',...
                                             'Position',[14, 9, 411, 20],'FontSize',11,...
                                             'HorizontalAlignment','center')
        guidata(hObject,handles)
        
    
%------------------------------------------------------------------------------------  
function BuildUrchinPlotButton_Callback(hObject, eventdata, handles)
    
    
         % #################################################################################################
        % COLUMN LABELS...
        % data = [Xc, Yc, Zc, uX1, uY1, uZ1, r1, r2, r3, MBSD, MBCD] (XYZ coords of Centroid of cell and UnitVector of the fitted ellipsoid longaxis)
        %==========================================================================================================================================
        
        nVec = size(handles.VectorData,1);
        CellVec = zeros(nVec,3); 
        CellCOM = zeros(nVec,3); 
        
        for n = 1:nVec  
            CellVec(n,:) = handles.VectorData{n,1}.EigenVectors(:,1)';
            CellIndex    = handles.VectorData{n,1}.CellIndex;
            CellCOM(n,:) = handles.CellData{CellIndex,1}.CellCenterOfMass;
        end
        
%         [p,u,q,v] = CreateAllLineCombinations(CellCOM, CellVec);
%         CCMP = ClosestConvergenceMidPoints(p,u,q,v); % Calculate midpoints of closest convergence for all vectors combinations
%         CP = mean(CCMP,1); % Take mean of all convergence midpoints

        cx = handles.IntersectionPoint(1,1);
        cy = handles.IntersectionPoint(1,2);
        cz = handles.IntersectionPoint(1,3);
        
        VecAngle = CalculateOrientationAngle( handles.IntersectionPoint, CellCOM, CellVec );   
               
        % Calculate MBCD and grab MBSD =======================================================================
           
           [MBSD, MBCD] = Calculate_MBSD_MBCD(handles); % Ellipsoid fit and Vectors must be turned on
           
        % Create Figure and Axes =============================================================================
            UPFH = figure;
            UPFH.Color = [1,1,1];
            AX = axes;
            CB = colorbar(AX);   CM = jet(9);    CM(9,:) = [1,0,0];
            CB.Label.String = 'Deviation Angle (degrees)';
            CB.FontSize = 11;
            
            set(AX,'Color',[1,1,1],'DataAspectRatio',[1 1 1],'LineWidth',1,...
                   'CameraPositionMode','auto','CameraTargetMode','auto',...
                   'CameraUpVectorMode','auto','BoxStyle','full','Colormap',CM,...
                   'CameraViewAngleMode','manual','CameraViewAngle',9,'ZDir','reverse',...
                   'CLim',[0,90],'CameraTarget',[cx,cy,cz],'Projection','perspective',...
                   'XGrid','on','YGrid','on','ZGrid','on',...
                   'XLim',handles.AxisRange(1,1:2),...
                   'YLim',handles.AxisRange(1,3:4),...
                   'ZLim',handles.AxisRange(1,5:6))
             xlabel(AX,'X (\mum)')
             ylabel(AX,'Y (\mum)')
             zlabel(AX,'Z (\mum)')
             
        % Create Vectors inversly proportional to MBSD/MBCD ratio ============================================
            MBSD_MBCD_ratio = MBSD./MBCD;
            VectorRadius = 0.45;
            [xx,yy,zz1] = cylinder(VectorRadius,15);
            
            P = gobjects(nVec,1);
            indices = 1:nVec;
            % Look for NaN's (indices where MBSD or MBCD calculation failed) and remove them 
            idx = find( isnan(MBSD_MBCD_ratio) );
            indices(idx) = [];                       
            
            for n = indices
                L = 5; % Length multiplier of vector (arbitary - for visual purposes only)
                % 0.99 is subtracted from ratio so that "circular" cells (where MBSD/MBCD ~= 1) show up as dots 
                % The zz1 values are centered around zero: (zz1 - 0.5);
                zz2 = L*(MBSD_MBCD_ratio(n,1)-0.99).*(zz1-0.5);
                Color = AssignColorBasedOnAngle(CM, VecAngle(n,1));
                DC = CellCOM(n,:);  % Center of Data Points (center of mass of cell)
                EV = CellVec(n,:);  % Eigenvector
                
                R  = RotationMatrix3D([0 0 1],EV); % Calculate Rotation Matrix
                    M1 = [xx(1,:); yy(1,:); zz2(1,:)]; 
                    M2 = [xx(2,:); yy(2,:); zz2(2,:)];
                    R1 = R*M1;
                    R2 = R*M2;
                XR = [R1(1,:); R2(1,:)];
                YR = [R1(2,:); R2(2,:)];
                ZR = [R1(3,:); R2(3,:)];
                
                hold(AX,'on') 
                P(n,1) = patch(AX,surf2patch(XR + DC(1,1), YR + DC(1,2), ZR + DC(1,3)));
                set(P(n,1),'FaceColor',Color,'EdgeColor','none','EdgeAlpha',1,'FaceAlpha',1,'FaceLighting','gouraud',...
                           'EdgeLighting','gouraud','BackFaceLighting','lit','Visible','on')
                hold(AX,'off')
            end

           hold(AX,'on')
           SH = scatter3(AX,cx,cy,cz,'MarkerEdgeColor','k','MarkerFaceColor',[1,0,0]);
           hold(AX,'off')
        %==========================================
            material shiny
        %==========================================
            camlight(AX,   30,  89)
            camlight(AX,   30, -89)
            camlight(AX,  100,  10)
            camlight(AX, -100,  10)
    
%------------------------------------------------------------------------------------      
function [MBSD, MBCD] = Calculate_MBSD_MBCD(handles)

    nVec = size(handles.VectorData,1);
    WB = waitbar(0,'Calculating MBCD for all cells... ');
    WB.Name = 'Building urchin plot...';
    drawnow

    MBCD = zeros(nVec,1);
    MBSD = zeros(nVec,1);

    for n = 1:nVec
        waitbar(n/nVec,WB, ['Calculating MBCD for all cells... ', num2str(100*n/nVec,'%0.1f') '%'] )
        index = handles.VectorData{n,1}.CellIndex;
        CellSurface.faces = handles.IsoSurfaceHandles{index,1}.Faces;; 
        CellSurface.vertices = handles.IsoSurfaceHandles{index,1}.Vertices;

        COM = double(handles.CellData{index}.CellCenterOfMass);
        r1 = handles.VectorData{n,1}.EigenVectors(:,1)';
        r2 = handles.VectorData{n,1}.EigenVectors(:,2)';
        r3 = handles.VectorData{n,1}.EigenVectors(:,3)';
        R2 = handles.VectorData{n,1}.Radius(2,1);
        R3 = handles.VectorData{n,1}.Radius(3,1);
        rmag = sqrt(R2.^2 + R3.^2);

        MBCD(n,1) = CalculateMBCDIntersectingPlane( NaN, CellSurface, COM, r1, r2, r3, rmag); 
        MBSD(n,1) = handles.VectorData{n,1}.MBSD;
    end            

    try; close(WB); end
    
 %------------------------------------------------------------------------------------   
    function [p,u,q,v] = CreateAllLineCombinations(x,w)

    % x is the an array of positions of size [n,3]. Combinations are p and q
    % w is an array of 3d vectors of size [n,3].    Combinations are u and v

    % Create all vector combinations without repeats
    N = size(w,1);
    nComb = (N-1)*N/2; % formula for number of combinations without repeats
    p = zeros(nComb,3);
    u = zeros(nComb,3);
    q = zeros(nComb,3);
    v = zeros(nComb,3);
    idx = 0;
    for ii = 2:N
        n = size( w(ii:end,:), 1 );
        p(idx+1:idx+n,:) = repmat( x(ii-1,:), N-ii+1, 1 );
        u(idx+1:idx+n,:) = repmat( w(ii-1,:), N-ii+1, 1 );
        q(idx+1:idx+n,:) = x( ii:end, :);
        v(idx+1:idx+n,:) = w( ii:end, :);
        idx = idx + n;
    end
    
    
%------------------------------------------------------------------------------------           
function [CCMP, CCP] = ClosestConvergenceMidPoints(p,u,q,v)
    
    %    
    % Solution: http://geomalgorithms.com/a07-_distance.html  
    % under "Distance between Lines" 
    %
    
    N = size(p,1);
    w = p-q; % Wzero 
    a = dot(u,u,2);
    b = dot(u,v,2);
    c = dot(v,v,2);
    d = dot(u,w,2);
    e = dot(v,w,2);
   
    scTOP = (b.*e-c.*d);
    scBOT = (a.*c-b.^2);
    scBOT(scBOT==0) = NaN; % Test if lines are parallel
        
    sc = scTOP./scBOT;
    Pc = p + sc.*u;
        
    tcTOP = (a.*e-b.*d);
    tc = tcTOP./scBOT; % Denominators are the same
    Qc = q + tc.*v;
    
    CCMP = (Pc + Qc)./2; % Closest Convergence MidPoints
    CCP  = cat(3,Pc,Qc); 
    
    
%------------------------------------------------------------------------------------        
function VecAngle = CalculateOrientationAngle(IP, CP, RV)

    N = size(CP,1);
    theta = zeros(N,1);
    
    for k = 1:N
        LV  = (IP-CP(k,:));
        uLV = LV./norm(LV);
        uRV = RV(k,:)./norm(RV(k,:));
        theta(k,1) = asin(norm(cross(uLV,uRV)));  
    end
    VecAngle = (180/pi)*theta;
    
    
%------------------------------------------------------------------------------------       
 function Color = AssignColorBasedOnAngle(Colormap,Angle)
    
    if Angle >= 0 & Angle < 10
        Color = Colormap(1,:);
    elseif Angle >= 10 & Angle < 20
        Color = Colormap(2,:);
    elseif Angle >= 20 & Angle < 30
        Color = Colormap(3,:);
    elseif Angle >= 30 & Angle < 40
        Color = Colormap(4,:);
    elseif Angle >= 40 & Angle < 50
        Color = Colormap(5,:); 
    elseif Angle >= 50 & Angle < 60
        Color = Colormap(6,:); 
    elseif Angle >= 60 & Angle < 70
        Color = Colormap(7,:);   
    elseif Angle >= 70 & Angle < 80
        Color = Colormap(8,:);   
    elseif Angle >= 80 & Angle <= 90
        Color = Colormap(9,:);    
    end   
    

% ------------------------------------------------------------------------------------------------------------
function ReverseXaxisCheck_Callback(hObject, eventdata, handles)
    
    switch handles.ReverseXaxisCheck.Value
        case 1;     set(handles.AxisHandle,'XDir','reverse')
        case 0;     set(handles.AxisHandle,'XDir','normal')
    end
    guidata(hObject,handles)  

    
% ------------------------------------------------------------------------------------------------------------
function ReverseYaxisCheck_Callback(hObject, eventdata, handles)

    switch handles.ReverseYaxisCheck.Value
        case 1;     set(handles.AxisHandle,'YDir','reverse')
        case 0;     set(handles.AxisHandle,'YDir','normal')
    end
    guidata(hObject,handles)  


% ------------------------------------------------------------------------------------------------------------
function ReverseZaxisCheck_Callback(hObject, eventdata, handles)

    switch handles.ReverseZaxisCheck.Value
        case 1;     set(handles.AxisHandle,'ZDir','reverse')
        case 0;     set(handles.AxisHandle,'ZDir','normal')
    end
    guidata(hObject,handles)  
    

% ------------------------------------------------------------------------------------------------------------
function RandomColorsCheck_Callback(hObject, eventdata, handles)

    
    
    
    
    
    


% --- Creates and returns a handle to the GUI figure. 
function h1 = longaxis_LayoutFcn(policy)
% policy - create a new figure or use a singleton. 'new' or 'reuse'.

persistent hsingleton;
if strcmpi(policy, 'reuse') & ishandle(hsingleton)
    h1 = hsingleton;
    return;
end

appdata = [];
appdata.GUIDEOptions = struct(...
    'active_h', [], ...
    'taginfo', struct(...
    'figure', 2, ...
    'text', 56, ...
    'pushbutton', 59, ...
    'axes', 9, ...
    'slider', 19, ...
    'edit', 11, ...
    'uipanel', 34, ...
    'togglebutton', 11, ...
    'uitable', 2, ...
    'checkbox', 20, ...
    'popupmenu', 9, ...
    'uibuttongroup', 2, ...
    'listbox', 3), ...
    'override', 0, ...
    'release', [], ...
    'resize', 'none', ...
    'accessibility', 'callback', ...
    'mfile', 1, ...
    'callbacks', 1, ...
    'singleton', 1, ...
    'syscolorfig', 1, ...
    'blocking', 0, ...
    'lastSavedFile', 'C:\Matlab Files\LongAxis\LongAxis main program and subfunctions\Fig and Code files combined\longaxis.m', ...
    'lastFilename', 'C:\Matlab Files\LongAxis\LongAxis main program and subfunctions\longaxis.fig');
appdata.lastValidTag = 'MainFigure1';
appdata.GUIDELayoutEditor = [];
appdata.initTags = struct(...
    'handle', [], ...
    'tag', 'MainFigure1');

h1 = figure(...
'PaperUnits',get(0,'defaultfigurePaperUnits'),...
'Units',get(0,'defaultfigureUnits'),...
'Position',[680.333333333333 213 1630 875],...
'Visible',get(0,'defaultfigureVisible'),...
'Color',get(0,'defaultfigureColor'),...
'CloseRequestFcn',@(hObject,eventdata)longaxis('MainFigure1_CloseRequestFcn',hObject,eventdata,guidata(hObject)),...
'CurrentAxesMode','manual',...
'CurrentObjectMode','manual',...
'CurrentPointMode','manual',...
'SelectionTypeMode','manual',...
'ResizeFcn',blanks(0),...
'IntegerHandle','off',...
'NextPlot',get(0,'defaultfigureNextPlot'),...
'Alphamap',get(0,'defaultfigureAlphamap'),...
'WindowButtonDownFcn',blanks(0),...
'WindowButtonUpFcn',blanks(0),...
'WindowButtonMotionFcn',blanks(0),...
'WindowScrollWheelFcn',blanks(0),...
'WindowKeyPressFcn',blanks(0),...
'WindowKeyReleaseFcn',blanks(0),...
'MenuBar','none',...
'ToolBar',get(0,'defaultfigureToolBar'),...
'Pointer',get(0,'defaultfigurePointer'),...
'PointerShapeHotSpot',get(0,'defaultfigurePointerShapeHotSpot'),...
'Name','longaxis',...
'NumberTitle','off',...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MainFigure1',...
'UserData',[],...
'WindowStyle',get(0,'defaultfigureWindowStyle'),...
'DockControls',get(0,'defaultfigureDockControls'),...
'Resize','off',...
'PaperPosition',get(0,'defaultfigurePaperPosition'),...
'PaperSize',get(0,'defaultfigurePaperSize'),...
'PaperType',get(0,'defaultfigurePaperType'),...
'InvertHardcopy',get(0,'defaultfigureInvertHardcopy'),...
'PaperOrientation',get(0,'defaultfigurePaperOrientation'),...
'ScreenPixelsPerInchMode','manual',...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility','callback');

appdata = [];
appdata.lastValidTag = 'NavigationPanel';

h2 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'ForegroundColor',get(0,'defaultuipanelForegroundColor'),...
'HighlightColor',get(0,'defaultuipanelHighlightColor'),...
'ShadowColor',get(0,'defaultuipanelShadowColor'),...
'BorderType','beveledout',...
'BorderWidth',3,...
'TitlePosition',get(0,'defaultuipanelTitlePosition'),...
'Title',blanks(0),...
'Visible',get(0,'defaultuipanelVisible'),...
'BackgroundColor',get(0,'defaultuipanelBackgroundColor'),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','NavigationPanel',...
'UserData',[],...
'Position',[1 4.33333333333303 522 825],...
'HandleVisibility',get(0,'defaultuipanelHandleVisibility'),...
'FontSize',get(0,'defaultuipanelFontSize'),...
'FontName',get(0,'defaultuipanelFontName'),...
'FontAngle',get(0,'defaultuipanelFontAngle'),...
'FontWeight',get(0,'defaultuipanelFontWeight'));

appdata = [];
appdata.lastValidTag = 'Navigation_Figure';

h3 = axes(...
'Parent',h2,...
'FontUnits',get(0,'defaultaxesFontUnits'),...
'Units','pixels',...
'CameraPosition',[0.5 0.5 9.16025403784439],...
'CameraPositionMode',get(0,'defaultaxesCameraPositionMode'),...
'CameraTarget',[0.5 0.5 0.5],...
'CameraTargetMode',get(0,'defaultaxesCameraTargetMode'),...
'CameraViewAngle',6.60861036031192,...
'CameraViewAngleMode',get(0,'defaultaxesCameraViewAngleMode'),...
'PlotBoxAspectRatio',[1 0.900862068965517 0.900862068965517],...
'PlotBoxAspectRatioMode',get(0,'defaultaxesPlotBoxAspectRatioMode'),...
'XTick',[0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1],...
'XTickMode',get(0,'defaultaxesXTickMode'),...
'XTickLabel',{  '0'; '0.1'; '0.2'; '0.3'; '0.4'; '0.5'; '0.6'; '0.7'; '0.8'; '0.9'; '1' },...
'XTickLabelMode',get(0,'defaultaxesXTickLabelMode'),...
'YTick',[0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1],...
'YTickMode',get(0,'defaultaxesYTickMode'),...
'YTickLabel',{  '0'; '0.1'; '0.2'; '0.3'; '0.4'; '0.5'; '0.6'; '0.7'; '0.8'; '0.9'; '1' },...
'YTickLabelMode',get(0,'defaultaxesYTickLabelMode'),...
'CameraMode',get(0,'defaultaxesCameraMode'),...
'DataSpaceMode',get(0,'defaultaxesDataSpaceMode'),...
'ColorSpaceMode',get(0,'defaultaxesColorSpaceMode'),...
'DecorationContainerMode',get(0,'defaultaxesDecorationContainerMode'),...
'ChildContainerMode',get(0,'defaultaxesChildContainerMode'),...
'XRulerMode',get(0,'defaultaxesXRulerMode'),...
'YRulerMode',get(0,'defaultaxesYRulerMode'),...
'ZRulerMode',get(0,'defaultaxesZRulerMode'),...
'AmbientLightSourceMode',get(0,'defaultaxesAmbientLightSourceMode'),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Navigation_Figure_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Navigation_Figure',...
'Position',[38 50 464 418],...
'ActivePositionProperty','position',...
'ActivePositionPropertyMode',get(0,'defaultaxesActivePositionPropertyMode'),...
'LooseInset',[55.38 89.43 40.47 60.975],...
'LooseInsetMode',get(0,'defaultaxesLooseInsetMode'),...
'FontSize',8,...
'SortMethod','childorder',...
'SortMethodMode',get(0,'defaultaxesSortMethodMode'));

h4 = get(h3,'title');

set(h4,...
'Parent',h3,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0 0 0],...
'ColorMode','auto',...
'Position',[0.500000554939796 1.00526315789474 0.500000000000007],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','bold',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','Axes Title',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h5 = get(h3,'xlabel');

set(h5,...
'Parent',h3,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0.500000476837158 -0.0417862828933832 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','top',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h6 = get(h3,'ylabel');

set(h6,...
'Parent',h3,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[-0.0455459760480571 0.500000476837158 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',90,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h7 = get(h3,'zlabel');

set(h7,...
'Parent',h3,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0 0 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontSize',10,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','left',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','middle',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','off',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

appdata = [];
appdata.lastValidTag = 'Z_slider';

h8 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','String',...
'Style','slider',...
'Position',[92 485 337 37],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('Z_slider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Z_slider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Z_slider');

appdata = [];
appdata.lastValidTag = 'Set_z1_Button';

h9 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','z1 = 1',...
'Style','togglebutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[11 485 70 37],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('Set_z1_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Set_z1_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',10,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'Set_z2_Button';

h10 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','z2 = 100',...
'Style','togglebutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[440 485 70 37],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('Set_z2_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Set_z2_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',10,...
'FontName','Ariel',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'CoordsPanel';

h11 = uipanel(...
'Parent',h2,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledin',...
'BorderWidth',2,...
'Title',blanks(0),...
'BackgroundColor',[1 1 1],...
'Tag','CoordsPanel',...
'Position',[253 551 256 120],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'PositionDisplay';

h12 = uicontrol(...
'Parent',h11,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String',{  '           X      Y'; 'microns: '; 'pixels: ' },...
'Style','text',...
'Position',[7 11 245 100],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'BusyAction','cancel',...
'Tag','PositionDisplay',...
'FontSize',10,...
'FontName','Monospaced',...
'FontWeight','bold',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'uipanel13';

h13 = uipanel(...
'Parent',h2,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType',get(0,'defaultuipanelBorderType'),...
'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
'Title',blanks(0),...
'Tag','uipanel13',...
'Position',[12 613 234 57],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'Select_Region_Button';

h14 = uicontrol(...
'Parent',h13,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Draw Select',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[11 8 100 41],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('Select_Region_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Select_Region_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'Input_Region_Button';

h15 = uicontrol(...
'Parent',h13,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Input Select',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[122 8 100 41],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('Input_Region_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Input_Region_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'uipanel17';

h16 = uipanel(...
'Parent',h2,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledout',...
'BorderWidth',2,...
'Title',blanks(0),...
'Tag','uipanel17',...
'Position',[253 676 257 82],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'HandednessLabel';

h17 = uicontrol(...
'Parent',h16,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','left-handed axis',...
'Style','text',...
'Position',[13 11 80 8],...
'Children',[],...
'Tag','HandednessLabel',...
'FontSize',7,...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'Create_3D_Rendering_Button';

h18 = uicontrol(...
'Parent',h16,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Render 3D Cells',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[11 29 236 45],...
'BackgroundColor',[0 0.450980392156863 0.741176470588235],...
'Callback',@(hObject,eventdata)longaxis('Create_3D_Rendering_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',[0 1 0],...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Create_3D_Rendering_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',14,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'EdgeCellsCheck';

h19 = uicontrol(...
'Parent',h16,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Render Edge Cells',...
'Style','checkbox',...
'Position',[119 7 110 16],...
'Callback',@(hObject,eventdata)longaxis('EdgeCellsCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','EdgeCellsCheck',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'uipanel18';

h20 = uipanel(...
'Parent',h2,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledin',...
'BorderWidth',2,...
'Title',blanks(0),...
'BackgroundColor',[1 1 1],...
'Tag','uipanel18',...
'Position',[11 551 234 59],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'Z_Display';

h21 = axes(...
'Parent',h20,...
'FontUnits',get(0,'defaultaxesFontUnits'),...
'Units','pixels',...
'View',get(0,'defaultaxesView'),...
'CameraPosition',[0.5 0.5 9.16025403784439],...
'CameraPositionMode',get(0,'defaultaxesCameraPositionMode'),...
'CameraTarget',[0.5 0.5 0.5],...
'CameraTargetMode',get(0,'defaultaxesCameraTargetMode'),...
'CameraViewAngle',6.60861036031192,...
'CameraViewAngleMode',get(0,'defaultaxesCameraViewAngleMode'),...
'Projection',get(0,'defaultaxesProjection'),...
'LabelFontSizeMultiplier',get(0,'defaultaxesLabelFontSizeMultiplier'),...
'AmbientLightColor',get(0,'defaultaxesAmbientLightColor'),...
'PlotBoxAspectRatio',[1 0.25 0.25],...
'PlotBoxAspectRatioMode',get(0,'defaultaxesPlotBoxAspectRatioMode'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultaxesFontAngle'),...
'FontWeight',get(0,'defaultaxesFontWeight'),...
'FontSmoothing',get(0,'defaultaxesFontSmoothing'),...
'TickLabelInterpreter',get(0,'defaultaxesTickLabelInterpreter'),...
'XDir',get(0,'defaultaxesXDir'),...
'YDir',get(0,'defaultaxesYDir'),...
'ZDir',get(0,'defaultaxesZDir'),...
'Layer',get(0,'defaultaxesLayer'),...
'TickLength',get(0,'defaultaxesTickLength'),...
'GridLineStyle',get(0,'defaultaxesGridLineStyle'),...
'MinorGridLineStyle',get(0,'defaultaxesMinorGridLineStyle'),...
'XAxisLocation',get(0,'defaultaxesXAxisLocation'),...
'XTick',[0 0.5 1],...
'XTickMode',get(0,'defaultaxesXTickMode'),...
'XTickLabelRotation',get(0,'defaultaxesXTickLabelRotation'),...
'XScale',get(0,'defaultaxesXScale'),...
'XTickLabel',{  '0'; '0.5'; '1' },...
'XTickLabelMode',get(0,'defaultaxesXTickLabelMode'),...
'XMinorTick',get(0,'defaultaxesXMinorTick'),...
'YAxisLocation',get(0,'defaultaxesYAxisLocation'),...
'YTick',[0 0.5 1],...
'YTickMode',get(0,'defaultaxesYTickMode'),...
'YTickLabelRotation',get(0,'defaultaxesYTickLabelRotation'),...
'YScale',get(0,'defaultaxesYScale'),...
'YTickLabel',{  '0'; '0.5'; '1' },...
'YTickLabelMode',get(0,'defaultaxesYTickLabelMode'),...
'YMinorTick',get(0,'defaultaxesYMinorTick'),...
'ZTickLabelRotation',get(0,'defaultaxesZTickLabelRotation'),...
'ZScale',get(0,'defaultaxesZScale'),...
'ZMinorTick',get(0,'defaultaxesZMinorTick'),...
'BoxStyle',get(0,'defaultaxesBoxStyle'),...
'LineWidth',get(0,'defaultaxesLineWidth'),...
'Color',get(0,'defaultaxesColor'),...
'ClippingStyle',get(0,'defaultaxesClippingStyle'),...
'CameraMode',get(0,'defaultaxesCameraMode'),...
'DataSpaceMode',get(0,'defaultaxesDataSpaceMode'),...
'ColorSpaceMode',get(0,'defaultaxesColorSpaceMode'),...
'DecorationContainerMode',get(0,'defaultaxesDecorationContainerMode'),...
'ChildContainerMode',get(0,'defaultaxesChildContainerMode'),...
'XAxisMode','manual',...
'YRulerMode',get(0,'defaultaxesYRulerMode'),...
'ZAxisMode','manual',...
'AmbientLightSourceMode',get(0,'defaultaxesAmbientLightSourceMode'),...
'XGrid',get(0,'defaultaxesXGrid'),...
'XMinorGrid',get(0,'defaultaxesXMinorGrid'),...
'YGrid',get(0,'defaultaxesYGrid'),...
'YMinorGrid',get(0,'defaultaxesYMinorGrid'),...
'ZGrid',get(0,'defaultaxesZGrid'),...
'ZMinorGrid',get(0,'defaultaxesZMinorGrid'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Z_Display',...
'UserData',[],...
'HitTest',get(0,'defaultaxesHitTest'),...
'PickableParts',get(0,'defaultaxesPickableParts'),...
'Position',[29 8 172 43],...
'ActivePositionProperty','position',...
'LooseInset',[69.94 98.78 51.11 67.35],...
'LooseInsetMode',get(0,'defaultaxesLooseInsetMode'),...
'ColorOrderIndex',get(0,'defaultaxesColorOrderIndex'),...
'LineStyleOrder',get(0,'defaultaxesLineStyleOrder'),...
'LineStyleOrderIndex',get(0,'defaultaxesLineStyleOrderIndex'),...
'FontSize',12,...
'TitleFontWeight',get(0,'defaultaxesTitleFontWeight'),...
'TitleFontSizeMultiplier',get(0,'defaultaxesTitleFontSizeMultiplier'),...
'SortMethod','childorder',...
'Clipping',get(0,'defaultaxesClipping'),...
'NextPlot',get(0,'defaultaxesNextPlot'),...
'Box',get(0,'defaultaxesBox'),...
'ChildrenMode','manual',...
'Visible',get(0,'defaultaxesVisible'),...
'HandleVisibility',get(0,'defaultaxesHandleVisibility'));

h22 = get(h21,'title');

set(h22,...
'Parent',h21,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0 0 0],...
'ColorMode','auto',...
'Position',[0.500000637631084 1.07674418604651 0.500000000000007],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Monospaced',...
'FontNameMode','auto',...
'FontSize',13.2,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','bold',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','Axes Title',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h23 = get(h21,'xlabel');

set(h23,...
'Parent',h21,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0.500000476837158 -0.679069752194161 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Monospaced',...
'FontNameMode','auto',...
'FontSize',13.2,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','top',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h24 = get(h21,'ylabel');

set(h24,...
'Parent',h21,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[-0.225968987223252 0.500000476837158 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',90,...
'RotationMode','auto',...
'FontName','Monospaced',...
'FontNameMode','auto',...
'FontSize',13.2,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h25 = get(h21,'zlabel');

set(h25,...
'Parent',h21,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0 0 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Monospaced',...
'FontNameMode','auto',...
'FontSize',10,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','left',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','middle',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','off',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

appdata = [];
appdata.lastValidTag = 'AboutButton';

h26 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','About LongAxis',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[417 793 95 26],...
'Callback',@(hObject,eventdata)longaxis('AboutButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','AboutButton');

appdata = [];
appdata.lastValidTag = 'ShortCutButton';

h27 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Short Cuts',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[417 765 95 26],...
'Callback',@(hObject,eventdata)longaxis('ShortCutButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ShortCutButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Pixel_Width_Input';

h28 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','0.21',...
'Style','edit',...
'Position',[360 794 47 24],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('Pixel_Width_Input_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Pixel_Width_Input_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Pixel_Width_Input',...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'Pixel_Width_Label';

h29 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','Pixel Width (microns):',...
'Style','text',...
'Position',[249 796 109 18],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','Pixel_Width_Label');

appdata = [];
appdata.lastValidTag = 'Z_Step_Label';

h30 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','Z Step (microns):',...
'Style','text',...
'Position',[264 768 93 18],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Z_Step_Label');

appdata = [];
appdata.lastValidTag = 'Z_Step_Input';

h31 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','0.42',...
'Style','edit',...
'Position',[360 766 47 24],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('Z_Step_Input_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Z_Step_Input_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Z_Step_Input',...
'KeyPressFcn',blanks(0),...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'LoadImageDataButton';

h32 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Load Data',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[155 793 90 24],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('LoadImageDataButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','LoadImageDataButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',9,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'Select_File_Button';

h33 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Process Image Data',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[12 763 138 54],...
'BackgroundColor',[0 0.450980392156863 0.741176470588235],...
'Callback',@(hObject,eventdata)longaxis('Select_File_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',[0.941176470588235 0.941176470588235 0.941176470588235],...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Select_File_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',9,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SaveImageDataButton';

h34 = uicontrol(...
'Parent',h2,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Save Data',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[155 763 90 24],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('SaveImageDataButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SaveImageDataButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',9,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'uipanel31';

h35 = uipanel(...
'Parent',h2,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel31',...
'Position',[12 675 234 82],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'ImageFileLocationDisplay';

h36 = uicontrol(...
'Parent',h35,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',blanks(0),...
'Style','text',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[7 7 219 70],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',blanks(0),...
'Children',[],...
'ForegroundColor',[0 0.450980392156863 0.741176470588235],...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ImageFileLocationDisplay',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',7,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'NavigationPanelButton';

h37 = uicontrol(...
'Parent',h1,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','NAVIGATION',...
'Style','togglebutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[2 826.666666666666 173 48],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('NavigationPanelButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','NavigationPanelButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',12,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'DisplayPanelButton';

h38 = uicontrol(...
'Parent',h1,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','IMAGE',...
'Style','togglebutton',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[175 826.666666666666 173 48],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('DisplayPanelButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','DisplayPanelButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',12,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'DataPanelButton';

h39 = uicontrol(...
'Parent',h1,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','DATA',...
'Style','togglebutton',...
'Position',[348 826.666666666666 174 48],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('DataPanelButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','DataPanelButton',...
'KeyPressFcn',blanks(0),...
'FontSize',12,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'DisplayPanel';

h40 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledout',...
'BorderWidth',3,...
'Title',blanks(0),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','DisplayPanel',...
'Position',[1084 29.6666666666661 522 825]);

appdata = [];
appdata.lastValidTag = 'DataSlicePanel';

h41 = uipanel(...
'Parent',h40,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledin',...
'BorderWidth',3,...
'Title',blanks(0),...
'Tag','DataSlicePanel',...
'Position',[21 18 477 491],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'DataSliceLabel';

h42 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Image Data Slice Overlay',...
'Style','text',...
'Position',[7 466 170 21],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','DataSliceLabel',...
'FontSize',10,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'uipanel12';

h43 = uipanel(...
'Parent',h41,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'ForegroundColor',get(0,'defaultuipanelForegroundColor'),...
'HighlightColor',get(0,'defaultuipanelHighlightColor'),...
'ShadowColor',get(0,'defaultuipanelShadowColor'),...
'BorderType',get(0,'defaultuipanelBorderType'),...
'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
'TitlePosition',get(0,'defaultuipanelTitlePosition'),...
'Title','Color Map',...
'Visible',get(0,'defaultuipanelVisible'),...
'BackgroundColor',get(0,'defaultuipanelBackgroundColor'),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','uipanel12',...
'UserData',[],...
'Position',[182 6 122 86],...
'HandleVisibility',get(0,'defaultuipanelHandleVisibility'),...
'FontSize',get(0,'defaultuipanelFontSize'),...
'FontName',get(0,'defaultuipanelFontName'),...
'FontAngle',get(0,'defaultuipanelFontAngle'),...
'FontWeight',get(0,'defaultuipanelFontWeight'));

appdata = [];
appdata.lastValidTag = 'ColormapPulldown';

h44 = uicontrol(...
'Parent',h43,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',{  'one'; 'two'; 'three'; 'four' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[12 37 90 28],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('ColormapPulldown_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('ColormapPulldown_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','ColormapPulldown');

appdata = [];
appdata.lastValidTag = 'ShowColorbarCheck';

h45 = uicontrol(...
'Parent',h43,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Show Colorbar',...
'Style','checkbox',...
'Position',[12 15 95 23],...
'Callback',@(hObject,eventdata)longaxis('ShowColorbarCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ShowColorbarCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'uipanel16';

h46 = uipanel(...
'Parent',h41,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType',get(0,'defaultuipanelBorderType'),...
'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
'Title','Specify reference point for vector orientation angle calculation',...
'Tag','uipanel16',...
'Position',[20 102 437 95],...
'FontSize',get(0,'defaultuipanelFontSize'),...
'FontWeight','bold',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'RecordIntersectionButton';

h47 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','RECORD CURRENT PT',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[98 39 146 22],...
'Callback',@(hObject,eventdata)longaxis('RecordIntersectionButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','RecordIntersectionButton',...
'FontSize',9,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'IntersectionPointDisplay';

h48 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','< x,y,z > = < 35.75, 68.94, 100.34 >',...
'Style','text',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 9 411 20],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',blanks(0),...
'Children',[],...
'ForegroundColor',[0 0 1],...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','IntersectionPointDisplay',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',11,...
'FontName','MSansSerif',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'InputIntersectionButton';

h49 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','INPUT PT',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[14 39 72 22],...
'Callback',@(hObject,eventdata)longaxis('InputIntersectionButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','InputIntersectionButton',...
'KeyPressFcn',blanks(0),...
'FontSize',9,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'CalculateConvergencePointButton';

h50 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','CALCULATE CONV PT',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[255 39 169 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('CalculateConvergencePointButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','CalculateConvergencePointButton',...
'KeyPressFcn',blanks(0),...
'FontSize',9,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'text53';

h51 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','(turn on ALL slices)',...
'Style','text',...
'Position',[120 60 100 14],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','text53',...
'FontSize',7.5);

appdata = [];
appdata.lastValidTag = 'text54';

h52 = uicontrol(...
'Parent',h46,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','(turn on ellipsoid fit and vectors)',...
'Style','text',...
'Position',[261 60 158 14],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text54',...
'FontSize',7.5);

appdata = [];
appdata.lastValidTag = 'uipanel22';

h53 = uipanel(...
'Parent',h41,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType',get(0,'defaultuipanelBorderType'),...
'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
'Title','View Cells Near Slice Plane',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','uipanel22',...
'Position',[34 221 270 82]);

appdata = [];
appdata.lastValidTag = 'ViewCellsNearSliceMenu';

h54 = uicontrol(...
'Parent',h53,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',{  'OFF'; 'X-plane'; 'Y-plane'; 'Z-plane' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[18 33 121 25],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('ViewCellsNearSliceMenu_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('ViewCellsNearSliceMenu_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','ViewCellsNearSliceMenu',...
'FontSize',9);

appdata = [];
appdata.lastValidTag = 'ViewCellsNearSliceRangeInput';

h55 = uicontrol(...
'Parent',h53,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','10',...
'Style','edit',...
'Position',[169 34 34 25],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('ViewCellsNearSliceRangeInput_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('ViewCellsNearSliceRangeInput_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','ViewCellsNearSliceRangeInput',...
'FontSize',9);

appdata = [];
appdata.lastValidTag = 'text43';

h56 = uicontrol(...
'Parent',h53,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','+/-',...
'Style','text',...
'Position',[139 38 27 16],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','text43',...
'FontSize',9,...
'FontName','Monospaced',...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'text44';

h57 = uicontrol(...
'Parent',h53,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','microns ',...
'Style','text',...
'Position',[207 38 58 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text44',...
'FontSize',9,...
'FontName','Monospaced',...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SliceIsStepSizeCheckBox';

h58 = uicontrol(...
'Parent',h53,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Image Slice Step  = Slice Thickness',...
'Style','checkbox',...
'Position',[43 6 204 23],...
'Callback',@(hObject,eventdata)longaxis('SliceIsStepSizeCheckBox_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'Tag','SliceIsStepSizeCheckBox',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'uipanel27';

h59 = uipanel(...
'Parent',h41,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType',get(0,'defaultuipanelBorderType'),...
'BorderWidth',get(0,'defaultuipanelBorderWidth'),...
'Title','Histograms',...
'Tag','uipanel27',...
'Position',[9 6 169 86],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'PolarHistButton';

h60 = uicontrol(...
'Parent',h59,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Hist (Rel to Planes)',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[12 42 146 24],...
'Callback',@(hObject,eventdata)longaxis('PolarHistButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','PolarHistButton',...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'PolarHistButton_Point';

h61 = uicontrol(...
'Parent',h59,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Hist (Rel to Inters Pt)',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[12 14 146 24],...
'Callback',@(hObject,eventdata)longaxis('PolarHistButton_Point_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PolarHistButton_Point',...
'KeyPressFcn',blanks(0),...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'Y_Plane_Slider';

h62 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',{  'Slider' },...
'Style','slider',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[17 376 318 17],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('Y_Plane_Slider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Y_Plane_Slider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Y_Plane_Slider',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'X_Plane_Slider';

h63 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',{  'Slider' },...
'Style','slider',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[17 416 318 17],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('X_Plane_Slider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('X_Plane_Slider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','X_Plane_Slider',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'XLow';

h64 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','45.1',...
'Style','text',...
'Position',[16 397 76 17],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','XLow',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'XHigh';

h65 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','100.2',...
'Style','text',...
'Position',[251 397 81 17],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','XHigh',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'XSliceCheck';

h66 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','X Slice',...
'Style','checkbox',...
'Position',[408 414 61 23],...
'Callback',@(hObject,eventdata)longaxis('XSliceCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','XSliceCheck');

appdata = [];
appdata.lastValidTag = 'XSliceDisplay';

h67 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','300.2',...
'Style','text',...
'Position',[338 414 58 20],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'Enable',get(0,'defaultuicontrolEnable'),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','XSliceDisplay',...
'FontSize',10,...
'FontName','Monospaced',...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'YLow';

h68 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','45.1',...
'Style','text',...
'Position',[16 357 73 17],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','YLow',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'YHigh';

h69 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','100.2',...
'Style','text',...
'Position',[255 358 77 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','YHigh',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'YSliceCheck';

h70 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Y Slice',...
'Style','checkbox',...
'Position',[408 374 61 23],...
'Callback',@(hObject,eventdata)longaxis('YSliceCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','YSliceCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'YSliceDisplay';

h71 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','300.2',...
'Style','text',...
'Position',[338 374 58 20],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','YSliceDisplay',...
'FontSize',10,...
'FontName','Monospaced',...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'Z_Plane_Slider';

h72 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',{  'Slider' },...
'Style','slider',...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[17 337 318 17],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('Z_Plane_Slider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Z_Plane_Slider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Z_Plane_Slider',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'ZLow';

h73 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','45.1',...
'Style','text',...
'Position',[16 319 76 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ZLow',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'ZHigh';

h74 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','100.2',...
'Style','text',...
'Position',[244 318 88 17],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ZHigh',...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'ZSliceCheck';

h75 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Z Slice',...
'Style','checkbox',...
'Position',[408 336 61 23],...
'Callback',@(hObject,eventdata)longaxis('ZSliceCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ZSliceCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ZSliceDisplay';

h76 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','300.2',...
'Style','text',...
'Position',[338 336 58 20],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ZSliceDisplay',...
'FontSize',10,...
'FontName','Monospaced',...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SliceOrLineCheck';

h77 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Slice/Line',...
'Style','checkbox',...
'Position',[377 461 88 23],...
'Callback',@(hObject,eventdata)longaxis('SliceOrLineCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'Tag','SliceOrLineCheck',...
'FontSize',10,...
'FontWeight','bold',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'SliceTransparencySlider';

h78 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[194 464 159 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('SliceTransparencySlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('SliceTransparencySlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SliceTransparencySlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'SliceTransparencyDisplay';

h79 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Slice Transparency:   100 %',...
'Style','text',...
'Position',[195 447 158 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SliceTransparencyDisplay');

appdata = [];
appdata.lastValidTag = 'uipanel30';

h80 = uipanel(...
'Parent',h41,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel30',...
'Position',[1 208 474 3],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'SliceSmoothingMenu';

h81 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',{  'Smoothing off'; 'sigma = 0.5'; 'sigma = 1.0'; 'sigma = 1.5'; 'sigma = 2.0'; 'sigma = 2.5'; 'sigma = 3.0' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[316 264 117 22],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('SliceSmoothingMenu_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('SliceSmoothingMenu_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','SliceSmoothingMenu');

appdata = [];
appdata.lastValidTag = 'SliceSaturateMenu';

h82 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',{  'No Saturation'; 'Saturation 2%'; 'Saturation 5%'; 'Saturation 10%'; 'Saturation 15%'; 'Saturation 20%'; 'Saturation 25%' },...
'Style','popupmenu',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[316 219 117 26],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('SliceSaturateMenu_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('SliceSaturateMenu_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','SliceSaturateMenu');

appdata = [];
appdata.lastValidTag = 'PopOutControllerButton';

h83 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Pop-Out Controller',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[311 52 158 39],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('PopOutControllerButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','PopOutControllerButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',10,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'text51';

h84 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','2D Gaussian Smoothing',...
'Style','text',...
'Position',[314 287 120 14],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','text51');

appdata = [];
appdata.lastValidTag = 'text52';

h85 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','2D Saturation',...
'Style','text',...
'Position',[316 245 120 14],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text52');

appdata = [];
appdata.lastValidTag = 'BuildUrchinPlotButton';

h86 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Build Urchin Plot',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[312 8 158 23],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('BuildUrchinPlotButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BuildUrchinPlotButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'text55';

h87 = uicontrol(...
'Parent',h41,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','(turn on ellipsoid fit and vectors)',...
'Style','text',...
'Position',[312 30 158 14],...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text55',...
'FontSize',7.5);

appdata = [];
appdata.lastValidTag = 'VisualizationPanel';

h88 = uipanel(...
'Parent',h40,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'ForegroundColor',get(0,'defaultuipanelForegroundColor'),...
'HighlightColor',get(0,'defaultuipanelHighlightColor'),...
'ShadowColor',get(0,'defaultuipanelShadowColor'),...
'BorderType','beveledin',...
'BorderWidth',3,...
'TitlePosition',get(0,'defaultuipanelTitlePosition'),...
'Title',blanks(0),...
'Visible',get(0,'defaultuipanelVisible'),...
'BackgroundColor',get(0,'defaultuipanelBackgroundColor'),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VisualizationPanel',...
'UserData',[],...
'Position',[21 517 477 294],...
'HandleVisibility',get(0,'defaultuipanelHandleVisibility'),...
'FontSize',get(0,'defaultuipanelFontSize'),...
'FontName',get(0,'defaultuipanelFontName'),...
'FontAngle',get(0,'defaultuipanelFontAngle'),...
'FontWeight',get(0,'defaultuipanelFontWeight'));

appdata = [];
appdata.lastValidTag = 'uipanel23';

h89 = uipanel(...
'Parent',h88,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','uipanel23',...
'Position',[12 88 153 175]);

appdata = [];
appdata.lastValidTag = 'FaceTransparencySlider';

h90 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[11 147 130 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('FaceTransparencySlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('FaceTransparencySlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','FaceTransparencySlider');

appdata = [];
appdata.lastValidTag = 'FaceTransparencyDisplay';

h91 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Face Transparency:   0 %',...
'Style','text',...
'Position',[11 130 135 15],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','FaceTransparencyDisplay');

appdata = [];
appdata.lastValidTag = 'FaceColorButton';

h92 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[12 63 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('FaceColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','FaceColorButton');

appdata = [];
appdata.lastValidTag = 'FaceCheck';

h93 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','points',...
'String','Show Face',...
'Style','checkbox',...
'Position',[29.25 45 63.75 17.25],...
'Callback',@(hObject,eventdata)longaxis('FaceCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','FaceCheck');

appdata = [];
appdata.lastValidTag = 'MeshColorButton';

h94 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[12 40 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('MeshColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MeshColorButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'MeshCheck';

h95 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','points',...
'String','Show Mesh',...
'Style','checkbox',...
'Position',[29.25 27.75 63.75 17.25],...
'Callback',@(hObject,eventdata)longaxis('MeshCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MeshCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'MeshTransparencySlider';

h96 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[11 106 130 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('MeshTransparencySlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('MeshTransparencySlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MeshTransparencySlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'MeshTransparencyDisplay';

h97 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Mesh Transparency:   0 %',...
'Style','text',...
'Position',[11 89 134 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MeshTransparencyDisplay');

appdata = [];
appdata.lastValidTag = 'RandomColorsCheck';

h98 = uicontrol(...
'Parent',h89,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Randomize Colors',...
'Style','checkbox',...
'Position',[15 9 122 24],...
'Callback',@(hObject,eventdata)longaxis('RandomColorsCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','RandomColorsCheck',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'uipanel25';

h99 = uipanel(...
'Parent',h88,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel25',...
'Position',[171 127 152 136],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'HighlightColorButton';

h100 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[10 23 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('HighlightColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('HighlightColorButton_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HighlightColorButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'HighlightColorLabel';

h101 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Highlight Color',...
'Style','text',...
'Position',[36 24 94 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HighlightColorLabel');

appdata = [];
appdata.lastValidTag = 'HLTransparencySlider';

h102 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[9 111 130 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('HLTransparencySlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('HLTransparencySlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HLTransparencySlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'HLTransparencyDisplay';

h103 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','HL Transparency:   0 %',...
'Style','text',...
'Position',[9 94 133 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HLTransparencyDisplay');

appdata = [];
appdata.lastValidTag = 'HLMeshTransparencySlider';

h104 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[10 69 130 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('HLMeshTransparencySlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('HLMeshTransparencySlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HLMeshTransparencySlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'HLMeshTransparencyDisplay';

h105 = uicontrol(...
'Parent',h99,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Mesh Transparency:   0 %',...
'Style','text',...
'Position',[10 52 138 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HLMeshTransparencyDisplay');

appdata = [];
appdata.lastValidTag = 'text26';

h106 = uicontrol(...
'Parent',h88,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','3D Display Control',...
'Style','text',...
'Position',[14 270 136 18],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text26',...
'FontSize',10,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'uipanel26';

h107 = uipanel(...
'Parent',h88,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel26',...
'Position',[332 10 140 269],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'CamProjButton';

h108 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Proj: Perspective',...
'Style','togglebutton',...
'Position',[8 240 124 22],...
'Callback',@(hObject,eventdata)longaxis('CamProjButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','CamProjButton');

appdata = [];
appdata.lastValidTag = 'ViewYZ_Button';

h109 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View +YZ',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 190 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewYZ_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','ViewYZ_Button');

appdata = [];
appdata.lastValidTag = 'ViewXZ_Button';

h110 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View +XZ',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 215 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewXZ_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewXZ_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ViewXY_Button';

h111 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View +XY',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 166 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewXY_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewXY_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ShowAxesCheck';

h112 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Show Axes',...
'Style','checkbox',...
'Position',[8 137 87 25],...
'Callback',@(hObject,eventdata)longaxis('ShowAxesCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','ShowAxesCheck');

appdata = [];
appdata.lastValidTag = 'ShowBoxCheck';

h113 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Show Box',...
'Style','checkbox',...
'Position',[8 116 87 25],...
'Callback',@(hObject,eventdata)longaxis('ShowBoxCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ShowBoxCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'BackgroundColorButton';

h114 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 92 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('BackgroundColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','BackgroundColorButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'BackgroundColorLabel';

h115 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Background Color',...
'Style','text',...
'Position',[34 92 91 16],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','BackgroundColorLabel');

appdata = [];
appdata.lastValidTag = 'AxesColorButton';

h116 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 68 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('AxesColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','AxesColorButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'AxesColorLabel';

h117 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Axes Color',...
'Style','text',...
'Position',[34 69 83 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','AxesColorLabel');

appdata = [];
appdata.lastValidTag = 'GridColorButton';

h118 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[8 44 20 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('GridColorButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','GridColorButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'GridColorLabel';

h119 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Grid Color',...
'Style','text',...
'Position',[34 45 75 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','GridColorLabel');

appdata = [];
appdata.lastValidTag = 'ViewAngleDisplay';

h120 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','View Angle Zoom: 10',...
'Style','text',...
'Position',[9 3 122 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewAngleDisplay');

appdata = [];
appdata.lastValidTag = 'ViewAngleSlider';

h121 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[9 20 123 20],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('ViewAngleSlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('ViewAngleSlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewAngleSlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ViewNegYZ_Button';

h122 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View -YZ',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[74 190 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewNegYZ_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewNegYZ_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ViewNegXZ_Button';

h123 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View -XZ',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[74 215 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewNegXZ_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewNegXZ_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ViewNegXY_Button';

h124 = uicontrol(...
'Parent',h107,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','View -XY',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[74 166 58 22],...
'Callback',@(hObject,eventdata)longaxis('ViewNegXY_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ViewNegXY_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'uipanel32';

h125 = uipanel(...
'Parent',h88,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel32',...
'Position',[171 11 152 108],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'ReverseXaxisCheck';

h126 = uicontrol(...
'Parent',h125,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Reverse X axis direction',...
'Style','checkbox',...
'Position',[7 71 140 25],...
'Callback',@(hObject,eventdata)longaxis('ReverseXaxisCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','ReverseXaxisCheck');

appdata = [];
appdata.lastValidTag = 'ReverseZaxisCheck';

h127 = uicontrol(...
'Parent',h125,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Reverse Z axis direction',...
'Style','checkbox',...
'Position',[7 15 140 25],...
'Callback',@(hObject,eventdata)longaxis('ReverseZaxisCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ReverseZaxisCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'ReverseYaxisCheck';

h128 = uicontrol(...
'Parent',h125,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Reverse Y axis direction',...
'Style','checkbox',...
'Position',[7 43 140 25],...
'Callback',@(hObject,eventdata)longaxis('ReverseYaxisCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ReverseYaxisCheck',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'uipanel33';

h129 = uipanel(...
'Parent',h88,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title',blanks(0),...
'Tag','uipanel33',...
'Position',[12 11 153 69],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'DataPanel';

h130 = uipanel(...
'Parent',h1,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledout',...
'BorderWidth',3,...
'Title',blanks(0),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','DataPanel',...
'Position',[540 37 522 825]);

appdata = [];
appdata.lastValidTag = 'SelectedCellAxis';

h131 = axes(...
'Parent',h130,...
'FontUnits',get(0,'defaultaxesFontUnits'),...
'Units','pixels',...
'CameraPosition',[0.5 0.5 9.16025403784439],...
'CameraPositionMode',get(0,'defaultaxesCameraPositionMode'),...
'CameraTarget',[0.5 0.5 0.5],...
'CameraTargetMode',get(0,'defaultaxesCameraTargetMode'),...
'CameraViewAngle',6.60861036031192,...
'CameraViewAngleMode',get(0,'defaultaxesCameraViewAngleMode'),...
'PlotBoxAspectRatio',[0.712328767123288 1 0.712328767123288],...
'PlotBoxAspectRatioMode',get(0,'defaultaxesPlotBoxAspectRatioMode'),...
'XTick',[0 0.2 0.4 0.6 0.8 1],...
'XTickMode',get(0,'defaultaxesXTickMode'),...
'XTickLabel',{  '0'; '0.2'; '0.4'; '0.6'; '0.8'; '1' },...
'XTickLabelMode',get(0,'defaultaxesXTickLabelMode'),...
'YTick',[0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1],...
'YTickMode',get(0,'defaultaxesYTickMode'),...
'YTickLabel',{  '0'; '0.1'; '0.2'; '0.3'; '0.4'; '0.5'; '0.6'; '0.7'; '0.8'; '0.9'; '1' },...
'YTickLabelMode',get(0,'defaultaxesYTickLabelMode'),...
'CameraMode',get(0,'defaultaxesCameraMode'),...
'DataSpaceMode',get(0,'defaultaxesDataSpaceMode'),...
'ColorSpaceMode',get(0,'defaultaxesColorSpaceMode'),...
'DecorationContainerMode',get(0,'defaultaxesDecorationContainerMode'),...
'ChildContainerMode',get(0,'defaultaxesChildContainerMode'),...
'XRulerMode',get(0,'defaultaxesXRulerMode'),...
'YRulerMode',get(0,'defaultaxesYRulerMode'),...
'ZRulerMode',get(0,'defaultaxesZRulerMode'),...
'AmbientLightSourceMode',get(0,'defaultaxesAmbientLightSourceMode'),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','SelectedCellAxis',...
'Position',[165 27 364 511],...
'ActivePositionProperty','position',...
'ActivePositionPropertyMode',get(0,'defaultaxesActivePositionPropertyMode'),...
'LooseInset',[67.08 63.25 49.02 43.125],...
'LooseInsetMode',get(0,'defaultaxesLooseInsetMode'),...
'SortMethod','childorder',...
'SortMethodMode',get(0,'defaultaxesSortMethodMode'),...
'Box',get(0,'defaultaxesBox'));

h132 = get(h131,'title');

set(h132,...
'Parent',h131,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0 0 0],...
'ColorMode','auto',...
'Position',[0.500000909134582 1.00538160469667 0.5],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',11,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','bold',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','Axes Title',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h133 = get(h131,'xlabel');

set(h133,...
'Parent',h131,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0.500000476837158 -0.0463144151859632 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',11,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','top',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h134 = get(h131,'ylabel');

set(h134,...
'Parent',h131,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[-0.0778388262832123 0.500000476837158 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',90,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',11,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h135 = get(h131,'zlabel');

set(h135,...
'Parent',h131,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0 0 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',10,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','left',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','middle',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','off',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

appdata = [];
appdata.lastValidTag = 'CellSpecsDisplayAxis';

h136 = axes(...
'Parent',h130,...
'FontUnits',get(0,'defaultaxesFontUnits'),...
'Units','pixels',...
'CameraPosition',[0.5 0.5 9.16025403784439],...
'CameraPositionMode',get(0,'defaultaxesCameraPositionMode'),...
'CameraTarget',[0.5 0.5 0.5],...
'CameraTargetMode',get(0,'defaultaxesCameraTargetMode'),...
'CameraViewAngle',6.60861036031192,...
'CameraViewAngleMode',get(0,'defaultaxesCameraViewAngleMode'),...
'PlotBoxAspectRatio',[1 0.256559766763848 0.256559766763848],...
'PlotBoxAspectRatioMode',get(0,'defaultaxesPlotBoxAspectRatioMode'),...
'XTick',[0 0.2 0.4 0.6 0.8 1],...
'XTickMode',get(0,'defaultaxesXTickMode'),...
'XTickLabel',{  '0'; '0.2'; '0.4'; '0.6'; '0.8'; '1' },...
'XTickLabelMode',get(0,'defaultaxesXTickLabelMode'),...
'YTick',[0 0.5 1],...
'YTickMode',get(0,'defaultaxesYTickMode'),...
'YTickLabel',{  '0'; '0.5'; '1' },...
'YTickLabelMode',get(0,'defaultaxesYTickLabelMode'),...
'CameraMode',get(0,'defaultaxesCameraMode'),...
'DataSpaceMode',get(0,'defaultaxesDataSpaceMode'),...
'ColorSpaceMode',get(0,'defaultaxesColorSpaceMode'),...
'DecorationContainerMode',get(0,'defaultaxesDecorationContainerMode'),...
'ChildContainerMode',get(0,'defaultaxesChildContainerMode'),...
'XRulerMode',get(0,'defaultaxesXRulerMode'),...
'YRulerMode',get(0,'defaultaxesYRulerMode'),...
'ZRulerMode',get(0,'defaultaxesZRulerMode'),...
'AmbientLightSourceMode',get(0,'defaultaxesAmbientLightSourceMode'),...
'BusyAction','cancel',...
'Tag','CellSpecsDisplayAxis',...
'Position',[165 568 343 88],...
'ActivePositionProperty','position',...
'ActivePositionPropertyMode',get(0,'defaultaxesActivePositionPropertyMode'),...
'LooseInset',[67.08 64.9 49.02 44.25],...
'LooseInsetMode',get(0,'defaultaxesLooseInsetMode'),...
'FontSize',8,...
'FontSizeMode',get(0,'defaultaxesFontSizeMode'),...
'SortMethod','childorder',...
'SortMethodMode',get(0,'defaultaxesSortMethodMode'),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

h137 = get(h136,'title');

set(h137,...
'Parent',h136,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0 0 0],...
'ColorMode','auto',...
'Position',[0.500000935601771 1.025 0.5],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','bold',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','Axes Title',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h138 = get(h136,'xlabel');

set(h138,...
'Parent',h136,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0.500000476837158 -0.19848484374357 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','top',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h139 = get(h136,'ylabel');

set(h139,...
'Parent',h136,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[-0.0616132154119489 0.500000476837158 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',90,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h140 = get(h136,'zlabel');

set(h140,...
'Parent',h136,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0 0 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',10,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','left',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','middle',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','off',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

appdata = [];
appdata.lastValidTag = 'FitPanel';

h141 = uipanel(...
'Parent',h130,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'ForegroundColor',get(0,'defaultuipanelForegroundColor'),...
'HighlightColor',get(0,'defaultuipanelHighlightColor'),...
'ShadowColor',get(0,'defaultuipanelShadowColor'),...
'BorderType','beveledout',...
'BorderWidth',2,...
'TitlePosition',get(0,'defaultuipanelTitlePosition'),...
'Title',blanks(0),...
'Visible',get(0,'defaultuipanelVisible'),...
'BackgroundColor',get(0,'defaultuipanelBackgroundColor'),...
'ResizeFcn',blanks(0),...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','FitPanel',...
'UserData',[],...
'Position',[159 666 360 120],...
'HandleVisibility',get(0,'defaultuipanelHandleVisibility'),...
'FontSize',get(0,'defaultuipanelFontSize'),...
'FontName',get(0,'defaultuipanelFontName'),...
'FontAngle',get(0,'defaultuipanelFontAngle'),...
'FontWeight',get(0,'defaultuipanelFontWeight'));

appdata = [];
appdata.lastValidTag = 'uipanel19';

h142 = uipanel(...
'Parent',h141,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title','Ellipsoid Fit and LongAxis Vector ',...
'Tag','uipanel19',...
'Position',[9 5 222 81],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'VectorLengthLabel';

h143 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','Length:',...
'Style','text',...
'Position',[128 26 41 18],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorLengthLabel');

appdata = [];
appdata.lastValidTag = 'VectorLengthInput';

h144 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','10',...
'Style','edit',...
'Position',[175 27 33 18],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('VectorLengthInput_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('VectorLengthInput_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorLengthInput',...
'KeyPressFcn',blanks(0),...
'FontSize',9);

appdata = [];
appdata.lastValidTag = 'VectorRadiusLabel';

h145 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','right',...
'String','Radius:',...
'Style','text',...
'Position',[128 45 41 18],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorRadiusLabel');

appdata = [];
appdata.lastValidTag = 'VectorRadiusInput';

h146 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','10',...
'Style','edit',...
'Position',[175 47 33 18],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('VectorRadiusInput_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('VectorRadiusInput_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorRadiusInput',...
'KeyPressFcn',blanks(0),...
'FontSize',9);

appdata = [];
appdata.lastValidTag = 'VectorColor_Button';

h147 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[126 11 15 15],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('VectorColor_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorColor_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'VectorColor_Label';

h148 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Vector Color',...
'Style','text',...
'Position',[145 9 64 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorColor_Label');

appdata = [];
appdata.lastValidTag = 'DataFitTechnique_PullDown';

h149 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',{  'No Fit'; 'Ellipsoid Fit' },...
'Style','popupmenu',...
'Value',2,...
'Position',[10 39 100 20],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('DataFitTechnique_PullDown_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('DataFitTechnique_PullDown_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','DataFitTechnique_PullDown',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'VectorDisplay_Listbox';

h150 = uicontrol(...
'Parent',h142,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String',{  'Hide Vectors'; 'Cylinder'; 'Cone'; 'Cone (reverse)' },...
'Style','popupmenu',...
'Value',4,...
'Position',[10 11 100 20],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('VectorDisplay_Listbox_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('VectorDisplay_Listbox_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VectorDisplay_Listbox',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'uipanel20';

h151 = uipanel(...
'Parent',h141,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'Title','Fit Parameter Filters',...
'Tag','uipanel20',...
'Position',[234 5 120 106],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'R1R2FilterButton';

h152 = uicontrol(...
'Parent',h151,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','r1/r2',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[12 63 45 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('R1R2FilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','R1R2FilterButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'MBSD_MBCD_FilterButton';

h153 = uicontrol(...
'Parent',h151,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','MBSD/MBCD',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 12 95 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('MBSD_MBCD_FilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MBSD_MBCD_FilterButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'VolumeDiffFilterButton';

h154 = uicontrol(...
'Parent',h151,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','PVD',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[63 36 45 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('VolumeDiffFilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','VolumeDiffFilterButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'R2R3FilterButton';

h155 = uicontrol(...
'Parent',h151,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','r2/r3',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[63 63 45 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('R2R3FilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','R2R3FilterButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'MBSDFilterButton';

h156 = uicontrol(...
'Parent',h151,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','MBSD',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 36 45 22],...
'BackgroundColor',get(0,'defaultuicontrolBackgroundColor'),...
'Callback',@(hObject,eventdata)longaxis('MBSDFilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','MBSDFilterButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName','Monospaced',...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight',get(0,'defaultuicontrolFontWeight'));

appdata = [];
appdata.lastValidTag = 'SingleCellDisplayStyle_PullDown';

h157 = uicontrol(...
'Parent',h141,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',{  'Hide Data'; 'Show Data Surface'; 'Show Data Points' },...
'Style','popupmenu',...
'Value',2,...
'Position',[12 89 144 24],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('SingleCellDisplayStyle_PullDown_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('SingleCellDisplayStyle_PullDown_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','SingleCellDisplayStyle_PullDown',...
'FontSize',9);

appdata = [];
appdata.lastValidTag = 'HideEdgeCellsButton';

h158 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Hide Edge Cells',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 164 116 20],...
'Callback',@(hObject,eventdata)longaxis('HideEdgeCellsButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','HideEdgeCellsButton');

appdata = [];
appdata.lastValidTag = 'ResetAllCellsButton';

h159 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Reset All',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 188 56 20],...
'Callback',@(hObject,eventdata)longaxis('ResetAllCellsButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ResetAllCellsButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'HideAllButton';

h160 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Hide All',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[78 188 56 20],...
'Callback',@(hObject,eventdata)longaxis('HideAllButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HideAllButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'RecentCellSelectionDisplay';

h161 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Main Figure Selection:    1',...
'Style','text',...
'Position',[8 799 138 16],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','RecentCellSelectionDisplay');

appdata = [];
appdata.lastValidTag = 'UnHLAll_Button';

h162 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Un-HighLight All',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 304 116 20],...
'Callback',@(hObject,eventdata)longaxis('UnHLAll_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','UnHLAll_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'OnlyHLCellsVis_Button';

h163 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Only HL-Cells Visible',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 280 116 20],...
'Callback',@(hObject,eventdata)longaxis('OnlyHLCellsVis_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','OnlyHLCellsVis_Button',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'uipanel14';

h164 = uipanel(...
'Parent',h130,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledin',...
'BorderWidth',4,...
'Title',blanks(0),...
'Tag','uipanel14',...
'Position',[12 22 126 135],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'LoadAnalysisButton';

h165 = uicontrol(...
'Parent',h164,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Load Analysis',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 44 100 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('LoadAnalysisButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','LoadAnalysisButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',9,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SaveAnalysisButton';

h166 = uicontrol(...
'Parent',h164,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Save Analysis',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 68 100 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('SaveAnalysisButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SaveAnalysisButton',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',9,...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'ExportData_Button';

h167 = uicontrol(...
'Parent',h164,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Export Data',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[13 7 100 26],...
'Callback',@(hObject,eventdata)longaxis('ExportData_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'Tag','ExportData_Button',...
'FontSize',10,...
'FontWeight','bold',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'Refresh3D_Button';

h168 = uicontrol(...
'Parent',h164,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment',get(0,'defaultuicontrolHorizontalAlignment'),...
'ListboxTop',get(0,'defaultuicontrolListboxTop'),...
'Max',get(0,'defaultuicontrolMax'),...
'Min',get(0,'defaultuicontrolMin'),...
'SliderStep',get(0,'defaultuicontrolSliderStep'),...
'String','Refresh 3D',...
'Style',get(0,'defaultuicontrolStyle'),...
'Value',get(0,'defaultuicontrolValue'),...
'Position',[13 102 100 20],...
'BackgroundColor',[0.8 0.8 0.8],...
'Callback',@(hObject,eventdata)longaxis('Refresh3D_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',get(0,'defaultuicontrolForegroundColor'),...
'Enable',get(0,'defaultuicontrolEnable'),...
'TooltipString',blanks(0),...
'Visible',get(0,'defaultuicontrolVisible'),...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Refresh3D_Button',...
'UserData',[],...
'KeyPressFcn',blanks(0),...
'KeyReleaseFcn',blanks(0),...
'HandleVisibility',get(0,'defaultuicontrolHandleVisibility'),...
'FontSize',get(0,'defaultuicontrolFontSize'),...
'FontName',get(0,'defaultuicontrolFontName'),...
'FontAngle',get(0,'defaultuicontrolFontAngle'),...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'nCellsVisibleDisplay';

h169 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','nCells Visible:  0',...
'Style','text',...
'Position',[8 782 138 16],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','nCellsVisibleDisplay');

appdata = [];
appdata.lastValidTag = 'DataAndEllipsoidPanelButton';

h170 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Data/Ellispoid',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[158 787 120 27],...
'Callback',@(hObject,eventdata)longaxis('DataAndEllipsoidPanelButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','DataAndEllipsoidPanelButton',...
'FontSize',10,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SizeFilterPanelButton';

h171 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Size Filter',...
'Style','togglebutton',...
'Position',[277 787 120 27],...
'Callback',@(hObject,eventdata)longaxis('SizeFilterPanelButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SizeFilterPanelButton',...
'KeyPressFcn',blanks(0),...
'FontSize',10,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'FilterPanel';

h172 = uipanel(...
'Parent',h130,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledout',...
'BorderWidth',2,...
'Title',blanks(0),...
'Tag','FilterPanel',...
'Position',[153 472 360 120],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'FilterVolumeDisplay';

h173 = axes(...
'Parent',h172,...
'FontUnits',get(0,'defaultaxesFontUnits'),...
'Units','pixels',...
'CameraPosition',[0.5 0.5 9.16025403784439],...
'CameraPositionMode',get(0,'defaultaxesCameraPositionMode'),...
'CameraTarget',[0.5 0.5 0.5],...
'CameraTargetMode',get(0,'defaultaxesCameraTargetMode'),...
'CameraViewAngle',6.60861036031192,...
'CameraViewAngleMode',get(0,'defaultaxesCameraViewAngleMode'),...
'PlotBoxAspectRatio',[1 0.460227272727273 0.460227272727273],...
'PlotBoxAspectRatioMode',get(0,'defaultaxesPlotBoxAspectRatioMode'),...
'XTick',[0 0.5 1],...
'XTickMode',get(0,'defaultaxesXTickMode'),...
'XTickLabel',{  '0'; '0.5'; '1' },...
'XTickLabelMode',get(0,'defaultaxesXTickLabelMode'),...
'YTick',[0 0.5 1],...
'YTickMode',get(0,'defaultaxesYTickMode'),...
'YTickLabel',{  '0'; '0.5'; '1' },...
'YTickLabelMode',get(0,'defaultaxesYTickLabelMode'),...
'CameraMode',get(0,'defaultaxesCameraMode'),...
'DataSpaceMode',get(0,'defaultaxesDataSpaceMode'),...
'ColorSpaceMode',get(0,'defaultaxesColorSpaceMode'),...
'DecorationContainerMode',get(0,'defaultaxesDecorationContainerMode'),...
'ChildContainerMode',get(0,'defaultaxesChildContainerMode'),...
'XRulerMode',get(0,'defaultaxesXRulerMode'),...
'YRulerMode',get(0,'defaultaxesYRulerMode'),...
'ZRulerMode',get(0,'defaultaxesZRulerMode'),...
'AmbientLightSourceMode',get(0,'defaultaxesAmbientLightSourceMode'),...
'BusyAction','cancel',...
'Tag','FilterVolumeDisplay',...
'Position',[170 20 176 81],...
'ActivePositionProperty','position',...
'ActivePositionPropertyMode',get(0,'defaultaxesActivePositionPropertyMode'),...
'LooseInset',[158.47 98.78 115.805 67.35],...
'LooseInsetMode',get(0,'defaultaxesLooseInsetMode'),...
'FontSize',8,...
'FontSizeMode',get(0,'defaultaxesFontSizeMode'),...
'SortMethod','childorder',...
'SortMethodMode',get(0,'defaultaxesSortMethodMode'),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

h174 = get(h173,'title');

set(h174,...
'Parent',h173,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0 0 0],...
'ColorMode','auto',...
'Position',[0.50000139799985 1.02716049382716 0.500000000000007],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','bold',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','Axes Title',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h175 = get(h173,'xlabel');

set(h175,...
'Parent',h173,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0.500000476837158 -0.215637854931286 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','top',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h176 = get(h173,'ylabel');

set(h176,...
'Parent',h173,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[-0.120075755035787 0.500000476837158 7.105427357601e-15],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',90,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',8.8,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','center',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','bottom',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','back',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','on',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

h177 = get(h173,'zlabel');

set(h177,...
'Parent',h173,...
'Units','data',...
'FontUnits','points',...
'DecorationContainer',[],...
'DecorationContainerMode','auto',...
'Color',[0.15 0.15 0.15],...
'ColorMode','auto',...
'Position',[0 0 0],...
'PositionMode','auto',...
'Interpreter','tex',...
'InterpreterMode','auto',...
'Rotation',0,...
'RotationMode','auto',...
'FontName','Helvetica',...
'FontNameMode','auto',...
'FontUnitsMode','auto',...
'FontSize',10,...
'FontSizeMode','auto',...
'FontAngle','normal',...
'FontAngleMode','auto',...
'FontWeight','normal',...
'FontWeightMode','auto',...
'HorizontalAlignment','left',...
'HorizontalAlignmentMode','auto',...
'VerticalAlignment','middle',...
'VerticalAlignmentMode','auto',...
'EdgeColor','none',...
'EdgeColorMode','auto',...
'LineStyle','-',...
'LineStyleMode','auto',...
'LineWidth',0.5,...
'LineWidthMode','auto',...
'BackgroundColor','none',...
'BackgroundColorMode','auto',...
'Margin',3,...
'MarginMode','auto',...
'Clipping','off',...
'ClippingMode','auto',...
'Layer','middle',...
'LayerMode','auto',...
'FontSmoothing','on',...
'FontSmoothingMode','auto',...
'UnitsMode','auto',...
'IncludeRenderer','on',...
'IsContainer','off',...
'IsContainerMode','auto',...
'HG1EraseMode','auto',...
'BusyAction','queue',...
'Interruptible','on',...
'HitTest','on',...
'HitTestMode','auto',...
'PickableParts','visible',...
'PickablePartsMode','auto',...
'DimensionNames',{  'X' 'Y' 'Z' },...
'DimensionNamesMode','auto',...
'XLimInclude','on',...
'XLimIncludeMode','auto',...
'YLimInclude','on',...
'YLimIncludeMode','auto',...
'ZLimInclude','on',...
'ZLimIncludeMode','auto',...
'CLimInclude','on',...
'CLimIncludeMode','auto',...
'ALimInclude','on',...
'ALimIncludeMode','auto',...
'Description','AxisRulerBase Label',...
'DescriptionMode','auto',...
'Visible','off',...
'VisibleMode','auto',...
'Serializable','on',...
'SerializableMode','auto',...
'HandleVisibility','off',...
'HandleVisibilityMode','auto',...
'TransformForPrintFcnImplicitInvoke','on',...
'TransformForPrintFcnImplicitInvokeMode','auto');

appdata = [];
appdata.lastValidTag = 'text29';

h178 = uicontrol(...
'Parent',h172,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','points',...
'HorizontalAlignment','right',...
'String','High (voxels):',...
'Style','text',...
'Position',[8.25 16.5 56 12],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','text29',...
'FontSize',get(0,'defaultuicontrolFontSize'));

appdata = [];
appdata.lastValidTag = 'High_Size_Filter_Input';

h179 = uicontrol(...
'Parent',h172,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','edit',...
'Position',[94 22 50 20],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('High_Size_Filter_Input_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('High_Size_Filter_Input_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','High_Size_Filter_Input',...
'KeyPressFcn',blanks(0),...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'LowFilterSizeText';

h180 = uicontrol(...
'Parent',h172,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','points',...
'HorizontalAlignment','right',...
'String','Low (voxels):',...
'Style','text',...
'Position',[8.25 33 56 12],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','LowFilterSizeText',...
'FontSize',get(0,'defaultuicontrolFontSize'));

appdata = [];
appdata.lastValidTag = 'Low_Size_Filter_Input';

h181 = uicontrol(...
'Parent',h172,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','edit',...
'Position',[94 45 50 20],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('Low_Size_Filter_Input_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('Low_Size_Filter_Input_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','Low_Size_Filter_Input',...
'FontSize',10);

appdata = [];
appdata.lastValidTag = 'ApplySizeFilterButton';

h182 = uicontrol(...
'Parent',h172,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Apply Size Filter',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 76 119 27],...
'Callback',@(hObject,eventdata)longaxis('ApplySizeFilterButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ApplySizeFilterButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'SingleCellViewAngleDisplay';

h183 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Zoom: 10',...
'Style','text',...
'Position',[348 10 92 15],...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SingleCellViewAngleDisplay');

appdata = [];
appdata.lastValidTag = 'SingleCellViewAngleSlider';

h184 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','slider',...
'Position',[192 10 147 16],...
'BackgroundColor',[0.9 0.9 0.9],...
'Callback',@(hObject,eventdata)longaxis('SingleCellViewAngleSlider_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('SingleCellViewAngleSlider_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','SingleCellViewAngleSlider',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'togglebutton10';

h185 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String',blanks(0),...
'Style','togglebutton',...
'Position',[396 787 120 27],...
'Callback',@(hObject,eventdata)longaxis('togglebutton10_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','togglebutton10',...
'KeyPressFcn',blanks(0),...
'FontSize',10,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'SingleCellHLCheck';

h186 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Single-Cell Highlighting',...
'Style','checkbox',...
'Position',[13 427 130 16],...
'Callback',@(hObject,eventdata)longaxis('SingleCellHLCheck_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'Tag','SingleCellHLCheck',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'CellList';

h187 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','    1  10528  V  H',...
'Style','listbox',...
'Value',1,...
'ValueMode',get(0,'defaultuicontrolValueMode'),...
'Position',[2 449 150 311],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)longaxis('CellList_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, @(hObject,eventdata)longaxis('CellList_CreateFcn',hObject,eventdata,guidata(hObject)), appdata} ,...
'Tag','CellList',...
'FontName','Monospaced');

appdata = [];
appdata.lastValidTag = 'ListBoxLabel';

h188 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'HorizontalAlignment','left',...
'String','Cell#   Voxels   Vis   Highlight',...
'Style','text',...
'Position',[4 760 151 12],...
'Children',[],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'Tag','ListBoxLabel',...
'FontSize',7,...
'FontWeight','bold');

appdata = [];
appdata.lastValidTag = 'ReverseVisibleCellsButton';

h189 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Reverse Visible Cells',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 328 116 20],...
'Callback',@(hObject,eventdata)longaxis('ReverseVisibleCellsButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','ReverseVisibleCellsButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'HideHLedCellsButton';

h190 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Hide HL''ed Cells',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 352 116 20],...
'Callback',@(hObject,eventdata)longaxis('HideHLedCellsButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','HideHLedCellsButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'uipanel21';

h191 = uipanel(...
'Parent',h130,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units','pixels',...
'BorderType','beveledin',...
'BorderWidth',2,...
'Title',blanks(0),...
'Tag','uipanel21',...
'Position',[13 214.666666666667 124 59],...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} );

appdata = [];
appdata.lastValidTag = 'csvOutputButton';

h192 = uicontrol(...
'Parent',h191,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Cell Index Export',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[10.3333333333333 30.3333333333334 104 20],...
'Callback',@(hObject,eventdata)longaxis('csvOutputButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','csvOutputButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'csvInputButton';

h193 = uicontrol(...
'Parent',h191,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','Cell Index Import',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[10.3333333333333 5.6666666666667 104 20],...
'Callback',@(hObject,eventdata)longaxis('csvInputButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','csvInputButton',...
'KeyPressFcn',blanks(0));

appdata = [];
appdata.lastValidTag = 'Undo_Button';

h194 = uicontrol(...
'Parent',h130,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units',get(0,'defaultuicontrolUnits'),...
'String','UNDO Vis edits',...
'Style',get(0,'defaultuicontrolStyle'),...
'Position',[18 382 116 33],...
'Callback',@(hObject,eventdata)longaxis('Undo_Button_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'ForegroundColor',[0.63921568627451 0.0784313725490196 0.180392156862745],...
'ButtonDownFcn',blanks(0),...
'BusyAction','cancel',...
'CreateFcn', {@local_CreateFcn, blanks(0), appdata} ,...
'DeleteFcn',blanks(0),...
'Tag','Undo_Button',...
'KeyPressFcn',blanks(0),...
'FontSize',9,...
'FontWeight','bold');


hsingleton = h1;


% --- Set application data first then calling the CreateFcn. 
function local_CreateFcn(hObject, eventdata, createfcn, appdata)

if ~isempty(appdata)
   names = fieldnames(appdata);
   for i=1:length(names)
       name = char(names(i));
       setappdata(hObject, name, getfield(appdata,name));
   end
end

if ~isempty(createfcn)
   if isa(createfcn,'function_handle')
       createfcn(hObject, eventdata);
   else
       eval(createfcn);
   end
end


% --- Handles default GUIDE GUI creation and callback dispatch
function varargout = gui_mainfcn(gui_State, varargin)

gui_StateFields =  {'gui_Name'
    'gui_Singleton'
    'gui_OpeningFcn'
    'gui_OutputFcn'
    'gui_LayoutFcn'
    'gui_Callback'};
gui_Mfile = '';
for i=1:length(gui_StateFields)
    if ~isfield(gui_State, gui_StateFields{i})
        error(message('MATLAB:guide:StateFieldNotFound', gui_StateFields{ i }, gui_Mfile));
    elseif isequal(gui_StateFields{i}, 'gui_Name')
        gui_Mfile = [gui_State.(gui_StateFields{i}), '.m'];
    end
end

numargin = length(varargin);

if numargin == 0
    % LONGAXIS
    % create the GUI only if we are not in the process of loading it
    % already
    gui_Create = true;
elseif local_isInvokeActiveXCallback(gui_State, varargin{:})
    % LONGAXIS(ACTIVEX,...)
    vin{1} = gui_State.gui_Name;
    vin{2} = [get(varargin{1}.Peer, 'Tag'), '_', varargin{end}];
    vin{3} = varargin{1};
    vin{4} = varargin{end-1};
    vin{5} = guidata(varargin{1}.Peer);
    feval(vin{:});
    return;
elseif local_isInvokeHGCallback(gui_State, varargin{:})
    % LONGAXIS('CALLBACK',hObject,eventData,handles,...)
    gui_Create = false;
else
    % LONGAXIS(...)
    % create the GUI and hand varargin to the openingfcn
    gui_Create = true;
end

if ~gui_Create
    % In design time, we need to mark all components possibly created in
    % the coming callback evaluation as non-serializable. This way, they
    % will not be brought into GUIDE and not be saved in the figure file
    % when running/saving the GUI from GUIDE.
    designEval = false;
    if (numargin>1 && ishghandle(varargin{2}))
        fig = varargin{2};
        while ~isempty(fig) && ~ishghandle(fig,'figure')
            fig = get(fig,'parent');
        end
        
        designEval = isappdata(0,'CreatingGUIDEFigure') || (isscalar(fig)&&isprop(fig,'GUIDEFigure'));
    end
        
    if designEval
        beforeChildren = findall(fig);
    end
    
    % evaluate the callback now
    varargin{1} = gui_State.gui_Callback;
    if nargout
        [varargout{1:nargout}] = feval(varargin{:});
    else       
        feval(varargin{:});
    end
    
    % Set serializable of objects created in the above callback to off in
    % design time. Need to check whether figure handle is still valid in
    % case the figure is deleted during the callback dispatching.
    if designEval && ishghandle(fig)
        set(setdiff(findall(fig),beforeChildren), 'Serializable','off');
    end
else
    if gui_State.gui_Singleton
        gui_SingletonOpt = 'reuse';
    else
        gui_SingletonOpt = 'new';
    end

    % Check user passing 'visible' P/V pair first so that its value can be
    % used by oepnfig to prevent flickering
    gui_Visible = 'auto';
    gui_VisibleInput = '';
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        % Recognize 'visible' P/V pair
        len1 = min(length('visible'),length(varargin{index}));
        len2 = min(length('off'),length(varargin{index+1}));
        if ischar(varargin{index+1}) && strncmpi(varargin{index},'visible',len1) && len2 > 1
            if strncmpi(varargin{index+1},'off',len2)
                gui_Visible = 'invisible';
                gui_VisibleInput = 'off';
            elseif strncmpi(varargin{index+1},'on',len2)
                gui_Visible = 'visible';
                gui_VisibleInput = 'on';
            end
        end
    end
    
    % Open fig file with stored settings.  Note: This executes all component
    % specific CreateFunctions with an empty HANDLES structure.

    
    % Do feval on layout code in m-file if it exists
    gui_Exported = ~isempty(gui_State.gui_LayoutFcn);
    % this application data is used to indicate the running mode of a GUIDE
    % GUI to distinguish it from the design mode of the GUI in GUIDE. it is
    % only used by actxproxy at this time.   
    setappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]),1);
    if gui_Exported
        gui_hFigure = feval(gui_State.gui_LayoutFcn, gui_SingletonOpt);

        % make figure invisible here so that the visibility of figure is
        % consistent in OpeningFcn in the exported GUI case
        if isempty(gui_VisibleInput)
            gui_VisibleInput = get(gui_hFigure,'Visible');
        end
        set(gui_hFigure,'Visible','off')

        % openfig (called by local_openfig below) does this for guis without
        % the LayoutFcn. Be sure to do it here so guis show up on screen.
        movegui(gui_hFigure,'onscreen');
    else
        gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        % If the figure has InGUIInitialization it was not completely created
        % on the last pass.  Delete this handle and try again.
        if isappdata(gui_hFigure, 'InGUIInitialization')
            delete(gui_hFigure);
            gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        end
    end
    if isappdata(0, genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]))
        rmappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]));
    end

    % Set flag to indicate starting GUI initialization
    setappdata(gui_hFigure,'InGUIInitialization',1);

    % Fetch GUIDE Application options
    gui_Options = getappdata(gui_hFigure,'GUIDEOptions');
    % Singleton setting in the GUI MATLAB code file takes priority if different
    gui_Options.singleton = gui_State.gui_Singleton;

    if ~isappdata(gui_hFigure,'GUIOnScreen')
        % Adjust background color
        if gui_Options.syscolorfig
            set(gui_hFigure,'Color', get(0,'DefaultUicontrolBackgroundColor'));
        end

        % Generate HANDLES structure and store with GUIDATA. If there is
        % user set GUI data already, keep that also.
        data = guidata(gui_hFigure);
        handles = guihandles(gui_hFigure);
        if ~isempty(handles)
            if isempty(data)
                data = handles;
            else
                names = fieldnames(handles);
                for k=1:length(names)
                    data.(char(names(k)))=handles.(char(names(k)));
                end
            end
        end
        guidata(gui_hFigure, data);
    end

    % Apply input P/V pairs other than 'visible'
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        len1 = min(length('visible'),length(varargin{index}));
        if ~strncmpi(varargin{index},'visible',len1)
            try set(gui_hFigure, varargin{index}, varargin{index+1}), catch break, end
        end
    end

    % If handle visibility is set to 'callback', turn it on until finished
    % with OpeningFcn
    gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
    if strcmp(gui_HandleVisibility, 'callback')
        set(gui_hFigure,'HandleVisibility', 'on');
    end

    feval(gui_State.gui_OpeningFcn, gui_hFigure, [], guidata(gui_hFigure), varargin{:});

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        % Handle the default callbacks of predefined toolbar tools in this
        % GUI, if any
        guidemfile('restoreToolbarToolPredefinedCallback',gui_hFigure); 
        
        % Update handle visibility
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);

        % Call openfig again to pick up the saved visibility or apply the
        % one passed in from the P/V pairs
        if ~gui_Exported
            gui_hFigure = local_openfig(gui_State.gui_Name, 'reuse',gui_Visible);
        elseif ~isempty(gui_VisibleInput)
            set(gui_hFigure,'Visible',gui_VisibleInput);
        end
        if strcmpi(get(gui_hFigure, 'Visible'), 'on')
            figure(gui_hFigure);
            
            if gui_Options.singleton
                setappdata(gui_hFigure,'GUIOnScreen', 1);
            end
        end

        % Done with GUI initialization
        if isappdata(gui_hFigure,'InGUIInitialization')
            rmappdata(gui_hFigure,'InGUIInitialization');
        end

        % If handle visibility is set to 'callback', turn it on until
        % finished with OutputFcn
        gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
        if strcmp(gui_HandleVisibility, 'callback')
            set(gui_hFigure,'HandleVisibility', 'on');
        end
        gui_Handles = guidata(gui_hFigure);
    else
        gui_Handles = [];
    end

    if nargout
        [varargout{1:nargout}] = feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    else
        feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    end

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);
    end
end

function gui_hFigure = local_openfig(name, singleton, visible)

% openfig with three arguments was new from R13. Try to call that first, if
% failed, try the old openfig.
if nargin('openfig') == 2
    % OPENFIG did not accept 3rd input argument until R13,
    % toggle default figure visible to prevent the figure
    % from showing up too soon.
    gui_OldDefaultVisible = get(0,'defaultFigureVisible');
    set(0,'defaultFigureVisible','off');
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton);
    set(0,'defaultFigureVisible',gui_OldDefaultVisible);
else
    % Call version of openfig that accepts 'auto' option"
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton, visible);  
%     %workaround for CreateFcn not called to create ActiveX
%         peers=findobj(findall(allchild(gui_hFigure)),'type','uicontrol','style','text');    
%         for i=1:length(peers)
%             if isappdata(peers(i),'Control')
%                 actxproxy(peers(i));
%             end            
%         end
end

function result = local_isInvokeActiveXCallback(gui_State, varargin)

try
    result = ispc && iscom(varargin{1}) ...
             && isequal(varargin{1},gcbo);
catch
    result = false;
end

function result = local_isInvokeHGCallback(gui_State, varargin)

try
    fhandle = functions(gui_State.gui_Callback);
    result = ~isempty(findstr(gui_State.gui_Name,fhandle.file)) || ...
             (ischar(varargin{1}) ...
             && isequal(ishghandle(varargin{2}), 1) ...
             && (~isempty(strfind(varargin{1},[get(varargin{2}, 'Tag'), '_'])) || ...
                ~isempty(strfind(varargin{1}, '_CreateFcn'))) );
catch
    result = false;
end


